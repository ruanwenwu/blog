[ 2017-02-21T15:12:31+08:00 ] 203.130.43.155 /admin.php
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000079s ]
INFO: [ app_init ] --END-- [ RunTime:0.000386s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000308s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000346s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.

[ 2017-02-21T15:12:31+08:00 ] 203.130.43.155 /admin.php/Login/login
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000010s ]
INFO: [ app_init ] --END-- [ RunTime:0.000220s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000283s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000320s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000030s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000069s ]
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.004431s ]
INFO: [ view_parse ] --END-- [ RunTime:0.004468s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000106s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000136s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000303s ]
INFO: [ app_end ] --END-- [ RunTime:0.000336s ]

[ 2017-02-21T15:12:33+08:00 ] 203.130.43.155 /admin.php
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000013s ]
INFO: [ app_init ] --END-- [ RunTime:0.000253s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000348s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000386s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.

[ 2017-02-21T15:12:33+08:00 ] 203.130.43.155 /admin.php/Login/login
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000012s ]
INFO: [ app_init ] --END-- [ RunTime:0.000248s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000350s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000387s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000039s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000095s ]
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.004815s ]
INFO: [ view_parse ] --END-- [ RunTime:0.004903s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000112s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000143s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000329s ]
INFO: [ app_end ] --END-- [ RunTime:0.000362s ]

[ 2017-02-21T15:12:33+08:00 ] 203.130.43.155 /admin.php/Login/login
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000053s ]
INFO: [ app_init ] --END-- [ RunTime:0.000288s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000305s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000343s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000029s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000068s ]
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.004306s ]
INFO: [ view_parse ] --END-- [ RunTime:0.004387s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000105s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000135s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000499s ]
INFO: [ app_end ] --END-- [ RunTime:0.000532s ]

[ 2017-02-21T15:12:35+08:00 ] 203.130.43.155 /admin.php/Ajax/login
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000012s ]
INFO: [ app_init ] --END-- [ RunTime:0.000248s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000344s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000381s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.

[ 2017-02-21T15:12:35+08:00 ] 203.130.43.155 /admin.php
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000010s ]
INFO: [ app_init ] --END-- [ RunTime:0.000219s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000321s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000358s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.
SQL: SHOW COLUMNS FROM `z_category` [ RunTime:0.0005s ]
SQL: SELECT * FROM `z_category`  [ RunTime:0.0001s ]
SQL: SHOW COLUMNS FROM `z_tag` [ RunTime:0.0003s ]
SQL: SELECT * FROM `z_tag`  [ RunTime:0.0001s ]
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000070s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000117s ]
NOTIC: [8] Undefined variable: userInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/b595b808c2ebeeeb0478ffc30bb4e87a.php 第 361 行.
NOTIC: [8] Undefined variable: hospitalInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/b595b808c2ebeeeb0478ffc30bb4e87a.php 第 424 行.
NOTIC: [8] Undefined variable: hospitalInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/b595b808c2ebeeeb0478ffc30bb4e87a.php 第 438 行.
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.013465s ]
INFO: [ view_parse ] --END-- [ RunTime:0.013499s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000115s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000147s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000324s ]
INFO: [ app_end ] --END-- [ RunTime:0.000363s ]

[ 2017-02-21T15:12:35+08:00 ] 203.130.43.155 /admin.php
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000013s ]
INFO: [ app_init ] --END-- [ RunTime:0.000249s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000353s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000391s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.
SQL: SHOW COLUMNS FROM `z_category` [ RunTime:0.0005s ]
SQL: SELECT * FROM `z_category`  [ RunTime:0.0001s ]
SQL: SHOW COLUMNS FROM `z_tag` [ RunTime:0.0005s ]
SQL: SELECT * FROM `z_tag`  [ RunTime:0.0001s ]
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000085s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000128s ]
NOTIC: [8] Undefined variable: userInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/b595b808c2ebeeeb0478ffc30bb4e87a.php 第 361 行.
NOTIC: [8] Undefined variable: hospitalInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/b595b808c2ebeeeb0478ffc30bb4e87a.php 第 424 行.
NOTIC: [8] Undefined variable: hospitalInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/b595b808c2ebeeeb0478ffc30bb4e87a.php 第 438 行.
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.013681s ]
INFO: [ view_parse ] --END-- [ RunTime:0.013717s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000116s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000147s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000331s ]
INFO: [ app_end ] --END-- [ RunTime:0.000370s ]

[ 2017-02-21T15:15:21+08:00 ] 203.130.43.155 /admin.php/Ajax/addNewPost
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000013s ]
INFO: [ app_init ] --END-- [ RunTime:0.000292s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000301s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000341s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.
NOTIC: [8] Undefined index: id /data/wwwroot/blog/Application/Admin/Controller/AjaxController.class.php 第 53 行.
SQL: SHOW COLUMNS FROM `z_post` [ RunTime:0.0006s ]
SQL: INSERT INTO `z_post` (`title`,`category`,`tag`,`summary`,`content`,`pubtime`,`mtime`,`ctime`) VALUES ('php搭建oatuth2.0服务端和客户端','php','框架','oauth2.0搭建服务端和客户端的一个记录','<p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">今天搭建了oauth2.0服务端与客户端。把搭建的过程记录一下。具体实现的功能是：client.ruanwenwu.cn的用户能够通过 server.ruanwenwu.cn的用户名和密码登陆client.ruanwenwu.cn。并且登陆 后，client.ruanwenwu.cn的用户能获取server.ruanwenwu.cn哪里的一些资源。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">我的个人博客原文地址：</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">一、oauth2.0的作用</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;1、搭建第三方登录平台（就像你用很多网站支持qq登录。其实是qq提供的oauth2.0服务端支持。网站作为第三方，只要用oauth2.0标准请求服务端，求能得到用户信息，并实现登录）。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;2、公共资源管理。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;就 像你（Y）想通过一个打印照片的网站（A)来打印你存放在google(B)的照片。你就要通过这个A来获取B的照片。B肯定要验证是否是他的用户Y的请 求，验证通过才把照片传递给A实现打印。问题是Y不想把账号密码直接给A。用oauth2.0就是来解决这个问题的：</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A先 把Y导向B的站点进行授权。授权通过，B向A发送oauth_code。A拿到这个oauth_code，连同A的client_id和 oauth_secrete发送给B，如果数据正确，B就会给A发送oauth_token。有了这个token,A就可以获取B的相关资源的。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;基本的流程是这样。下面是具体的实现过程。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">二、oauth2.0服务端的搭建。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oauth2.0的服务端分为验证服务器和资源服务器。这两个服务器也可以是同一个服务器（只不过把这两个功能用一个 服务器来完成罢了）。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;说明：我的实现都在Thinkphp3.2.3框架下实现。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1、下载thinkphp3.2.3。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2、配置虚拟机server.ruanwenwu.cn</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3、在Thinkphp的Home应用下修改配置文件（server.ruanwenwu.cn/Application/Home/Conf/config.php）如下所示：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;?phpreturn&nbsp;array(&nbsp;&nbsp;&nbsp;&nbsp;//&#39;配置项&#39;=&gt;&#39;配置值&#39;&nbsp;&nbsp;&nbsp;&nbsp;//数据库设置&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DB_TYPE&#39;&nbsp;=&gt;&nbsp;&#39;mysql&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DB_HOST&#39;&nbsp;=&gt;&nbsp;&#39;127.0.0.1&#39;,//localhost&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DB_NAME&#39;&nbsp;=&gt;&nbsp;&#39;oauth&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DB_USER&#39;&nbsp;=&gt;&nbsp;&#39;root&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DB_PWD&#39;&nbsp;&nbsp;=&gt;&nbsp;&#39;root&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DB_PORT&#39;&nbsp;=&gt;&nbsp;&#39;3306&#39;,&nbsp;&nbsp;&nbsp;&nbsp;

&nbsp;&nbsp;&nbsp;&nbsp;&#39;SCOPE_INFO&#39;&nbsp;&nbsp;=&gt;&nbsp;array(&nbsp;&nbsp;&nbsp;&nbsp;//这是授权选项。根据你自己的项目来&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;name&#39;&nbsp;=&gt;&nbsp;&#39;个人信息&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;value&#39;&nbsp;=&gt;&nbsp;&#39;basicinfo&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;name&#39;&nbsp;=&gt;&nbsp;&#39;论坛发帖回帖&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;value&#39;&nbsp;=&gt;&nbsp;&#39;bbsinfo&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),&nbsp;&nbsp;&nbsp;&nbsp;),&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&#39;OAUTH2_CODES_TABLE&#39;&nbsp;&nbsp;&nbsp;=&gt;&#39;oauth_code&#39;,&nbsp;&nbsp;&nbsp;&nbsp;//这里是oauth项目需要用的三个基础表&nbsp;&nbsp;&nbsp;&nbsp;&#39;OAUTH2_CLIENTS_TABLE&#39;&nbsp;=&gt;&#39;oauth_client&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&#39;OAUTH2_TOKEN_TABLE&#39;&nbsp;&nbsp;&nbsp;=&gt;&#39;oauth_token&#39;,&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&#39;SECRETKYE&#39;&nbsp;=&gt;&nbsp;&#39;Mumayi!@#&#39;,&nbsp;&nbsp;&nbsp;&nbsp;//下面是一些网站自定义的项目。可以根据自己的情况来写或者不写&nbsp;&nbsp;&nbsp;&nbsp;//session&nbsp;有效期&nbsp;&nbsp;&nbsp;&nbsp;&#39;SESSION_EXPIRES&#39;&nbsp;=&gt;&nbsp;1200,&nbsp;&nbsp;&nbsp;&nbsp;//key&nbsp;有效期&nbsp;&nbsp;&nbsp;&nbsp;&#39;PASS_KEY_EXPIRES&#39;&nbsp;=&gt;&nbsp;86400,&nbsp;&nbsp;&nbsp;&nbsp;//key&nbsp;有效期&nbsp;&nbsp;&nbsp;&nbsp;&#39;PHONE_KEY_EXPIRES&#39;&nbsp;=&gt;&nbsp;300,&nbsp;&nbsp;&nbsp;&nbsp;//key&nbsp;加密&nbsp;整型&nbsp;数字&nbsp;必须为&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;&#39;PASS_KEY_CALC&#39;&nbsp;=&gt;&nbsp;1314,);</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4、建oauth表。</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">SET&nbsp;FOREIGN_KEY_CHECKS=0;--&nbsp;------------------------------&nbsp;Table&nbsp;structure&nbsp;for&nbsp;oauth_client--&nbsp;----------------------------DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;`oauth_client`;CREATE&nbsp;TABLE&nbsp;`oauth_client`&nbsp;(
&nbsp;&nbsp;`id`&nbsp;bigint(20)&nbsp;NOT&nbsp;NULL&nbsp;AUTO_INCREMENT,
&nbsp;&nbsp;`client_id`&nbsp;varchar(32)&nbsp;NOT&nbsp;NULL,
&nbsp;&nbsp;`client_secret`&nbsp;varchar(32)&nbsp;NOT&nbsp;NULL,
&nbsp;&nbsp;`redirect_uri`&nbsp;varchar(200)&nbsp;NOT&nbsp;NULL,
&nbsp;&nbsp;`create_time`&nbsp;int(11)&nbsp;NOT&nbsp;NULL,&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(`id`))&nbsp;ENGINE=MyISAM&nbsp;AUTO_INCREMENT=3&nbsp;DEFAULT&nbsp;CHARSET=utf8;--&nbsp;------------------------------&nbsp;Table&nbsp;structure&nbsp;for&nbsp;oauth_code--&nbsp;----------------------------DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;`oauth_code`;CREATE&nbsp;TABLE&nbsp;`oauth_code`&nbsp;(
&nbsp;&nbsp;`id`&nbsp;bigint(20)&nbsp;NOT&nbsp;NULL&nbsp;AUTO_INCREMENT,
&nbsp;&nbsp;`client_id`&nbsp;varchar(32)&nbsp;NOT&nbsp;NULL,
&nbsp;&nbsp;`user_id`&nbsp;int(11)&nbsp;NOT&nbsp;NULL&nbsp;DEFAULT&nbsp;&#39;1&#39;,
&nbsp;&nbsp;`code`&nbsp;varchar(40)&nbsp;NOT&nbsp;NULL,
&nbsp;&nbsp;`redirect_uri`&nbsp;varchar(200)&nbsp;NOT&nbsp;NULL,
&nbsp;&nbsp;`expires`&nbsp;int(11)&nbsp;NOT&nbsp;NULL,
&nbsp;&nbsp;`scope`&nbsp;varchar(250)&nbsp;DEFAULT&nbsp;NULL,&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(`id`))&nbsp;ENGINE=MyISAM&nbsp;AUTO_INCREMENT=57&nbsp;DEFAULT&nbsp;CHARSET=utf8;

--&nbsp;----------------------------
--&nbsp;Table&nbsp;structure&nbsp;for&nbsp;oauth_token
--&nbsp;----------------------------
DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;`oauth_token`;
CREATE&nbsp;TABLE&nbsp;`oauth_token`&nbsp;(
&nbsp;&nbsp;`id`&nbsp;bigint(20)&nbsp;NOT&nbsp;NULL&nbsp;AUTO_INCREMENT,
&nbsp;&nbsp;`client_id`&nbsp;varchar(32)&nbsp;NOT&nbsp;NULL,
&nbsp;&nbsp;`user_id`&nbsp;int(11)&nbsp;NOT&nbsp;NULL,
&nbsp;&nbsp;`access_token`&nbsp;varchar(40)&nbsp;NOT&nbsp;NULL,
&nbsp;&nbsp;`refresh_token`&nbsp;varchar(40)&nbsp;NOT&nbsp;NULL,
&nbsp;&nbsp;`expires_in`&nbsp;int(11)&nbsp;NOT&nbsp;NULL,
&nbsp;&nbsp;`scope`&nbsp;varchar(200)&nbsp;DEFAULT&nbsp;NULL,
&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(`id`)
)&nbsp;ENGINE=MyISAM&nbsp;AUTO_INCREMENT=26&nbsp;DEFAULT&nbsp;CHARSET=utf8;</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5、引入oauth2.0服务端类文件。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-1、在\\server.ruanwenwu.cn\\ThinkPHP\\Library\\Vendor\\目录下建立oauth目录。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-2、引入oauth2.0服务端PHP脚本。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在刚建立的oauth目录下引入OAuth2.class.php这个文件基本不用做修改。我们的操作都在继承这个类的子类上完成。类的代码如下：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;?php/**&nbsp;*&nbsp;@mainpage&nbsp;*&nbsp;OAuth&nbsp;2.0&nbsp;server&nbsp;in&nbsp;PHP,&nbsp;originally&nbsp;written&nbsp;for&nbsp;*&nbsp;&lt;a&nbsp;href=&quot;http://www.opendining.net/&quot;&gt;&nbsp;Open&nbsp;Dining&lt;/a&gt;.&nbsp;Supports&nbsp;*&nbsp;&lt;a&nbsp;href=&quot;http://tools.ietf.org/html/draft-ietf-oauth-v2-10&quot;&gt;IETF&nbsp;draft&nbsp;v10&lt;/a&gt;.&nbsp;*&nbsp;*&nbsp;Source&nbsp;repo&nbsp;has&nbsp;sample&nbsp;servers&nbsp;implementations&nbsp;for&nbsp;*&nbsp;&lt;a&nbsp;href=&quot;http://php.net/manual/en/book.pdo.php&quot;&gt;&nbsp;PHP&nbsp;Data&nbsp;Objects&lt;/a&gt;&nbsp;and&nbsp;*&nbsp;&lt;a&nbsp;href=&quot;http://www.mongodb.org/&quot;&gt;MongoDB&lt;/a&gt;.&nbsp;Easily&nbsp;adaptable&nbsp;to&nbsp;other&nbsp;*&nbsp;storage&nbsp;engines.&nbsp;*&nbsp;*&nbsp;PHP&nbsp;Data&nbsp;Objects&nbsp;supports&nbsp;a&nbsp;variety&nbsp;of&nbsp;databases,&nbsp;including&nbsp;MySQL,&nbsp;*&nbsp;Microsoft&nbsp;SQL&nbsp;Server,&nbsp;SQLite,&nbsp;and&nbsp;Oracle,&nbsp;so&nbsp;you&nbsp;can&nbsp;try&nbsp;out&nbsp;the&nbsp;sample&nbsp;*&nbsp;to&nbsp;see&nbsp;how&nbsp;it&nbsp;all&nbsp;works.&nbsp;*&nbsp;*&nbsp;We&#39;re&nbsp;expanding&nbsp;the&nbsp;wiki&nbsp;to&nbsp;include&nbsp;more&nbsp;helpful&nbsp;documentation,&nbsp;but&nbsp;for&nbsp;*&nbsp;now,&nbsp;your&nbsp;best&nbsp;bet&nbsp;is&nbsp;to&nbsp;view&nbsp;the&nbsp;oauth.php&nbsp;source&nbsp;-&nbsp;it&nbsp;has&nbsp;lots&nbsp;of&nbsp;*&nbsp;comments.&nbsp;*&nbsp;*&nbsp;@author&nbsp;Tim&nbsp;Ridgely&nbsp;&lt;tim.ridgely@gmail.com&gt;&nbsp;*&nbsp;@author&nbsp;Aaron&nbsp;Parecki&nbsp;&lt;aaron@parecki.com&gt;&nbsp;*&nbsp;@author&nbsp;Edison&nbsp;Wong&nbsp;&lt;hswong3i@pantarei-design.com&gt;&nbsp;*&nbsp;*&nbsp;@see&nbsp;http://code.google.com/p/oauth2-php/&nbsp;*//**
&nbsp;*&nbsp;The&nbsp;default&nbsp;duration&nbsp;in&nbsp;seconds&nbsp;of&nbsp;the&nbsp;access&nbsp;token&nbsp;lifetime.
&nbsp;*/define(&quot;OAUTH2_DEFAULT_ACCESS_TOKEN_LIFETIME&quot;,&nbsp;3600);/**
&nbsp;*&nbsp;The&nbsp;default&nbsp;duration&nbsp;in&nbsp;seconds&nbsp;of&nbsp;the&nbsp;authorization&nbsp;code&nbsp;lifetime.
&nbsp;*/define(&quot;OAUTH2_DEFAULT_AUTH_CODE_LIFETIME&quot;,&nbsp;30);/**
&nbsp;*&nbsp;The&nbsp;default&nbsp;duration&nbsp;in&nbsp;seconds&nbsp;of&nbsp;the&nbsp;refresh&nbsp;token&nbsp;lifetime.
&nbsp;*/define(&quot;OAUTH2_DEFAULT_REFRESH_TOKEN_LIFETIME&quot;,&nbsp;1209600);/**
&nbsp;*&nbsp;@defgroup&nbsp;oauth2_section_2&nbsp;Client&nbsp;Credentials
&nbsp;*&nbsp;@{
&nbsp;*
&nbsp;*&nbsp;When&nbsp;interacting&nbsp;with&nbsp;the&nbsp;authorization&nbsp;server,&nbsp;the&nbsp;client&nbsp;identifies
&nbsp;*&nbsp;itself&nbsp;using&nbsp;a&nbsp;client&nbsp;identifier&nbsp;and&nbsp;authenticates&nbsp;using&nbsp;a&nbsp;set&nbsp;of
&nbsp;*&nbsp;client&nbsp;credentials.&nbsp;This&nbsp;specification&nbsp;provides&nbsp;one&nbsp;mechanism&nbsp;for
&nbsp;*&nbsp;authenticating&nbsp;the&nbsp;client&nbsp;using&nbsp;password&nbsp;credentials.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-2
&nbsp;*//**
&nbsp;*&nbsp;Regex&nbsp;to&nbsp;filter&nbsp;out&nbsp;the&nbsp;client&nbsp;identifier&nbsp;(described&nbsp;in&nbsp;Section&nbsp;2&nbsp;of&nbsp;IETF&nbsp;draft).
&nbsp;*
&nbsp;*&nbsp;IETF&nbsp;draft&nbsp;does&nbsp;not&nbsp;prescribe&nbsp;a&nbsp;format&nbsp;for&nbsp;these,&nbsp;however&nbsp;I&#39;ve&nbsp;arbitrarily
&nbsp;*&nbsp;chosen&nbsp;alphanumeric&nbsp;strings&nbsp;with&nbsp;hyphens&nbsp;and&nbsp;underscores,&nbsp;3-32&nbsp;characters
&nbsp;*&nbsp;long.
&nbsp;*
&nbsp;*&nbsp;Feel&nbsp;free&nbsp;to&nbsp;change.
&nbsp;*/define(&quot;OAUTH2_CLIENT_ID_REGEXP&quot;,&nbsp;&quot;/^[a-z0-9-_]{3,32}$/i&quot;);/**
&nbsp;*&nbsp;@}
&nbsp;*//**
&nbsp;*&nbsp;@defgroup&nbsp;oauth2_section_3&nbsp;Obtaining&nbsp;End-User&nbsp;Authorization
&nbsp;*&nbsp;@{
&nbsp;*
&nbsp;*&nbsp;When&nbsp;the&nbsp;client&nbsp;interacts&nbsp;with&nbsp;an&nbsp;end-user,&nbsp;the&nbsp;end-user&nbsp;MUST&nbsp;first
&nbsp;*&nbsp;grant&nbsp;the&nbsp;client&nbsp;authorization&nbsp;to&nbsp;access&nbsp;its&nbsp;protected&nbsp;resources.
&nbsp;*&nbsp;Once&nbsp;obtained,&nbsp;the&nbsp;end-user&nbsp;access&nbsp;grant&nbsp;is&nbsp;expressed&nbsp;as&nbsp;an
&nbsp;*&nbsp;authorization&nbsp;code&nbsp;which&nbsp;the&nbsp;client&nbsp;uses&nbsp;to&nbsp;obtain&nbsp;an&nbsp;access&nbsp;token.
&nbsp;*&nbsp;To&nbsp;obtain&nbsp;an&nbsp;end-user&nbsp;authorization,&nbsp;the&nbsp;client&nbsp;sends&nbsp;the&nbsp;end-user&nbsp;to
&nbsp;*&nbsp;the&nbsp;end-user&nbsp;authorization&nbsp;endpoint.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3
&nbsp;*//**
&nbsp;*&nbsp;Denotes&nbsp;&quot;token&quot;&nbsp;authorization&nbsp;response&nbsp;type.
&nbsp;*/define(&quot;OAUTH2_AUTH_RESPONSE_TYPE_ACCESS_TOKEN&quot;,&nbsp;&quot;token&quot;);/**
&nbsp;*&nbsp;Denotes&nbsp;&quot;code&quot;&nbsp;authorization&nbsp;response&nbsp;type.
&nbsp;*/define(&quot;OAUTH2_AUTH_RESPONSE_TYPE_AUTH_CODE&quot;,&nbsp;&quot;code&quot;);/**
&nbsp;*&nbsp;Denotes&nbsp;&quot;code-and-token&quot;&nbsp;authorization&nbsp;response&nbsp;type.
&nbsp;*/define(&quot;OAUTH2_AUTH_RESPONSE_TYPE_CODE_AND_TOKEN&quot;,&nbsp;&quot;code-and-token&quot;);/**
&nbsp;*&nbsp;Regex&nbsp;to&nbsp;filter&nbsp;out&nbsp;the&nbsp;authorization&nbsp;response&nbsp;type.
&nbsp;*/define(&quot;OAUTH2_AUTH_RESPONSE_TYPE_REGEXP&quot;,&nbsp;&quot;/^(token|code|code-and-token)$/&quot;);/**
&nbsp;*&nbsp;@}
&nbsp;*//**
&nbsp;*&nbsp;@defgroup&nbsp;oauth2_section_4&nbsp;Obtaining&nbsp;an&nbsp;Access&nbsp;Token
&nbsp;*&nbsp;@{
&nbsp;*
&nbsp;*&nbsp;The&nbsp;client&nbsp;obtains&nbsp;an&nbsp;access&nbsp;token&nbsp;by&nbsp;authenticating&nbsp;with&nbsp;the
&nbsp;*&nbsp;authorization&nbsp;server&nbsp;and&nbsp;presenting&nbsp;its&nbsp;access&nbsp;grant&nbsp;(in&nbsp;the&nbsp;form&nbsp;of
&nbsp;*&nbsp;an&nbsp;authorization&nbsp;code,&nbsp;resource&nbsp;owner&nbsp;credentials,&nbsp;an&nbsp;assertion,&nbsp;or&nbsp;a
&nbsp;*&nbsp;refresh&nbsp;token).
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4
&nbsp;*//**
&nbsp;*&nbsp;Denotes&nbsp;&quot;authorization_code&quot;&nbsp;grant&nbsp;types&nbsp;(for&nbsp;token&nbsp;obtaining).
&nbsp;*/define(&quot;OAUTH2_GRANT_TYPE_AUTH_CODE&quot;,&nbsp;&quot;authorization_code&quot;);

/**
&nbsp;*&nbsp;Denotes&nbsp;&quot;password&quot;&nbsp;grant&nbsp;types&nbsp;(for&nbsp;token&nbsp;obtaining).
&nbsp;*/
define(&quot;OAUTH2_GRANT_TYPE_USER_CREDENTIALS&quot;,&nbsp;&quot;password&quot;);

/**
&nbsp;*&nbsp;Denotes&nbsp;&quot;assertion&quot;&nbsp;grant&nbsp;types&nbsp;(for&nbsp;token&nbsp;obtaining).
&nbsp;*/
define(&quot;OAUTH2_GRANT_TYPE_ASSERTION&quot;,&nbsp;&quot;assertion&quot;);

/**
&nbsp;*&nbsp;Denotes&nbsp;&quot;refresh_token&quot;&nbsp;grant&nbsp;types&nbsp;(for&nbsp;token&nbsp;obtaining).
&nbsp;*/
define(&quot;OAUTH2_GRANT_TYPE_REFRESH_TOKEN&quot;,&nbsp;&quot;refresh_token&quot;);

/**
&nbsp;*&nbsp;Denotes&nbsp;&quot;none&quot;&nbsp;grant&nbsp;types&nbsp;(for&nbsp;token&nbsp;obtaining).
&nbsp;*/
define(&quot;OAUTH2_GRANT_TYPE_NONE&quot;,&nbsp;&quot;none&quot;);

/**
&nbsp;*&nbsp;Regex&nbsp;to&nbsp;filter&nbsp;out&nbsp;the&nbsp;grant&nbsp;type.
&nbsp;*/
define(&quot;OAUTH2_GRANT_TYPE_REGEXP&quot;,&nbsp;&quot;/^(authorization_code|password|assertion|refresh_token|none)$/&quot;);

/**
&nbsp;*&nbsp;@}
&nbsp;*/


/**
&nbsp;*&nbsp;@defgroup&nbsp;oauth2_section_5&nbsp;Accessing&nbsp;a&nbsp;Protected&nbsp;Resource
&nbsp;*&nbsp;@{
&nbsp;*
&nbsp;*&nbsp;Clients&nbsp;access&nbsp;protected&nbsp;resources&nbsp;by&nbsp;presenting&nbsp;an&nbsp;access&nbsp;token&nbsp;to
&nbsp;*&nbsp;the&nbsp;resource&nbsp;server.&nbsp;Access&nbsp;tokens&nbsp;act&nbsp;as&nbsp;bearer&nbsp;tokens,&nbsp;where&nbsp;the
&nbsp;*&nbsp;token&nbsp;string&nbsp;acts&nbsp;as&nbsp;a&nbsp;shared&nbsp;symmetric&nbsp;secret.&nbsp;This&nbsp;requires
&nbsp;*&nbsp;treating&nbsp;the&nbsp;access&nbsp;token&nbsp;with&nbsp;the&nbsp;same&nbsp;care&nbsp;as&nbsp;other&nbsp;secrets&nbsp;(e.g.
&nbsp;*&nbsp;end-user&nbsp;passwords).&nbsp;Access&nbsp;tokens&nbsp;SHOULD&nbsp;NOT&nbsp;be&nbsp;sent&nbsp;in&nbsp;the&nbsp;clear
&nbsp;*&nbsp;over&nbsp;an&nbsp;insecure&nbsp;channel.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5
&nbsp;*/

/**
&nbsp;*&nbsp;Used&nbsp;to&nbsp;define&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;OAuth&nbsp;access&nbsp;token&nbsp;parameter&nbsp;(POST/GET/etc.).
&nbsp;*
&nbsp;*&nbsp;IETF&nbsp;Draft&nbsp;sections&nbsp;5.1.2&nbsp;and&nbsp;5.1.3&nbsp;specify&nbsp;that&nbsp;it&nbsp;should&nbsp;be&nbsp;called
&nbsp;*&nbsp;&quot;oauth_token&quot;&nbsp;but&nbsp;other&nbsp;implementations&nbsp;use&nbsp;things&nbsp;like&nbsp;&quot;access_token&quot;.
&nbsp;*
&nbsp;*&nbsp;I&nbsp;won&#39;t&nbsp;be&nbsp;heartbroken&nbsp;if&nbsp;you&nbsp;change&nbsp;it,&nbsp;but&nbsp;it&nbsp;might&nbsp;be&nbsp;better&nbsp;to&nbsp;adhere
&nbsp;*&nbsp;to&nbsp;the&nbsp;spec.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.1.2
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.1.3
&nbsp;*/
define(&quot;OAUTH2_TOKEN_PARAM_NAME&quot;,&nbsp;&quot;oauth_token&quot;);

/**
&nbsp;*&nbsp;@}
&nbsp;*/


/**
&nbsp;*&nbsp;@defgroup&nbsp;oauth2_http_status&nbsp;HTTP&nbsp;status&nbsp;code
&nbsp;*&nbsp;@{
&nbsp;*/

/**
&nbsp;*&nbsp;&quot;Found&quot;&nbsp;HTTP&nbsp;status&nbsp;code.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3
&nbsp;*/
define(&quot;OAUTH2_HTTP_FOUND&quot;,&nbsp;&quot;302&nbsp;Found&quot;);

/**
&nbsp;*&nbsp;&quot;Bad&nbsp;Request&quot;&nbsp;HTTP&nbsp;status&nbsp;code.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2.1
&nbsp;*/
define(&quot;OAUTH2_HTTP_BAD_REQUEST&quot;,&nbsp;&quot;400&nbsp;Bad&nbsp;Request&quot;);

/**
&nbsp;*&nbsp;&quot;Unauthorized&quot;&nbsp;HTTP&nbsp;status&nbsp;code.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2.1
&nbsp;*/
define(&quot;OAUTH2_HTTP_UNAUTHORIZED&quot;,&nbsp;&quot;401&nbsp;Unauthorized&quot;);

/**
&nbsp;*&nbsp;&quot;Forbidden&quot;&nbsp;HTTP&nbsp;status&nbsp;code.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2.1
&nbsp;*/
define(&quot;OAUTH2_HTTP_FORBIDDEN&quot;,&nbsp;&quot;403&nbsp;Forbidden&quot;);

/**
&nbsp;*&nbsp;@}
&nbsp;*/


/**
&nbsp;*&nbsp;@defgroup&nbsp;oauth2_error&nbsp;Error&nbsp;handling
&nbsp;*&nbsp;@{
&nbsp;*
&nbsp;*&nbsp;@todo&nbsp;Extend&nbsp;for&nbsp;i18n.
&nbsp;*/

/**
&nbsp;*&nbsp;The&nbsp;request&nbsp;is&nbsp;missing&nbsp;a&nbsp;required&nbsp;parameter,&nbsp;includes&nbsp;an&nbsp;unsupported
&nbsp;*&nbsp;parameter&nbsp;or&nbsp;parameter&nbsp;value,&nbsp;or&nbsp;is&nbsp;otherwise&nbsp;malformed.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2.1
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3.1
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2.1
&nbsp;*/
define(&quot;OAUTH2_ERROR_INVALID_REQUEST&quot;,&nbsp;&quot;invalid_request&quot;);

/**
&nbsp;*&nbsp;The&nbsp;client&nbsp;identifier&nbsp;provided&nbsp;is&nbsp;invalid.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2.1
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3.1
&nbsp;*/
define(&quot;OAUTH2_ERROR_INVALID_CLIENT&quot;,&nbsp;&quot;invalid_client&quot;);

/**
&nbsp;*&nbsp;The&nbsp;client&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;use&nbsp;the&nbsp;requested&nbsp;response&nbsp;type.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2.1
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3.1
&nbsp;*/
define(&quot;OAUTH2_ERROR_UNAUTHORIZED_CLIENT&quot;,&nbsp;&quot;unauthorized_client&quot;);

/**
&nbsp;*&nbsp;The&nbsp;redirection&nbsp;URI&nbsp;provided&nbsp;does&nbsp;not&nbsp;match&nbsp;a&nbsp;pre-registered&nbsp;value.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2.1
&nbsp;*/
define(&quot;OAUTH2_ERROR_REDIRECT_URI_MISMATCH&quot;,&nbsp;&quot;redirect_uri_mismatch&quot;);

/**
&nbsp;*&nbsp;The&nbsp;end-user&nbsp;or&nbsp;authorization&nbsp;server&nbsp;denied&nbsp;the&nbsp;request.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2.1
&nbsp;*/
define(&quot;OAUTH2_ERROR_USER_DENIED&quot;,&nbsp;&quot;access_denied&quot;);

/**
&nbsp;*&nbsp;The&nbsp;requested&nbsp;response&nbsp;type&nbsp;is&nbsp;not&nbsp;supported&nbsp;by&nbsp;the&nbsp;authorization&nbsp;server.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2.1
&nbsp;*/
define(&quot;OAUTH2_ERROR_UNSUPPORTED_RESPONSE_TYPE&quot;,&nbsp;&quot;unsupported_response_type&quot;);

/**
&nbsp;*&nbsp;The&nbsp;requested&nbsp;scope&nbsp;is&nbsp;invalid,&nbsp;unknown,&nbsp;or&nbsp;malformed.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2.1
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3.1
&nbsp;*/
define(&quot;OAUTH2_ERROR_INVALID_SCOPE&quot;,&nbsp;&quot;invalid_scope&quot;);

/**
&nbsp;*&nbsp;The&nbsp;provided&nbsp;access&nbsp;grant&nbsp;is&nbsp;invalid,&nbsp;expired,&nbsp;or&nbsp;revoked&nbsp;(e.g.&nbsp;invalid
&nbsp;*&nbsp;assertion,&nbsp;expired&nbsp;authorization&nbsp;token,&nbsp;bad&nbsp;end-user&nbsp;password&nbsp;credentials,
&nbsp;*&nbsp;or&nbsp;mismatching&nbsp;authorization&nbsp;code&nbsp;and&nbsp;redirection&nbsp;URI).
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3.1
&nbsp;*/
define(&quot;OAUTH2_ERROR_INVALID_GRANT&quot;,&nbsp;&quot;invalid_grant&quot;);

/**
&nbsp;*&nbsp;The&nbsp;access&nbsp;grant&nbsp;included&nbsp;-&nbsp;its&nbsp;type&nbsp;or&nbsp;another&nbsp;attribute&nbsp;-&nbsp;is&nbsp;not
&nbsp;*&nbsp;supported&nbsp;by&nbsp;the&nbsp;authorization&nbsp;server.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3.1
&nbsp;*/
define(&quot;OAUTH2_ERROR_UNSUPPORTED_GRANT_TYPE&quot;,&nbsp;&quot;unsupported_grant_type&quot;);

/**
&nbsp;*&nbsp;The&nbsp;access&nbsp;token&nbsp;provided&nbsp;is&nbsp;invalid.&nbsp;Resource&nbsp;servers&nbsp;SHOULD&nbsp;use&nbsp;this
&nbsp;*&nbsp;error&nbsp;code&nbsp;when&nbsp;receiving&nbsp;an&nbsp;expired&nbsp;token&nbsp;which&nbsp;cannot&nbsp;be&nbsp;refreshed&nbsp;to
&nbsp;*&nbsp;indicate&nbsp;to&nbsp;the&nbsp;client&nbsp;that&nbsp;a&nbsp;new&nbsp;authorization&nbsp;is&nbsp;necessary.&nbsp;The&nbsp;resource
&nbsp;*&nbsp;server&nbsp;MUST&nbsp;respond&nbsp;with&nbsp;the&nbsp;HTTP&nbsp;401&nbsp;(Unauthorized)&nbsp;status&nbsp;code.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2.1
&nbsp;*/
define(&quot;OAUTH2_ERROR_INVALID_TOKEN&quot;,&nbsp;&quot;invalid_token&quot;);

/**
&nbsp;*&nbsp;The&nbsp;access&nbsp;token&nbsp;provided&nbsp;has&nbsp;expired.&nbsp;Resource&nbsp;servers&nbsp;SHOULD&nbsp;only&nbsp;use
&nbsp;*&nbsp;this&nbsp;error&nbsp;code&nbsp;when&nbsp;the&nbsp;client&nbsp;is&nbsp;expected&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;handle&nbsp;the
&nbsp;*&nbsp;response&nbsp;and&nbsp;request&nbsp;a&nbsp;new&nbsp;access&nbsp;token&nbsp;using&nbsp;the&nbsp;refresh&nbsp;token&nbsp;issued
&nbsp;*&nbsp;with&nbsp;the&nbsp;expired&nbsp;access&nbsp;token.&nbsp;The&nbsp;resource&nbsp;server&nbsp;MUST&nbsp;respond&nbsp;with&nbsp;the
&nbsp;*&nbsp;HTTP&nbsp;401&nbsp;(Unauthorized)&nbsp;status&nbsp;code.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2.1
&nbsp;*/
define(&quot;OAUTH2_ERROR_EXPIRED_TOKEN&quot;,&nbsp;&quot;expired_token&quot;);

/**
&nbsp;*&nbsp;The&nbsp;request&nbsp;requires&nbsp;higher&nbsp;privileges&nbsp;than&nbsp;provided&nbsp;by&nbsp;the&nbsp;access&nbsp;token.
&nbsp;*&nbsp;The&nbsp;resource&nbsp;server&nbsp;SHOULD&nbsp;respond&nbsp;with&nbsp;the&nbsp;HTTP&nbsp;403&nbsp;(Forbidden)&nbsp;status
&nbsp;*&nbsp;code&nbsp;and&nbsp;MAY&nbsp;include&nbsp;the&nbsp;&quot;scope&quot;&nbsp;attribute&nbsp;with&nbsp;the&nbsp;scope&nbsp;necessary&nbsp;to
&nbsp;*&nbsp;access&nbsp;the&nbsp;protected&nbsp;resource.
&nbsp;*
&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2.1
&nbsp;*/
define(&quot;OAUTH2_ERROR_INSUFFICIENT_SCOPE&quot;,&nbsp;&quot;insufficient_scope&quot;);

/**
&nbsp;*&nbsp;@}
&nbsp;*/

/**
&nbsp;*&nbsp;OAuth2.0&nbsp;draft&nbsp;v10&nbsp;server-side&nbsp;implementation.
&nbsp;*
&nbsp;*&nbsp;@author&nbsp;Originally&nbsp;written&nbsp;by&nbsp;Tim&nbsp;Ridgely&nbsp;&lt;tim.ridgely@gmail.com&gt;.
&nbsp;*&nbsp;@author&nbsp;Updated&nbsp;to&nbsp;draft&nbsp;v10&nbsp;by&nbsp;Aaron&nbsp;Parecki&nbsp;&lt;aaron@parecki.com&gt;.
&nbsp;*&nbsp;@author&nbsp;Debug,&nbsp;coding&nbsp;style&nbsp;clean&nbsp;up&nbsp;and&nbsp;documented&nbsp;by&nbsp;Edison&nbsp;Wong&nbsp;&lt;hswong3i@pantarei-design.com&gt;.
&nbsp;*/
abstract&nbsp;class&nbsp;OAuth2&nbsp;{

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Array&nbsp;of&nbsp;persistent&nbsp;variables&nbsp;stored.
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;$conf&nbsp;=&nbsp;array();

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;a&nbsp;persistent&nbsp;variable.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;To&nbsp;avoid&nbsp;problems,&nbsp;always&nbsp;use&nbsp;lower&nbsp;case&nbsp;for&nbsp;persistent&nbsp;variable&nbsp;names.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$name
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;variable&nbsp;to&nbsp;return.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$default
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;default&nbsp;value&nbsp;to&nbsp;use&nbsp;if&nbsp;this&nbsp;variable&nbsp;has&nbsp;never&nbsp;been&nbsp;set.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;value&nbsp;of&nbsp;the&nbsp;variable.
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;public&nbsp;function&nbsp;getVariable($name,&nbsp;$default&nbsp;=&nbsp;NULL)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;isset($this-&gt;conf[$name])&nbsp;?&nbsp;$this-&gt;conf[$name]&nbsp;:&nbsp;$default;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;a&nbsp;persistent&nbsp;variable.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;To&nbsp;avoid&nbsp;problems,&nbsp;always&nbsp;use&nbsp;lower&nbsp;case&nbsp;for&nbsp;persistent&nbsp;variable&nbsp;names.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$name
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;variable&nbsp;to&nbsp;set.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$value
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;value&nbsp;to&nbsp;set.
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;public&nbsp;function&nbsp;setVariable($name,&nbsp;$value)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;conf[$name]&nbsp;=&nbsp;$value;
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this;
&nbsp;&nbsp;}

&nbsp;&nbsp;//&nbsp;Subclasses&nbsp;must&nbsp;implement&nbsp;the&nbsp;following&nbsp;functions.

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Make&nbsp;sure&nbsp;that&nbsp;the&nbsp;client&nbsp;credentials&nbsp;is&nbsp;valid.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;check&nbsp;with.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_secret
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;If&nbsp;a&nbsp;secret&nbsp;is&nbsp;required,&nbsp;check&nbsp;that&nbsp;they&#39;ve&nbsp;given&nbsp;the&nbsp;right&nbsp;one.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;TRUE&nbsp;if&nbsp;client&nbsp;credentials&nbsp;are&nbsp;valid,&nbsp;and&nbsp;MUST&nbsp;return&nbsp;FALSE&nbsp;if&nbsp;invalid.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-2.1
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_2
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;abstract&nbsp;protected&nbsp;function&nbsp;checkClientCredentials($client_id,&nbsp;$client_secret&nbsp;=&nbsp;NULL);

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;the&nbsp;registered&nbsp;redirect&nbsp;URI&nbsp;of&nbsp;corresponding&nbsp;client_id.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;OAuth&nbsp;says&nbsp;we&nbsp;should&nbsp;store&nbsp;request&nbsp;URIs&nbsp;for&nbsp;each&nbsp;registered&nbsp;client.
&nbsp;&nbsp;&nbsp;*&nbsp;Implement&nbsp;this&nbsp;function&nbsp;to&nbsp;grab&nbsp;the&nbsp;stored&nbsp;URI&nbsp;for&nbsp;a&nbsp;given&nbsp;client&nbsp;id.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;check&nbsp;with.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Registered&nbsp;redirect&nbsp;URI&nbsp;of&nbsp;corresponding&nbsp;client&nbsp;identifier,&nbsp;and&nbsp;MUST
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;return&nbsp;FALSE&nbsp;if&nbsp;the&nbsp;given&nbsp;client&nbsp;does&nbsp;not&nbsp;exist&nbsp;or&nbsp;is&nbsp;invalid.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;abstract&nbsp;protected&nbsp;function&nbsp;getRedirectUri($client_id);

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Look&nbsp;up&nbsp;the&nbsp;supplied&nbsp;oauth_token&nbsp;from&nbsp;storage.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;We&nbsp;need&nbsp;to&nbsp;retrieve&nbsp;access&nbsp;token&nbsp;data&nbsp;as&nbsp;we&nbsp;create&nbsp;and&nbsp;verify&nbsp;tokens.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$oauth_token
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;oauth_token&nbsp;to&nbsp;be&nbsp;check&nbsp;with.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;associative&nbsp;array&nbsp;as&nbsp;below,&nbsp;and&nbsp;return&nbsp;NULL&nbsp;if&nbsp;the&nbsp;supplied&nbsp;oauth_token
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;is&nbsp;invalid:
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;client_id:&nbsp;Stored&nbsp;client&nbsp;identifier.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;expires:&nbsp;Stored&nbsp;expiration&nbsp;in&nbsp;unix&nbsp;timestamp.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;scope:&nbsp;(optional)&nbsp;Stored&nbsp;scope&nbsp;values&nbsp;in&nbsp;space-separated&nbsp;string.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_5
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;abstract&nbsp;protected&nbsp;function&nbsp;getAccessToken($oauth_token);

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Store&nbsp;the&nbsp;supplied&nbsp;access&nbsp;token&nbsp;values&nbsp;to&nbsp;storage.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;We&nbsp;need&nbsp;to&nbsp;store&nbsp;access&nbsp;token&nbsp;data&nbsp;as&nbsp;we&nbsp;create&nbsp;and&nbsp;verify&nbsp;tokens.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$oauth_token
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;oauth_token&nbsp;to&nbsp;be&nbsp;stored.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;stored.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$expires
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Expiration&nbsp;to&nbsp;be&nbsp;stored.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$user_id
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;User&nbsp;ID
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$scope
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;Scopes&nbsp;to&nbsp;be&nbsp;stored&nbsp;in&nbsp;space-separated&nbsp;string.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;abstract&nbsp;protected&nbsp;function&nbsp;setAccessToken($oauth_token,&nbsp;$client_id,&nbsp;$expires,&nbsp;$user_id,&nbsp;$scope=NULL,&nbsp;$refresh_token=&#39;&#39;);

&nbsp;&nbsp;//&nbsp;Stuff&nbsp;that&nbsp;should&nbsp;get&nbsp;overridden&nbsp;by&nbsp;subclasses.
&nbsp;&nbsp;//
&nbsp;&nbsp;//&nbsp;I&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;make&nbsp;these&nbsp;abstract,&nbsp;because&nbsp;then&nbsp;subclasses&nbsp;would&nbsp;have
&nbsp;&nbsp;//&nbsp;to&nbsp;implement&nbsp;all&nbsp;of&nbsp;them,&nbsp;which&nbsp;is&nbsp;too&nbsp;much&nbsp;work.
&nbsp;&nbsp;//
&nbsp;&nbsp;//&nbsp;So&nbsp;they&#39;re&nbsp;just&nbsp;stubs.&nbsp;Override&nbsp;the&nbsp;ones&nbsp;you&nbsp;need.

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Return&nbsp;supported&nbsp;grant&nbsp;types.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;You&nbsp;should&nbsp;override&nbsp;this&nbsp;function&nbsp;with&nbsp;something,&nbsp;or&nbsp;else&nbsp;your&nbsp;OAuth
&nbsp;&nbsp;&nbsp;*&nbsp;provider&nbsp;won&#39;t&nbsp;support&nbsp;any&nbsp;grant&nbsp;types!
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;list&nbsp;as&nbsp;below.&nbsp;If&nbsp;you&nbsp;support&nbsp;all&nbsp;grant&nbsp;types,&nbsp;then&nbsp;you&#39;d&nbsp;do:
&nbsp;&nbsp;&nbsp;*&nbsp;@code
&nbsp;&nbsp;&nbsp;*&nbsp;return&nbsp;array(
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_GRANT_TYPE_AUTH_CODE,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_GRANT_TYPE_USER_CREDENTIALS,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_GRANT_TYPE_ASSERTION,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_GRANT_TYPE_REFRESH_TOKEN,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_GRANT_TYPE_NONE,
&nbsp;&nbsp;&nbsp;*&nbsp;);
&nbsp;&nbsp;&nbsp;*&nbsp;@endcode
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;getSupportedGrantTypes()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array();
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Return&nbsp;supported&nbsp;authorization&nbsp;response&nbsp;types.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;You&nbsp;should&nbsp;override&nbsp;this&nbsp;function&nbsp;with&nbsp;your&nbsp;supported&nbsp;response&nbsp;types.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;list&nbsp;as&nbsp;below.&nbsp;If&nbsp;you&nbsp;support&nbsp;all&nbsp;authorization&nbsp;response&nbsp;types,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;then&nbsp;you&#39;d&nbsp;do:
&nbsp;&nbsp;&nbsp;*&nbsp;@code
&nbsp;&nbsp;&nbsp;*&nbsp;return&nbsp;array(
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_AUTH_CODE,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_ACCESS_TOKEN,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_CODE_AND_TOKEN,
&nbsp;&nbsp;&nbsp;*&nbsp;);
&nbsp;&nbsp;&nbsp;*&nbsp;@endcode
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;getSupportedAuthResponseTypes()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_AUTH_CODE,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_ACCESS_TOKEN,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_CODE_AND_TOKEN
&nbsp;&nbsp;&nbsp;&nbsp;);
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Return&nbsp;supported&nbsp;scopes.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;you&nbsp;want&nbsp;to&nbsp;support&nbsp;scope&nbsp;use,&nbsp;then&nbsp;have&nbsp;this&nbsp;function&nbsp;return&nbsp;a&nbsp;list
&nbsp;&nbsp;&nbsp;*&nbsp;of&nbsp;all&nbsp;acceptable&nbsp;scopes&nbsp;(used&nbsp;to&nbsp;throw&nbsp;the&nbsp;invalid-scope&nbsp;error).
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;list&nbsp;as&nbsp;below,&nbsp;for&nbsp;example:
&nbsp;&nbsp;&nbsp;*&nbsp;@code
&nbsp;&nbsp;&nbsp;*&nbsp;return&nbsp;array(
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&#39;my-friends&#39;,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&#39;photos&#39;,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&#39;whatever-else&#39;,
&nbsp;&nbsp;&nbsp;*&nbsp;);
&nbsp;&nbsp;&nbsp;*&nbsp;@endcode
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;getSupportedScopes()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array();
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Check&nbsp;restricted&nbsp;authorization&nbsp;response&nbsp;types&nbsp;of&nbsp;corresponding&nbsp;Client
&nbsp;&nbsp;&nbsp;*&nbsp;identifier.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;you&nbsp;want&nbsp;to&nbsp;restrict&nbsp;clients&nbsp;to&nbsp;certain&nbsp;authorization&nbsp;response&nbsp;types,
&nbsp;&nbsp;&nbsp;*&nbsp;override&nbsp;this&nbsp;function.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;check&nbsp;with.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$response_type
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Authorization&nbsp;response&nbsp;type&nbsp;to&nbsp;be&nbsp;check&nbsp;with,&nbsp;would&nbsp;be&nbsp;one&nbsp;of&nbsp;the
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;values&nbsp;contained&nbsp;in&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_REGEXP.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;TRUE&nbsp;if&nbsp;the&nbsp;authorization&nbsp;response&nbsp;type&nbsp;is&nbsp;supported&nbsp;by&nbsp;this
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;client&nbsp;identifier,&nbsp;and&nbsp;FALSE&nbsp;if&nbsp;it&nbsp;isn&#39;t.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;checkRestrictedAuthResponseType($client_id,&nbsp;$response_type)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Check&nbsp;restricted&nbsp;grant&nbsp;types&nbsp;of&nbsp;corresponding&nbsp;client&nbsp;identifier.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;you&nbsp;want&nbsp;to&nbsp;restrict&nbsp;clients&nbsp;to&nbsp;certain&nbsp;grant&nbsp;types,&nbsp;override&nbsp;this
&nbsp;&nbsp;&nbsp;*&nbsp;function.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;check&nbsp;with.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$grant_type
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Grant&nbsp;type&nbsp;to&nbsp;be&nbsp;check&nbsp;with,&nbsp;would&nbsp;be&nbsp;one&nbsp;of&nbsp;the&nbsp;values&nbsp;contained&nbsp;in
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_GRANT_TYPE_REGEXP.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;TRUE&nbsp;if&nbsp;the&nbsp;grant&nbsp;type&nbsp;is&nbsp;supported&nbsp;by&nbsp;this&nbsp;client&nbsp;identifier,&nbsp;and
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;FALSE&nbsp;if&nbsp;it&nbsp;isn&#39;t.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;checkRestrictedGrantType($client_id,&nbsp;$grant_type)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;
&nbsp;&nbsp;}

&nbsp;&nbsp;//&nbsp;Functions&nbsp;that&nbsp;help&nbsp;grant&nbsp;access&nbsp;tokens&nbsp;for&nbsp;various&nbsp;grant&nbsp;types.

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Fetch&nbsp;authorization&nbsp;code&nbsp;data&nbsp;(probably&nbsp;the&nbsp;most&nbsp;common&nbsp;grant&nbsp;type).
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Retrieve&nbsp;the&nbsp;stored&nbsp;data&nbsp;for&nbsp;the&nbsp;given&nbsp;authorization&nbsp;code.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Required&nbsp;for&nbsp;OAUTH2_GRANT_TYPE_AUTH_CODE.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$code
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Authorization&nbsp;code&nbsp;to&nbsp;be&nbsp;check&nbsp;with.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;associative&nbsp;array&nbsp;as&nbsp;below,&nbsp;and&nbsp;NULL&nbsp;if&nbsp;the&nbsp;code&nbsp;is&nbsp;invalid:
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;client_id:&nbsp;Stored&nbsp;client&nbsp;identifier.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;redirect_uri:&nbsp;Stored&nbsp;redirect&nbsp;URI.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;expires:&nbsp;Stored&nbsp;expiration&nbsp;in&nbsp;unix&nbsp;timestamp.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;scope:&nbsp;(optional)&nbsp;Stored&nbsp;scope&nbsp;values&nbsp;in&nbsp;space-separated&nbsp;string.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.1.1
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;getAuthCode($code)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Take&nbsp;the&nbsp;provided&nbsp;authorization&nbsp;code&nbsp;values&nbsp;and&nbsp;store&nbsp;them&nbsp;somewhere.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;function&nbsp;should&nbsp;be&nbsp;the&nbsp;storage&nbsp;counterpart&nbsp;to&nbsp;getAuthCode().
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;storage&nbsp;fails&nbsp;for&nbsp;some&nbsp;reason,&nbsp;we&#39;re&nbsp;not&nbsp;currently&nbsp;checking&nbsp;for
&nbsp;&nbsp;&nbsp;*&nbsp;any&nbsp;sort&nbsp;of&nbsp;success/failure,&nbsp;so&nbsp;you&nbsp;should&nbsp;bail&nbsp;out&nbsp;of&nbsp;the&nbsp;script
&nbsp;&nbsp;&nbsp;*&nbsp;and&nbsp;provide&nbsp;a&nbsp;descriptive&nbsp;fail&nbsp;message.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Required&nbsp;for&nbsp;OAUTH2_GRANT_TYPE_AUTH_CODE.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$code
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Authorization&nbsp;code&nbsp;to&nbsp;be&nbsp;stored.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;stored.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$redirect_uri
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Redirect&nbsp;URI&nbsp;to&nbsp;be&nbsp;stored.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$expires
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Expiration&nbsp;to&nbsp;be&nbsp;stored.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$scope
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;Scopes&nbsp;to&nbsp;be&nbsp;stored&nbsp;in&nbsp;space-separated&nbsp;string.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;setAuthCode($code,&nbsp;$client_id,&nbsp;$redirect_uri,&nbsp;$expires,&nbsp;$userId,&nbsp;$scope&nbsp;=&nbsp;NULL)&nbsp;{
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Grant&nbsp;access&nbsp;tokens&nbsp;for&nbsp;basic&nbsp;user&nbsp;credentials.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Check&nbsp;the&nbsp;supplied&nbsp;username&nbsp;and&nbsp;password&nbsp;for&nbsp;validity.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;You&nbsp;can&nbsp;also&nbsp;use&nbsp;the&nbsp;$client_id&nbsp;param&nbsp;to&nbsp;do&nbsp;any&nbsp;checks&nbsp;required&nbsp;based
&nbsp;&nbsp;&nbsp;*&nbsp;on&nbsp;a&nbsp;client,&nbsp;if&nbsp;you&nbsp;need&nbsp;that.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Required&nbsp;for&nbsp;OAUTH2_GRANT_TYPE_USER_CREDENTIALS.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;check&nbsp;with.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$username
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Username&nbsp;to&nbsp;be&nbsp;check&nbsp;with.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$password
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Password&nbsp;to&nbsp;be&nbsp;check&nbsp;with.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;TRUE&nbsp;if&nbsp;the&nbsp;username&nbsp;and&nbsp;password&nbsp;are&nbsp;valid,&nbsp;and&nbsp;FALSE&nbsp;if&nbsp;it&nbsp;isn&#39;t.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Moreover,&nbsp;if&nbsp;the&nbsp;username&nbsp;and&nbsp;password&nbsp;are&nbsp;valid,&nbsp;and&nbsp;you&nbsp;want&nbsp;to
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;verify&nbsp;the&nbsp;scope&nbsp;of&nbsp;a&nbsp;user&#39;s&nbsp;access,&nbsp;return&nbsp;an&nbsp;associative&nbsp;array
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;with&nbsp;the&nbsp;scope&nbsp;values&nbsp;as&nbsp;below.&nbsp;We&#39;ll&nbsp;check&nbsp;the&nbsp;scope&nbsp;you&nbsp;provide
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;against&nbsp;the&nbsp;requested&nbsp;scope&nbsp;before&nbsp;providing&nbsp;an&nbsp;access&nbsp;token:
&nbsp;&nbsp;&nbsp;*&nbsp;@code
&nbsp;&nbsp;&nbsp;*&nbsp;return&nbsp;array(
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&#39;scope&#39;&nbsp;=&gt;&nbsp;&lt;stored&nbsp;scope&nbsp;values&nbsp;(space-separated&nbsp;string)&gt;,
&nbsp;&nbsp;&nbsp;*&nbsp;);
&nbsp;&nbsp;&nbsp;*&nbsp;@endcode
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.1.2
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;checkUserCredentials($client_id,&nbsp;$username,&nbsp;$password)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Grant&nbsp;access&nbsp;tokens&nbsp;for&nbsp;assertions.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Check&nbsp;the&nbsp;supplied&nbsp;assertion&nbsp;for&nbsp;validity.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;You&nbsp;can&nbsp;also&nbsp;use&nbsp;the&nbsp;$client_id&nbsp;param&nbsp;to&nbsp;do&nbsp;any&nbsp;checks&nbsp;required&nbsp;based
&nbsp;&nbsp;&nbsp;*&nbsp;on&nbsp;a&nbsp;client,&nbsp;if&nbsp;you&nbsp;need&nbsp;that.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Required&nbsp;for&nbsp;OAUTH2_GRANT_TYPE_ASSERTION.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;check&nbsp;with.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$assertion_type
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;format&nbsp;of&nbsp;the&nbsp;assertion&nbsp;as&nbsp;defined&nbsp;by&nbsp;the&nbsp;authorization&nbsp;server.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$assertion
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;assertion.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;TRUE&nbsp;if&nbsp;the&nbsp;assertion&nbsp;is&nbsp;valid,&nbsp;and&nbsp;FALSE&nbsp;if&nbsp;it&nbsp;isn&#39;t.&nbsp;Moreover,&nbsp;if
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;the&nbsp;assertion&nbsp;is&nbsp;valid,&nbsp;and&nbsp;you&nbsp;want&nbsp;to&nbsp;verify&nbsp;the&nbsp;scope&nbsp;of&nbsp;an&nbsp;access
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;request,&nbsp;return&nbsp;an&nbsp;associative&nbsp;array&nbsp;with&nbsp;the&nbsp;scope&nbsp;values&nbsp;as&nbsp;below.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;We&#39;ll&nbsp;check&nbsp;the&nbsp;scope&nbsp;you&nbsp;provide&nbsp;against&nbsp;the&nbsp;requested&nbsp;scope&nbsp;before
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;providing&nbsp;an&nbsp;access&nbsp;token:
&nbsp;&nbsp;&nbsp;*&nbsp;@code
&nbsp;&nbsp;&nbsp;*&nbsp;return&nbsp;array(
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&#39;scope&#39;&nbsp;=&gt;&nbsp;&lt;stored&nbsp;scope&nbsp;values&nbsp;(space-separated&nbsp;string)&gt;,
&nbsp;&nbsp;&nbsp;*&nbsp;);
&nbsp;&nbsp;&nbsp;*&nbsp;@endcode
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.1.3
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;checkAssertion($client_id,&nbsp;$assertion_type,&nbsp;$assertion)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Grant&nbsp;refresh&nbsp;access&nbsp;tokens.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Retrieve&nbsp;the&nbsp;stored&nbsp;data&nbsp;for&nbsp;the&nbsp;given&nbsp;refresh&nbsp;token.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Required&nbsp;for&nbsp;OAUTH2_GRANT_TYPE_REFRESH_TOKEN.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$refresh_token
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Refresh&nbsp;token&nbsp;to&nbsp;be&nbsp;check&nbsp;with.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;associative&nbsp;array&nbsp;as&nbsp;below,&nbsp;and&nbsp;NULL&nbsp;if&nbsp;the&nbsp;refresh_token&nbsp;is
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;invalid:
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;client_id:&nbsp;Stored&nbsp;client&nbsp;identifier.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;expires:&nbsp;Stored&nbsp;expiration&nbsp;unix&nbsp;timestamp.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;scope:&nbsp;(optional)&nbsp;Stored&nbsp;scope&nbsp;values&nbsp;in&nbsp;space-separated&nbsp;string.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.1.4
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;getRefreshToken($refresh_token)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Take&nbsp;the&nbsp;provided&nbsp;refresh&nbsp;token&nbsp;values&nbsp;and&nbsp;store&nbsp;them&nbsp;somewhere.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;function&nbsp;should&nbsp;be&nbsp;the&nbsp;storage&nbsp;counterpart&nbsp;to&nbsp;getRefreshToken().
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;storage&nbsp;fails&nbsp;for&nbsp;some&nbsp;reason,&nbsp;we&#39;re&nbsp;not&nbsp;currently&nbsp;checking&nbsp;for
&nbsp;&nbsp;&nbsp;*&nbsp;any&nbsp;sort&nbsp;of&nbsp;success/failure,&nbsp;so&nbsp;you&nbsp;should&nbsp;bail&nbsp;out&nbsp;of&nbsp;the&nbsp;script
&nbsp;&nbsp;&nbsp;*&nbsp;and&nbsp;provide&nbsp;a&nbsp;descriptive&nbsp;fail&nbsp;message.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Required&nbsp;for&nbsp;OAUTH2_GRANT_TYPE_REFRESH_TOKEN.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$refresh_token
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Refresh&nbsp;token&nbsp;to&nbsp;be&nbsp;stored.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;stored.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$expires
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;expires&nbsp;to&nbsp;be&nbsp;stored.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$scope
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;Scopes&nbsp;to&nbsp;be&nbsp;stored&nbsp;in&nbsp;space-separated&nbsp;string.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;setRefreshToken($refresh_token,&nbsp;$client_id,&nbsp;$expires,&nbsp;$scope&nbsp;=&nbsp;NULL)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Expire&nbsp;a&nbsp;used&nbsp;refresh&nbsp;token.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;is&nbsp;not&nbsp;explicitly&nbsp;required&nbsp;in&nbsp;the&nbsp;spec,&nbsp;but&nbsp;is&nbsp;almost&nbsp;implied.
&nbsp;&nbsp;&nbsp;*&nbsp;After&nbsp;granting&nbsp;a&nbsp;new&nbsp;refresh&nbsp;token,&nbsp;the&nbsp;old&nbsp;one&nbsp;is&nbsp;no&nbsp;longer&nbsp;useful&nbsp;and
&nbsp;&nbsp;&nbsp;*&nbsp;so&nbsp;should&nbsp;be&nbsp;forcibly&nbsp;expired&nbsp;in&nbsp;the&nbsp;data&nbsp;store&nbsp;so&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;used&nbsp;again.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;storage&nbsp;fails&nbsp;for&nbsp;some&nbsp;reason,&nbsp;we&#39;re&nbsp;not&nbsp;currently&nbsp;checking&nbsp;for
&nbsp;&nbsp;&nbsp;*&nbsp;any&nbsp;sort&nbsp;of&nbsp;success/failure,&nbsp;so&nbsp;you&nbsp;should&nbsp;bail&nbsp;out&nbsp;of&nbsp;the&nbsp;script
&nbsp;&nbsp;&nbsp;*&nbsp;and&nbsp;provide&nbsp;a&nbsp;descriptive&nbsp;fail&nbsp;message.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$refresh_token
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Refresh&nbsp;token&nbsp;to&nbsp;be&nbsp;expirse.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;unsetRefreshToken($refresh_token)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Grant&nbsp;access&nbsp;tokens&nbsp;for&nbsp;the&nbsp;&quot;none&quot;&nbsp;grant&nbsp;type.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Not&nbsp;really&nbsp;described&nbsp;in&nbsp;the&nbsp;IETF&nbsp;Draft,&nbsp;so&nbsp;I&nbsp;just&nbsp;left&nbsp;a&nbsp;method
&nbsp;&nbsp;&nbsp;*&nbsp;stub...&nbsp;Do&nbsp;whatever&nbsp;you&nbsp;want!
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Required&nbsp;for&nbsp;OAUTH2_GRANT_TYPE_NONE.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;checkNoneAccess($client_id)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;default&nbsp;authentication&nbsp;realm&nbsp;for&nbsp;WWW-Authenticate&nbsp;header.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Change&nbsp;this&nbsp;to&nbsp;whatever&nbsp;authentication&nbsp;realm&nbsp;you&nbsp;want&nbsp;to&nbsp;send&nbsp;in&nbsp;a
&nbsp;&nbsp;&nbsp;*&nbsp;WWW-Authenticate&nbsp;header.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;string&nbsp;that&nbsp;you&nbsp;want&nbsp;to&nbsp;send&nbsp;in&nbsp;a&nbsp;WWW-Authenticate&nbsp;header.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_error
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;getDefaultAuthenticationRealm()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&quot;Service&quot;;
&nbsp;&nbsp;}

&nbsp;&nbsp;//&nbsp;End&nbsp;stuff&nbsp;that&nbsp;should&nbsp;get&nbsp;overridden.

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Creates&nbsp;an&nbsp;OAuth2.0&nbsp;server-side&nbsp;instance.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$config
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;associative&nbsp;array&nbsp;as&nbsp;below:
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;access_token_lifetime:&nbsp;(optional)&nbsp;The&nbsp;lifetime&nbsp;of&nbsp;access&nbsp;token&nbsp;in
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seconds.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;auth_code_lifetime:&nbsp;(optional)&nbsp;The&nbsp;lifetime&nbsp;of&nbsp;authorization&nbsp;code&nbsp;in
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seconds.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;refresh_token_lifetime:&nbsp;(optional)&nbsp;The&nbsp;lifetime&nbsp;of&nbsp;refresh&nbsp;token&nbsp;in
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seconds.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;display_error:&nbsp;(optional)&nbsp;Whether&nbsp;to&nbsp;show&nbsp;verbose&nbsp;error&nbsp;messages&nbsp;in
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;response.
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;public&nbsp;function&nbsp;__construct($config&nbsp;=&nbsp;array())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($config&nbsp;as&nbsp;$name&nbsp;=&gt;&nbsp;$value)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;setVariable($name,&nbsp;$value);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}

&nbsp;&nbsp;//&nbsp;Resource&nbsp;protecting&nbsp;(Section&nbsp;5).

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Check&nbsp;that&nbsp;a&nbsp;valid&nbsp;access&nbsp;token&nbsp;has&nbsp;been&nbsp;provided.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;scope&nbsp;parameter&nbsp;defines&nbsp;any&nbsp;required&nbsp;scope&nbsp;that&nbsp;the&nbsp;token&nbsp;must&nbsp;have.
&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;a&nbsp;scope&nbsp;param&nbsp;is&nbsp;provided&nbsp;and&nbsp;the&nbsp;token&nbsp;does&nbsp;not&nbsp;have&nbsp;the&nbsp;required
&nbsp;&nbsp;&nbsp;*&nbsp;scope,&nbsp;we&nbsp;bounce&nbsp;the&nbsp;request.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Some&nbsp;implementations&nbsp;may&nbsp;choose&nbsp;to&nbsp;return&nbsp;a&nbsp;subset&nbsp;of&nbsp;the&nbsp;protected
&nbsp;&nbsp;&nbsp;*&nbsp;resource&nbsp;(i.e.&nbsp;&quot;public&quot;&nbsp;data)&nbsp;if&nbsp;the&nbsp;user&nbsp;has&nbsp;not&nbsp;provided&nbsp;an&nbsp;access
&nbsp;&nbsp;&nbsp;*&nbsp;token&nbsp;or&nbsp;if&nbsp;the&nbsp;access&nbsp;token&nbsp;is&nbsp;invalid&nbsp;or&nbsp;expired.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;IETF&nbsp;spec&nbsp;says&nbsp;that&nbsp;we&nbsp;should&nbsp;send&nbsp;a&nbsp;401&nbsp;Unauthorized&nbsp;header&nbsp;and
&nbsp;&nbsp;&nbsp;*&nbsp;bail&nbsp;immediately&nbsp;so&nbsp;that&#39;s&nbsp;what&nbsp;the&nbsp;defaults&nbsp;are&nbsp;set&nbsp;to.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$scope
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;space-separated&nbsp;string&nbsp;of&nbsp;required&nbsp;scope(s),&nbsp;if&nbsp;you&nbsp;want&nbsp;to&nbsp;check
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;for&nbsp;scope.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$exit_not_present
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;If&nbsp;TRUE&nbsp;and&nbsp;no&nbsp;access&nbsp;token&nbsp;is&nbsp;provided,&nbsp;send&nbsp;a&nbsp;401&nbsp;header&nbsp;and&nbsp;exit,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;otherwise&nbsp;return&nbsp;FALSE.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$exit_invalid
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;If&nbsp;TRUE&nbsp;and&nbsp;the&nbsp;implementation&nbsp;of&nbsp;getAccessToken()&nbsp;returns&nbsp;NULL,&nbsp;exit,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;otherwise&nbsp;return&nbsp;FALSE.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$exit_expired
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;If&nbsp;TRUE&nbsp;and&nbsp;the&nbsp;access&nbsp;token&nbsp;has&nbsp;expired,&nbsp;exit,&nbsp;otherwise&nbsp;return&nbsp;FALSE.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$exit_scope
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;If&nbsp;TRUE&nbsp;the&nbsp;access&nbsp;token&nbsp;does&nbsp;not&nbsp;have&nbsp;the&nbsp;required&nbsp;scope(s),&nbsp;exit,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;otherwise&nbsp;return&nbsp;FALSE.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$realm
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;If&nbsp;you&nbsp;want&nbsp;to&nbsp;specify&nbsp;a&nbsp;particular&nbsp;realm&nbsp;for&nbsp;the&nbsp;WWW-Authenticate
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;header,&nbsp;supply&nbsp;it&nbsp;here.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_5
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;public&nbsp;function&nbsp;verifyAccessToken($scope&nbsp;=&nbsp;NULL,&nbsp;$exit_not_present&nbsp;=&nbsp;TRUE,&nbsp;$exit_invalid&nbsp;=&nbsp;TRUE,&nbsp;$exit_expired&nbsp;=&nbsp;TRUE,&nbsp;$exit_scope&nbsp;=&nbsp;TRUE,&nbsp;$realm&nbsp;=&nbsp;NULL)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;$token_param&nbsp;=&nbsp;$this-&gt;getAccessTokenParams();
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($token_param&nbsp;===&nbsp;FALSE)&nbsp;//&nbsp;Access&nbsp;token&nbsp;was&nbsp;not&nbsp;provided
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$exit_not_present&nbsp;?&nbsp;$this-&gt;errorWWWAuthenticateResponseHeader(OAUTH2_HTTP_BAD_REQUEST,&nbsp;$realm,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;The&nbsp;request&nbsp;is&nbsp;missing&nbsp;a&nbsp;required&nbsp;parameter,&nbsp;includes&nbsp;an&nbsp;unsupported&nbsp;parameter&nbsp;or&nbsp;parameter&nbsp;value,&nbsp;repeats&nbsp;the&nbsp;same&nbsp;parameter,&nbsp;uses&nbsp;more&nbsp;than&nbsp;one&nbsp;method&nbsp;for&nbsp;including&nbsp;an&nbsp;access&nbsp;token,&nbsp;or&nbsp;is&nbsp;otherwise&nbsp;malformed.&#39;,&nbsp;NULL,&nbsp;$scope)&nbsp;:&nbsp;FALSE;
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Get&nbsp;the&nbsp;stored&nbsp;token&nbsp;data&nbsp;(from&nbsp;the&nbsp;implementing&nbsp;subclass)
&nbsp;&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;$this-&gt;getAccessToken($token_param);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($token&nbsp;===&nbsp;NULL)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$exit_invalid&nbsp;?&nbsp;$this-&gt;errorWWWAuthenticateResponseHeader(OAUTH2_HTTP_UNAUTHORIZED,&nbsp;$realm,&nbsp;OAUTH2_ERROR_INVALID_TOKEN,&nbsp;&#39;The&nbsp;access&nbsp;token&nbsp;provided&nbsp;is&nbsp;invalid.&#39;,&nbsp;NULL,&nbsp;$scope)&nbsp;:&nbsp;FALSE;

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;token&nbsp;expiration&nbsp;(I&#39;m&nbsp;leaving&nbsp;this&nbsp;check&nbsp;separated,&nbsp;later&nbsp;we&#39;ll&nbsp;fill&nbsp;in&nbsp;better&nbsp;error&nbsp;messages)
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($token[&quot;expires&quot;])&nbsp;&amp;&amp;&nbsp;time()&nbsp;&gt;&nbsp;$token[&quot;expires&quot;])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$exit_expired&nbsp;?&nbsp;$this-&gt;errorWWWAuthenticateResponseHeader(OAUTH2_HTTP_UNAUTHORIZED,&nbsp;$realm,&nbsp;OAUTH2_ERROR_EXPIRED_TOKEN,&nbsp;&#39;The&nbsp;access&nbsp;token&nbsp;provided&nbsp;has&nbsp;expired.&#39;,&nbsp;NULL,&nbsp;$scope)&nbsp;:&nbsp;FALSE;

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;scope,&nbsp;if&nbsp;provided
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;If&nbsp;token&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;scope,&nbsp;it&#39;s&nbsp;NULL/empty,&nbsp;or&nbsp;it&#39;s&nbsp;insufficient,&nbsp;then&nbsp;throw&nbsp;an&nbsp;error
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($scope&nbsp;&amp;&amp;&nbsp;(!isset($token[&quot;scope&quot;])&nbsp;||&nbsp;!$token[&quot;scope&quot;]&nbsp;||&nbsp;!$this-&gt;checkScope($scope,&nbsp;$token[&quot;scope&quot;])))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$exit_scope&nbsp;?&nbsp;$this-&gt;errorWWWAuthenticateResponseHeader(OAUTH2_HTTP_FORBIDDEN,&nbsp;$realm,&nbsp;OAUTH2_ERROR_INSUFFICIENT_SCOPE,&nbsp;&#39;The&nbsp;request&nbsp;requires&nbsp;higher&nbsp;privileges&nbsp;than&nbsp;provided&nbsp;by&nbsp;the&nbsp;access&nbsp;token.&#39;,&nbsp;NULL,&nbsp;$scope)&nbsp;:&nbsp;FALSE;

&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Check&nbsp;if&nbsp;everything&nbsp;in&nbsp;required&nbsp;scope&nbsp;is&nbsp;contained&nbsp;in&nbsp;available&nbsp;scope.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$required_scope
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Required&nbsp;scope&nbsp;to&nbsp;be&nbsp;check&nbsp;with.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$available_scope
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Available&nbsp;scope&nbsp;to&nbsp;be&nbsp;compare&nbsp;with.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;TRUE&nbsp;if&nbsp;everything&nbsp;in&nbsp;required&nbsp;scope&nbsp;is&nbsp;contained&nbsp;in&nbsp;available&nbsp;scope,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;and&nbsp;False&nbsp;if&nbsp;it&nbsp;isn&#39;t.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_5
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;private&nbsp;function&nbsp;checkScope($required_scope,&nbsp;$available_scope)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;required&nbsp;scope&nbsp;should&nbsp;match&nbsp;or&nbsp;be&nbsp;a&nbsp;subset&nbsp;of&nbsp;the&nbsp;available&nbsp;scope
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!is_array($required_scope))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$required_scope&nbsp;=&nbsp;explode(&quot;&nbsp;&quot;,&nbsp;$required_scope);

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!is_array($available_scope))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$available_scope&nbsp;=&nbsp;explode(&quot;&nbsp;&quot;,&nbsp;$available_scope);

&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(count(array_diff($required_scope,&nbsp;$available_scope))&nbsp;==&nbsp;0);
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Pulls&nbsp;the&nbsp;access&nbsp;token&nbsp;out&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;request.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Either&nbsp;from&nbsp;the&nbsp;Authorization&nbsp;header&nbsp;or&nbsp;GET/POST/etc.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Access&nbsp;token&nbsp;value&nbsp;if&nbsp;present,&nbsp;and&nbsp;FALSE&nbsp;if&nbsp;it&nbsp;isn&#39;t.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@todo&nbsp;Support&nbsp;PUT&nbsp;or&nbsp;DELETE.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.1
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_5
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;private&nbsp;function&nbsp;getAccessTokenParams()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;$auth_header&nbsp;=&nbsp;$this-&gt;getAuthorizationHeader();
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($auth_header&nbsp;!==&nbsp;FALSE)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Make&nbsp;sure&nbsp;only&nbsp;the&nbsp;auth&nbsp;header&nbsp;is&nbsp;set
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_GET[OAUTH2_TOKEN_PARAM_NAME])&nbsp;||&nbsp;isset($_POST[OAUTH2_TOKEN_PARAM_NAME]))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;Auth&nbsp;token&nbsp;found&nbsp;in&nbsp;GET&nbsp;or&nbsp;POST&nbsp;when&nbsp;token&nbsp;present&nbsp;in&nbsp;header&#39;);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$auth_header&nbsp;=&nbsp;trim($auth_header);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Make&nbsp;sure&nbsp;it&#39;s&nbsp;Token&nbsp;authorization
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strcmp(substr($auth_header,&nbsp;0,&nbsp;5),&nbsp;&quot;OAuth&nbsp;&quot;)&nbsp;!==&nbsp;0)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;Auth&nbsp;header&nbsp;found&nbsp;that&nbsp;doesn\\&#39;t&nbsp;start&nbsp;with&nbsp;&quot;OAuth&quot;&#39;);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Parse&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;header
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(preg_match(&#39;/\\s*OAuth\\s*=&quot;(.+)&quot;/&#39;,&nbsp;substr($auth_header,&nbsp;5),&nbsp;$matches)&nbsp;==&nbsp;0&nbsp;||&nbsp;count($matches)&nbsp;&lt;&nbsp;2)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;Malformed&nbsp;auth&nbsp;header&#39;);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$matches[1];
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_GET[OAUTH2_TOKEN_PARAM_NAME]))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_POST[OAUTH2_TOKEN_PARAM_NAME]))&nbsp;//&nbsp;Both&nbsp;GET&nbsp;and&nbsp;POST&nbsp;are&nbsp;not&nbsp;allowed
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;Only&nbsp;send&nbsp;the&nbsp;token&nbsp;in&nbsp;GET&nbsp;or&nbsp;POST,&nbsp;not&nbsp;both&#39;);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$_GET[OAUTH2_TOKEN_PARAM_NAME];
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_POST[OAUTH2_TOKEN_PARAM_NAME]))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$_POST[OAUTH2_TOKEN_PARAM_NAME];

&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;
&nbsp;&nbsp;}

&nbsp;&nbsp;//&nbsp;Access&nbsp;token&nbsp;granting&nbsp;(Section&nbsp;4).

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Grant&nbsp;or&nbsp;deny&nbsp;a&nbsp;requested&nbsp;access&nbsp;token.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;would&nbsp;be&nbsp;called&nbsp;from&nbsp;the&nbsp;&quot;/token&quot;&nbsp;endpoint&nbsp;as&nbsp;defined&nbsp;in&nbsp;the&nbsp;spec.
&nbsp;&nbsp;&nbsp;*&nbsp;Obviously,&nbsp;you&nbsp;can&nbsp;call&nbsp;your&nbsp;endpoint&nbsp;whatever&nbsp;you&nbsp;want.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;public&nbsp;function&nbsp;grantAccessToken()&nbsp;{

&nbsp;&nbsp;&nbsp;&nbsp;$filters&nbsp;=&nbsp;array(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;grant_type&quot;&nbsp;=&gt;&nbsp;array(&quot;filter&quot;&nbsp;=&gt;&nbsp;FILTER_VALIDATE_REGEXP,&nbsp;&quot;options&quot;&nbsp;=&gt;&nbsp;array(&quot;regexp&quot;&nbsp;=&gt;&nbsp;OAUTH2_GRANT_TYPE_REGEXP),&nbsp;&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;scope&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;code&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;redirect_uri&quot;&nbsp;=&gt;&nbsp;array(&quot;filter&quot;&nbsp;=&gt;&nbsp;FILTER_SANITIZE_URL),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;username&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;password&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;assertion_type&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;assertion&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;refresh_token&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),
&nbsp;&nbsp;&nbsp;&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;filter_input_array(INPUT_POST,&nbsp;$filters);
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Grant&nbsp;Type&nbsp;must&nbsp;be&nbsp;specified.
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;grant_type&quot;])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;Invalid&nbsp;grant_type&nbsp;parameter&nbsp;or&nbsp;parameter&nbsp;missing&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Make&nbsp;sure&nbsp;we&#39;ve&nbsp;implemented&nbsp;the&nbsp;requested&nbsp;grant&nbsp;type
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!in_array($input[&quot;grant_type&quot;],&nbsp;$this-&gt;getSupportedGrantTypes()))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_UNSUPPORTED_GRANT_TYPE);

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Authorize&nbsp;the&nbsp;client
&nbsp;&nbsp;&nbsp;&nbsp;$client&nbsp;=&nbsp;$this-&gt;getClientCredentials();

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;checkClientCredentials($client[0],&nbsp;$client[1])&nbsp;===&nbsp;FALSE)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_CLIENT);

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$this-&gt;checkRestrictedGrantType($client[0],&nbsp;$input[&quot;grant_type&quot;]))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_UNAUTHORIZED_CLIENT);

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Do&nbsp;the&nbsp;granting
&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;($input[&quot;grant_type&quot;])&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;OAUTH2_GRANT_TYPE_AUTH_CODE:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;code&quot;]&nbsp;||&nbsp;!$input[&quot;redirect_uri&quot;])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stored&nbsp;=&nbsp;$this-&gt;getAuthCode($input[&quot;code&quot;]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Ensure&nbsp;that&nbsp;the&nbsp;input&nbsp;uri&nbsp;starts&nbsp;with&nbsp;the&nbsp;stored&nbsp;uri
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($stored&nbsp;===&nbsp;NULL&nbsp;||&nbsp;(strcasecmp(substr($input[&quot;redirect_uri&quot;],&nbsp;0,&nbsp;strlen($stored[&quot;redirect_uri&quot;])),&nbsp;$stored[&quot;redirect_uri&quot;])&nbsp;!==&nbsp;0)&nbsp;||&nbsp;$client[0]&nbsp;!=&nbsp;$stored[&quot;client_id&quot;])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_GRANT);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($stored[&quot;expires&quot;]&nbsp;&lt;&nbsp;time())
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_EXPIRED_TOKEN);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;OAUTH2_GRANT_TYPE_USER_CREDENTIALS:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;username&quot;]&nbsp;||&nbsp;!$input[&quot;password&quot;])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;Missing&nbsp;parameters.&nbsp;&quot;username&quot;&nbsp;and&nbsp;&quot;password&quot;&nbsp;required&#39;);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stored&nbsp;=&nbsp;$this-&gt;checkUserCredentials($client[0],&nbsp;$input[&quot;username&quot;],&nbsp;$input[&quot;password&quot;]);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($stored&nbsp;===&nbsp;FALSE)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_GRANT);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;OAUTH2_GRANT_TYPE_ASSERTION:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;assertion_type&quot;]&nbsp;||&nbsp;!$input[&quot;assertion&quot;])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stored&nbsp;=&nbsp;$this-&gt;checkAssertion($client[0],&nbsp;$input[&quot;assertion_type&quot;],&nbsp;$input[&quot;assertion&quot;]);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($stored&nbsp;===&nbsp;FALSE)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_GRANT);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;OAUTH2_GRANT_TYPE_REFRESH_TOKEN:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;refresh_token&quot;])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;No&nbsp;&quot;refresh_token&quot;&nbsp;parameter&nbsp;found&#39;);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stored&nbsp;=&nbsp;$this-&gt;getRefreshToken($input[&quot;refresh_token&quot;]);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($stored&nbsp;===&nbsp;NULL&nbsp;||&nbsp;$client[0]&nbsp;!=&nbsp;$stored[&quot;client_id&quot;])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_GRANT);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($stored[&quot;expires&quot;]&nbsp;&lt;&nbsp;time())
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_EXPIRED_TOKEN);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;store&nbsp;the&nbsp;refresh&nbsp;token&nbsp;locally&nbsp;so&nbsp;we&nbsp;can&nbsp;delete&nbsp;it&nbsp;when&nbsp;a&nbsp;new&nbsp;refresh&nbsp;token&nbsp;is&nbsp;generated
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;setVariable(&#39;_old_refresh_token&#39;,&nbsp;$stored[&quot;token&quot;]);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;OAUTH2_GRANT_TYPE_NONE:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stored&nbsp;=&nbsp;$this-&gt;checkNoneAccess($client[0]);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($stored&nbsp;===&nbsp;FALSE)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST);
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;scope,&nbsp;if&nbsp;provided
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($input[&quot;scope&quot;]&nbsp;&amp;&amp;&nbsp;(!is_array($stored)&nbsp;||&nbsp;!isset($stored[&quot;scope&quot;])&nbsp;||&nbsp;!$this-&gt;checkScope($input[&quot;scope&quot;],&nbsp;$stored[&quot;scope&quot;])))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_SCOPE);

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;scope&quot;])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$input[&quot;scope&quot;]&nbsp;=&nbsp;NULL;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;$this-&gt;createAccessToken($client[0],&nbsp;$input[&quot;scope&quot;],&nbsp;$stored[&quot;user_id&quot;]);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//TOKEN&nbsp;为&nbsp;数组&nbsp;(包括&nbsp;TOKEN&nbsp;值，&nbsp;有效时间，&nbsp;权限)
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;$this-&gt;sendJsonHeaders();
&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;json_encode($token);
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Internal&nbsp;function&nbsp;used&nbsp;to&nbsp;get&nbsp;the&nbsp;client&nbsp;credentials&nbsp;from&nbsp;HTTP&nbsp;basic
&nbsp;&nbsp;&nbsp;*&nbsp;auth&nbsp;or&nbsp;POST&nbsp;data.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;list&nbsp;containing&nbsp;the&nbsp;client&nbsp;identifier&nbsp;and&nbsp;password,&nbsp;for&nbsp;example
&nbsp;&nbsp;&nbsp;*&nbsp;@code
&nbsp;&nbsp;&nbsp;*&nbsp;return&nbsp;array(
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;$_POST[&quot;client_id&quot;],
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;$_POST[&quot;client_secret&quot;],
&nbsp;&nbsp;&nbsp;*&nbsp;);
&nbsp;&nbsp;&nbsp;*&nbsp;@endcode
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-2
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_2
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;getClientCredentials()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_SERVER[&quot;PHP_AUTH_USER&quot;])&nbsp;&amp;&amp;&nbsp;$_POST&nbsp;&amp;&amp;&nbsp;isset($_POST[&quot;client_id&quot;]))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_CLIENT);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Try&nbsp;basic&nbsp;auth
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_SERVER[&quot;PHP_AUTH_USER&quot;]))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array($_SERVER[&quot;PHP_AUTH_USER&quot;],&nbsp;$_SERVER[&quot;PHP_AUTH_PW&quot;]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Try&nbsp;POST
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($_POST&nbsp;&amp;&amp;&nbsp;isset($_POST[&quot;client_id&quot;]))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_POST[&quot;client_secret&quot;]))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array($_POST[&quot;client_id&quot;],&nbsp;$_POST[&quot;client_secret&quot;]);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array($_POST[&quot;client_id&quot;],&nbsp;NULL);
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;No&nbsp;credentials&nbsp;were&nbsp;specified
&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_CLIENT);
&nbsp;&nbsp;}

&nbsp;&nbsp;//&nbsp;End-user/client&nbsp;Authorization&nbsp;(Section&nbsp;3&nbsp;of&nbsp;IETF&nbsp;Draft).

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Pull&nbsp;the&nbsp;authorization&nbsp;request&nbsp;data&nbsp;out&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;request.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;authorization&nbsp;parameters&nbsp;so&nbsp;the&nbsp;authorization&nbsp;server&nbsp;can&nbsp;prompt
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;the&nbsp;user&nbsp;for&nbsp;approval&nbsp;if&nbsp;valid.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;public&nbsp;function&nbsp;getAuthorizeParams()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;$filters&nbsp;=&nbsp;array(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;client_id&quot;&nbsp;=&gt;&nbsp;array(&quot;filter&quot;&nbsp;=&gt;&nbsp;FILTER_VALIDATE_REGEXP,&nbsp;&quot;options&quot;&nbsp;=&gt;&nbsp;array(&quot;regexp&quot;&nbsp;=&gt;&nbsp;OAUTH2_CLIENT_ID_REGEXP),&nbsp;&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;response_type&quot;&nbsp;=&gt;&nbsp;array(&quot;filter&quot;&nbsp;=&gt;&nbsp;FILTER_VALIDATE_REGEXP,&nbsp;&quot;options&quot;&nbsp;=&gt;&nbsp;array(&quot;regexp&quot;&nbsp;=&gt;&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_REGEXP),&nbsp;&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;redirect_uri&quot;&nbsp;=&gt;&nbsp;array(&quot;filter&quot;&nbsp;=&gt;&nbsp;FILTER_SANITIZE_URL),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;state&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;scope&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),
&nbsp;&nbsp;&nbsp;&nbsp;);

&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;filter_input_array(INPUT_GET,&nbsp;$filters);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Make&nbsp;sure&nbsp;a&nbsp;valid&nbsp;client&nbsp;id&nbsp;was&nbsp;supplied
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;client_id&quot;])&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($input[&quot;redirect_uri&quot;])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorDoRedirectUriCallback($input[&quot;redirect_uri&quot;],&nbsp;OAUTH2_ERROR_INVALID_CLIENT,&nbsp;NULL,&nbsp;NULL,&nbsp;$input[&quot;state&quot;]);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_FOUND,&nbsp;OAUTH2_ERROR_INVALID_CLIENT);&nbsp;//&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;good&nbsp;URI&nbsp;to&nbsp;use
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;redirect_uri&nbsp;is&nbsp;not&nbsp;required&nbsp;if&nbsp;already&nbsp;established&nbsp;via&nbsp;other&nbsp;channels
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;check&nbsp;an&nbsp;existing&nbsp;redirect&nbsp;URI&nbsp;against&nbsp;the&nbsp;one&nbsp;supplied
&nbsp;&nbsp;&nbsp;&nbsp;$redirect_uri&nbsp;=&nbsp;$this-&gt;getRedirectUri($input[&quot;client_id&quot;]);

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;At&nbsp;least&nbsp;one&nbsp;of:&nbsp;existing&nbsp;redirect&nbsp;URI&nbsp;or&nbsp;input&nbsp;redirect&nbsp;URI&nbsp;must&nbsp;be&nbsp;specified
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$redirect_uri&nbsp;&amp;&amp;&nbsp;!$input[&quot;redirect_uri&quot;])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_FOUND,&nbsp;OAUTH2_ERROR_INVALID_REQUEST);

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;getRedirectUri()&nbsp;should&nbsp;return&nbsp;FALSE&nbsp;if&nbsp;the&nbsp;given&nbsp;client&nbsp;ID&nbsp;is&nbsp;invalid
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;this&nbsp;probably&nbsp;saves&nbsp;us&nbsp;from&nbsp;making&nbsp;a&nbsp;separate&nbsp;db&nbsp;call,&nbsp;and&nbsp;simplifies&nbsp;the&nbsp;method&nbsp;set
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($redirect_uri&nbsp;===&nbsp;FALSE)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorDoRedirectUriCallback($input[&quot;redirect_uri&quot;],&nbsp;OAUTH2_ERROR_INVALID_CLIENT,&nbsp;NULL,&nbsp;NULL,&nbsp;$input[&quot;state&quot;]);

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;existing&nbsp;uri&nbsp;and&nbsp;one&nbsp;from&nbsp;input,&nbsp;verify&nbsp;that&nbsp;they&nbsp;match
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($redirect_uri&nbsp;&amp;&amp;&nbsp;$input[&quot;redirect_uri&quot;])&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Ensure&nbsp;that&nbsp;the&nbsp;input&nbsp;uri&nbsp;starts&nbsp;with&nbsp;the&nbsp;stored&nbsp;uri
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strcasecmp(substr($input[&quot;redirect_uri&quot;],&nbsp;0,&nbsp;strlen($redirect_uri)),&nbsp;$redirect_uri)&nbsp;!==&nbsp;0)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorDoRedirectUriCallback($input[&quot;redirect_uri&quot;],&nbsp;OAUTH2_ERROR_REDIRECT_URI_MISMATCH,&nbsp;NULL,&nbsp;NULL,&nbsp;$input[&quot;state&quot;]);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;elseif&nbsp;($redirect_uri)&nbsp;{&nbsp;//&nbsp;They&nbsp;did&nbsp;not&nbsp;provide&nbsp;a&nbsp;uri&nbsp;from&nbsp;input,&nbsp;so&nbsp;use&nbsp;the&nbsp;stored&nbsp;one
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$input[&quot;redirect_uri&quot;]&nbsp;=&nbsp;$redirect_uri;
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;type&nbsp;and&nbsp;client_id&nbsp;are&nbsp;required
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;response_type&quot;])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorDoRedirectUriCallback($input[&quot;redirect_uri&quot;],&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;Invalid&nbsp;response&nbsp;type.&#39;,&nbsp;NULL,&nbsp;$input[&quot;state&quot;]);

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;requested&nbsp;auth&nbsp;response&nbsp;type&nbsp;against&nbsp;the&nbsp;list&nbsp;of&nbsp;supported&nbsp;types
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(array_search($input[&quot;response_type&quot;],&nbsp;$this-&gt;getSupportedAuthResponseTypes())&nbsp;===&nbsp;FALSE)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorDoRedirectUriCallback($input[&quot;redirect_uri&quot;],&nbsp;OAUTH2_ERROR_UNSUPPORTED_RESPONSE_TYPE,&nbsp;NULL,&nbsp;NULL,&nbsp;$input[&quot;state&quot;]);

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Restrict&nbsp;clients&nbsp;to&nbsp;certain&nbsp;authorization&nbsp;response&nbsp;types
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;checkRestrictedAuthResponseType($input[&quot;client_id&quot;],&nbsp;$input[&quot;response_type&quot;])&nbsp;===&nbsp;FALSE)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorDoRedirectUriCallback($input[&quot;redirect_uri&quot;],&nbsp;OAUTH2_ERROR_UNAUTHORIZED_CLIENT,&nbsp;NULL,&nbsp;NULL,&nbsp;$input[&quot;state&quot;]);

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Validate&nbsp;that&nbsp;the&nbsp;requested&nbsp;scope&nbsp;is&nbsp;supported
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($input[&quot;scope&quot;]&nbsp;&amp;&amp;&nbsp;!$this-&gt;checkScope($input[&quot;scope&quot;],&nbsp;$this-&gt;getSupportedScopes()))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorDoRedirectUriCallback($input[&quot;redirect_uri&quot;],&nbsp;OAUTH2_ERROR_INVALID_SCOPE,&nbsp;NULL,&nbsp;NULL,&nbsp;$input[&quot;state&quot;]);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$input;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Redirect&nbsp;the&nbsp;user&nbsp;appropriately&nbsp;after&nbsp;approval.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;After&nbsp;the&nbsp;user&nbsp;has&nbsp;approved&nbsp;or&nbsp;denied&nbsp;the&nbsp;access&nbsp;request&nbsp;the
&nbsp;&nbsp;&nbsp;*&nbsp;authorization&nbsp;server&nbsp;should&nbsp;call&nbsp;this&nbsp;function&nbsp;to&nbsp;redirect&nbsp;the&nbsp;user
&nbsp;&nbsp;&nbsp;*&nbsp;appropriately.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$is_authorized
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;TRUE&nbsp;or&nbsp;FALSE&nbsp;depending&nbsp;on&nbsp;whether&nbsp;the&nbsp;user&nbsp;authorized&nbsp;the&nbsp;access.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$params
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;associative&nbsp;array&nbsp;as&nbsp;below:
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;response_type:&nbsp;The&nbsp;requested&nbsp;response:&nbsp;an&nbsp;access&nbsp;token,&nbsp;an
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authorization&nbsp;code,&nbsp;or&nbsp;both.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;client_id:&nbsp;The&nbsp;client&nbsp;identifier&nbsp;as&nbsp;described&nbsp;in&nbsp;Section&nbsp;2.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;redirect_uri:&nbsp;An&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;which&nbsp;the&nbsp;authorization&nbsp;server
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will&nbsp;redirect&nbsp;the&nbsp;user-agent&nbsp;to&nbsp;when&nbsp;the&nbsp;end-user&nbsp;authorization
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step&nbsp;is&nbsp;completed.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;scope:&nbsp;(optional)&nbsp;The&nbsp;scope&nbsp;of&nbsp;the&nbsp;access&nbsp;request&nbsp;expressed&nbsp;as&nbsp;a
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list&nbsp;of&nbsp;space-delimited&nbsp;strings.
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;state:&nbsp;(optional)&nbsp;An&nbsp;opaque&nbsp;value&nbsp;used&nbsp;by&nbsp;the&nbsp;client&nbsp;to&nbsp;maintain
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;between&nbsp;the&nbsp;request&nbsp;and&nbsp;callback.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;public&nbsp;function&nbsp;finishClientAuthorization($is_authorized,&nbsp;$params&nbsp;=&nbsp;array())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;$params&nbsp;+=&nbsp;array(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&#39;scope&#39;&nbsp;=&gt;&nbsp;NULL,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;state&#39;&nbsp;=&gt;&nbsp;NULL,
&nbsp;&nbsp;&nbsp;&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;extract($params);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($state&nbsp;!==&nbsp;NULL)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;query&quot;][&quot;state&quot;]&nbsp;=&nbsp;$state;

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($is_authorized&nbsp;===&nbsp;FALSE)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;query&quot;][&quot;error&quot;]&nbsp;=&nbsp;OAUTH2_ERROR_USER_DENIED;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($response_type&nbsp;==&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_AUTH_CODE&nbsp;||&nbsp;$response_type&nbsp;==&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_CODE_AND_TOKEN)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;query&quot;][&quot;code&quot;]&nbsp;=&nbsp;$this-&gt;createAuthCode($client_id,&nbsp;$redirect_uri,&nbsp;$user_id,&nbsp;$scope);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($response_type&nbsp;==&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_ACCESS_TOKEN&nbsp;||&nbsp;$response_type&nbsp;==&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_CODE_AND_TOKEN)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;fragment&quot;]&nbsp;=&nbsp;$this-&gt;createAccessToken($client_id,&nbsp;$scope,&nbsp;$user_id);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;$result[&#39;display&#39;]&nbsp;=&nbsp;!empty($display)&nbsp;?&nbsp;$display&nbsp;:&nbsp;&#39;&#39;;

&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;doRedirectUriCallback($redirect_uri,&nbsp;$result);
&nbsp;&nbsp;}

&nbsp;&nbsp;//&nbsp;Other/utility&nbsp;functions.

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Redirect&nbsp;the&nbsp;user&nbsp;agent.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Handle&nbsp;both&nbsp;redirect&nbsp;for&nbsp;success&nbsp;or&nbsp;error&nbsp;response.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$redirect_uri
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;which&nbsp;the&nbsp;authorization&nbsp;server&nbsp;will&nbsp;redirect
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;the&nbsp;user-agent&nbsp;to&nbsp;when&nbsp;the&nbsp;end-user&nbsp;authorization&nbsp;step&nbsp;is&nbsp;completed.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$params
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Parameters&nbsp;to&nbsp;be&nbsp;pass&nbsp;though&nbsp;buildUri().
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;private&nbsp;function&nbsp;doRedirectUriCallback($redirect_uri,&nbsp;$params)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;HTTP/1.1&nbsp;&quot;.&nbsp;OAUTH2_HTTP_FOUND);
&nbsp;&nbsp;&nbsp;&nbsp;if($params[&#39;display&#39;]&nbsp;==&nbsp;&#39;frame&#39;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&#39;&lt;script&gt;window.top.location.href=&quot;&#39;.$this-&gt;buildUri($redirect_uri,&nbsp;$params).&#39;&quot;;&lt;/script&gt;&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;Location:&nbsp;&quot;&nbsp;.&nbsp;$this-&gt;buildUri($redirect_uri,&nbsp;$params));
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;exit;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Build&nbsp;the&nbsp;absolute&nbsp;URI&nbsp;based&nbsp;on&nbsp;supplied&nbsp;URI&nbsp;and&nbsp;parameters.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$uri
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;absolute&nbsp;URI.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$params
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Parameters&nbsp;to&nbsp;be&nbsp;append&nbsp;as&nbsp;GET.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;absolute&nbsp;URI&nbsp;with&nbsp;supplied&nbsp;parameters.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;private&nbsp;function&nbsp;buildUri($uri,&nbsp;$params)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;session_start();
&nbsp;&nbsp;&nbsp;&nbsp;$parse_url&nbsp;=&nbsp;parse_url($uri);

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Add&nbsp;our&nbsp;params&nbsp;to&nbsp;the&nbsp;parsed&nbsp;uri
&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($params&nbsp;as&nbsp;$k&nbsp;=&gt;&nbsp;$v)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($parse_url[$k]))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parse_url[$k]&nbsp;.=&nbsp;&quot;&amp;&quot;&nbsp;.&nbsp;http_build_query($v);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parse_url[$k]&nbsp;=&nbsp;http_build_query($v);
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Put&nbsp;humpty&nbsp;dumpty&nbsp;back&nbsp;together
&nbsp;&nbsp;&nbsp;&nbsp;$return&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((isset($parse_url[&quot;scheme&quot;]))&nbsp;?&nbsp;$parse_url[&quot;scheme&quot;]&nbsp;.&nbsp;&quot;://&quot;&nbsp;:&nbsp;&quot;&quot;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.&nbsp;((isset($parse_url[&quot;user&quot;]))&nbsp;?&nbsp;$parse_url[&quot;user&quot;]&nbsp;.&nbsp;((isset($parse_url[&quot;pass&quot;]))&nbsp;?&nbsp;&quot;:&quot;&nbsp;.&nbsp;$parse_url[&quot;pass&quot;]&nbsp;:&nbsp;&quot;&quot;)&nbsp;.&nbsp;&quot;@&quot;&nbsp;:&nbsp;&quot;&quot;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.&nbsp;((isset($parse_url[&quot;host&quot;]))&nbsp;?&nbsp;$parse_url[&quot;host&quot;]&nbsp;:&nbsp;&quot;&quot;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.&nbsp;((isset($parse_url[&quot;port&quot;]))&nbsp;?&nbsp;&quot;:&quot;&nbsp;.&nbsp;$parse_url[&quot;port&quot;]&nbsp;:&nbsp;&quot;&quot;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.&nbsp;((isset($parse_url[&quot;path&quot;]))&nbsp;?&nbsp;$parse_url[&quot;path&quot;]&nbsp;:&nbsp;&quot;&quot;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.&nbsp;((isset($parse_url[&quot;query&quot;]))&nbsp;?&nbsp;&quot;?&quot;&nbsp;.&nbsp;$parse_url[&quot;query&quot;]&nbsp;:&nbsp;&quot;&quot;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.&nbsp;((isset($parse_url[&quot;fragment&quot;]))&nbsp;?&nbsp;&quot;#&quot;&nbsp;.&nbsp;$parse_url[&quot;fragment&quot;]&nbsp;:&nbsp;&quot;&quot;)&nbsp;.&nbsp;&quot;&amp;ssid=&quot;.base64_encode(&#39;2egc83&#39;.session_id());
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$return;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Handle&nbsp;the&nbsp;creation&nbsp;of&nbsp;access&nbsp;token,&nbsp;also&nbsp;issue&nbsp;refresh&nbsp;token&nbsp;if&nbsp;support.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;belongs&nbsp;in&nbsp;a&nbsp;separate&nbsp;factory,&nbsp;but&nbsp;to&nbsp;keep&nbsp;it&nbsp;simple,&nbsp;I&#39;m&nbsp;just
&nbsp;&nbsp;&nbsp;*&nbsp;keeping&nbsp;it&nbsp;here.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;related&nbsp;to&nbsp;the&nbsp;access&nbsp;token.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$scope
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;Scopes&nbsp;to&nbsp;be&nbsp;stored&nbsp;in&nbsp;space-separated&nbsp;string.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;createAccessToken($client_id,&nbsp;$scope&nbsp;=&nbsp;NULL,&nbsp;$user_id&nbsp;=&nbsp;10)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;array(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;access_token&quot;&nbsp;=&gt;&nbsp;$this-&gt;genAccessToken(),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;expires_in&quot;&nbsp;=&gt;&nbsp;$this-&gt;getVariable(&#39;access_token_lifetime&#39;,&nbsp;OAUTH2_DEFAULT_ACCESS_TOKEN_LIFETIME),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;user_id&quot;&nbsp;=&gt;&nbsp;$user_id,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;scope&quot;&nbsp;=&gt;&nbsp;$scope
&nbsp;&nbsp;&nbsp;&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;$refresh_token&nbsp;=&nbsp;&#39;&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Issue&nbsp;a&nbsp;refresh&nbsp;token&nbsp;also,&nbsp;if&nbsp;we&nbsp;support&nbsp;them
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(in_array(OAUTH2_GRANT_TYPE_REFRESH_TOKEN,&nbsp;$this-&gt;getSupportedGrantTypes()))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$refresh_token&nbsp;=&nbsp;$this-&gt;genAccessToken();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;$this-&gt;setRefreshToken($token[&quot;refresh_token&quot;],&nbsp;$client_id,&nbsp;time()&nbsp;+&nbsp;$this-&gt;getVariable(&#39;refresh_token_lifetime&#39;,&nbsp;OAUTH2_DEFAULT_REFRESH_TOKEN_LIFETIME),&nbsp;$user_id,&nbsp;$scope);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$token[&quot;refresh_token&quot;]&nbsp;=&nbsp;$refresh_token;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;If&nbsp;we&#39;ve&nbsp;granted&nbsp;a&nbsp;new&nbsp;refresh&nbsp;token,&nbsp;expire&nbsp;the&nbsp;old&nbsp;one
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;getVariable(&#39;_old_refresh_token&#39;))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;unsetRefreshToken($this-&gt;getVariable(&#39;_old_refresh_token&#39;));
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;$access_token&nbsp;=&nbsp;$token[&#39;access_token&#39;];

&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;setAccessToken($access_token,&nbsp;$client_id,&nbsp;time()&nbsp;+&nbsp;$this-&gt;getVariable(&#39;access_token_lifetime&#39;,&nbsp;OAUTH2_DEFAULT_ACCESS_TOKEN_LIFETIME),&nbsp;$token[&#39;user_id&#39;],&nbsp;$scope,&nbsp;$refresh_token);

&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$token;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Handle&nbsp;the&nbsp;creation&nbsp;of&nbsp;auth&nbsp;code.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;belongs&nbsp;in&nbsp;a&nbsp;separate&nbsp;factory,&nbsp;but&nbsp;to&nbsp;keep&nbsp;it&nbsp;simple,&nbsp;I&#39;m&nbsp;just
&nbsp;&nbsp;&nbsp;*&nbsp;keeping&nbsp;it&nbsp;here.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;related&nbsp;to&nbsp;the&nbsp;access&nbsp;token.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$redirect_uri
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;which&nbsp;the&nbsp;authorization&nbsp;server&nbsp;will&nbsp;redirect&nbsp;the
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;user-agent&nbsp;to&nbsp;when&nbsp;the&nbsp;end-user&nbsp;authorization&nbsp;step&nbsp;is&nbsp;completed.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$scope
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;Scopes&nbsp;to&nbsp;be&nbsp;stored&nbsp;in&nbsp;space-separated&nbsp;string.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;private&nbsp;function&nbsp;createAuthCode($client_id,&nbsp;$redirect_uri,&nbsp;$userId,&nbsp;$scope&nbsp;=&nbsp;NULL)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;$code&nbsp;=&nbsp;$this-&gt;genAuthCode();
&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;setAuthCode($code,&nbsp;$client_id,&nbsp;$redirect_uri,&nbsp;time()&nbsp;+&nbsp;$this-&gt;getVariable(&#39;auth_code_lifetime&#39;,&nbsp;OAUTH2_DEFAULT_AUTH_CODE_LIFETIME),&nbsp;$userId,&nbsp;$scope);
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$code;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Generate&nbsp;unique&nbsp;access&nbsp;token.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Implementing&nbsp;classes&nbsp;may&nbsp;want&nbsp;to&nbsp;override&nbsp;these&nbsp;function&nbsp;to&nbsp;implement
&nbsp;&nbsp;&nbsp;*&nbsp;other&nbsp;access&nbsp;token&nbsp;or&nbsp;auth&nbsp;code&nbsp;generation&nbsp;schemes.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;unique&nbsp;access&nbsp;token.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;genAccessToken()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;md5(base64_encode(pack(&#39;N6&#39;,&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;uniqid())));
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Generate&nbsp;unique&nbsp;auth&nbsp;code.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Implementing&nbsp;classes&nbsp;may&nbsp;want&nbsp;to&nbsp;override&nbsp;these&nbsp;function&nbsp;to&nbsp;implement
&nbsp;&nbsp;&nbsp;*&nbsp;other&nbsp;access&nbsp;token&nbsp;or&nbsp;auth&nbsp;code&nbsp;generation&nbsp;schemes.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;unique&nbsp;auth&nbsp;code.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;genAuthCode()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;md5(base64_encode(pack(&#39;N6&#39;,&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;uniqid())));
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Pull&nbsp;out&nbsp;the&nbsp;Authorization&nbsp;HTTP&nbsp;header&nbsp;and&nbsp;return&nbsp;it.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;Implementing&nbsp;classes&nbsp;may&nbsp;need&nbsp;to&nbsp;override&nbsp;this&nbsp;function&nbsp;for&nbsp;use&nbsp;on
&nbsp;&nbsp;&nbsp;*&nbsp;non-Apache&nbsp;web&nbsp;servers.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@return
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;Authorization&nbsp;HTTP&nbsp;header,&nbsp;and&nbsp;FALSE&nbsp;if&nbsp;does&nbsp;not&nbsp;exist.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@todo&nbsp;Handle&nbsp;Authorization&nbsp;HTTP&nbsp;header&nbsp;for&nbsp;non-Apache&nbsp;web&nbsp;servers.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_5
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;private&nbsp;function&nbsp;getAuthorizationHeader()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(array_key_exists(&quot;HTTP_AUTHORIZATION&quot;,&nbsp;$_SERVER))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$_SERVER[&quot;HTTP_AUTHORIZATION&quot;];

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(function_exists(&quot;apache_request_headers&quot;))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers&nbsp;=&nbsp;apache_request_headers();

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(array_key_exists(&quot;Authorization&quot;,&nbsp;$headers))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$headers[&quot;Authorization&quot;];
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Send&nbsp;out&nbsp;HTTP&nbsp;headers&nbsp;for&nbsp;JSON.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.2
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;private&nbsp;function&nbsp;sendJsonHeaders()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;Content-Type:&nbsp;application/json&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;Cache-Control:&nbsp;no-store&quot;);
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Redirect&nbsp;the&nbsp;end-user&#39;s&nbsp;user&nbsp;agent&nbsp;with&nbsp;error&nbsp;message.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$redirect_uri
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;which&nbsp;the&nbsp;authorization&nbsp;server&nbsp;will&nbsp;redirect&nbsp;the
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;user-agent&nbsp;to&nbsp;when&nbsp;the&nbsp;end-user&nbsp;authorization&nbsp;step&nbsp;is&nbsp;completed.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;single&nbsp;error&nbsp;code&nbsp;as&nbsp;described&nbsp;in&nbsp;Section&nbsp;3.2.1.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error_description
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;A&nbsp;human-readable&nbsp;text&nbsp;providing&nbsp;additional&nbsp;information,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;used&nbsp;to&nbsp;assist&nbsp;in&nbsp;the&nbsp;understanding&nbsp;and&nbsp;resolution&nbsp;of&nbsp;the&nbsp;error
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;occurred.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error_uri
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;A&nbsp;URI&nbsp;identifying&nbsp;a&nbsp;human-readable&nbsp;web&nbsp;page&nbsp;with
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;information&nbsp;about&nbsp;the&nbsp;error,&nbsp;used&nbsp;to&nbsp;provide&nbsp;the&nbsp;end-user&nbsp;with
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;additional&nbsp;information&nbsp;about&nbsp;the&nbsp;error.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$state
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;REQUIRED&nbsp;if&nbsp;the&nbsp;&quot;state&quot;&nbsp;parameter&nbsp;was&nbsp;present&nbsp;in&nbsp;the&nbsp;client
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;authorization&nbsp;request.&nbsp;Set&nbsp;to&nbsp;the&nbsp;exact&nbsp;value&nbsp;received&nbsp;from&nbsp;the&nbsp;client.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_error
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;private&nbsp;function&nbsp;errorDoRedirectUriCallback($redirect_uri,&nbsp;$error,&nbsp;$error_description&nbsp;=&nbsp;NULL,&nbsp;$error_uri&nbsp;=&nbsp;NULL,&nbsp;$state&nbsp;=&nbsp;NULL)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;query&quot;][&quot;error&quot;]&nbsp;=&nbsp;$error;

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($state)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;query&quot;][&quot;state&quot;]&nbsp;=&nbsp;$state;

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;getVariable(&#39;display_error&#39;)&nbsp;&amp;&amp;&nbsp;$error_description)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;query&quot;][&quot;error_description&quot;]&nbsp;=&nbsp;$error_description;

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;getVariable(&#39;display_error&#39;)&nbsp;&amp;&amp;&nbsp;$error_uri)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;query&quot;][&quot;error_uri&quot;]&nbsp;=&nbsp;$error_uri;

&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;doRedirectUriCallback($redirect_uri,&nbsp;$result);
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Send&nbsp;out&nbsp;error&nbsp;message&nbsp;in&nbsp;JSON.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$http_status_code
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;HTTP&nbsp;status&nbsp;code&nbsp;message&nbsp;as&nbsp;predefined.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;single&nbsp;error&nbsp;code.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error_description
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;A&nbsp;human-readable&nbsp;text&nbsp;providing&nbsp;additional&nbsp;information,
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;used&nbsp;to&nbsp;assist&nbsp;in&nbsp;the&nbsp;understanding&nbsp;and&nbsp;resolution&nbsp;of&nbsp;the&nbsp;error
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;occurred.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error_uri
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;A&nbsp;URI&nbsp;identifying&nbsp;a&nbsp;human-readable&nbsp;web&nbsp;page&nbsp;with
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;information&nbsp;about&nbsp;the&nbsp;error,&nbsp;used&nbsp;to&nbsp;provide&nbsp;the&nbsp;end-user&nbsp;with
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;additional&nbsp;information&nbsp;about&nbsp;the&nbsp;error.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_error
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;private&nbsp;function&nbsp;errorJsonResponse($http_status_code,&nbsp;$error,&nbsp;$error_description&nbsp;=&nbsp;NULL,&nbsp;$error_uri&nbsp;=&nbsp;NULL)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;$result[&#39;error&#39;]&nbsp;=&nbsp;$error;

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;getVariable(&#39;display_error&#39;)&nbsp;&amp;&amp;&nbsp;$error_description)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;error_description&quot;]&nbsp;=&nbsp;$error_description;

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;getVariable(&#39;display_error&#39;)&nbsp;&amp;&amp;&nbsp;$error_uri)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;error_uri&quot;]&nbsp;=&nbsp;$error_uri;

&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;HTTP/1.1&nbsp;&quot;&nbsp;.&nbsp;$http_status_code);
&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;sendJsonHeaders();
&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;json_encode($result);

&nbsp;&nbsp;&nbsp;&nbsp;exit;
&nbsp;&nbsp;}

&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Send&nbsp;a&nbsp;401&nbsp;unauthorized&nbsp;header&nbsp;with&nbsp;the&nbsp;given&nbsp;realm&nbsp;and&nbsp;an&nbsp;error,&nbsp;if
&nbsp;&nbsp;&nbsp;*&nbsp;provided.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$http_status_code
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;HTTP&nbsp;status&nbsp;code&nbsp;message&nbsp;as&nbsp;predefined.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$realm
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;&quot;realm&quot;&nbsp;attribute&nbsp;is&nbsp;used&nbsp;to&nbsp;provide&nbsp;the&nbsp;protected&nbsp;resources
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;partition&nbsp;as&nbsp;defined&nbsp;by&nbsp;[RFC2617].
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$scope
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;space-delimited&nbsp;list&nbsp;of&nbsp;scope&nbsp;values&nbsp;indicating&nbsp;the&nbsp;required&nbsp;scope
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;of&nbsp;the&nbsp;access&nbsp;token&nbsp;for&nbsp;accessing&nbsp;the&nbsp;requested&nbsp;resource.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;&quot;error&quot;&nbsp;attribute&nbsp;is&nbsp;used&nbsp;to&nbsp;provide&nbsp;the&nbsp;client&nbsp;with&nbsp;the&nbsp;reason
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;why&nbsp;the&nbsp;access&nbsp;request&nbsp;was&nbsp;declined.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error_description
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;The&nbsp;&quot;error_description&quot;&nbsp;attribute&nbsp;provides&nbsp;a&nbsp;human-readable&nbsp;text
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;containing&nbsp;additional&nbsp;information,&nbsp;used&nbsp;to&nbsp;assist&nbsp;in&nbsp;the&nbsp;understanding
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;and&nbsp;resolution&nbsp;of&nbsp;the&nbsp;error&nbsp;occurred.
&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error_uri
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;The&nbsp;&quot;error_uri&quot;&nbsp;attribute&nbsp;provides&nbsp;a&nbsp;URI&nbsp;identifying&nbsp;a&nbsp;human-readable
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;web&nbsp;page&nbsp;with&nbsp;information&nbsp;about&nbsp;the&nbsp;error,&nbsp;used&nbsp;to&nbsp;offer&nbsp;the&nbsp;end-user
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;with&nbsp;additional&nbsp;information&nbsp;about&nbsp;the&nbsp;error.&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;not&nbsp;an
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;absolute&nbsp;URI,&nbsp;it&nbsp;is&nbsp;relative&nbsp;to&nbsp;the&nbsp;URI&nbsp;of&nbsp;the&nbsp;requested&nbsp;protected
&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;resource.
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2
&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_error
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;private&nbsp;function&nbsp;errorWWWAuthenticateResponseHeader($http_status_code,&nbsp;$realm,&nbsp;$error,&nbsp;$error_description&nbsp;=&nbsp;NULL,&nbsp;$error_uri&nbsp;=&nbsp;NULL,&nbsp;$scope&nbsp;=&nbsp;NULL)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;$realm&nbsp;=&nbsp;$realm&nbsp;===&nbsp;NULL&nbsp;?&nbsp;$this-&gt;getDefaultAuthenticationRealm()&nbsp;:&nbsp;$realm;
&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;&quot;WWW-Authenticate:&nbsp;OAuth&nbsp;realm=&#39;&quot;&nbsp;.&nbsp;$realm&nbsp;.&nbsp;&quot;&#39;&quot;;

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($error)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;,&nbsp;error=&#39;&quot;&nbsp;.&nbsp;$error&nbsp;.&nbsp;&quot;&#39;&quot;;

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;getVariable(&#39;display_error&#39;)&nbsp;&amp;&amp;&nbsp;$error_description)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;,&nbsp;error_description=&#39;&quot;&nbsp;.&nbsp;$error_description&nbsp;.&nbsp;&quot;&#39;&quot;;

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;getVariable(&#39;display_error&#39;)&nbsp;&amp;&amp;&nbsp;$error_uri)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;,&nbsp;error_uri=&#39;&quot;&nbsp;.&nbsp;$error_uri&nbsp;.&nbsp;&quot;&#39;&quot;;

&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($scope)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;,&nbsp;scope=&#39;&quot;&nbsp;.&nbsp;$scope&nbsp;.&nbsp;&quot;&#39;&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;HTTP/1.1&nbsp;&quot;.&nbsp;$http_status_code);
&nbsp;&nbsp;&nbsp;&nbsp;header($result);

&nbsp;&nbsp;&nbsp;&nbsp;exit;
&nbsp;&nbsp;}
}</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;代码比较多。有兴趣的可以细看。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于采用Vendor方法引入，所以这里的文件都没有采用命名空间。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-3、在同目录下，建ThinkOAuth2.php文件，这个文件里的类继承上面那个基类：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;?phprequire&nbsp;&quot;oauth2.class.php&quot;;class&nbsp;ThinkOAuth2&nbsp;extends&nbsp;OAuth2{&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;$db;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;$table;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;构造
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;__construct()&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent::__construct();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;=&nbsp;M();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;table&nbsp;=&nbsp;array(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;auth_codes&#39;=&gt;C(&#39;OAUTH2_CODES_TABLE&#39;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;clients&#39;=&gt;C(&#39;OAUTH2_CLIENTS_TABLE&#39;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;tokens&#39;=&gt;C(&#39;OAUTH2_TOKEN_TABLE&#39;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;析构
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;__destruct()&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;db&nbsp;=&nbsp;NULL;&nbsp;//&nbsp;Release&nbsp;db&nbsp;connection&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;function&nbsp;handleException($e)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&quot;Database&nbsp;error:&nbsp;&quot;&nbsp;.&nbsp;$e-&gt;getMessage();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;增加client
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$client_id
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$client_secret
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$redirect_uri
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;addClient($client_id,&nbsp;$client_secret,&nbsp;$redirect_uri)&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$time&nbsp;=&nbsp;time();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;{$this&nbsp;-&gt;&nbsp;table[&#39;clients&#39;]}&nbsp;(client_id,&nbsp;client_secret,&nbsp;redirect_uri,create_time)&nbsp;VALUES&nbsp;(&#39;{$client_id}&#39;,&nbsp;&#39;{$client_secret}&#39;,&nbsp;&#39;{$redirect_uri}&#39;,&#39;{$time}&#39;)&quot;;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;-&gt;&nbsp;execute($sql);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;res;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Implements&nbsp;OAuth2::checkClientCredentials()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::checkClientCredentials()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;function&nbsp;checkClientCredentials($client_id,&nbsp;$client_secret&nbsp;=&nbsp;NULL)&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;&quot;SELECT&nbsp;client_secret&nbsp;FROM&nbsp;{$this&nbsp;-&gt;&nbsp;table[&#39;clients&#39;]}&nbsp;WHERE&nbsp;client_id&nbsp;=&nbsp;{$client_id}&quot;;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;-&gt;&nbsp;query($sql);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($client_secret&nbsp;===&nbsp;NULL)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$result&nbsp;!==&nbsp;FALSE;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;checkClientCredentials&nbsp;:&nbsp;&quot;.$result);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;checkClientCredentials&nbsp;:&nbsp;&quot;.$result[0]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;checkClientCredentials&nbsp;:&nbsp;&quot;.$result[0][&quot;client_secret&quot;]);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$result[0][&quot;client_secret&quot;]&nbsp;==&nbsp;$client_secret;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Implements&nbsp;OAuth2::getRedirectUri().
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::getRedirectUri()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;function&nbsp;getRedirectUri($client_id)&nbsp;{
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;&quot;SELECT&nbsp;redirect_uri&nbsp;FROM&nbsp;{$this&nbsp;-&gt;&nbsp;table[&#39;clients&#39;]}&nbsp;WHERE&nbsp;client_id&nbsp;=&nbsp;{$client_id}&quot;;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;-&gt;&nbsp;query($sql);
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($result&nbsp;===&nbsp;FALSE)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getRedirectUri&nbsp;:&nbsp;&quot;.$result);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getRedirectUri&nbsp;:&nbsp;&quot;.$result[0]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getRedirectUri&nbsp;:&nbsp;&quot;.$result[0][&quot;redirect_uri&quot;]);
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;isset($result[0][&quot;redirect_uri&quot;])&nbsp;&amp;&amp;&nbsp;$result[0][&quot;redirect_uri&quot;]&nbsp;?&nbsp;$result[0][&quot;redirect_uri&quot;]&nbsp;:&nbsp;NULL;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Implements&nbsp;OAuth2::getAccessToken().
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::getAccessToken()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;function&nbsp;getAccessToken($access_token)&nbsp;{
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;&quot;SELECT&nbsp;client_id,&nbsp;expires_in,&nbsp;scope&nbsp;FROM&nbsp;{$this&nbsp;-&gt;&nbsp;table[&#39;tokens&#39;]}&nbsp;WHERE&nbsp;access_token&nbsp;=&nbsp;&#39;{$access_token}&#39;&quot;;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;-&gt;&nbsp;query($sql);
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getAccessToken&nbsp;:&nbsp;&quot;.$result);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getAccessToken&nbsp;:&nbsp;&quot;.$result[0]);
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$result&nbsp;!==&nbsp;FALSE&nbsp;?&nbsp;$result&nbsp;:&nbsp;NULL;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Implements&nbsp;OAuth2::setAccessToken().
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::setAccessToken()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;function&nbsp;setAccessToken($access_token,&nbsp;$client_id,&nbsp;$expires,&nbsp;$user_id,&nbsp;$scope=NULL,&nbsp;$refresh_token=&#39;&#39;)&nbsp;{
&nbsp;
$sql&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;{$this&nbsp;-&gt;&nbsp;table[&#39;tokens&#39;]}&nbsp;(access_token,&nbsp;client_id,&nbsp;expires_in,&nbsp;scope,user_id,refresh_token)&nbsp;VALUES&nbsp;(&#39;{$access_token}&#39;,&nbsp;&#39;{$client_id}&#39;,&nbsp;&#39;{$expires}&#39;,&nbsp;&#39;{$scope}&#39;,{$user_id},&#39;{$refresh_token}&#39;)&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;-&gt;&nbsp;execute($sql);
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Overrides&nbsp;OAuth2::getSupportedGrantTypes().
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::getSupportedGrantTypes()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;function&nbsp;getSupportedGrantTypes()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OAUTH2_GRANT_TYPE_AUTH_CODE
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Overrides&nbsp;OAuth2::getAuthCode().
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::getAuthCode()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;function&nbsp;getAuthCode($code)&nbsp;{
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;&quot;SELECT&nbsp;user_id,&nbsp;code,&nbsp;client_id,&nbsp;redirect_uri,&nbsp;expires,&nbsp;scope&nbsp;FROM&nbsp;{$this&nbsp;-&gt;&nbsp;table[&#39;auth_codes&#39;]}&nbsp;WHERE&nbsp;code&nbsp;=&nbsp;&#39;{$code}&#39;&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;-&gt;&nbsp;query($sql);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getAuthcode&nbsp;:&nbsp;&quot;.$result);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getAuthcode&nbsp;:&nbsp;&quot;.$result[0]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getAuthcode&nbsp;:&nbsp;&quot;.$result[0][&quot;code&quot;]);
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$result&nbsp;!==&nbsp;FALSE&nbsp;?&nbsp;$result[0]&nbsp;:&nbsp;NULL;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Overrides&nbsp;OAuth2::setAuthCode().
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::setAuthCode()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;function&nbsp;setAuthCode($code,&nbsp;$client_id,&nbsp;$redirect_uri,&nbsp;$expires,&nbsp;$scope&nbsp;=&nbsp;NULL)&nbsp;{
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$time&nbsp;=&nbsp;time();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;{$this&nbsp;-&gt;&nbsp;table[&#39;auth_codes&#39;]}&nbsp;(code,&nbsp;client_id,&nbsp;redirect_uri,&nbsp;expires,&nbsp;scope)&nbsp;VALUES&nbsp;(&#39;{$code}&#39;,&nbsp;&#39;{$client_id}&#39;,&nbsp;&#39;{$redirect_uri}&#39;,&nbsp;&#39;{$expires}&#39;,&nbsp;&#39;{$scope}&#39;)&quot;;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;-&gt;&nbsp;execute($sql);
&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;*&nbsp;Overrides&nbsp;OAuth2::checkUserCredentials().
&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::checkUserCredentials()
&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;protected&nbsp;function&nbsp;checkUserCredentials($client_id,&nbsp;$username,&nbsp;$password){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;
&nbsp;&nbsp;}
&nbsp;&nbsp;

}</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">这里涉及到一些数据库的操作。继承出来操作，还是比较一目了然的。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-4、准备好类了。我们就可以实现控制器里的功能代码。动手之前先搞清楚我们的意图。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;首先，我们需要分配一个oauth_client和一个oauth_secrete给第三方网站（也就是client.ruanwenwu.cn)来获取oauth服务。 &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其次，client.ruanwenwu.cn会把用户导入到server.ruanwenwu.cn来进行授权。所以我们我们还需要准备授权页面。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;因为涉及到服务端和客户端的数据交互，所以可能服务端和客户端的相关介绍我会交叉进行。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-4-1、创建oauth_client。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-4-2、获取oauth_cliest列表。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-4-3、准备获取用户授权的页面和逻辑。（授权服务器）</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-4-4、准备提供用户数据的逻辑。（资源服务器）</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这些逻辑我都写在一个控制器OauthController.class.php里。代码如下：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;?phpnamespace&nbsp;Home\\Controller;use&nbsp;Think\\Controller;class&nbsp;OauthController&nbsp;extends&nbsp;Controller{&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;$oauth&nbsp;=&nbsp;NULL;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;_initialize(){&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;Content-Type:&nbsp;application/json&quot;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Vendor(&quot;oauth.ThinkOAuth2&quot;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;=&nbsp;new&nbsp;\\ThinkOAuth2();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;index(){&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;Content-Type:application/json;&nbsp;charset=utf-8&quot;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;ajaxReturn(null,&nbsp;&#39;oauth-server-start&#39;,&nbsp;1,&nbsp;&#39;json&#39;);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;access_token()&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;-&gt;&nbsp;grantAccessToken();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//权限验证&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;authorize()&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(IS_POST)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(true){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//这个地方验证成功后要把用户的uid加进来&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_POST[&#39;user_id&#39;]&nbsp;=&nbsp;1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;-&gt;&nbsp;finishClientAuthorization(true,&nbsp;$_POST);&nbsp;&nbsp;&nbsp;&nbsp;//第一个参数很重要，是用户是否授权&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;///表单准备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$auth_params&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;-&gt;&nbsp;getAuthorizeParams();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;assign(&quot;auth_params&quot;,$auth_params);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;display();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;addclient()&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&#39;jack&#39;;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(IS_POST)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&#39;pd&#39;;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;-&gt;&nbsp;addClient($_POST[&quot;client_id&quot;],&nbsp;$_POST[&quot;client_secret&quot;],&nbsp;$_POST[&quot;redirect_uri&quot;]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($res){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;redirect(&quot;/home/Oauth/clientlist&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;display();
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;clientlist(){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res&nbsp;=&nbsp;M()-&gt;table(&quot;oauth_client&quot;)-&gt;select();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;assign(&quot;clients&quot;,$res);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var_dump($res);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;display();
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">顺便我将用到的模板文件（server.ruanwenwu.cn\\Application\\Home\\View\\oauth目录下）也贴出来给大家参考一下：</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">addclient.html</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;!doctype&nbsp;html&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;head&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;charset=&quot;utf-8&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;title&gt;这里是添加客户端界面&lt;/title&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/head&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;body&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;h1&gt;添加客户端&lt;/h1&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;form&nbsp;action=&quot;&quot;&nbsp;method=&quot;post&quot;&nbsp;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientId:&lt;input&nbsp;type=&quot;text&quot;&nbsp;name=&quot;client_id&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;/&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client_secrete:&lt;input&nbsp;type=&quot;text&quot;&nbsp;name=&quot;client_secret&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;/&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackUrl:&lt;input&nbsp;type=&quot;text&quot;&nbsp;name=&quot;redirect_uri&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input&nbsp;type=&quot;submit&quot;&nbsp;value=&quot;submit&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/form&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/body&gt;&lt;/html&gt;</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">authorize.html</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;!doctype&nbsp;html&gt;&lt;html&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;form&nbsp;action=&quot;&quot;&nbsp;method=&quot;post&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;用户名：&lt;input&nbsp;type=&quot;text&quot;&nbsp;name=&quot;username&quot;&nbsp;/&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;/&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;密码：&lt;input&nbsp;type=&quot;text&quot;&nbsp;name=&quot;pwd&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input&nbsp;type=&quot;hidden&quot;&nbsp;name=&quot;response_type&quot;&nbsp;value=&quot;code&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input&nbsp;type=&quot;hidden&quot;&nbsp;name=&quot;client_id&quot;&nbsp;value=&quot;{$auth_params[&#39;client_id&#39;]}&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input&nbsp;type=&quot;hidden&quot;&nbsp;name=&quot;redirect_uri&quot;&nbsp;value=&quot;{$auth_params[&#39;redirect_uri&#39;]}&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input&nbsp;type=&quot;submit&quot;&nbsp;value=&quot;submit&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/form&gt;&lt;/html&gt;</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">注意：我这里用到了几个隐藏域。这个是必须的，在post提交验证时会用到。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-4-5、创建oauth2.0用户。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;打 开server.ruanwenwu.cn/index.php/home/oauth/addcient,输入client_id和 client_secrete还有redirect_uri创建一个oauth2.0用户。其中redirect_uri是用户授权后需要跳转的地方。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">到这里服务端的部署就差不多结束了。现在开始部署客户端。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\"><strong>三、oauth2.0客户端搭建。</strong></p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;1、同服务端一样搭建client.ruanwenwu.cn。（也是用thinkphp)。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;2、能正常访问后。在类库中加入oauth2.0客户端类。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在\\client.ruanwenwu.cn\\ThinkPHP\\Library\\Org\\Util目录下建立Oauth2.class.php，代码如下：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;?phpnamespace&nbsp;Org\\Util;/**
&nbsp;*&nbsp;与&nbsp;OAuth2&nbsp;服务器&nbsp;通讯验证&nbsp;核心类&nbsp;(PHP版)
&nbsp;*&nbsp;
&nbsp;*&nbsp;@description&nbsp;OAuth2&nbsp;说明请大家参考&nbsp;木蚂蚁接口文档
&nbsp;*
&nbsp;*
&nbsp;*&nbsp;@author&nbsp;&nbsp;&nbsp;Mumayi-Team&nbsp;(zhaopan赵攀)
&nbsp;*&nbsp;@version&nbsp;&nbsp;1.0
&nbsp;*&nbsp;@datetime&nbsp;2013-12-31
&nbsp;*/class&nbsp;Oauth2{&nbsp;&nbsp;&nbsp;&nbsp;/*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;以下几个参数&nbsp;具体作用和用法&nbsp;详见&nbsp;木蚂蚁接口文档
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//分配的客户端&nbsp;ID&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$client_id;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//分配的客户端&nbsp;密匙&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$client_secret;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//获得的&nbsp;用户授权&nbsp;访问令牌&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$access_token;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//刷新&nbsp;访问令牌&nbsp;(过期时使用)&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$refresh_token;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;最后一个收到的HTTP代码&nbsp;(用于调试，忽略)&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$http_code;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//预留字段&nbsp;(忽略)&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$url;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//设置&nbsp;基础链接&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$host&nbsp;=&nbsp;&quot;http://server.ruanwenwu.cn/index.php/home/oauth/&quot;;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//请求超时时间&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$timeout&nbsp;=&nbsp;30;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//链接超时时间&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$connecttimeout&nbsp;=&nbsp;30;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//是否验证&nbsp;SSL&nbsp;证书&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$ssl_verifypeer&nbsp;=&nbsp;FALSE;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//请求结果处理格式&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$format&nbsp;=&nbsp;&#39;json&#39;;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//以&nbsp;JSON_DECODE&nbsp;方式解析&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$decode_json&nbsp;=&nbsp;TRUE;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//预留字段&nbsp;(忽略)&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$http_info;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//CURL&nbsp;函数使用&nbsp;(验证使用，&nbsp;忽略)&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$useragent&nbsp;=&nbsp;&#39;Mumayi&nbsp;Team&nbsp;OAuth2&nbsp;v1.0&#39;;&nbsp;&nbsp;&nbsp;&nbsp;//是否&nbsp;开启&nbsp;请求调试&nbsp;(开启时&nbsp;将输出&nbsp;详细的请求结果)&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$debug&nbsp;=&nbsp;FALSE;&nbsp;&nbsp;&nbsp;&nbsp;//边界&nbsp;(CURL使用&nbsp;写入在Header的分界线,&nbsp;忽略)&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;$boundary&nbsp;=&nbsp;&#39;&#39;;&nbsp;&nbsp;&nbsp;&nbsp;//返回&nbsp;OAuth&nbsp;令牌&nbsp;请求地址&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;accessTokenURL()&nbsp;&nbsp;{&nbsp;return&nbsp;$this-&gt;host.&#39;access_token&#39;;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//返回&nbsp;OAuth&nbsp;自动授权&nbsp;请求地址&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;authorizeURL()&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;return&nbsp;$this-&gt;host.&#39;authorize&#39;;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;//构造函数&nbsp;赋值&nbsp;一些必要参数&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;__construct($client_id,&nbsp;$client_secret,&nbsp;$access_token&nbsp;=&nbsp;NULL,&nbsp;$refresh_token&nbsp;=&nbsp;NULL)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;client_id&nbsp;=&nbsp;$client_id;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;client_secret&nbsp;=&nbsp;$client_secret;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;access_token&nbsp;=&nbsp;$access_token;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;refresh_token&nbsp;=&nbsp;$refresh_token;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;$this-&gt;debug&nbsp;=&nbsp;true;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;authorize接口
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;对应API：{@link&nbsp;http://u.mumayi.com/oauth/authorize&nbsp;Oauth2/authorize}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$url&nbsp;授权后的回调地址,站外应用需与回调地址一致,站内应用需要填写canvas&nbsp;page的地址
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$response_type&nbsp;支持的值包括&nbsp;code&nbsp;和token&nbsp;默认值为code
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$state&nbsp;用于保持请求和回调的状态。在回调时,会在Query&nbsp;Parameter中回传该参数
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$display&nbsp;授权页面类型&nbsp;可选范围:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;default&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;默认授权页面
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;mobile&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;支持html5的手机
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;popup&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;弹窗授权页
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;wap1.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wap1.2页面
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;wap2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wap2.0页面
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;js&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;js-sdk&nbsp;专用&nbsp;授权页面是弹窗，返回结果为js-sdk回掉函数
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;apponweibo&nbsp;&nbsp;&nbsp;&nbsp;站内应用专用,站内应用不传display参数,并且response_type为token时,默认使用改display.授权后不会返回access_token，只是输出js刷新站内应用父框架
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;getAuthorizeURL(&nbsp;$url,&nbsp;$response_type&nbsp;=&nbsp;&#39;code&#39;,&nbsp;$state&nbsp;=&nbsp;NULL,&nbsp;$display&nbsp;=&nbsp;NULL&nbsp;)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params&nbsp;=&nbsp;array();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;client_id&#39;]&nbsp;=&nbsp;$this-&gt;client_id;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;redirect_uri&#39;]&nbsp;=&nbsp;$url;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;response_type&#39;]&nbsp;=&nbsp;$response_type;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;state&#39;]&nbsp;=&nbsp;$state;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;display&#39;]&nbsp;=&nbsp;$display;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;authorizeURL()&nbsp;.&nbsp;&quot;&amp;&quot;&nbsp;.&nbsp;http_build_query($params);
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;access_token接口
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;对应API：{@link&nbsp;http://open.weibo.com/wiki/OAuth2/access_token&nbsp;OAuth2/access_token}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$type&nbsp;请求的类型,可以为:code,&nbsp;password,&nbsp;token
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;array&nbsp;$keys&nbsp;其他参数：
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;当$type为code时：&nbsp;array(&#39;code&#39;=&gt;...,&nbsp;&#39;redirect_uri&#39;=&gt;...)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;当$type为password时：&nbsp;array(&#39;username&#39;=&gt;...,&nbsp;&#39;password&#39;=&gt;...)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;当$type为token时：&nbsp;array(&#39;refresh_token&#39;=&gt;...)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;getAccessToken(&nbsp;$type&nbsp;=&nbsp;&#39;code&#39;,&nbsp;$keys&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params&nbsp;=&nbsp;array();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;client_id&#39;]&nbsp;=&nbsp;$this-&gt;client_id;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;client_secret&#39;]&nbsp;=&nbsp;$this-&gt;client_secret;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;$type&nbsp;===&nbsp;&#39;token&#39;&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;grant_type&#39;]&nbsp;=&nbsp;&#39;refresh_token&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;refresh_token&#39;]&nbsp;=&nbsp;$keys[&#39;refresh_token&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(&nbsp;$type&nbsp;===&nbsp;&#39;code&#39;&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;grant_type&#39;]&nbsp;=&nbsp;&#39;authorization_code&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;code&#39;]&nbsp;=&nbsp;$keys[&#39;code&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;redirect_uri&#39;]&nbsp;=&nbsp;$keys[&#39;redirect_uri&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(&nbsp;$type&nbsp;===&nbsp;&#39;password&#39;&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;grant_type&#39;]&nbsp;=&nbsp;&#39;password&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;username&#39;]&nbsp;=&nbsp;$keys[&#39;username&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;password&#39;]&nbsp;=&nbsp;$keys[&#39;password&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;json_encode(array(&#39;error&#39;&nbsp;=&gt;&nbsp;&#39;错误的授权类型[&#39;.$type.&#39;(token,&nbsp;code)]&#39;));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$this-&gt;oAuthRequest($this-&gt;accessTokenURL(),&nbsp;&#39;POST&#39;,&nbsp;$params);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//var_dump($response);die;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;json_decode($response,&nbsp;true);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;is_array($token)&nbsp;&amp;&amp;&nbsp;!isset($token[&#39;error&#39;])&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;access_token&nbsp;=&nbsp;$token[&#39;access_token&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$this-&gt;refresh_token&nbsp;=&nbsp;$token[&#39;refresh_token&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;json_encode(array(&#39;error&#39;&nbsp;=&gt;&nbsp;&#39;获取访问令牌失败。[&#39;.$token[&#39;error&#39;].&#39;]&#39;));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$token;
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;解析&nbsp;signed_request
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$signed_request&nbsp;应用框架在加载iframe时会通过向Canvas&nbsp;URL&nbsp;post的参数signed_request
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;parseSignedRequest($signed_request)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list($encoded_sig,&nbsp;$payload)&nbsp;=&nbsp;explode(&#39;.&#39;,&nbsp;$signed_request,&nbsp;2);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sig&nbsp;=&nbsp;self::base64decode($encoded_sig)&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data&nbsp;=&nbsp;json_decode(self::base64decode($payload),&nbsp;true);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strtoupper($data[&#39;algorithm&#39;])&nbsp;!==&nbsp;&#39;HMAC-SHA256&#39;)&nbsp;return&nbsp;&#39;-1&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$expected_sig&nbsp;=&nbsp;hash_hmac(&#39;sha256&#39;,&nbsp;$payload,&nbsp;$this-&gt;client_secret,&nbsp;true);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;($sig&nbsp;!==&nbsp;$expected_sig)?&nbsp;&#39;-2&#39;:$data;
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@ignore
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;base64decode($str)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;base64_decode(strtr($str.str_repeat(&#39;=&#39;,&nbsp;(4&nbsp;-&nbsp;strlen($str)&nbsp;%&nbsp;4)),&nbsp;&#39;-_&#39;,&nbsp;&#39;+/&#39;));
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;读取jssdk授权信息，用于和jssdk的同步登录
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array&nbsp;成功返回array(&#39;access_token&#39;=&gt;&#39;value&#39;,&nbsp;&#39;refresh_token&#39;=&gt;&#39;value&#39;);&nbsp;失败返回false
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;getTokenFromJSSDK()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key&nbsp;=&nbsp;&quot;mumayijs_&quot;&nbsp;.&nbsp;$this-&gt;client_id;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;isset($_COOKIE[$key])&nbsp;&amp;&amp;&nbsp;$cookie&nbsp;=&nbsp;$_COOKIE[$key]&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parse_str($cookie,&nbsp;$token);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;isset($token[&#39;access_token&#39;])&nbsp;&amp;&amp;&nbsp;isset($token[&#39;refresh_token&#39;])&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;access_token&nbsp;=&nbsp;$token[&#39;access_token&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;refresh_token&nbsp;=&nbsp;$token[&#39;refresh_token&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$token;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;从数组中读取access_token和refresh_token
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;常用于从Session或Cookie中读取token，或通过Session/Cookie中是否存有token判断登录状态。
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;array&nbsp;$arr&nbsp;存有access_token和secret_token的数组
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array&nbsp;成功返回array(&#39;access_token&#39;=&gt;&#39;value&#39;,&nbsp;&#39;refresh_token&#39;=&gt;&#39;value&#39;);&nbsp;失败返回false
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;getTokenFromArray(&nbsp;$arr&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($arr[&#39;access_token&#39;])&nbsp;&amp;&amp;&nbsp;$arr[&#39;access_token&#39;])&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;array();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;access_token&nbsp;=&nbsp;$token[&#39;access_token&#39;]&nbsp;=&nbsp;$arr[&#39;access_token&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($arr[&#39;refresh_token&#39;])&nbsp;&amp;&amp;&nbsp;$arr[&#39;refresh_token&#39;])&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;refresh_token&nbsp;=&nbsp;$token[&#39;refresh_token&#39;]&nbsp;=&nbsp;$arr[&#39;refresh_token&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$token;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;以&nbsp;GET&nbsp;请求方式&nbsp;请求&nbsp;OAuth&nbsp;验证服务器
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;mixed
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;get($url,&nbsp;$parameters&nbsp;=&nbsp;array())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$this-&gt;oAuthRequest($url,&nbsp;&#39;GET&#39;,&nbsp;$parameters);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;format&nbsp;===&nbsp;&#39;json&#39;&nbsp;&amp;&amp;&nbsp;$this-&gt;decode_json)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;json_decode($response,&nbsp;true);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;以&nbsp;POST&nbsp;请求方式&nbsp;请求&nbsp;OAuth&nbsp;验证服务器
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;mixed
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;post($url,&nbsp;$parameters&nbsp;=&nbsp;array(),&nbsp;$multi&nbsp;=&nbsp;false)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$this-&gt;oAuthRequest($url,&nbsp;&#39;POST&#39;,&nbsp;$parameters,&nbsp;$multi&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;format&nbsp;===&nbsp;&#39;json&#39;&nbsp;&amp;&amp;&nbsp;$this-&gt;decode_json)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;json_decode($response,&nbsp;true);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;请求&nbsp;OAuth&nbsp;验证服务器&nbsp;进行验证
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;string
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;oAuthRequest($url,&nbsp;$method,&nbsp;$parameters,&nbsp;$multi&nbsp;=&nbsp;false)&nbsp;{

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strrpos($url,&nbsp;&#39;http://&#39;)&nbsp;!==&nbsp;0&nbsp;&amp;&amp;&nbsp;strrpos($url,&nbsp;&#39;https://&#39;)&nbsp;!==&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url&nbsp;=&nbsp;&quot;{$this-&gt;host}{$url}.{$this-&gt;format}&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;($method)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;&#39;GET&#39;:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!empty($parameters))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url&nbsp;=&nbsp;$url&nbsp;.&nbsp;&#39;&amp;&#39;&nbsp;.&nbsp;http_build_query($parameters);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;http($url,&nbsp;&#39;GET&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers&nbsp;=&nbsp;array();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$multi&nbsp;&amp;&amp;&nbsp;(is_array($parameters)&nbsp;||&nbsp;is_object($parameters))&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body&nbsp;=&nbsp;http_build_query($parameters);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body&nbsp;=&nbsp;self::build_http_query_multi($parameters);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers[]&nbsp;=&nbsp;&quot;Content-Type:&nbsp;multipart/form-data;&nbsp;boundary=&quot;&nbsp;.&nbsp;self::$boundary;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//return&nbsp;$this-&gt;http($url,&nbsp;$method,&nbsp;$body,&nbsp;$headers);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;http($url,&nbsp;$method,&nbsp;$body,&nbsp;$headers);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;使用&nbsp;CURL&nbsp;模拟一个&nbsp;HTTP&nbsp;请求&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@description&nbsp;(需要开启&nbsp;CURL&nbsp;扩展)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;string&nbsp;API&nbsp;results
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;http($url,&nbsp;$method,&nbsp;$postfields&nbsp;=&nbsp;NULL,&nbsp;$headers&nbsp;=&nbsp;array())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;http_info&nbsp;=&nbsp;array();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ci&nbsp;=&nbsp;curl_init();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;Curl&nbsp;settings&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_HTTP_VERSION,&nbsp;CURL_HTTP_VERSION_1_0);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_USERAGENT,&nbsp;$this-&gt;useragent);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_CONNECTTIMEOUT,&nbsp;$this-&gt;connecttimeout);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_TIMEOUT,&nbsp;$this-&gt;timeout);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_RETURNTRANSFER,&nbsp;TRUE);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_ENCODING,&nbsp;&quot;&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_SSL_VERIFYPEER,&nbsp;$this-&gt;ssl_verifypeer);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_SSL_VERIFYHOST,&nbsp;1);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_HEADERFUNCTION,&nbsp;array($this,&nbsp;&#39;getHeader&#39;));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_HEADER,&nbsp;FALSE);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;($method)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;&#39;POST&#39;:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_POST,&nbsp;TRUE);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!empty($postfields))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_POSTFIELDS,&nbsp;$postfields);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;postdata&nbsp;=&nbsp;$postfields;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;&#39;DELETE&#39;:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_CUSTOMREQUEST,&nbsp;&#39;DELETE&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!empty($postfields))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url&nbsp;=&nbsp;&quot;{$url}?{$postfields}&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;isset($this-&gt;access_token)&nbsp;&amp;&amp;&nbsp;$this-&gt;access_token&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers[]&nbsp;=&nbsp;&quot;Authorization:&nbsp;OAuth2&nbsp;&quot;.$this-&gt;access_token;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!empty($this-&gt;remote_ip)&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;defined(&#39;SAE_ACCESSKEY&#39;)&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers[]&nbsp;=&nbsp;&quot;SaeRemoteIP:&nbsp;&quot;&nbsp;.&nbsp;$this-&gt;remote_ip;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers[]&nbsp;=&nbsp;&quot;API-RemoteIP:&nbsp;&quot;&nbsp;.&nbsp;$this-&gt;remote_ip;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!defined(&#39;SAE_ACCESSKEY&#39;)&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers[]&nbsp;=&nbsp;&quot;API-RemoteIP:&nbsp;&quot;&nbsp;.&nbsp;$_SERVER[&#39;REMOTE_ADDR&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_URL,&nbsp;$url&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_HTTPHEADER,&nbsp;$headers&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLINFO_HEADER_OUT,&nbsp;TRUE&nbsp;);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;curl_exec($ci);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;http_code&nbsp;=&nbsp;curl_getinfo($ci,&nbsp;CURLINFO_HTTP_CODE);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;http_info&nbsp;=&nbsp;array_merge($this-&gt;http_info,&nbsp;curl_getinfo($ci));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;url&nbsp;=&nbsp;$url;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;debug)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&quot;=====post&nbsp;data======\\r\\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var_dump($postfields);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&quot;=====headers======\\r\\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_r($headers);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&#39;=====request&nbsp;info=====&#39;.&quot;\\r\\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_r(&nbsp;curl_getinfo($ci)&nbsp;);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&#39;=====response=====&#39;.&quot;\\r\\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_r(&nbsp;$response&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_close&nbsp;($ci);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;从结果中&nbsp;获取&nbsp;header&nbsp;参数&nbsp;(CURL&nbsp;使用)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;int
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@ignore&nbsp;(忽略)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;getHeader($ch,&nbsp;$header)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i&nbsp;=&nbsp;strpos($header,&nbsp;&#39;:&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!empty($i))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key&nbsp;=&nbsp;str_replace(&#39;-&#39;,&nbsp;&#39;_&#39;,&nbsp;strtolower(substr($header,&nbsp;0,&nbsp;$i)));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value&nbsp;=&nbsp;trim(substr($header,&nbsp;$i&nbsp;+&nbsp;2));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;http_header[$key]&nbsp;=&nbsp;$value;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;strlen($header);
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;把要传递的参数&nbsp;重新构造一下&nbsp;(多维数组)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@ignore&nbsp;(忽略)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;function&nbsp;build_http_query_multi($params)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$params)&nbsp;return&nbsp;&#39;&#39;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uksort($params,&nbsp;&#39;strcmp&#39;);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pairs&nbsp;=&nbsp;array();

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$boundary&nbsp;=&nbsp;$boundary&nbsp;=&nbsp;uniqid(&#39;------------------&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$MPboundary&nbsp;=&nbsp;&#39;--&#39;.$boundary;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$endMPboundary&nbsp;=&nbsp;$MPboundary.&nbsp;&#39;--&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;=&nbsp;&#39;&#39;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($params&nbsp;as&nbsp;$parameter&nbsp;=&gt;&nbsp;$value)&nbsp;{

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;in_array($parameter,&nbsp;array(&#39;pic&#39;,&nbsp;&#39;image&#39;))&nbsp;&amp;&amp;&nbsp;$value{0}&nbsp;==&nbsp;&#39;@&#39;&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url&nbsp;=&nbsp;ltrim(&nbsp;$value,&nbsp;&#39;@&#39;&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content&nbsp;=&nbsp;file_get_contents(&nbsp;$url&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$array&nbsp;=&nbsp;explode(&nbsp;&#39;?&#39;,&nbsp;basename(&nbsp;$url&nbsp;)&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$filename&nbsp;=&nbsp;$array[0];

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;$MPboundary&nbsp;.&nbsp;&quot;\\r\\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;&#39;Content-Disposition:&nbsp;form-data;&nbsp;name=&quot;&#39;&nbsp;.&nbsp;$parameter&nbsp;.&nbsp;&#39;&quot;;&nbsp;filename=&quot;&#39;&nbsp;.&nbsp;$filename&nbsp;.&nbsp;&#39;&quot;&#39;.&nbsp;&quot;\\r\\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;&quot;Content-Type:&nbsp;image/unknown\\r\\n\\r\\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;$content.&nbsp;&quot;\\r\\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;$MPboundary&nbsp;.&nbsp;&quot;\\r\\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;&#39;content-disposition:&nbsp;form-data;&nbsp;name=&quot;&#39;&nbsp;.&nbsp;$parameter&nbsp;.&nbsp;&quot;\\&quot;\\r\\n\\r\\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;$value.&quot;\\r\\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;$endMPboundary;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$multipartbody;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;get_uid()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hostUrl&nbsp;=&nbsp;&#39;http://server.ruanwenwu.cn/index.php/home/resource/userinfo?type=mumayi&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params&nbsp;=&nbsp;array(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;access_token&#39;&nbsp;=&gt;&nbsp;$this-&gt;access_token,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;get(&nbsp;$hostUrl,&nbsp;$params&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">注意：这个类的加载跟服务端采用的不同的方式。这里用了命名空间。服务端用的vendor。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3、准备访问链接。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们通过这个url将用户导向server.ruanwenwu.cn进行授权，发送accesss_code操作。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我在client.ruanwenwu.cn的index控制器中实现的这个url。控制器里没有逻辑，我只贴index.html了：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;!doctype&nbsp;html&gt;&lt;html&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;head&gt;&lt;/head&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;body&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://server.ruanwenwu.cn/index.php/home/oauth/authorize?redirect_uri=http://client.ruanwenwu.cn/index.php/home/login&amp;response_type=code&amp;client_id=10009174&amp;type=123456&quot;&gt;登陆&lt;/a&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/body&gt;&lt;/html&gt;</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注 意：这个url中redirect_uri,response_type为必选参数。而且这个redirect_uri必须包含我们在服务端添加 oauth服务时写的那个redirect_uri。否则不能通过验证。（也就是说：在我们这个例子里，这个redirect_uri必须包含：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">http://client.ruanwenwu.cn/index.php/home/login</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4、点击链接，跳转到服务端对应的url。实际上就是server.ruanwenwu.cn的authorize操作。在这里会对用户进行验证，并判断是否授权。</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&nbsp;&nbsp;&nbsp;&nbsp;//权限验证&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;authorize()&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(IS_POST)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(true){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//这个地方验证成功后要把用户的uid加进来&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_POST[&#39;user_id&#39;]&nbsp;=&nbsp;1;&nbsp;&nbsp;&nbsp;&nbsp;//这里是写死的，实际上是从数据库读出来&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;-&gt;&nbsp;finishClientAuthorization(true,&nbsp;$_POST);&nbsp;&nbsp;&nbsp;&nbsp;//第一个参数很重要，是用户是否授权&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;///表单准备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$auth_params&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;-&gt;&nbsp;getAuthorizeParams();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;assign(&quot;auth_params&quot;,$auth_params);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;display();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注意看我在这个操作里写的注释。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;验证成功后，页面又跳回到我们之前写的redirect_uri，并带上了code参数，这就是验证服务器向客户端发送的access_code。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5、客户端拿到access_code，向验证服务器请求access_token。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在我的client.ruanwenwu.cn的loginController.class.php中进行：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;?phpnamespace&nbsp;Home\\Controller;use&nbsp;Think\\Controller;use&nbsp;Org\\Util\\Oauth2;class&nbsp;LoginController&nbsp;extends&nbsp;Controller{&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;_initialize(){&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;index(){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;oauth&nbsp;=&nbsp;new&nbsp;Oauth2(&#39;10009174&#39;,&#39;123456&#39;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$keys&nbsp;=&nbsp;array();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//keys&nbsp;数组&nbsp;赋值&nbsp;code&nbsp;值&nbsp;(换取token,&nbsp;必须参数)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$keys[&#39;code&#39;]&nbsp;=&nbsp;$_GET[&#39;code&#39;];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//keys&nbsp;数组&nbsp;赋值&nbsp;回调地址信息&nbsp;(换取token,&nbsp;必须参数)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$keys[&#39;redirect_uri&#39;]&nbsp;=&nbsp;&#39;http://client.ruanwenwu.cn/index.php/home/login?type=mumayidev&#39;;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//根据&nbsp;code&nbsp;获取&nbsp;token&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//var_dump(&nbsp;$token&nbsp;=&nbsp;$this-&gt;oauth-&gt;getAccessToken(&nbsp;&#39;code&#39;,&nbsp;$keys&nbsp;))&nbsp;;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;$this-&gt;oauth-&gt;getAccessToken(&nbsp;&#39;code&#39;,&nbsp;$keys&nbsp;)&nbsp;;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//现在已经得到token，并且将access_token写到对象里了。就可以请求资源了&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var_dump(&nbsp;$this-&gt;oauth-&gt;get_uid());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die;&nbsp;&nbsp;&nbsp;&nbsp;}}</pre><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;$this-&gt;oauth-&gt;getAccessToken(&nbsp;&#39;code&#39;,&nbsp;$keys&nbsp;)&nbsp;;&nbsp;&nbsp;&nbsp;&nbsp;//这就是请求代码。code是验证方式。$keys数组里要code和redirect_uri。在服务器端需要验证</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">服务端的响应是这样的：</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">验证client.ruanwenwu.cn的client_id和secrete是否合法，还要判读access_code是否过期</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;access_token()&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;-&gt;&nbsp;grantAccessToken();&nbsp;&nbsp;&nbsp;&nbsp;//这个方法里有所有的验证及生成access_token的操作。（会有数据库的写入）&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">服务端生成access_token之后，会返回给客户端。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">客户端拿到access_token之后，向资源服务器请求用户资源：</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">在这里我的验证服务器和资源服务器都是server.ruanwenwu.cn。我用resourceController.class.php来做资源控制：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;?phpnamespace&nbsp;Home\\Controller;use&nbsp;Think\\Controller;class&nbsp;ResourceController&nbsp;extends&nbsp;Controller{&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;$db;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;_initialize(){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;db&nbsp;=&nbsp;M();&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;userinfo(){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;$arr&nbsp;=&nbsp;array(&quot;username&quot;=&gt;&quot;阮文武&quot;,&quot;sex&quot;=&gt;1,&quot;img&quot;=&gt;&quot;http://weewrerfdf&quot;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;echo&nbsp;json_encode($arr);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;die;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($_GET[&#39;access_token&#39;])&nbsp;&amp;&amp;&nbsp;$_GET[&#39;access_token&#39;]){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res&nbsp;=&nbsp;$this-&gt;db-&gt;table(&quot;oauth_token&quot;)-&gt;where(&quot;access_token&nbsp;=&nbsp;&#39;&quot;.$_GET[&#39;access_token&#39;].&quot;&#39;&quot;)-&gt;find();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($res&nbsp;&amp;&amp;&nbsp;count($res)&nbsp;&gt;&nbsp;0){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($res[&#39;expires_in&#39;]&nbsp;&gt;&nbsp;time()){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$arr&nbsp;=&nbsp;array(&quot;username&quot;=&gt;&quot;阮文武d&quot;,&quot;sex&quot;=&gt;1,&quot;img&quot;=&gt;&quot;http://weewrerfdf&quot;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;json_encode($arr);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};&nbsp;&nbsp;&nbsp;&nbsp;}}</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">如果access_token有效，就查到用户id，取出用户的信息。我这里只是做测试，所以就直接自己返回了数据。<br/>原本写的很详细，后来因为内容字段是text，没保存完整，这会时间比较赶，就写的简单一点。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">再抽时间补充吧。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">欢迎大家与我讨论哦。</p><p><br/></p>','1487661321','1487661321','1487661321') [ RunTime:0.1124s ]
SQL: SHOW COLUMNS FROM `z_category` [ RunTime:0.0006s ]
SQL: SELECT * FROM `z_category` WHERE `name` = 'php' LIMIT 1   [ RunTime:0.0003s ]
SQL: SHOW COLUMNS FROM `z_tag` [ RunTime:0.0003s ]
SQL: SELECT * FROM `z_tag` WHERE `name` = '框架' LIMIT 1   [ RunTime:0.0002s ]

[ 2017-02-21T15:15:22+08:00 ] 203.130.43.155 /admin.php/Post/all
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000014s ]
INFO: [ app_init ] --END-- [ RunTime:0.000298s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000304s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000343s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.
SQL: SHOW COLUMNS FROM `z_post` [ RunTime:0.0006s ]
SQL: SELECT COUNT(*) AS tp_count FROM `z_post` LIMIT 1   [ RunTime:0.0002s ]
SQL: SELECT * FROM `z_post` ORDER BY ctime desc LIMIT 0,20   [ RunTime:0.0009s ]
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000067s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000123s ]
NOTIC: [8] Undefined variable: userInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/c171e2b85832ae9943251ee8295bfacb.php 第 361 行.
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.013480s ]
INFO: [ view_parse ] --END-- [ RunTime:0.013520s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000132s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000164s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000350s ]
INFO: [ app_end ] --END-- [ RunTime:0.000388s ]

[ 2017-02-21T15:15:23+08:00 ] 203.130.43.155 /admin.php/Post/all
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000012s ]
INFO: [ app_init ] --END-- [ RunTime:0.000257s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000353s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000391s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.
SQL: SHOW COLUMNS FROM `z_post` [ RunTime:0.0006s ]
SQL: SELECT COUNT(*) AS tp_count FROM `z_post` LIMIT 1   [ RunTime:0.0001s ]
SQL: SELECT * FROM `z_post` ORDER BY ctime desc LIMIT 0,20   [ RunTime:0.0003s ]
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000063s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000112s ]
NOTIC: [8] Undefined variable: userInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/c171e2b85832ae9943251ee8295bfacb.php 第 361 行.
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.013322s ]
INFO: [ view_parse ] --END-- [ RunTime:0.013360s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000119s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000149s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000373s ]
INFO: [ app_end ] --END-- [ RunTime:0.000412s ]

[ 2017-02-21T18:08:36+08:00 ] 203.130.43.155 /admin.php
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000012s ]
INFO: [ app_init ] --END-- [ RunTime:0.000252s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000302s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000339s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.
SQL: SHOW COLUMNS FROM `z_category` [ RunTime:0.0005s ]
SQL: SELECT * FROM `z_category`  [ RunTime:0.0001s ]
SQL: SHOW COLUMNS FROM `z_tag` [ RunTime:0.0003s ]
SQL: SELECT * FROM `z_tag`  [ RunTime:0.0001s ]
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000064s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000104s ]
NOTIC: [8] Undefined variable: userInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/b595b808c2ebeeeb0478ffc30bb4e87a.php 第 361 行.
NOTIC: [8] Undefined variable: hospitalInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/b595b808c2ebeeeb0478ffc30bb4e87a.php 第 424 行.
NOTIC: [8] Undefined variable: hospitalInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/b595b808c2ebeeeb0478ffc30bb4e87a.php 第 438 行.
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.013652s ]
INFO: [ view_parse ] --END-- [ RunTime:0.013686s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000108s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000139s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000320s ]
INFO: [ app_end ] --END-- [ RunTime:0.000363s ]

[ 2017-02-21T18:08:36+08:00 ] 203.130.43.155 /admin.php
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000018s ]
INFO: [ app_init ] --END-- [ RunTime:0.000383s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000490s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000547s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.
SQL: SHOW COLUMNS FROM `z_category` [ RunTime:0.0005s ]
SQL: SELECT * FROM `z_category`  [ RunTime:0.0001s ]
SQL: SHOW COLUMNS FROM `z_tag` [ RunTime:0.0004s ]
SQL: SELECT * FROM `z_tag`  [ RunTime:0.0001s ]
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000065s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000104s ]
NOTIC: [8] Undefined variable: userInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/b595b808c2ebeeeb0478ffc30bb4e87a.php 第 361 行.
NOTIC: [8] Undefined variable: hospitalInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/b595b808c2ebeeeb0478ffc30bb4e87a.php 第 424 行.
NOTIC: [8] Undefined variable: hospitalInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/b595b808c2ebeeeb0478ffc30bb4e87a.php 第 438 行.
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.013670s ]
INFO: [ view_parse ] --END-- [ RunTime:0.013706s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000109s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000140s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000324s ]
INFO: [ app_end ] --END-- [ RunTime:0.000361s ]

[ 2017-02-21T18:10:48+08:00 ] 203.130.43.155 /admin.php/Ajax/addNewPost
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000013s ]
INFO: [ app_init ] --END-- [ RunTime:0.000359s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000321s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000360s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.
NOTIC: [8] Undefined index: id /data/wwwroot/blog/Application/Admin/Controller/AjaxController.class.php 第 53 行.
SQL: SHOW COLUMNS FROM `z_post` [ RunTime:0.0006s ]
SQL: INSERT INTO `z_post` (`title`,`category`,`tag`,`summary`,`content`,`pubtime`,`mtime`,`ctime`) VALUES ('array_multisort','php','','本文摘自php手册，仅作为日常工作参考','<p style=\"margin-top: 0px; margin-bottom: 1.5rem; color: rgb(51, 51, 51); font-family: &quot;Fira Sans&quot;, &quot;Source Sans Pro&quot;, Helvetica, Arial, sans-serif; white-space: normal; background-color: rgb(242, 242, 242);\"><span style=\"text-rendering: optimizeLegibility;\">对数据库结果（当然可以对自定义结果集）进行排序，其实usort也可以实现。除此之外usort还可以对对象进行排序。</span></p><p style=\"margin-top: 0px; margin-bottom: 1.5rem;\">本例中&nbsp;data&nbsp;数组中的每个单元表示一个表中的一行。这是典型的数据库记录的数据集合。</p><p style=\"margin-top: 0px; margin-bottom: 1.5rem;\">例子中的数据如下：</p><pre style=\"white-space: pre-wrap; margin-top: 0px; margin-bottom: 0px;\">volume&nbsp;|&nbsp;edition
-------+--------
&nbsp;&nbsp;&nbsp;&nbsp;67&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2
&nbsp;&nbsp;&nbsp;&nbsp;86&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;85&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6
&nbsp;&nbsp;&nbsp;&nbsp;98&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2
&nbsp;&nbsp;&nbsp;&nbsp;86&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6
&nbsp;&nbsp;&nbsp;&nbsp;67&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7</pre><p style=\"margin-top: 0px; margin-bottom: 1.5rem;\">数据全都存放在名为&nbsp;data&nbsp;的数组中。这通常是通过循环从数据库取得的结果，例如&nbsp;<span class=\"function\"><a href=\"http://php.net/manual/zh/function.mysql-fetch-assoc.php\" class=\"function\" style=\"border-bottom: 1px solid; text-decoration: none; color: rgb(51, 102, 153);\">mysql_fetch_assoc()</a></span>。</p><p><code style=\"font-stretch: normal; font-size: 0.875rem; line-height: 1.5rem; font-family: &quot;Fira Mono&quot;, &quot;Source Code Pro&quot;, monospace; word-wrap: break-word; display: block;\"><span style=\"color: rgb(0, 0, 0);\"><span style=\"color: rgb(0, 0, 187);\">&lt;?php<br/>$data</span><span style=\"color: rgb(0, 119, 0);\">[]&nbsp;=&nbsp;array(</span><span style=\"color: rgb(221, 0, 0);\">&#39;volume&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">67</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(221, 0, 0);\">&#39;edition&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">2</span><span style=\"color: rgb(0, 119, 0);\">);<br/></span><span style=\"color: rgb(0, 0, 187);\">$data</span><span style=\"color: rgb(0, 119, 0);\">[]&nbsp;=&nbsp;array(</span><span style=\"color: rgb(221, 0, 0);\">&#39;volume&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">86</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(221, 0, 0);\">&#39;edition&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">1</span><span style=\"color: rgb(0, 119, 0);\">);<br/></span><span style=\"color: rgb(0, 0, 187);\">$data</span><span style=\"color: rgb(0, 119, 0);\">[]&nbsp;=&nbsp;array(</span><span style=\"color: rgb(221, 0, 0);\">&#39;volume&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">85</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(221, 0, 0);\">&#39;edition&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">6</span><span style=\"color: rgb(0, 119, 0);\">);<br/></span><span style=\"color: rgb(0, 0, 187);\">$data</span><span style=\"color: rgb(0, 119, 0);\">[]&nbsp;=&nbsp;array(</span><span style=\"color: rgb(221, 0, 0);\">&#39;volume&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">98</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(221, 0, 0);\">&#39;edition&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">2</span><span style=\"color: rgb(0, 119, 0);\">);<br/></span><span style=\"color: rgb(0, 0, 187);\">$data</span><span style=\"color: rgb(0, 119, 0);\">[]&nbsp;=&nbsp;array(</span><span style=\"color: rgb(221, 0, 0);\">&#39;volume&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">86</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(221, 0, 0);\">&#39;edition&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">6</span><span style=\"color: rgb(0, 119, 0);\">);<br/></span><span style=\"color: rgb(0, 0, 187);\">$data</span><span style=\"color: rgb(0, 119, 0);\">[]&nbsp;=&nbsp;array(</span><span style=\"color: rgb(221, 0, 0);\">&#39;volume&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">67</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(221, 0, 0);\">&#39;edition&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">7</span><span style=\"color: rgb(0, 119, 0);\">);<br/></span><span style=\"color: rgb(0, 0, 187);\">?&gt;</span></span></code></p><p style=\"margin-top: 0px; margin-bottom: 1.5rem;\">本例中将把&nbsp;volume&nbsp;降序排列，把&nbsp;edition&nbsp;升序排列。</p><p style=\"margin-top: 0px; margin-bottom: 1.5rem;\">现在有了包含有行的数组，但是&nbsp;<span class=\"function\"><span style=\"text-rendering: optimizeLegibility;\">array_multisort()</span></span>&nbsp;需要一个包含列的数组，因此用以下代码来取得列，然后排序。</p><p><code style=\"font-stretch: normal; font-size: 0.875rem; line-height: 1.5rem; font-family: &quot;Fira Mono&quot;, &quot;Source Code Pro&quot;, monospace; word-wrap: break-word; display: block;\"><span style=\"color: rgb(0, 0, 0);\"><span style=\"color: rgb(0, 0, 187);\">&lt;?php<br/></span><span style=\"color: rgb(255, 128, 0);\">//&nbsp;取得列的列表<br/></span><span style=\"color: rgb(0, 119, 0);\">foreach&nbsp;(</span><span style=\"color: rgb(0, 0, 187);\">$data&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">as&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$key&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$row</span><span style=\"color: rgb(0, 119, 0);\">)&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$volume</span><span style=\"color: rgb(0, 119, 0);\">[</span><span style=\"color: rgb(0, 0, 187);\">$key</span><span style=\"color: rgb(0, 119, 0);\">]&nbsp;&nbsp;=&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$row</span><span style=\"color: rgb(0, 119, 0);\">[</span><span style=\"color: rgb(221, 0, 0);\">&#39;volume&#39;</span><span style=\"color: rgb(0, 119, 0);\">];<br/>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$edition</span><span style=\"color: rgb(0, 119, 0);\">[</span><span style=\"color: rgb(0, 0, 187);\">$key</span><span style=\"color: rgb(0, 119, 0);\">]&nbsp;=&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$row</span><span style=\"color: rgb(0, 119, 0);\">[</span><span style=\"color: rgb(221, 0, 0);\">&#39;edition&#39;</span><span style=\"color: rgb(0, 119, 0);\">];<br/>}<br/><br/></span><span style=\"color: rgb(255, 128, 0);\">//&nbsp;将数据根据&nbsp;volume&nbsp;降序排列，根据&nbsp;edition&nbsp;升序排列<br/>//&nbsp;把&nbsp;$data&nbsp;作为最后一个参数，以通用键排序<br/></span><span style=\"color: rgb(0, 0, 187);\">array_multisort</span><span style=\"color: rgb(0, 119, 0);\">(</span><span style=\"color: rgb(0, 0, 187);\">$volume</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">SORT_DESC</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$edition</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">SORT_ASC</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$data</span><span style=\"color: rgb(0, 119, 0);\">);<br/></span><span style=\"color: rgb(0, 0, 187);\">?&gt;</span></span></code></p><p style=\"margin-top: 0px; margin-bottom: 1.5rem;\">数据集合现在排好序了，结果如下：</p><pre style=\"white-space: pre-wrap; margin-top: 0px; margin-bottom: 0px;\">volume&nbsp;|&nbsp;edition
-------+--------
&nbsp;&nbsp;&nbsp;&nbsp;98&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2
&nbsp;&nbsp;&nbsp;&nbsp;86&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;86&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6
&nbsp;&nbsp;&nbsp;&nbsp;85&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6
&nbsp;&nbsp;&nbsp;&nbsp;67&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2
&nbsp;&nbsp;&nbsp;&nbsp;67&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7</pre><p><br/></p>','1487671848','1487671848','1487671848') [ RunTime:0.0278s ]
SQL: SHOW COLUMNS FROM `z_category` [ RunTime:0.0004s ]
SQL: SELECT * FROM `z_category` WHERE `name` = 'php' LIMIT 1   [ RunTime:0.0001s ]

[ 2017-02-21T18:10:50+08:00 ] 203.130.43.155 /admin.php/Post/all
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000012s ]
INFO: [ app_init ] --END-- [ RunTime:0.000302s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000317s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000357s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.
SQL: SHOW COLUMNS FROM `z_post` [ RunTime:0.0007s ]
SQL: SELECT COUNT(*) AS tp_count FROM `z_post` LIMIT 1   [ RunTime:0.0003s ]
SQL: SELECT * FROM `z_post` ORDER BY ctime desc LIMIT 0,20   [ RunTime:0.0008s ]
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000058s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000111s ]
NOTIC: [8] Undefined variable: userInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/c171e2b85832ae9943251ee8295bfacb.php 第 361 行.
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.013228s ]
INFO: [ view_parse ] --END-- [ RunTime:0.013265s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000114s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000159s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000320s ]
INFO: [ app_end ] --END-- [ RunTime:0.000361s ]

[ 2017-02-21T18:10:50+08:00 ] 203.130.43.155 /admin.php/Post/all
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000013s ]
INFO: [ app_init ] --END-- [ RunTime:0.000248s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000353s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000391s ]
NOTIC: [8] A session had already been started - ignoring session_start() /data/wwwroot/blog/ThinkPHP/Common/functions.php 第 1263 行.
SQL: SHOW COLUMNS FROM `z_post` [ RunTime:0.0006s ]
SQL: SELECT COUNT(*) AS tp_count FROM `z_post` LIMIT 1   [ RunTime:0.0001s ]
SQL: SELECT * FROM `z_post` ORDER BY ctime desc LIMIT 0,20   [ RunTime:0.0003s ]
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000057s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000095s ]
NOTIC: [8] Undefined variable: userInfo /data/wwwroot/blog/Application/Runtime/Cache/Admin/c171e2b85832ae9943251ee8295bfacb.php 第 361 行.
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.012849s ]
INFO: [ view_parse ] --END-- [ RunTime:0.012886s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000109s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000140s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000326s ]
INFO: [ app_end ] --END-- [ RunTime:0.000364s ]

