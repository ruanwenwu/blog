-- MySQL dump 10.13  Distrib 5.6.29, for Linux (x86_64)
--
-- Host: localhost    Database: blog
-- ------------------------------------------------------
-- Server version	5.6.29-log

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8mb4 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Table structure for table `sdfsdf`
--

DROP TABLE IF EXISTS `sdfsdf`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `sdfsdf` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `sdf` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=3 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `sdfsdf`
--

LOCK TABLES `sdfsdf` WRITE;
/*!40000 ALTER TABLE `sdfsdf` DISABLE KEYS */;
INSERT INTO `sdfsdf` VALUES (1,'23'),(2,'sdf');
/*!40000 ALTER TABLE `sdfsdf` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `sph_counter`
--

DROP TABLE IF EXISTS `sph_counter`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `sph_counter` (
  `counter_id` int(10) unsigned NOT NULL,
  `max_doc_id` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`counter_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `sph_counter`
--

LOCK TABLES `sph_counter` WRITE;
/*!40000 ALTER TABLE `sph_counter` DISABLE KEYS */;
INSERT INTO `sph_counter` VALUES (1,107);
/*!40000 ALTER TABLE `sph_counter` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `z_black_email`
--

DROP TABLE IF EXISTS `z_black_email`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `z_black_email` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `z_black_email`
--

LOCK TABLES `z_black_email` WRITE;
/*!40000 ALTER TABLE `z_black_email` DISABLE KEYS */;
/*!40000 ALTER TABLE `z_black_email` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `z_black_website`
--

DROP TABLE IF EXISTS `z_black_website`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `z_black_website` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `z_black_website`
--

LOCK TABLES `z_black_website` WRITE;
/*!40000 ALTER TABLE `z_black_website` DISABLE KEYS */;
INSERT INTO `z_black_website` VALUES (1,'ayosport'),(2,'amazonaws'),(3,'ayospdort'),(4,'magc'),(5,'letschat'),(6,'sb-u.ch');
/*!40000 ALTER TABLE `z_black_website` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `z_category`
--

DROP TABLE IF EXISTS `z_category`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `z_category` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(25) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `z_category`
--

LOCK TABLES `z_category` WRITE;
/*!40000 ALTER TABLE `z_category` DISABLE KEYS */;
INSERT INTO `z_category` VALUES (2,'生活'),(3,'说说'),(4,'php'),(5,'js'),(6,'转载'),(7,'工作'),(8,'算法'),(9,'linux'),(10,'mac'),(13,'node');
/*!40000 ALTER TABLE `z_category` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `z_comment`
--

DROP TABLE IF EXISTS `z_comment`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `z_comment` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `name` varchar(30) NOT NULL DEFAULT '' COMMENT '评论者姓名',
  `email` varchar(50) NOT NULL DEFAULT '' COMMENT '评论者邮箱',
  `content` varchar(255) NOT NULL DEFAULT '' COMMENT '评论内容',
  `pid` int(11) NOT NULL DEFAULT '0' COMMENT '评论的父id',
  `postid` int(11) NOT NULL DEFAULT '0' COMMENT '评论所属文章id',
  `depth` tinyint(4) NOT NULL DEFAULT '1' COMMENT '评论深度',
  `website` varchar(255) NOT NULL DEFAULT '' COMMENT '评论者网址',
  `ctime` int(11) NOT NULL DEFAULT '0' COMMENT '评论发表时间',
  `ip` varchar(255) NOT NULL DEFAULT '',
  `status` tinyint(1) NOT NULL DEFAULT '1' COMMENT '状态值,1.显示，0.隐藏',
  `uid` int(11) NOT NULL DEFAULT '1' COMMENT '用户id',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=530 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `z_comment`
--

LOCK TABLES `z_comment` WRITE;
/*!40000 ALTER TABLE `z_comment` DISABLE KEYS */;
INSERT INTO `z_comment` VALUES (466,'阮文武','379879523@qq.com','很实用。',0,60,1,'',1486470290,'203.130.43.156',1,1),(470,'感动','290224603@qq.com','看了第一感受，有点莫名的感动！',0,44,1,'',1486544235,'111.198.71.131',1,1),(471,'同感','379879523@qq.com','这就是历史。',470,44,2,'',1486544433,'203.130.43.155',1,1),(524,'ruanwenwu','379879523@qq.com','测试一下。',0,76,1,'',1489864278,'203.130.43.155',1,1),(525,'ruanwenwu','379879523@qq.com','测试一下。again',0,76,1,'',1489864302,'203.130.43.155',1,1),(526,'ruanwenwu','379879523@qq.com','测试一下。again more.',0,76,1,'',1489864489,'203.130.43.155',1,1),(527,'ruanwenwu','379879523@qq.com','测试子回复。',526,76,2,'',1489864535,'203.130.43.155',1,1),(528,'gh72029002','666@qq.com','这个功能66的',0,77,1,'http://www.wayde.org',1490001197,'222.128.110.245',1,2),(529,'ruanwenwu','379879523@qq.com','还行，git有点慢。',528,77,2,'',1490452922,'203.130.43.155',1,1);
/*!40000 ALTER TABLE `z_comment` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `z_editor_read_log`
--

DROP TABLE IF EXISTS `z_editor_read_log`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `z_editor_read_log` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `replyid` int(11) NOT NULL DEFAULT '0',
  `editor` varchar(20) NOT NULL DEFAULT '',
  `ctime` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `z_editor_read_log`
--

LOCK TABLES `z_editor_read_log` WRITE;
/*!40000 ALTER TABLE `z_editor_read_log` DISABLE KEYS */;
/*!40000 ALTER TABLE `z_editor_read_log` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `z_post`
--

DROP TABLE IF EXISTS `z_post`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `z_post` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `ctime` int(11) NOT NULL,
  `mtime` int(11) NOT NULL,
  `pubtime` int(11) NOT NULL,
  `content` longtext NOT NULL,
  `tag` varchar(255) NOT NULL,
  `title` varchar(255) NOT NULL DEFAULT '',
  `summary` varchar(255) NOT NULL DEFAULT '',
  `category` varchar(11) NOT NULL,
  `comment_num` int(11) NOT NULL DEFAULT '0' COMMENT '评论数量',
  `pv` int(11) NOT NULL DEFAULT '0' COMMENT '阅读量',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=108 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `z_post`
--

LOCK TABLES `z_post` WRITE;
/*!40000 ALTER TABLE `z_post` DISABLE KEYS */;
INSERT INTO `z_post` VALUES (1,1477217510,1477217510,1477217510,'<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;不知庐山真面目，只缘身在此山中。<br/></p><p><br/></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这世界也许你最近亲却最不了解的人，就是你自己。所以自我介绍，说履历容易，讲真性情却是难极了的事。</p><p><br/></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;很多年前，就是刚毕业那一阵，我是一个“极浪漫主义”的青年。那时的我，用生活践行着轰轰烈烈的诗与歌的亢奋。<br/></p><p><br/></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;08年的夏天，奥运会正如火如荼的进行的时候，那也是我浪漫主义的极致：新沟镇的月与夜与雨，持刀与黑夜搏斗的激情，漏居数雨的情怀，至今是我最美的回忆。<br/></p><p><br/></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;原来一切人生的大悲大喜均是形而上的。<br/></p><p><br/></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;后来，社会大学教会了我做实事，这样才是真正有意义的生活。从那以后，我基本上告别了那些细腻的体会，封了笔，在工作中践行自己的价值观。<br/></p><p><br/></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; 现在的我觉得，无论做什么工作，能体现出自己的价值就是幸福的；有梦就要勇敢追，任何事从今天开始做都不算晚。<br/></p><p><br/></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;写这个博客的初衷是希望认真地，重新地捡起自己内心非常喜欢做的那件事：分享生命，留住感动。<br/></p>','自我介绍','关于我','你了解你自己吗？','生活',11,456),(12,1478104850,1478104850,1478104850,'','','时光教会了我们一切','','说说',0,97),(17,1479020435,1479020435,1479020435,'','','不要跑，当你还没学会走之前','','说说',0,80),(18,1479020763,1479020763,1479020763,'','','怀念友情','','说说',0,77),(19,1479026114,1479534220,1479026114,'<p>								</p><h3>题外话<br/></h3><p>不知道怎么去表达。只希望能够帮到有需要的同学。</p><p>这将是个简单的不能再简单的mvc框架，但是足以让你了解框架的奥秘了。</p><h3>框架原理<br/></h3><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>首先你需要做rewrite重写，将网站的所有请求指向到你的index.php来实现单一入口。</p></li><li><p>一般我们在index.php中定义很多的常量，比如项目目录，框架核心文件目录，业务目录，静态文件目录等等。除了定义这些常量之外，我们只需要做另外一件事：启动框架。（这都是套路^_^）</p></li><li><p>启动框架实际上就是实现路由寻址。所谓路由寻址，就是将url指向到对应的控制器和方法，并且保存参数以供使用。</p></li><li><p>接下来在根据路由得到的控制器和方法里写业务逻辑。</p></li><li><p>最后将业务逻辑中得到的数据分配到模板就完事了。</p></li></ol><p>是不是很简单呢？接下来我们来熟悉一下这个框架。</p><h3>目录</h3><p><img src=\"/ueditor/php/upload/image/20161113/1479029828670748.png\" title=\"1479029828670748.png\" alt=\"blob.png\"/></p><p><br/></p><p>这里可以先忽略vendor目录和composer.json以及composer.lock这三个文件。这是框架写完之后，利用了 composer 来扩展框架的健壮性。<br/></p><p><br/></p><p>目录很简单。app里放业务。core里是核心文件和类库。.htaccess负责将请求指向index.php，入口文件index.php。我有理由相信，如果你对php的命名空间，自动加载，类和对象的知识比较熟悉的话，半个小时你就能掌握这个小东西。</p><p><br/></p><h3>index.php</h3><pre class=\"brush:php;toolbar:false\">&lt;?php\r\n/**\r\n&nbsp;*&nbsp;入口文件\r\n&nbsp;*&nbsp;1.定义常量\r\n&nbsp;*&nbsp;2.加载函数库\r\n&nbsp;*&nbsp;3.运行框架\r\n&nbsp;*/\r\ndefine(&quot;PROJECT_PATH&quot;,realpath(&quot;./&quot;).&quot;/&quot;);\r\ndefine(&quot;APP_PATH&quot;,PROJECT_PATH.&quot;app/&quot;);\r\ndefine(&quot;CORE&quot;,PROJECT_PATH.&quot;core/&quot;);\r\ndefine(&quot;MODULE&quot;,&#39;app&#39;);\r\ndefine(&quot;DEBUG&quot;,true);\r\ninclude(&quot;vendor/autoload.php&quot;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//引入composer自动加载文件\r\n\r\nif(DEBUG){\r\n&nbsp;&nbsp;&nbsp;&nbsp;$whoops&nbsp;=&nbsp;new&nbsp;\\Whoops\\Run;\r\n&nbsp;&nbsp;&nbsp;&nbsp;$whoops-&gt;pushHandler(new&nbsp;\\Whoops\\Handler\\PrettyPageHandler);\r\n&nbsp;&nbsp;&nbsp;&nbsp;$whoops-&gt;register();\r\n&nbsp;&nbsp;&nbsp;&nbsp;ini_set(&quot;display_errors&quot;,&quot;On&quot;);\r\n}else{\r\n&nbsp;&nbsp;&nbsp;&nbsp;ini_set(&quot;display_errors&quot;,&quot;Off&quot;);\r\n}\r\n\r\ninclude&nbsp;CORE.&quot;common/functions.php&quot;;\r\ninclude&nbsp;CORE.&quot;core.php&quot;;\r\nspl_autoload_register(&#39;core\\Core::load&#39;);\r\ncore\\Core::run();</pre><p>这里定义了几个常量。引入了common/function.php这个供系统使用的函数库。然后，引入框架核心文件core.php，最后调用core.php中的core类下的load方法进行自动加载配置。最后运行core类下的run方法运行整个框架。</p><p><br/></p><p>接下来我们看看框架的核心文件core.php。</p><p><br/></p><h3>core.php</h3><pre class=\"brush:php;toolbar:false\">&lt;?php\r\n/**\r\n&nbsp;*&nbsp;框架核心文件，负责加载类，解析路由等\r\n&nbsp;*/\r\nnamespace&nbsp;core;\r\n\r\nclass&nbsp;Core\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;$classMap&nbsp;=&nbsp;array();\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;function&nbsp;load($class){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$classDir&nbsp;=&nbsp;str_replace(&quot;\\\\&quot;,&quot;/&quot;,$class);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$classPath&nbsp;=&nbsp;PROJECT_PATH.$classDir.&quot;.php&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(in_array($class,self::$classMap)){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(is_file($classPath)){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;$classPath;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$classMap[]&nbsp;=&nbsp;$class;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;function&nbsp;run(){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$router&nbsp;=&nbsp;new&nbsp;\\core\\lib\\Router();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ctrl&nbsp;=&nbsp;\\core\\lib\\Router::$ctrl;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$act&nbsp;=&nbsp;\\core\\lib\\Router::$act;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params&nbsp;=&nbsp;\\core\\lib\\Router::$params;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ctrlClass&nbsp;=&nbsp;&quot;\\\\&quot;.MODULE.&quot;\\\\controller\\\\&quot;.$ctrl.&quot;Controller&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ctrlObj&nbsp;=&nbsp;new&nbsp;$ctrlClass();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ctrlObj-&gt;$act();\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n}</pre><p>如果您曾经读过其他框架的源码，那么core.php将是你见过最短的框架核心文件。它只有两个方法。</p><p><br/></p><p>load方法用在index.php中来初始化自动加载。spl_autoload_register方法能接收带有命名空间的类名，并根据方法中定义的规则引入指定的类。</p><p><br/></p><p>run用在index.php启动整个框架。实际上它只做了一件事，就是将Router类中得到的控制器和方法名称拿来，拼接出我们最终需要进入的控制器和方法，并进行实例化和调用。<br/></p><p><br/></p><p>我们看到core类中只用到一个其他的类：Router。我们来看看它长什么样吧。</p><h3>Router</h3><pre class=\"brush:php;toolbar:false\">&lt;?php\r\nnamespace&nbsp;core\\lib;\r\n\r\nclass&nbsp;Router\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;$ctrl;\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;$act;\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;$params;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;__construct(){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($_SERVER[&#39;REQUEST_URI&#39;]&nbsp;==&nbsp;&quot;/&quot;){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$ctrl&nbsp;=&nbsp;Config::get(&quot;CTRL&quot;,&quot;router.php&quot;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$act&nbsp;&nbsp;=&nbsp;Config::get(&quot;ACTION&quot;,&quot;router.php&quot;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pathArr&nbsp;=&nbsp;explode(&quot;/&quot;,trim($_SERVER[&#39;REQUEST_URI&#39;],&quot;/&quot;));\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pathNum&nbsp;=&nbsp;count($pathArr);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($pathNum&nbsp;==&nbsp;1){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$ctrl&nbsp;=&nbsp;$pathArr[0];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$act&nbsp;=&nbsp;&quot;index&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else&nbsp;if($pathNum&nbsp;==&nbsp;2){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$ctrl&nbsp;=&nbsp;$pathArr[0];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$act&nbsp;=&nbsp;$pathArr[1];&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$ctrl&nbsp;=&nbsp;$pathArr[0];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$act&nbsp;=&nbsp;$pathArr[1];&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for($i&nbsp;=&nbsp;2;&nbsp;$i&nbsp;&lt;&nbsp;$pathNum&nbsp;-&nbsp;1&nbsp;;&nbsp;$i&nbsp;+=&nbsp;2){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($pathArr[$i+1]){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$params[$pathArr[$i]]&nbsp;=&nbsp;$pathArr[$i+1];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_GET&nbsp;=&nbsp;self::$params;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n}</pre><p>这个路由类只有一个构造函数。它的作用就是根据当前的url得到我们需要的控制器和方法名称，并把参数放到$_GET这个超全局变量中。</p><p><br/></p><p>这里使用了config类。这个类让我们可以很方便的管理我们的配置，比如路由配置，数据库配置，缓存配置等等，非常有用。</p><h3>config</h3><pre class=\"brush:php;toolbar:false\">&lt;?php\r\n/**\r\n&nbsp;*&nbsp;配置加载类\r\n&nbsp;*&nbsp;\r\n&nbsp;*&nbsp;@author&nbsp;rww\r\n&nbsp;*&nbsp;@date&nbsp;2016/11/06\r\n&nbsp;*/\r\nnamespace&nbsp;core\\lib;\r\n\r\nclass&nbsp;Config\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;$config&nbsp;=&nbsp;array();\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;根据对应的文件和key加载配置\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$key\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$file\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;mixed\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;function&nbsp;get($key,&nbsp;$file)\r\n&nbsp;&nbsp;&nbsp;&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($config[$file]))&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$config[$file][$key];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$filePath&nbsp;=&nbsp;CORE.&quot;config/&quot;.$file;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(file_exists($filePath))&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$config[$file]&nbsp;=&nbsp;$config&nbsp;=&nbsp;include($filePath);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($config[$key]){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$config[$key];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;\\Exception(&quot;$key&nbsp;not&nbsp;exist&quot;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;\\Exception(&quot;$filePath&nbsp;not&nbsp;found&quot;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;加载所有配置\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;function&nbsp;all($file)\r\n&nbsp;&nbsp;&nbsp;&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($config[$file]))&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$config[$file];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$filePath&nbsp;=&nbsp;CORE.&quot;config/&quot;.$file;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(file_exists($filePath))&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$config[$file]&nbsp;=&nbsp;$config&nbsp;=&nbsp;include($filePath);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$config;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;\\Exception(&quot;$filePath&nbsp;not&nbsp;found&quot;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n}</pre><p>config类只有两个方法。一个方法用来获取某文件中的某个配置，另一个方法用来获取某配置文件中的所有配置。<br/></p><p><br/></p><p>到这里，我们已经可以在对应的控制器里写业务逻辑了。我们来看看控制器。</p><h3>controller</h3><p>以IndexController为例：</p><pre class=\"brush:php;toolbar:false\">&lt;?php\r\nnamespace&nbsp;app\\controller;\r\nuse&nbsp;core\\lib\\Model&nbsp;as&nbsp;Model;\r\nuse&nbsp;core\\lib\\Router&nbsp;as&nbsp;Router;\r\nuse&nbsp;core\\lib\\View&nbsp;as&nbsp;View;\r\nclass&nbsp;IndexController\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;addData(){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pdo&nbsp;=&nbsp;Model::getInstance();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;&quot;insert&nbsp;into&nbsp;z_post&nbsp;(title,content)&nbsp;values&nbsp;(&#39;this&nbsp;is&nbsp;test&#39;,&#39;this&nbsp;i&nbsp;test&#39;)&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($pdo-&gt;insertData($sql)){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&#39;chenggong&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;index(){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//echo&nbsp;$_GET[&#39;a&#39;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//echo&nbsp;$_GET[&#39;b&#39;];&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pdo&nbsp;=&nbsp;Model::getInstance();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;&quot;select&nbsp;*&nbsp;from&nbsp;z_post&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data&nbsp;=&nbsp;$pdo-&gt;query($sql);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$view&nbsp;=&nbsp;new&nbsp;View();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$view-&gt;assign(&quot;data&quot;,$data[0]);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$view-&gt;display();\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;p(){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//echo&nbsp;&#39;&lt;pre&gt;&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//var_dump(Router::$params);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;Router::$params[&#39;id&#39;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n}</pre><p>先看index这个方法。在这里我们实例化Model类，得到pdo实例，并且执行了一条sql查询语句。然后实例化view类，输出了页面。逻辑很简单。我们接下来看看Model类和View类，看看数据对象的实例化和模板的使用。</p><h3>Model</h3><pre class=\"brush:php;toolbar:false\">&lt;?php\r\nnamespace&nbsp;core\\lib;\r\n\r\nclass&nbsp;Model{\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;$instance=null;\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$dbLink;\r\n&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;function&nbsp;__construct($params=null){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$options&nbsp;=&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;dsn&quot;&nbsp;=&gt;&nbsp;&quot;mysql:host=localhost;dbname=blog&quot;,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;username&quot;&nbsp;=&gt;&nbsp;&quot;root&quot;,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;pwd&quot;&nbsp;=&gt;&nbsp;&quot;&quot;,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;option&quot;=&gt;&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\PDO::ATTR_ERRMODE&nbsp;&nbsp;&nbsp;=&gt;&nbsp;&nbsp;\\PDO::ERRMODE_EXCEPTION,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($params){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$options&nbsp;=&nbsp;array_merge($options,$params);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;extract($options);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;dbLink&nbsp;=&nbsp;new&nbsp;\\PDO($dsn,$username,$pwd,$options);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;dbLink-&gt;exec(&quot;set&nbsp;names&nbsp;utf8&quot;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;function&nbsp;__clone(){}&nbsp;&nbsp;//禁止克隆\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;function&nbsp;getInstance(){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!self::$instance&nbsp;instanceof&nbsp;self){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self::$instance&nbsp;=&nbsp;new&nbsp;self();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self::$instance;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;insertData($sql){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;dbLink-&gt;exec($sql);\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;query($sql){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$record&nbsp;=&nbsp;$this-&gt;dbLink-&gt;query($sql);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($record){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$record-&gt;fetchAll(\\PDO::FETCH_ASSOC);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n}</pre><p>重点看一下getInstance和构造函数。这里单例模式的典型写法。这样每次我们getInstance得到的都是同一个实例。</p><h3>view</h3><pre class=\"brush:php;toolbar:false\">&lt;?php\r\nnamespace&nbsp;core\\lib;\r\n\r\nclass&nbsp;View\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$data&nbsp;=&nbsp;array();\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;assign($name,$data){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;data[$name]&nbsp;=&nbsp;$data;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;display($filename=&quot;&quot;){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;extract($this-&gt;data);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($filename){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$filePath&nbsp;=&nbsp;APP_PATH.&quot;view/&quot;.Router::$ctrl.&quot;/&quot;.$filename;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$filePath&nbsp;=&nbsp;APP_PATH.&quot;view/&quot;.Router::$ctrl.&quot;/&quot;.Router::$act.&quot;.php&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(is_file($filePath)){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;$filePath;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(&#39;模版文件不存在&#39;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n}</pre><p>原理就是将assign方法使用到的数据放到data这个属性中。当display的时候，找到模板，并将分配过去的数据放到模板中。</p><p><br/></p><p>项目github地址：https://github.com/ruanwenwu/rwwfrm</p><p><br/></p><p><br/></p><p>							</p>','框架','php框架原理','框架完成项目中的基础布置，让开发人员将更多的精力放在业务的实现上。','php',0,114),(20,1479181613,1479181935,1479181613,'<p>								</p><h3>题记</h3><p>Zol_config的原理和大多数框架里的config类没有太大区别，甚至更加简单，而有些地方比较臃肿。简单在只有一个方法，臃肿在多了很多不必要的判断，像ini后缀的根本不必要。最好再加一个all方法，能获取指定配置文件的所有配置。</p><h3>源码</h3><pre class=\"brush:php;toolbar:false\">&lt;?php\r\n/**\r\n*&nbsp;获取配置\r\n*&nbsp;@author&nbsp;wiki&lt;wu.kun@zol.com.cn&gt;\r\n*&nbsp;@copyright&nbsp;(c)&nbsp;2010-06-22\r\n*&nbsp;@version&nbsp;v1.0\r\n*/\r\n\r\nclass&nbsp;ZOL_Config\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;配置缓存\r\n&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;array\r\n&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n	private&nbsp;static&nbsp;$_cache;\r\n\r\n	/**\r\n	*&nbsp;获取\r\n	*\r\n	*&nbsp;@param&nbsp;mixed&nbsp;$key&nbsp;配置地址\r\n	*&nbsp;@param&nbsp;mixed&nbsp;$arrKeyName&nbsp;配置子键，可多维，用.号分隔\r\n	*&nbsp;@param&nbsp;enum&nbsp;$type&nbsp;PHP|INI|EVAL\r\n	*&nbsp;@return&nbsp;array|false\r\n	*/\r\n	public&nbsp;static&nbsp;function&nbsp;get($key,&nbsp;$arrKeyName&nbsp;=&nbsp;&#39;&#39;,&nbsp;$type&nbsp;=&nbsp;&#39;PHP&#39;)\r\n	{\r\n		if&nbsp;(!defined(&#39;PRODUCTION_CONFIG_PATH&#39;))&nbsp;{\r\n			define(&#39;PRODUCTION_CONFIG_PATH&#39;,&nbsp;PRODUCTION_ROOT&nbsp;.&nbsp;&#39;/Config&#39;);\r\n		}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fileExt&nbsp;=&nbsp;array(&nbsp;#不同配置文件的扩展名映射关系\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;ini&#39;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;&#39;ini&#39;,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;php&#39;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;&#39;php&#39;,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;eval&#39;&nbsp;&nbsp;=&gt;&nbsp;&#39;php&#39;,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);\r\n\r\n		$path&nbsp;=&nbsp;PRODUCTION_CONFIG_PATH&nbsp;.&nbsp;&#39;/&#39;&nbsp;.&nbsp;str_replace(&#39;_&#39;,&nbsp;&#39;/&#39;,&nbsp;$key)&nbsp;.&nbsp;&#39;.&#39;&nbsp;.&nbsp;$fileExt[strtolower($type)];\r\n		if&nbsp;(isset(self::$_cache[$path]))&nbsp;{\r\n			$config&nbsp;=&nbsp;self::$_cache[$path];\r\n		}&nbsp;else&nbsp;{\r\n			if&nbsp;(!ZOL_File::exists($path))&nbsp;{\r\n				self::$_cache[$path]&nbsp;=&nbsp;false;\r\n				return&nbsp;false;\r\n			}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$type&nbsp;=&nbsp;strtoupper($type);\r\n			switch&nbsp;($type)&nbsp;{\r\n				case&nbsp;&#39;INI&#39;:\r\n					$config&nbsp;=&nbsp;parse_ini_file($path);\r\n					break;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;&#39;EVAL&#39;:&nbsp;#config中可以有变量，这样可以将变量传入到config中\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(is_array($arrKeyName)){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;extract($arrKeyName);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n					$config&nbsp;=&nbsp;include($path);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;\r\n				default:\r\n				case&nbsp;&#39;PHP&#39;:\r\n					$config&nbsp;=&nbsp;include($path);\r\n					break;\r\n			}\r\n			self::$_cache[$path]&nbsp;=&nbsp;$config;\r\n		}\r\n\r\n		if&nbsp;($arrKeyName&nbsp;&amp;&amp;&nbsp;$type&nbsp;!=&nbsp;&#39;EVAL&#39;)&nbsp;{\r\n			if&nbsp;(strpos(&#39;.&#39;,&nbsp;$arrKeyName))&nbsp;{\r\n				$keyArr&nbsp;=&nbsp;explode(&#39;.&#39;,&nbsp;$arrKeyName);\r\n				foreach&nbsp;($keyArr&nbsp;as&nbsp;$key)&nbsp;{\r\n					if&nbsp;(!$config)&nbsp;{\r\n						break;\r\n					}\r\n\r\n					$config&nbsp;=&nbsp;empty($config[$key])&nbsp;?&nbsp;false&nbsp;:&nbsp;$config[$key];\r\n				}\r\n			}&nbsp;else&nbsp;{\r\n				$config&nbsp;=&nbsp;empty($config[$arrKeyName])&nbsp;?&nbsp;false&nbsp;:&nbsp;$config[$arrKeyName];\r\n			}\r\n		}\r\n		return&nbsp;$config;\r\n	}\r\n}</pre><h3>解读</h3><p>还是套路。^_^。首先定义一个static的$_cache变量来做缓存。然后解析文件名获得配置数组。<br/></p><p><br/></p><p>只有一个方法get()用来获取配置文件。get里传入配置文件名和需要取得键名。如果已经缓存过该文件就直接取，如果没有就看文件是否存在，存在的话就取出来。个人觉得ini后缀不用管，拿实用的php就可以了。</p><p><br/></p><p>最后附上被加载的配置文件的格式：</p><p><img src=\"/ueditor/php/upload/image/20161115/1479181931403201.png\" title=\"1479181931403201.png\" alt=\"blob.png\"/></p><p>							</p>','zolframework','Zol_config','Zol_config的原理和大多数框架里的config类没有太大区别，甚至更加简单。','php',0,74),(21,1479181734,1479181734,1479181734,'','','持续前进！','','说说',0,74),(22,1479199655,1479211407,1479199655,'<p>								</p><h3>题记</h3><p>当公司项目发展到一定阶段，出现了a.domain.com,b.domain.com,c.domain.com并且各个domain下的开发人员对彼此的项目不了解，但需要对方的数据或者进行交互的时候，依赖问题就出现了。</p><p><br/></p><p>比如a.domain.com需要b.domain提供数据。一般情况下a项目的开发人员需要b项目的开发人员提供接口。接口写好了：b.domain.com/api.php。用了一段时间挺好。可是突然有一天，b.domain.com出现问题挂了，a.domain.com也跟着遭殃了。这就是依赖。也是私有云出现的原因。</p><p><br/></p><h3>私有云的优势</h3><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>切断各个业务的耦合。用了私有云，a.domain.com下的开发人员，可以直接调用私有云下的方法，尽管这些方法仍然需要b.domain.com下的开发人员开发。</p></li><li><p>没有单点问题，a.domain.com下的私有云入口是自己的独立的一份文件。b.domain.com也是一样。每小时或者推送数据同步，保持各服务器私有云程序一致。</p></li><li><p>减少不必要的请求。数据就在本应用内得到，省去b.domain.com在还要复制一份a.domain.com的请求与处理。效率加倍。<br/></p><p><br/></p></li></ol><h3>私有云的使用</h3><p>私有云的使用很简单，只需要在项目中引入私有云这个项目中的api.php，然后就可以了，就像这样：</p><p class=\"p1\"><span class=\"s1\">ZOL_Api</span><span class=\"s2\">::<em>run</em>(</span>&quot;Service.Area.getClientIp&quot;<span class=\"s2\">, </span><span class=\"s3\"><strong>array</strong></span><span class=\"s2\">())。</span></p><p class=\"p1\"><span class=\"s2\"><br/></span></p><p>这个api.php里有个ZOL_API类里，有个autoload方法控制了私有云类和方法的加载，有个run方法来进行执行对应的类的方法。<br/></p><p><br/></p><p>autoload方法：</p><pre class=\"brush:php;toolbar:false\">public&nbsp;static&nbsp;function&nbsp;autoload($name)\r\n&nbsp;&nbsp;&nbsp;&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(trim($name)&nbsp;==&nbsp;&#39;&#39;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;exception(&#39;No&nbsp;class&nbsp;or&nbsp;interface&nbsp;named&nbsp;for&nbsp;loading&#39;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(class_exists($name,&nbsp;false)&nbsp;||&nbsp;interface_exists($name,&nbsp;false))&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$namespace&nbsp;=&nbsp;substr($name,&nbsp;0,&nbsp;strpos($name,&nbsp;&#39;_&#39;));\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(ZOL_API_ISFW&nbsp;&amp;&amp;&nbsp;in_array($namespace,&nbsp;array(&#39;Db&#39;,&#39;ZOL&#39;))&nbsp;){&nbsp;#框架的自动加载加载\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file&nbsp;=&nbsp;&#39;&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($namespace&nbsp;==&nbsp;&#39;API&#39;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file&nbsp;=&nbsp;ZOL_API_BASE&nbsp;.&nbsp;&#39;/&#39;&nbsp;.&nbsp;str_replace(&#39;_&#39;,&nbsp;DIRECTORY_SEPARATOR,&nbsp;$name)&nbsp;.&nbsp;&#39;.php&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;对个性的命名空间做处理\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elseif&nbsp;(isset(self::$_namespace[$namespace])){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file&nbsp;=&nbsp;self::$_namespace[$namespace]&nbsp;.&nbsp;&#39;/&#39;&nbsp;.&nbsp;str_replace(&#39;_&#39;,&nbsp;DIRECTORY_SEPARATOR,&nbsp;$name)&nbsp;.&nbsp;&#39;.php&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($file){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;$file;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!&nbsp;class_exists($name,&nbsp;false)&nbsp;&amp;&amp;&nbsp;!&nbsp;interface_exists($name,&nbsp;false))&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ZOL_Exception(&#39;Class&nbsp;or&nbsp;interface&nbsp;does&nbsp;not&nbsp;exist&nbsp;in&nbsp;loaded&nbsp;file&#39;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p>这个方法里，定义：如果$name的第一段是ZOL或者Db,那么不进行任何操作，直接返回，交给框架自带的自动加载进行处理；如果$name的第一段以API开头，那么就进行文件名拼接并进行加载；如果是自定义的命名空间，就加载自定义空间下的类文件。<br/></p><p><br/></p><p>run方法：</p><pre class=\"brush:php;toolbar:false\">public&nbsp;static&nbsp;function&nbsp;run($method,$param=false){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$method)return&nbsp;false;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$method&nbsp;=&nbsp;str_replace(&quot;.&quot;,&nbsp;&quot;_&quot;,&nbsp;$method);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$class&nbsp;=&nbsp;&quot;API_Item_&quot;&nbsp;.&nbsp;substr($method,&nbsp;0,strrpos($method,&quot;_&quot;));\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$func&nbsp;&nbsp;=&nbsp;substr($method,&nbsp;strrpos($method,&quot;_&quot;)+1);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$_nowMethod&nbsp;=&nbsp;$method;//通过私有云run调用\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data&nbsp;&nbsp;=&nbsp;call_user_func_array(array($class,&nbsp;$func),&nbsp;array($param));\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$data;\r\n}</pre><p>run方法的作用就是利用ZOL_API类里的autoload方法将私有云类文件加载进来，并执行对应的方法了。</p><p><br/></p><h3>私有云里的spl_autoload_register和框架里的spl_autoload_register</h3><p>两个自动加载都是生效的，但是要避免两个不互相干扰。</p><h3>同步</h3><p>a.domain.com的开发修改完代码之后，会同步到b.domain.com的相同位置。由于每台使用私有云的服务器都有自己的代码，这样即使b.domain.com挂了，a.domain.com也能正常使用。</p><p>							</p>','架构','私有云','当公司项目发展到一定阶段，出现了a.domain.com,b.domain.com,c.domain.com并且各个domain下的开发人员对彼此的项目不了解，但需要对方的数据或者进行交互的时候，依赖问题就出现了。比如a.domain.com需要b.domain提供数据...','php',0,97),(23,1479302069,1479302069,1479302069,'','','世间总是你好','','说说',0,73),(24,1479378141,1479378141,1479378141,'','','好强烈的恋爱中的感觉','','',0,74),(25,1479394790,1479394790,1479394790,'<h3>题记</h3><p>js是非常容易引起人们兴趣的一门语言。有一千种理由让你爱上他，瀑布流就是其中之一。</p><h3>demo</h3><p><a href=\"/demo/pubuliu/\" target=\"_blank\" title=\"瀑布流\">瀑布流演示</a><br/></p><h3>原理</h3><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>首先计算出屏幕大小。根据预设的图片的宽度，求出列数。</p></li><li><p>将通过php加载过来的数据依次，每次计算出最低的那一列，然后算出绝对top值和left值，放到容器中就好了。</p></li><li><p>当屏幕尺寸改变时，只需要从新按照这个思想走一遍就行了。</p><p></p></li></ol><h3>php代码</h3><p>js的代码，大家可以查看demo的源代码，php的我贴出来一下：</p><pre class=\"brush:php;toolbar:false\">&lt;?php\r\n/**\r\n&nbsp;*&nbsp;获取瀑布流图片数据\r\n&nbsp;*/\r\n$dataArr&nbsp;=&nbsp;array(&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&quot;status&quot;&nbsp;=&gt;&nbsp;true,\r\n);\r\nfor&nbsp;($i&nbsp;=&nbsp;1;&nbsp;$i&nbsp;&lt;=&nbsp;30;&nbsp;$i++)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;$file&nbsp;=&nbsp;&quot;./img/$i.jpg&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;if(!file_exists($file)){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file&nbsp;=&nbsp;&quot;./img/$i.jpeg&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$src&nbsp;&nbsp;=&nbsp;&nbsp;&quot;/demo/pubuliu/img/$i.jpeg&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}else{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$src&nbsp;=&nbsp;&quot;/demo/pubuliu/img/$i.jpg&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;list($width,&nbsp;$height,&nbsp;$type,&nbsp;$attr)&nbsp;=&nbsp;getimagesize($file);\r\n&nbsp;&nbsp;&nbsp;&nbsp;$dataArr[&#39;data&#39;][]&nbsp;=&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;src&quot;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;$src,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;width&quot;&nbsp;=&gt;&nbsp;&nbsp;$width,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;height&quot;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;&nbsp;$height,\r\n&nbsp;&nbsp;&nbsp;&nbsp;);\r\n}\r\necho&nbsp;json_encode($dataArr);\r\n?&gt;</pre><p><br/></p>','瀑布流','瀑布流原理','瀑布流在图片网站的应用非常广泛。今天我就跟大家一起研究一下瀑布流的原理。','js',0,193),(26,1479485091,1479485920,1479485091,'<p>								</p><h3>1.引入css和js文件<br/></h3><pre class=\"brush:css;toolbar:false\">&lt;link&nbsp;href=&quot;http://www.js-css.cn/jscode/highlight/highlight1/prettify.css&quot;&nbsp;type=&quot;text/css&quot;&nbsp;rel=&quot;stylesheet&quot;/&gt;\r\n&lt;script&nbsp;type=&quot;text/javascript&quot;&nbsp;src=&quot;http://www.js-css.cn/jscode/highlight/highlight1/prettify.js&quot;&gt;&lt;/script&gt;</pre><h3>2.给pre标签添加样式</h3><pre class=\"brush:php;toolbar:false\">var&nbsp;preObj&nbsp;=&nbsp;document.getElementsByTagName(&quot;pre&quot;);\r\nfor(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;preObj.length;&nbsp;i++){\r\n&nbsp;&nbsp;&nbsp;&nbsp;preObj[i].className&nbsp;=&nbsp;&quot;prettyprint&nbsp;lang-php&quot;;\r\n}</pre><h3>3.渲染pre标签</h3><pre class=\"brush:php;toolbar:false\">&lt;body&nbsp;onload=&quot;prettyPrint()&quot;&gt;</pre><p>其实，如果发表文章的时候，如果事先给pre标签写好样式，也就不需要第二部了。因为懒得改编辑器，所以就在页面里用这段脚本加了样式。<br/></p><p><br/></p><p><br/></p><p>							</p>','代码高亮','用google-code-prettify为博客添加代码高亮','博客上线了，发现代码没有高亮，不怎么好看。刚才添加了，记录一下。','js',0,82),(27,1479488679,1479488679,1479488679,'','','有一种幸福叫做相守','相爱容易，相守不易，且行且珍惜！','说说',0,112),(28,1479525922,1479525922,1479525922,'','','沉着冷静','静静的看完这篇文章','说说',0,77),(29,1479531074,1479532022,1479531074,'<p>								</p><h3>1.优化工具使用<br/></h3><p>chrom浏览器自带。打开浏览器，按f12。如果没有发现Rending选项，按ESC键。出现的界面如图：</p><p><img src=\"/ueditor/php/upload/image/20161119/1479531538979342.png\" title=\"1479531538979342.png\" alt=\"7F580AD9-4F4B-46A8-B45F-4BFDA5BB8979.png\"/></p><p>打开页面之后，需要点击左上角的小圆球，开始录制，录制结束后，在summary里就能看到了。如果重绘区域比较大，而且<span style=\"color: rgb(192, 0, 0);\">非常频繁</span>，那么就要采取优化措施了。</p><h3>2.优化措施<br/></h3><h4>2.1.对待优化区域采取absolute或者fixed处理。</h4><p>使用position属性后可以降低回流，从而减少重绘面积。原理就好像是你丢一块石头到河里，发现水波会一圈一圈的荡漾开来，最终一直蔓延到河边，结果是影响到整条河了。而如果你在河上放一个装上水的小盆，把石子扔在小盆里，影响就没那么大了。下面接下来要讲的layer层其实是一样的原理。</p><h4>2.2.添加layer层。<br/></h4><p>从图中可以看出，layer层以橘黄色的边框包着。以下几个方法可以添加layer层：</p><ol style=\"padding: 0px 0px 0px 40px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13px; white-space: normal;\" class=\" list-paddingleft-2\"><ol style=\"list-style-type: lower-alpha;\" class=\" list-paddingleft-2\"><li><p>有3D元素的属性；</p></li><li><p>video标签并使用加速视频解码；</p></li><li><p>canvas元素并启用3D；</p></li><li><p>插件，比如flash；</p></li><li><p>CSS动画；</p></li><li><p>CSS滤镜；</p></li><li><p>有一个后代元素是独立的layer；</p></li><li><p>元素的相邻元素是独立layer。</p></li></ol></ol><p>注意，添加layer层会增加ram和gpu的开销，过多的layer层可能会发挥反作用，使页面变得更卡。</p><p><br/></p><p>看上去挺多挺复杂的，其实最简单、最容易理解、也最容易滥用的是第一条。实现第一条仅需要在元素的样式加上:transform:translateZ(0);-webkit-transform:translateZ(0);就可以了。</p><h3>2.3.动画优化<br/></h3><p>javascript是单线程，一个耗时较长的任务会影响到下一帧的动画。而css3是一个独立运行的线程，效果比js好很多，但是使用不够灵活。<br/></p><h3>2.4.减少gif动画的使用<br/></h3><p>因为gif会以非常高的频率进行重绘，验证影响页面流畅度。</p><p><br/></p><p>以上是我的阅读笔记，原文请参考：<a href=\"http://www.cnblogs.com/aser1989/p/4527491.html\" target=\"_blank\" title=\"http://www.cnblogs.com/aser1989/p/4527491.html\">http://www.cnblogs.com/aser1989/p/4527491.html</a>，谢谢ASER的辛勤付出与智慧。</p><p><br/></p><p><br/></p><p>							</p>','移动端性能优化','移动端性能优化阅读笔记','1.移动端优化的工具使用。2.降低重绘的两种方法。','js',0,91),(30,1479533192,1479533270,1479533192,'','温暖','给你们','张宇的《给你们》：\"一定是特别的缘分，才可以一路走来变成一家人\"。','说说',0,72),(31,1479539654,1479539861,1479539654,'<p>								</p><blockquote><p>工作中经常要用到BOM里的东西，每次用都要查，比较麻烦。今天周末，做个总结，省的以后麻烦。</p><p class=\"p1\"><span class=\"s1\">找到合适的资料，刚开始看，就碰到offsetParent这个东西，不懂，就先学习一下这个东西吧。</span></p></blockquote><h3><span class=\"s1\">1. 看图</span></h3><h3><img src=\"/ueditor/php/upload/image/20161119/1479536320781372.png\" title=\"1479536320781372.png\" alt=\"blob.png\"/></h3><p>元素的offsetParent实际上找的是元素拥有定位属性的父级元素。<br/></p><p><br/></p><h3>2.解析<br/></h3><p>比如下面这个dom结构：</p><pre class=\"brush:html;toolbar:false\">&lt;div&nbsp;id=&quot;parent&quot;&nbsp;style=&quot;position:absolute;&quot;&gt;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&nbsp;id=&quot;child&quot;&gt;&lt;div&gt;\r\n&lt;div&gt;</pre><p>id为child的元素的offsetParent实际上就是id为parent的div了。如果parent元素没有定位属性，它会一直往上找，如果一直没有，最后会找到body。<br/></p><p><br/></p><p>							</p>','offsetParent','js的offsetParent','今天，我们一起来探一探offsetParent的究竟。','js',0,224),(32,1479615443,1479615475,1479615443,'<p>								</p><p><img src=\"/ueditor/php/upload/image/20161120/1479615416907472.png\" title=\"1479615416907472.png\" alt=\"blob.png\"/></p><p>							</p>','','宽带升级到100M啦，哇哈哈','从此进入高速模式！','生活',0,120),(33,1479639425,1479827275,1479639425,'<p>								</p><p><br/></p><p>懒得看文章的可以戳这里：<a href=\"/demo/sizeandpos/\" target=\"_self\">js位置和大小demo</a><br/></p><h3 style=\"text-align: left;\">1.元素的偏移量</h3><p style=\"text-align:center\"><img src=\"/ueditor/php/upload/image/20161120/1479638455572006.png\" title=\"1479638455572006.png\" alt=\"blob.png\"/></p><p><img src=\"/ueditor/php/upload/image/20161120/1479638429919622.png\" title=\"1479638429919622.png\" alt=\"blob.png\"/></p><h3>2.客户区大小<br/></h3><p><span style=\"color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, &#39;PingFang SC&#39;, &#39;Hiragino Sans GB&#39;, &#39;WenQuanYi Micro Hei&#39;, &#39;Microsoft Yahei&#39;, sans-serif; font-size: 14px; line-height: 22.4px; background-color: rgb(255, 255, 255);\">元素的客户区大小指的是元素内容机器内边距占据空间的大小。</span></p><p><span style=\"color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, &#39;PingFang SC&#39;, &#39;Hiragino Sans GB&#39;, &#39;WenQuanYi Micro Hei&#39;, &#39;Microsoft Yahei&#39;, sans-serif; font-size: 14px; line-height: 22.4px; background-color: rgb(255, 255, 255);\"><img src=\"/ueditor/php/upload/image/20161120/1479638505782196.png\" title=\"1479638505782196.png\" alt=\"blob.png\"/></span></p><p><span style=\"color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, &#39;PingFang SC&#39;, &#39;Hiragino Sans GB&#39;, &#39;WenQuanYi Micro Hei&#39;, &#39;Microsoft Yahei&#39;, sans-serif; font-size: 14px; line-height: 22.4px; background-color: rgb(255, 255, 255);\"><img src=\"/ueditor/php/upload/image/20161120/1479638531535862.png\" title=\"1479638531535862.png\" alt=\"blob.png\"/></span></p><p><span style=\"color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, &#39;PingFang SC&#39;, &#39;Hiragino Sans GB&#39;, &#39;WenQuanYi Micro Hei&#39;, &#39;Microsoft Yahei&#39;, sans-serif; font-size: 14px; line-height: 22.4px; background-color: rgb(255, 255, 255);\"></span></p><p>要确定浏览器可见窗口的大小，可以使用document.documentElement或document.body（IE7之前的版本中）。</p><p>从以上两个我们可以看出元素偏移量（offset）与客户区大小（client）的区别在于有没有包含边框，客户区大小不包含边框。</p><h3>3.滚动大小<br/></h3><p><img src=\"/ueditor/php/upload/image/20161120/1479638684483523.png\" title=\"1479638684483523.png\" alt=\"blob.png\"/></p><p>scrollWidth和scrollHeight主要用于确定元素内容的实际大小。所以带有垂直滚动条的页面总高度就是document.documentElement.scrollHeight。</p><p><img src=\"/ueditor/php/upload/image/20161120/1479638735393838.png\" title=\"1479638735393838.png\" alt=\"blob.png\"/></p><h3>4.窗口大小</h3><p>在现代主流浏览器中提供了四个属性确定窗口的大小，分别为：innerWidth、innerHeight、outerWidth和outerHeight。</p><p><br/></p><p>在主流浏览器中，<code>document.documentElement.clientWidth</code>和<code>window.innerWidth</code>的值一样。但是在ie8及以下，<code>window.innerHeight</code>的值为undefined,而<code>document.documentElement.clientHeight</code>仍然有值。以下是求出适口的代码：</p><pre class=\"brush:php;toolbar:false\">var&nbsp;pageWidth=window.innerWidth,\r\npageHeight=window.innerHeight;\r\nif(typeof&nbsp;pageWidth&nbsp;!==&nbsp;&#39;number&#39;){\r\n&nbsp;&nbsp;&nbsp;&nbsp;if(document.compatMode&nbsp;===&nbsp;&#39;CSS1Compat&#39;){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pageWidth=document.documentElement.clientWidth;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pageHeight=document.documentElement.clientHeight;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}else{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pageWidth=document.body.clientWidth;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pageHeight=document.body.clientHeight;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n}</pre><p>解释：如果是现代浏览器，直接使用window.innerWidth和window.innerHeight就可以得到适口信息，如果是非现代浏览器。判断是标准模式，则用documentElement，否则的话就是body。</p><p><br/></p><p>代码中document.compatMode用于判断浏览器处于什么模式，它有两个值：BackCompat:浏览器处于怪异模式CSS1Compat:浏览器处于标准模式。</p><p><br/></p><p>本文摘录自：<a href=\"https://segmentfault.com/a/1190000005967868\" target=\"_self\">https://segmentfault.com/a/1190000005967868</a></p><p><br/></p><p>							</p>','scrollTop','js中的位置和大小','js中的位置和大小的知识点比较多，而且存在严重的兼容问题。','js',0,194),(34,1479731665,1479827494,1479731665,'<p>								</p><h3>1.题记<br/></h3><p>js运动是js学习中的一个难点，也是一个最能勾起你兴趣的点。看着各种动画效果，就有一种想去掌握的冲动。今天，我们就开始一步一步的来学习，掌握js运动。</p><p>js运动的核心是一个运动框架，有了这个框架，写任何运动都会事半功倍。看到框架不要害怕，所谓的框架就是一系列经验的总结，保证运动在各个平台，各种情况下都能正常运行。</p><p>废话不多说了，看我们的第一个简单到不能再简单的运动框架：</p><p>点击demo:<a href=\"/demo.php/Move/basic\" target=\"_blank\" title=\"阮文武-js运动基础\">/demo.php/Move/basic</a></p><pre class=\"brush:html;toolbar:false\">&lt;!doctype&nbsp;html&gt;\r\n&lt;html&gt;\r\n	&lt;head&gt;\r\n		&lt;meta&nbsp;charset=&quot;utf-8&quot;&nbsp;/&gt;\r\n		&lt;title&gt;js运动基础&lt;/title&gt;\r\n		&lt;style&gt;\r\n			*{padding:0;margin:0;}\r\n			#div1{width:200px;height:200px;position:absolute;left:0;top:0;background:red;}\r\n			#btn{position:absolute;top:250px;}\r\n		&lt;/style&gt;\r\n	&lt;/head&gt;\r\n	&lt;body&gt;\r\n		&lt;div&nbsp;id=&quot;div1&quot;&gt;&lt;/div&gt;\r\n		&lt;button&nbsp;id=&quot;btn&quot;&nbsp;onclick=&quot;startMove()&quot;&gt;click&nbsp;me&lt;/button&gt;\r\n	&lt;/body&gt;\r\n	&lt;script&gt;\r\n		var&nbsp;timer;\r\n		function&nbsp;startMove(){\r\n			var&nbsp;oDiv1&nbsp;=&nbsp;document.getElementById(&quot;div1&quot;);\r\n			var&nbsp;oBtn&nbsp;=&nbsp;document.getElementById(&quot;btn&quot;);\r\n			clearInterval(timer);&nbsp;&nbsp;&nbsp;&nbsp;//需要加上这一句，否则每次点击，定时器就会叠加，速度就会越来越快\r\n			timer&nbsp;=&nbsp;setInterval(function(){\r\n				if(oDiv1.offsetLeft&nbsp;&lt;&nbsp;300){\r\n					oDiv1.style.left&nbsp;=&nbsp;oDiv1.offsetLeft&nbsp;+&nbsp;10&nbsp;+&nbsp;&quot;px&quot;;&nbsp;&nbsp;&nbsp;&nbsp;//如果没到就继续运动，offsetLeft加10\r\n				}else{\r\n					clearInterval(timer);&nbsp;&nbsp;&nbsp;&nbsp;//如果到了就停止\r\n				}\r\n			},30);\r\n		}		\r\n	&lt;/script&gt;\r\n&lt;/html&gt;</pre><h3>2.代码解读</h3><p>原理就是，获取按钮元素和div元素。前提是div元素必须具有position属性才能动起来。</p><p>开启一个定时器，不断改变div的offsetLeft就可以了。就这么简单。</p><p>在完成这个最基本的运动框架的时候，有几个需要注意的点：</p><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>运动到固定位置的时候需要挺下来，不能没完没了的运动。</p></li><li><p>运动到了指定位置之后，再点按钮不能接着走。</p></li><li><p>在运动的过程中，点击按钮不能重复开启定时器，否则速度会倍增的。</p></li></ol><p>大家发现了没有，所谓的框架就是一个startMove方法而已。当然，随着我们学习的深入，这个方法会越来越“大”，也会越来越强大。</p><p>下面我将写几个基于这个最基本运动框架的例子。</p><p>							</p>','js运动','js运动基础（一）','跟我一起来温习一下js的运动知识吧。','js',0,76),(35,1479736213,1479827138,1479736213,'<p>								</p><h3>1.题记</h3><p>原理不多说了，参照我的前一篇博文。</p><h3>2.demo示例</h3><p><a href=\"/demo.php/Move/basicdemo\" target=\"_blank\">基本运动框架实例</a></p><p>							</p>','js运动','js运动基础（二）','js运动框架基础的简单应用的2个例子。这里的两个例子都是匀速运动。','js',0,140),(36,1479826963,1479895801,1479826963,'<p>								</p><h3>题记<br/></h3><p>前面两节，我们讲的都是匀速运动。今天我们学习一下缓冲运动的原理。缓冲运动的应用非常广泛。各大门户的焦点图基本都是缓冲运动。很常见的图片切换效果，大多也是缓冲。</p><h3>原理</h3><p>写一个控制器，不断的循环下面两个步骤就ok了。</p><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>运动的“目标点”减去“出发点”除以“速度系数”得到速度。</p></li><li><p>按照这个速度运动一次。</p></li></ol><h3>需要注意的点</h3><p>显示屏上的最小单位是1像素，在求得“速度”的时候，会出现小数的情况，出现小数，表现在运动上就是“走不动了”。解决办法就是取整：<span style=\"color: rgb(255, 0, 0);\">当正向运动时向上取整，当反向运动时向下取整。</span></p><p><span style=\"color:#ff0000\"><span style=\"color: rgb(0, 0, 0);\">代码我就不贴了，现在对贴代码有点反感，想看代码的同学，可以看我下面的链接。</span></span></p><h3>demo</h3><p>猛戳这里：<a href=\"/demo.php/Move/buffermove\" target=\"_blank\" title=\"缓冲运动实例\">缓冲运动实例（一）</a></p><p>猛戳这里：<a href=\"/demo.php/Move/chunlian\" target=\"_blank\">缓冲运动示例（二）春联效果</a></p><p>							</p>','缓冲运动','js运动基础（三）','写缓冲运动有两点要特别注意：1.运动“到位”，2.速度控制。','js',0,101),(37,1479828032,1481595931,1479828032,'<p>坚持就是你，不坚持就是nothing...</p>','干劲','keep moving...','坚持就是你，不坚持就是nothing...','说说',0,155),(38,1479950653,1479950653,1479950653,'<h3>题记</h3><p>运动的原理在上面几节都已经讲过了，这一节只是将上面讲的运动框架进行扩展，让它能支持多个物体同时运动起来，其实本质都是一样。不贴代码了，想看源码的同学，欢迎猛戳下面的demo。</p><h3>demo</h3><p>猛戳：<a href=\"/demo.php/Move/duowuti\" target=\"_blank\">js多物体运动框架</a></p>','js运动','js运动基础（四）','js多物体运动框架的核心是给每一个运动分配一个定时器，让他们互不干扰','js',0,64),(39,1479951940,1479951940,1479951940,'<h3>题记</h3><p>任意值运动框架仍然由我们前面熟悉的startMove函数扩展而来。只是在原来的基础上引入了getStyle方法来解决了一些再特殊情况下会发生的bug，并且让框架支持所有属性。</p><h3>核心代码</h3><p>startMove函数</p><pre class=\"brush:js;toolbar:false\">function&nbsp;startMove(obj,&nbsp;attr,&nbsp;target){\r\n	clearInterval(obj.timer);\r\n	obj.timer&nbsp;=&nbsp;setInterval(function(){\r\n		var&nbsp;cur&nbsp;=&nbsp;0;\r\n		if(attr&nbsp;==&nbsp;&quot;opacity&quot;){\r\n			//需要round，因为计算机的不精确性\r\n			cur&nbsp;=&nbsp;Math.round(parseFloat(getStyle(obj,attr))*100);\r\n			console.log(cur);\r\n		}else{\r\n		&nbsp;&nbsp;&nbsp;&nbsp;cur&nbsp;=&nbsp;parseInt(getStyle(obj,attr));\r\n		}\r\n		var&nbsp;speed&nbsp;=&nbsp;(target&nbsp;-&nbsp;cur)/10;\r\n		speed&nbsp;=&nbsp;speed&nbsp;&gt;&nbsp;0&nbsp;?&nbsp;Math.ceil(speed)&nbsp;:&nbsp;Math.floor(speed);\r\n		if(target&nbsp;==&nbsp;cur){\r\n			clearInterval(obj.timer);\r\n		}else{\r\n			if(attr&nbsp;!=&nbsp;&quot;opacity&quot;){\r\n				obj.style[attr]&nbsp;=&nbsp;cur&nbsp;+&nbsp;speed&nbsp;+&nbsp;&quot;px&quot;;\r\n			}else{\r\n				obj.style[attr]&nbsp;=&nbsp;(cur&nbsp;+&nbsp;speed)/100;\r\n				obj.style.filter&nbsp;=&nbsp;&quot;alpha(opacity:&quot;+(cur+speed)+&quot;)&quot;;\r\n			}\r\n		}\r\n	},30);\r\n}</pre><p>getStyle函数</p><pre class=\"brush:js;toolbar:false\">function&nbsp;getStyle(obj,&nbsp;attr){\r\n	if(obj.currentstyle){\r\n		return&nbsp;obj.currentStyle[attr];\r\n	}else{\r\n		return&nbsp;getComputedStyle(obj,false)[attr];\r\n	}\r\n}</pre><h3>demo</h3><p>猛戳这里：<a href=\"/demo.php/Move/renyizhi\" target=\"_blank\">js任意值运动框架，里面包含了一个透明度无线循环的例子</a></p>','js运动','js运动基础（五）','任意值运动框架要解决的问题，是让除了位置和大小以外的比如border，opacity等任意属性值动起来。','js',0,243),(40,1480228323,1480386511,1480228323,'<p>								</p><h3>题记<br/></h3><p>毫不夸张，这是一次足以让人受益终身的分享。虽说这次训练营是为新员工而发起，但是我觉得，这次分享对任何人都是极受用的。</p><p>肖总的《企业发展史》，蔡总的《有一份工作叫做中关村在线》，老大的《小东成功心法》，板凳的《员工职业路径规划》，王晔的《关键词解读》，沛哥的《数说ZOL》。这些分享，内容不同，但是分享的人都有一个共同点：正能量满满！</p><p>以下是我对这次分享的一些感悟，希望对读到它的人能有所帮助。</p><h3>企业发展史</h3><p>肖总讲企业发展史再合适不过了，因为他基本上见证了公司发展的各个时期。从1999年3月至今，这中间发生了很多故事，我摘其中几个印象比较深刻的说：<br/></p><p>1.2000年小东总加入公司。虽说职位是设计，但是他什么都做，而且都做的很优秀。且不论他是如何做到把专业之外的工作做的很优秀，只这种愿意多做，勇于担当的精神足以让人信赖。第一年加入公司就全面接手公司，抛开一些时机因素，其他的也就没什么好奇怪的了。</p><p>2.大概是2002年，我记不太清楚了，公司实现初次盈利。这次盈利意义重大，它不单是挽救公司于倒闭的边缘，更是证明了互联网盈利模式的可行性。</p><p>3.2003年非典肆虐期间，所有的公司都歇业了，唯有我们ZOL人，冒着生命的危险前往一线采集行情。正是这种超越同行的智慧与勇气，让ZOL在当时众多的竞争对手当中脱颖而出，从此ZOL进入飞速发展时期。</p><p>4.大概是2013年，在CBSi对中国国情不了解，对ZOL的发展不太看好的情况下，老大筹措数亿元将ZOL从CBSi买了回来，这是一个企业家对梦想的坚持，是对数代ZOL人的负责！</p><h3>有一份工作叫做中关村在线</h3><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>创新。</p><p>我到现在还记得荣耀V8拍摄的地球画面，太震撼了。原来我们能做到比自己想象的更多。</p></li><li><p>传承与创新。</p><p>传承的是精神，年轻就应该做些不一样的事情。</p></li><li><p>责任心。</p><p>我们要时刻的记住，我们不是在做一件主管或者经理交代的事情，我们是在客户负责，对客户的每一分钱负责，也是对自己同事负责，对自己的青春负责。</p></li><li><p>团队的力量</p><p>这些奇思妙想，没有团队的合作，是不可能完成的。</p></li></ol><h3>小东成功心法</h3><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>如何在逆境中生存。</p><p>小东总刚入社会时十分不顺利，辗转4个城市，换了几十份工作。后来好不容易在深圳一家知名的设计公司任职，工资是最低的不说，还不为老板认可。可是小东总并没有退缩，他谦卑为人，虚心请教，自掏腰包请客取经，团结同事最终得到同事和老板认可。</p></li><li><p>如何缩短自己和别人的差距。</p><p>向行业里最优秀的人学习，研究他们的长处，弥补自己的短处。凭借这一点，小东总那时候无论是在设计上还是在撰文上，都能在最短的时间内做的比周围的人优秀。</p></li><li><p>勤奋。</p><p>小东总十分谦虚，他在分享时说自己凭什么能获得成功？他说有些人是因为别的，而他是因为勤奋。可见勤奋对他的影响有多大，勤奋对一个人是多么重要。</p></li><li><p>负责。</p><p>小东总提到责任心这块就能挡住85%的人。确实，摸摸自己的良心，自己尽到自己最大的责任心了吗？在这个点上，小东总特别提到了女厕所的改造，和马桶品牌的选择。马桶比五星级酒店用的还好。而女厕的改造，因为大厦结构的原因，实施起来特别不容易，但是小东总仍然坚持做了。引用小东总的一句话：大的方面我们暂时比不过BAT，但是我们先从这些小的方面超越他们。他不希望女生上厕所总是要排队。这是一个企业家的责任心，也是一份善意。</p></li><li><p>情商。</p><p>小东总说以前公司小的时候，经常要求人。现在公司大了，比好多客户还要大。但是小东总出去见客户仍然十分谦卑，他总会跟对方提到三句话：您看我们那些方面做到不好的，给我们提个建议。您看有什么我们可以帮您的。还有一句记不得了，总之，要秉承利他原则。再就是要树立自己的品牌，朋友多了路好走。</p><p>一个人能走多远，不是由你的智商决定的，更多的由情商决定的。</p></li><li><p>正能量。</p><p>要充满正能量。负能量会让朋友远离你，何必自己给自己挖坑呢？</p></li><li><p>设定一个更高的目标。</p><p>没有一个更高的目标，怎么超越自己。</p></li><li><p>感恩。<br/></p></li></ol><h3>职业路径规划</h3><p>罗总的分享特别实用。他从自身的发展过程来讲述了这四个阶段：</p><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>起步。</p><p>首先做好自己的本职工作，提高职业技能。</p></li><li><p>发展期。</p><p>从小事做起，让自己成为一个靠谱的人，被依赖的人。</p></li><li><p>拓展自己的接触面。</p><p>我做好了设计，可不可以尝试一下其他的方面呢？比如产品。</p></li><li><p>进一步拓展自己。</p><p>做了产品，可不可以参加产品的运营了？</p></li></ol><p>这其中，罗总还考了我们一道题：说是有一个banner图，怎么改造这个banner图，让它获得更多的用户点击。结果让人都非常惊讶，改造后的方案是：把这个banner图变成了一个实用的小工具。一下子点击率从万分之一飙升到百分之一。创意实在是太有力的东西！</p><p>总之就是，做好每一件简单的事情，让自己成为一个值得依赖的人，不给自己设限。</p><h3>关键词解读</h3><p>王晔十分年轻，90后，来公司至今3年多。做的十分出色，2014，2015年的优秀员工都有他。他开始讲之前我一直很好奇，他是如何做到在三年内成为为数不多的资深编辑之一的。他分享完后，我就一点也不意外了。他阐述了12个关键词，我不能都记得了，但以下几个我印象深刻。</p><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>勇敢。</p><p>敢于做错，而不是粗心大意。</p></li><li><p>果敢。</p><p>敢于决断，有所为，而不是不把主管或者经理放在眼里。最近上映的《我不是潘金莲》传达了这样一个意思：不作为才是最大的腐败。确实，不作为不会做错，但是有什么值得称道的呢？</p></li><li><p>正直。</p><p>自己是否对的起自己的良心？</p><p>树立自己的品牌，走遍天下都不怕。</p></li><li><p>正能量。</p><p>不要受负能量的影响，把注意力放在自己最应该关注的方面。</p></li></ol><h3>数说ZOL</h3><p>作为一个技术员，我对沛哥列举的这些数字十分敏感。</p><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>平均每秒3万次的请求。</p><p>这对我们的网站架构和开发人员的技术要求都很高。也是我的技术目标。希望自己将来能传承这些技术，并做出自己的贡献。<br/></p></li><li><p>500多条产品线，平均每天更新4000+的产品和数量巨大的报价等相关信息。</p><p>据说市面上的产品库都是从ZOL取经学习而来的，实在是太牛了。</p></li><li><p>ZOL的技术布局。</p><p>这让我了解到自己所在公司的哪一环，自我定位和奋斗目标更明确了。</p></li></ol><p>以上这些都是我根据自己的记忆和感受所写，一来记录下来对自己是一个指引，二来希望能帮助到看到的人。如果有什么错误和纰漏，欢迎批评指正。</p><p>							</p>','分享','新员工拓展训练营总结','毫不夸张，这是一次足以让人受益终身的分享。虽说这次训练营是为新员工而发起，但是我觉得，这次分享对任何人都是极受用的。','生活',0,228),(41,1480424788,1480424907,1480424788,'<p>								</p><h3>题记</h3><p>原理的话在前面5节已经讲到，看demo吧。</p><h3>demo</h3><p><a href=\"/demo.php/Move/yingyong\" target=\"_blank\">js运动框架应用实例</a></p><p>							</p>','js运动','js运动基础（六）','js运动框架一个比较复杂的实例','js',0,151),(42,1480554236,1480556769,1480554236,'<p>								</p><p>《釜山行》的观后感就是：不要等到快要或者已经失去才知道珍惜。</p><p>							</p>','亲情','要重视对家人的陪伴与关注','《釜山行》看了两遍。一遍是自己一个人看的，一遍是和老婆一起看的。我们两个人看了都很感动。也是奇葩了，一部让人感动到不要不要的丧尸片。','说说',0,85),(43,1480555484,1480555972,1480555484,'<p>								</p><h3>题记<br/></h3><p>前面几节我们已经让startMove这个运动框架能够支持多物体、任意值的运动。现在我们对它进一步扩展，让它能够支持多属性。</p><h3>原理</h3><p>原理跟单属性类似，只是在开启定时器之后，需要遍历所有属性，当所有属性都运动“到位”后，我们才停止定时器。这里我们引入bStop这个变量作为“开关”,只有这个开关“说YES”了，我们就停止定时器。这个代码并不多，我就贴一下。不喜欢在这里看代码的，下面还有demo演示。</p><h3>代码</h3><pre class=\"brush:js;toolbar:false\">&lt;script&gt;\r\n//完美运动框架，支持多物体，任意值，多属性，链条式（回调）\r\nwindow.onload&nbsp;=&nbsp;function(){\r\n	function&nbsp;startMove(obj,&nbsp;json,&nbsp;fn){\r\n		clearInterval(obj.timer);\r\n		obj.timer&nbsp;=&nbsp;setInterval(function(){\r\n			var&nbsp;bStop&nbsp;=&nbsp;true;\r\n			for(var&nbsp;attr&nbsp;in&nbsp;json){\r\n				var&nbsp;cur;\r\n				if(attr&nbsp;==&nbsp;&quot;opacity&quot;){\r\n					cur&nbsp;=&nbsp;Math.round(parseFloat(getStyle(obj,attr))*100);\r\n				}else{\r\n					cur&nbsp;=&nbsp;parseInt(getStyle(obj,&nbsp;attr));\r\n				}\r\n				if(attr&nbsp;==&nbsp;&quot;opacity&quot;){\r\n					console.log(cur);\r\n				}\r\n				var&nbsp;speed&nbsp;=&nbsp;(json[attr]&nbsp;-&nbsp;cur)/10;\r\n				speed&nbsp;=&nbsp;speed&nbsp;&gt;&nbsp;0&nbsp;?&nbsp;Math.ceil(speed)&nbsp;:&nbsp;Math.floor(speed);\r\n				\r\n				if(cur&nbsp;!=&nbsp;json[attr]){\r\n					bStop&nbsp;=&nbsp;false;\r\n				}\r\n				\r\n				if(bStop){\r\n					clearInterval(obj.timer);\r\n					if(fn){\r\n						fn();\r\n					}\r\n				}else{\r\n					if(attr&nbsp;==&nbsp;&quot;opacity&quot;){\r\n						obj.style.opacity&nbsp;=&nbsp;(cur+speed)/100;\r\n						obj.style.filter&nbsp;=&nbsp;&quot;alpha(opacity:&quot;+(cur+speed)+&quot;)&quot;;\r\n					}else{\r\n						obj.style[attr]&nbsp;=&nbsp;cur&nbsp;+&nbsp;speed&nbsp;+&nbsp;&quot;px&quot;;\r\n					}\r\n				}\r\n			}\r\n		});\r\n	}\r\n	\r\n	//获取元素属性大小\r\n	function&nbsp;getStyle(obj,&nbsp;attr){\r\n		if(obj.currentStyle){\r\n			return&nbsp;obj.currentStyle[attr];\r\n		}else{\r\n			return&nbsp;getComputedStyle(obj,false)[attr];\r\n		}\r\n	}\r\n	\r\n	var&nbsp;oDiv&nbsp;=&nbsp;document.getElementById(&quot;j&quot;);\r\n	oDiv.onmouseover&nbsp;=&nbsp;function(){//添加鼠标移入事件\r\n		startMove(this,{width:30,height:400,opacity:80},function(){\r\n			alert(&quot;运动结束了，我出来了^_^&quot;);\r\n		});\r\n	}\r\n}\r\n&lt;/script&gt;</pre><h3>demo</h3><p>看例子猛戳我：<a href=\"/demo.php/Move/perfect\" target=\"_blank\">js完美运动框架demo</a></p>','js运动','js运动基础（七）','这一节我们进一步完善我们的运动框架，也就是startMove函数。','js',0,193),(44,1480688650,1480688720,1480688650,'<p>								</p><p><img src=\"/ueditor/php/upload/image/20161202/1480688711285550.png\" title=\"1480688711285550.png\" alt=\"blob.png\"/></p><p>							</p>','亲情','给宝贝画了一幅画','我跟她妈妈分别给她画了一幅画像。画工简直惨不忍睹，记下来做个纪念。','说说',2,183),(45,1480844902,1481363551,1480844902,'<p>								</p><h3>题记<br/></h3><p>拖拽也是js的应用中比较有趣的一个部分。</p><h3>原理</h3><p>鼠标移动时，让元素跟随鼠标进行“改变坐标”的操作。</p><h3>代码</h3><pre class=\"brush:js;toolbar:false\">&lt;script&gt;\r\n	window.onload&nbsp;=&nbsp;function(){\r\n		var&nbsp;oDiv&nbsp;=&nbsp;document.getElementById(&quot;div1&quot;);\r\n		oDiv.onmousedown&nbsp;=&nbsp;function(){\r\n			var&nbsp;pos&nbsp;=&nbsp;getPos();\r\n			console.log(pos);\r\n			var&nbsp;diffX&nbsp;=&nbsp;pos.x&nbsp;-&nbsp;this.offsetLeft;&nbsp;&nbsp;&nbsp;&nbsp;//求出鼠标点距离元素的边距\r\n			var&nbsp;diffY&nbsp;=&nbsp;pos.y&nbsp;-&nbsp;this.offsetTop;\r\n			console.log(diffX+&quot;,&quot;+diffY);\r\n			document.onmousemove&nbsp;=&nbsp;function(){\r\n				var&nbsp;pos&nbsp;=&nbsp;getPos();\r\n				oDiv.style.left&nbsp;=&nbsp;pos.x&nbsp;-&nbsp;diffX&nbsp;+&nbsp;&quot;px&quot;;\r\n				oDiv.style.top&nbsp;&nbsp;=&nbsp;pos.y&nbsp;-&nbsp;diffY&nbsp;+&nbsp;&quot;px&quot;;\r\n			}\r\n			\r\n			document.onmouseup&nbsp;=&nbsp;function(){\r\n				//oDiv.onmousedown&nbsp;=&nbsp;null;\r\n				document.onmousemove&nbsp;=&nbsp;null;\r\n				document.onmouseup&nbsp;=&nbsp;null;\r\n			}\r\n		}\r\n	}\r\n	\r\n	//获取鼠标在屏幕中的位置\r\n	function&nbsp;getPos(){\r\n		var&nbsp;oTop&nbsp;&nbsp;=&nbsp;document.documentElement.scrollTop&nbsp;||&nbsp;document.body.scrollTop;\r\n		var&nbsp;oLeft&nbsp;=&nbsp;document.documentElement.scrollLeft&nbsp;||&nbsp;document.body.scrollLeft;\r\n		var&nbsp;e&nbsp;=&nbsp;arguments.callee.caller.arguments[0]&nbsp;||&nbsp;event;\r\n		var&nbsp;y&nbsp;=&nbsp;oTop&nbsp;+&nbsp;e.clientY;\r\n		var&nbsp;x&nbsp;=&nbsp;oLeft&nbsp;+&nbsp;e.clientX;\r\n		return&nbsp;{x:x,y:y};\r\n	}\r\n&lt;/script&gt;</pre><h3>demo</h3><p>猛戳我，看效果：<a href=\"/demo.php/Event/dragbasic\" target=\"_blank\">js拖拽基础demo</a></p><p>							</p>','js事件','js事件应用基础之拖拽（一）','拖拽的核心原理是鼠标跟随。','js',0,97),(47,1480904680,1481079125,1480904680,'<p>								</p><h3>题记<br/></h3><p>上一节中说的拖拽在ie7下有个bug。就是在拖拽的过程中会选中文字。这一节展示的是一个兼容的版本。</p><p><br/></p><p>使用的是setCapture和releaseCapture这对东西。这对东西的作用是事件捕获,释放事件捕获。通俗点来说，就是一旦某个元素开始调用捕获方法（setCapture），页面中所有的事件都会跑到这个元素上来。所以相应的，当我们使用完毕这个属性后要用releaseCapture（释放捕获）</p><h3>demo</h3><p>最好的说明就是看demo:<a href=\"/demo.php/Event/perfectdrag\" target=\"_blank\">猛戳这里</a></p><p><br/></p><h3>补充（重要）</h3><p>在调试的过程中发现一个问题。就是在ff和chrome下window.event都是undefined，传入参数获取event对象的方法不是在所有函数里都通用，而是必须在事件处理的匿名函数中才可以。有兴趣的可以运行一下这个小代码：</p><pre class=\"brush:html;toolbar:false\">&lt;!doctype&nbsp;html&gt;\r\n&lt;html&gt;\r\n	&lt;input&nbsp;type=&quot;button&quot;&nbsp;value=&quot;click&quot;&nbsp;id=&quot;btn1&quot;&nbsp;/&gt;\r\n	&lt;script&gt;\r\n		console.log(window.event);	\r\n		var&nbsp;oBtn&nbsp;=&nbsp;document.getElementById(&quot;btn1&quot;);\r\n		oBtn.onclick&nbsp;=&nbsp;function(e){\r\n			console.log(e);\r\n		}\r\n		\r\n		function&nbsp;noEvent(e){\r\n			console.log(&quot;---&quot;+e);\r\n		}\r\n		noEvent();\r\n	&lt;/script&gt;\r\n&lt;/html&gt;</pre><p>运行的结果如图所示（火狐和chrome下面的显示结果一样）：</p><p><img src=\"http://ruanwenwu.cn/Public/plugin/ueditor/themes/default/images/spacer.gif\"/></p><p><img src=\"/ueditor/php/upload/image/20161207/1481078314150715.png\" title=\"1481078314150715.png\" alt=\"8BRIZ8IW[})6J{`~[(AJIKO.png\"/></p><p>最后，我是通过这样的方法解决的：</p><pre class=\"brush:html;toolbar:false\">function&nbsp;getPos(){\r\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;sTop&nbsp;&nbsp;=&nbsp;document.documentElement.scrollTop&nbsp;||&nbsp;document.body.scrollTop;\r\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;sLeft&nbsp;=&nbsp;document.documentElement.scrollLeft&nbsp;||&nbsp;document.body.scrollLeft;\r\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;e=arguments.callee.caller.arguments[0]&nbsp;||&nbsp;window.event;&nbsp;//关键在这里\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;{x&nbsp;:&nbsp;sLeft&nbsp;+&nbsp;e.clientX,&nbsp;y&nbsp;:&nbsp;sTop&nbsp;+&nbsp;e.clientY};\r\n}</pre><p>原理就是通过arguments.callee.caller.arguments[0]解决的。这句代码的意思是获得arguments的callee，也就是getPos。然后获得getPos的caller，也就是事件匿名函数了。而匿名函数的第一个参数就是event对象。这样问题就解决了。<span style=\"color: rgb(255, 0, 0);\">至于后面为什么还要加上window.event这个东西，是因为ie7下不支持arguments。</span></p>','js事件','js事件应用基础之拖拽（二）','上一节中说的拖拽在ie7下有个bug。就是在拖拽的过程中会选中文字。这一节展示的是一个兼容的版本。','js',0,377),(48,1481460540,1481460540,1481460540,'<h3>1.题记</h3><p>下拉刷新的核心原理很简单。主要可以分解成3个部分。1.开始拉动。2.拉动。3.拉动结束。</p><h3>2.原理</h3><p>2.1.开始拉动</p><p>记录触摸点Y轴坐标。使用的是touchstart事件。</p><p>2.2.拉动</p><p>使用touchmove事件，每次事件触发时记录触摸点Y坐标。根据拉动的方向与距离判断在拉动过程中“提示部分”的状态变化。</p><p>2.3.拉动结束</p><p>使用touchend事件，判断最终运动的位置，判断是否需要刷新页面。</p><h3>3.demo</h3><p>猛戳这里：<a href=\"/demo.php/event/pullrefresh\" target=\"_blank\">js下拉刷新实例</a></p><h3>4.说明</h3><p>这个例子还远弹不上完美，需要使用的盆友，请斟酌再使用。</p><p><br/></p>','css3','原生js下拉刷新','下拉刷新的核心原理很简单。主要可以分解成3个部分。1.开始拉动。2.拉动。3.拉动结束。','js',0,66),(49,1481461619,1481461653,1481461619,'<p>								</p><h3>什么是设计模式</h3><p>什么是设计模式？如果把某种变成语言比作一本武功秘籍，那么设计模式就是具体的一招一式。所以，想成为武林高手的你，不妨跟我来一起探索一下设计模式的奥秘吧。</p><p><br/></p><p>							</p>','php设计模式','php设计模式（一）','什么是设计模式？如果把某种编程语言比作一本武功秘籍，那么设计模式就是具体的一招一式。所以，想成为武林高手的你，不妨跟我来一起探索一下设计模式的奥秘吧。','php',0,86),(50,1481502944,1481506594,1481502944,'<p>								</p><h3>题记</h3><p>这一节我们讲php的spl标准库。</p><h3>栈结构</h3><p>splStack代码示例：</p><pre class=\"brush:php;toolbar:false\">&nbsp;&nbsp;&nbsp;&nbsp;//栈结构，后进先出，就像步枪压子弹。\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;splstack(){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stack&nbsp;=&nbsp;new&nbsp;\\SplStack();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stack-&gt;push(3);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stack-&gt;push(&quot;jack&quot;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var_dump($stack-&gt;pop());\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&#39;&lt;br/&gt;&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($stack&nbsp;as&nbsp;$k&nbsp;=&gt;&nbsp;$v){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;$k.&#39;-&#39;.$v.&#39;&lt;br/&gt;&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p>运行结果:<a href=\"/demo.php/spl/splstack\" target=\"_blank\">猛戳这里</a><br/></p><p><img src=\"/ueditor/php/upload/image/20161212/1481501436981213.png\" title=\"1481501436981213.png\" alt=\"blob.png\"/></p><h3>队列</h3><pre class=\"brush:php;toolbar:false\">&nbsp;&nbsp;&nbsp;&nbsp;//队列，像排队一样，先进先出\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;splqueue(){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$queue&nbsp;=&nbsp;new&nbsp;\\SplQueue();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$queue&nbsp;-&gt;&nbsp;enqueue(3);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$queue&nbsp;-&gt;&nbsp;enqueue(&quot;jack&quot;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$queue&nbsp;-&gt;&nbsp;enqueue(&quot;lucy&quot;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$queue&nbsp;-&gt;&nbsp;shift();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($queue&nbsp;as&nbsp;$k&nbsp;=&gt;&nbsp;$v){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;$k.&#39;-&#39;.$v.&#39;&lt;br/&gt;&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p>运行结果：<a href=\"/demo.php/spl/splqueue\" target=\"_blank\">猛戳这里</a></p><p><img src=\"/ueditor/php/upload/image/20161212/1481501985474659.png\" title=\"1481501985474659.png\" alt=\"blob.png\"/></p><h3>堆和固定尺寸数组</h3><p>SplMinHeap</p><p>固定尺寸数组</p><p>SplFixedArray(n)</p><h3>后记<br/></h3><p>数据结构的内容很多，后面我们专门来讲。<br/></p><p>							</p>','php设计模式','php设计模式（二）','这一节我们讲php的spl标准库。','php',0,89),(51,1481509457,1481509565,1481509457,'<p>								</p><p><img src=\"/ueditor/php/upload/image/20161212/1481509437209386.png\" title=\"1481509437209386.png\" alt=\"C~B83V@0]50S`WDX5D{{YQ1.png\"/></p><p>							</p>','温暖','秀一把恩爱，添加点动力','前方高能，\"单身汪\"请做好心理准备^_^。','说说',0,149),(52,1481592171,1481595960,1481592171,'<p>								</p><p>三毛的字字句句里都闪耀着人性的光辉。因为三毛，再一次，我觉得到了文字的美好。<br/></p><p><br/></p><p><br/></p><p>							</p>','温暖','有一种感动叫做三毛','三毛的字字句句里都闪耀着人性的光辉。因为三毛，再一次，我觉得到了文字的美好。','说说',0,82),(53,1481625157,1481625157,1481625157,'<p>题记</p><p>计划任务多到一定程度，如果我们不对crontab做规划，那么我们的crontab将会老长老长。于是出现了这种布置：</p><p><img src=\"/ueditor/php/upload/image/20161213/1481624702218904.png\" title=\"1481624702218904.png\" alt=\"blob.png\"/></p><p>可以发现，这样一定程度上缓解了一些crontab的臃肿。一个文件，比如auto_run_1hour.php里可以运行4个计划任务了。这样做，把需要每小时执行一次的文件归纳到了一起，但是这样做有个致命的问题，当这4个中任何一个脚本终止，会导致整个下面的代码停止执行。为了解决这个问题，我们尊敬的徐闯先生想出了这样一个办法：</p><p><img src=\"/ueditor/php/upload/image/20161213/1481624988566114.png\" title=\"1481624988566114.png\" alt=\"blob.png\"/></p><p>仍然是把每小时执行一次的脚本放到一起，只是这个auto_run_1day.php发生了改变，不是简单的include需要自动运行的php脚本，而是遍历需要跑的文件，将他们丢到系统后台去跑，而且还做了进程监控，避免重复的运行开销以及错误。是在是太棒了。</p>','小技巧','更灵活的计划任务布置','感谢我的领导徐闯先生发明了这么好的方法。我在此进行记录，希望帮到更多的人。','php',0,106),(54,1481642441,1481642566,1481642441,'<p>								</p><p>三毛，我亲爱的女儿：　</p><p>　　自你决定去撒哈拉大漠后，我们的心就没有一天安静过，怕你吃苦，怕你寂寞，更担心你难以适应沙漠的日常生活。但每次接你来信好像都在天堂，心情愉快，对生活充满信心。物质上的缺乏，气候的骤变，并没有影响你的情绪。我想可能是沙漠美丽的景色深深地迷惑了你，夕阳中的蜃楼，一望无垠的黄沙，一向是你所神住。一旦投入其中，谁能体会？谁能领略？<br/><br/>　　所以，这次你去撒哈拉，我和你父亲都没有阻止。明知道这是何等崎岖艰苦的道路，但是为了你的志趣和新生活的尝试，我们忍住了眼泪，答应下来。孩子，你可知道父母的心里是如何的矛盾，如何的心酸！这一时期，我差不多常常跑邮局，恨不得把你喜爱的食物或点缀布置的小玩意儿，统统寄上，借着那些小小的礼物，也寄上我们无限的爱和想念。有一天，你告诉我们，已拥有了梦中的白马王子，我们万分喜悦接纳了我们淳厚的半子——荷西。你孤单的生活将告一段落，从此有人陪伴你，携手共度人生漫漫的岁月。重重的叮咛，深深的祝福，难表父母的心声。我的女儿，愿你幸福快乐，直到永永远远。<br/><br/>　　在你完全适应荒凉单调的沙漠婚姻生活后，你很想动动久已搁起的笔杆，希望哪一位副刊的主编先生能慧眼识英雄（小猫也），提拔一下，让你乐一乐，以后才有信心再写。我每晚都祈祷求神拭一拭那位主编的眼睛，能使他看中我们三毛的文章，真的，那天早晨在联副上看到你第一篇文章《中国饭店》（《沙漠中的饭店》），我把家中所有的人都叫起来，争阅你的故事，大家都非常高兴。家中没有香槟，只好买豆浆代替庆祝，心中十分感激那位主编先生。（后来才知道是平鑫涛先生，大概是受了上帝的催眠。）从此你打开了写作之门，一篇比一篇精彩，一篇比一篇生动。你把我们每一个读者都引进了你的生活，你的故事好像就发生在我们的身边左右，有笑也有泪。自读完了你的《白手成家》后，我泪流满面，心如绞痛，孩子，你从来都没有告诉父母，你所受的苦难和物质上的缺乏，体力上的透支，影响你的健康，你时时都在病中。你把这个僻远荒凉、简陋的小屋，布置成你们的王国（都是废物利用），我十分相信，你确有此能耐。那时，许多爱护你的前辈，关怀你的友好，最可爱的是一些年轻的热爱你的读者朋友们，电话、信件纷纷而来，使人十分感动。在《白手成家》刊出后，进入最高潮，任何地方都能听到谈论三毛何许人也，我们以你为荣，也分享了你的快乐，这是你给父母一生中最大的安慰。（是你牺牲多少夜晚及日常生活中的辛酸换取的代价。虽然你在写作上刚刚起步，但在给我们父母的感受上却是永恒。）<br/><br/>　　我的女儿，在逝去的岁月中，虽然有太多的坎坷，但我们已用尽爱的金线，一针一针经纬地织补起来，希望父母的巧手神工能织得像当初上帝赐给你的一样，天衣无缝，重度你快乐健康的人生。孩子，请接受父母的祝福和祈祷，愿主赐恩。<br/><br/>　　你车祸的消息，一直等你出院后，你姐姐才告诉我们（瞒得好紧）。当时我脑中一片茫然，整个世界仿佛都在旋转，泪含满眶，默默无语，心碎片片，千水万山，无法亲临照顾。孩子，你怕我们伤心难受，教姐姐慢慢再讲，这是你的孝心，但你可想到，我们知道了一样地神伤，担忧焦急，一直到收到你的录音带与照片后，仍未能释然。看到你消瘦无力的样子，更耿耿于怀；每次午夜梦回，你可曾听到母亲依依的呼唤？天涯海角，不论离我们多么遥远，我们的心灵总是彼此相通。尤其是你父亲，是你一生中最大的凭依。前一阵他患眼疾，视力衰退，你每信都殷殷问候，思亲之情，隐于字间，读后常使我们泫然泪下，思念更深。最近虽然你没有提及任何不妥，但在家信中常感觉到你又在病中。<br/><br/>　　撒哈拉的一段生活，使你亏损太多，等荷西找到了新的工作，安顿好家，快快地回来吧，让我们好好地看看久别的女儿，是否依旧神采飘逸。<br/><br/>　　夜已很深，春天的夜晚仍有寒意，请为父母多披上一件外衣，珍重复珍重。千言万言，难诉尽母亲的心语。我的女儿，愿你快乐健康！顺祝平安！<br/><br/>　　母示<br/><br/>　　一九七六年四月一日午夜</p><p><br/></p><p>							</p>','撒哈拉沙漠的故事','妈妈的一封信','静静地听三毛说就好。','转载',0,68),(55,1481642879,1481642879,1481642879,'<p>各位朋友：<br/><br/>　　回到台北已经二十多天，在这短短的时间里，我收到无数过去与我通信的读者、我教过的学生、以及许许多多新朋友的来信与电话，我也在台北街头看见自己的新书挤在一大堆花花绿绿的书刊里向我扮着顽皮的鬼脸。<br/><br/>　　每当我收到由各方面转来的你们的来信时，我在这一封封诚意的信里，才看出了我自己的形象，才知道三毛有这么多不相识的朋友在鼓励着她。<br/><br/>　　我多么希望每一封信都细细的回答你们，因为我知道，每一个写信给我的人，在提笔时，也费了番心思和时间来表示对我的关怀。<br/><br/>　　我怎么能够看见你们诚意的来信，知道你们一定在等着我的回音，而那一封封的信都如石沉大海，没有回声。<br/><br/>　　请无数写信给我的朋友了解我，三毛不是一个没有感情也没有礼貌的人。<br/><br/>　　离开家国那么久了，台北的亲情友情，整整的占据了我，我尽力愿意把我自己的时间，分给每一个关怀我的朋友，可惜的是，我一天也只能捉住二十四小时。<br/><br/>　　生活突然的忙碌热闹，使我精神上兴奋而紧张，体力上透支再透支，而内心的宁静却已因为这些感人的真情流露起了很大的波澜。<br/><br/>　　虽然我努力在告诉自己，我要完完全全享受我在祖国的假期，游山玩水，与父母亲闲话家常。事实上，我每日的生活，已成了时间的奴隶，我日日夜夜的追赶着它，而仿佛永远不能在这件事上得到释放。<br/><br/>　　过去长久的沙漠生活，已使我成了一个极度享受孤独的悠闲乡下人，而今赶场似的吃饭和约会，对我来说，就如同刘姥姥进了大观园，昏头转向，意乱情迷。<br/><br/>　　每日对着山珍海味，食不下咽，一个吃惯了白薯饼的三毛，对着亲友感情的无数大菜，感动之余，恨不能拿一个大盒子装回北非去，也好在下半年不再开伙。我多么遗憾这些美味的东西要我在短短的时间里全部吃下去啊！<br/><br/>　　在这种走马灯的日子里，我一方面极感动朋友对我的爱护；另一方面，我却不能一一答应来信及电话中要求与我单独见面的朋友的盛意。<br/><br/>　　我恨不能将我的时间，分成每一个如稿纸似的小格子，像写稿一样，在每一格里填上一个朋友的名字、时间、和见面的地点。在我，写两三千字是易，而要分别见到那么多朋友，却是力不从心的憾事啊！<br/><br/>　　我真愿意爱护我的朋友，了解我现在的情况，请不要认为我们不能见面就是一件可惜的事，因为文学的本身，对每一个读者，在看的时候，已经成了每一个人再创造出来的东西，实体的三毛，不过是一个如她一再强调的小人物，看了她你们不但要失望，连她自己看了她的故事，再去照顾镜子，一样也感到不真实。<br/><br/>　　因此我很愿意对我的朋友们说，我的文章刊出来时，我们就是在默默的交谈了。<br/><br/>　　在台北亲友聚会里，常常会遇到许多我过去不认识的人，他们对我刚出的书——《撒哈拉的故事》里的每一篇，每一个细节，每一件小事，甚而每一句话，都好似背通过了似的熟悉。<br/><br/>　　这种情形，令一个远方归来的游子惊讶、木讷，再而更觉得惭愧而不知所措。<br/><br/>　　我所能说的，也许只是一句普通的谢谢，但是这份关怀，却成了我日后努力写作下去的力量。<br/><br/>　　我一向没有耐性，尤其讨厌把自己钉在书桌前爬格子，但是当我回国的第一天，我听到居然有许多学校的同学，整班整班的在预约我的新书时，我的心一样受到了感动。许多人对我谈起《撒哈拉的故事》，更令我惊讶的是，我过去只期待着大人看我的书，没想到，竟也有小学生，托了我的侄儿和外甥们，要请他们带着，来拜望这个沙漠里的姑姑。<br/><br/>　　我多么为这一个发现而骄傲欢喜，我真愿意我也做一个小朋友的三毛，因为《圣经》上一再的说——“你们要像小孩子，才能进天国，因为天堂是他们的。”<br/><br/>　　亲爱的小读者，我是多么的看重你们，但愿三毛的书，能够在沉重的课业之外，带给你们片刻轻松的时光。<br/><br/>　　如果朋友们还没有厌倦了这个如我一样的小人物三毛，我愿意不断的做一个说故事的人。我不会讲什么大道理，因为我没有学问，但是，我愿意在将来的日子里，仍做不断的努力，以我的手，写我的口，以我的口，表达我的心声。<br/><br/>　　也许有时候我会沉寂一阵，不再出稿，请不要以为我是懒散了，更不要以为三毛已经鸿飞无痕，不计东西。如果我突然停顿了，那只表示我在培养自己、沉淀自己；在告诉自己：写，是重要，而有时搁笔不写，却是更重要。<br/><br/>　　目前我仍有写作的兴趣和材料，我因此仍要继续我过去已经开始了的长跑，但愿在不久的将来，当三毛一本一本的新书出版时，使爱护我的读者看见我默默的努力。<br/><br/>　　我的书在短短的一个半月之内，已经出了第四版了，我要感谢读者对我的支持和鼓励。在我，写作的本身，并不是为了第三者，更不是为了成名。但是，因为读者热烈的反应，使我一个平凡而简单的家庭主妇，认知了今后要再努力去奔跑的路，这是我一生里要感谢你们的啊！<br/><br/>　　下个月，我为了对家庭及对丈夫的责任，不得不再度告别我的家，我的国，回到千山万水外的北非去。我是多么的不舍，也多么的不安，不能给每一个爱护我的朋友充足的时间，来聚一聚，谈一谈。<br/><br/>　　我的朋友，我们原来并不相识，而今也不会相逢，但是人生相识何必相逢，而相逢又何必相识。<br/><br/>　　在台北，我不觉得离你们近，在非洲我也不觉得离你们远，只要彼此相知欣赏，天涯真是如比邻啊！<br/><br/>　　我再谢谢你们的关爱，请不要忘记，三毛虽然是个小人物，却有一颗宽阔的心，在她的心里，安得下世界上每一个她所爱的人。<br/><br/>　　给我生命，养我长大，不变的爱护着我的双亲，他们给了我一个永远欢迎我的家，在这个避风港里，我完全的释放自己，尽情的享受我在外得不着的温暖和情爱。<br/><br/>　　感谢上帝，给了我永恒的信仰，她迎我平安的归来，又要带着我一路飞到北非我丈夫的身边去。我何其有幸，在亲情、友情和爱情上，一样都不缺乏。<br/><br/>　　我虽然常握着我生命小船的舵，但是在黑暗里，替我挂上了那颗在静静闪烁的指路星，却是我的神。他叫我去哪里，我就去哪里，在我心的深处，没有惧怕，没有悲哀，有的只是一丝别离的怅然。<br/><br/>　　因为上帝恒久不变的大爱，我就能学习着去爱每一个人，每一个世上的一草一木一沙。<br/><br/>　　谢谢你们，没有见过面的朋友。但愿人长久，千里共婵娟。<br/><br/>　　祝<br/><br/>　　平安喜乐<br/><br/>　　三毛上</p>','撒哈拉沙漠的故事','回乡小笺','静静地听三毛说就好了。','转载',0,789),(56,1482809305,1482816790,1482809305,'<p>								</p><h3>题记：<br/></h3><p>一般我自己生成XML文件习惯使用字符串拼接的方式。其实php中的DOMDocument已经帮我们准备好了生成一个标准的XML文件的一切方法。</p><pre>&lt;?php\r\n\r\n//&nbsp;Set&nbsp;the&nbsp;content&nbsp;type&nbsp;to&nbsp;be&nbsp;XML,&nbsp;so&nbsp;that&nbsp;the&nbsp;browser&nbsp;will&nbsp;&nbsp;&nbsp;recognise&nbsp;it&nbsp;as&nbsp;XML.\r\nheader(&nbsp;&quot;content-type:&nbsp;application/xml;&nbsp;charset=utf-8&quot;&nbsp;);\r\n\r\n//&nbsp;实例化DOMDocument.\r\n$xml&nbsp;=&nbsp;new&nbsp;DOMDocument(&nbsp;&quot;1.0&quot;,&nbsp;&quot;utf-8&quot;&nbsp;);\r\n\r\n//&nbsp;创建Album元素和其子元素Track.\r\n$xml_album&nbsp;=&nbsp;$xml-&gt;createElement(&nbsp;&quot;Album&quot;&nbsp;);\r\n$xml_track&nbsp;=&nbsp;$xml-&gt;createElement(&nbsp;&quot;Track&quot;,&nbsp;&quot;The&nbsp;ninth&nbsp;symphony&quot;&nbsp;);\r\n\r\n//&nbsp;为元素设置属性\r\n$xml_track-&gt;setAttribute(&nbsp;&quot;length&quot;,&nbsp;&quot;0:01:15&quot;&nbsp;);\r\n$xml_track-&gt;setAttribute(&nbsp;&quot;bitrate&quot;,&nbsp;&quot;64kb/s&quot;&nbsp;);\r\n$xml_track-&gt;setAttribute(&nbsp;&quot;channels&quot;,&nbsp;&quot;2&quot;&nbsp;);\r\n\r\n//&nbsp;创建Note子元素\r\n$xml_note&nbsp;=&nbsp;$xml-&gt;createElement(&nbsp;&quot;Note&quot;,&nbsp;&quot;The&nbsp;last&nbsp;symphony&nbsp;composed&nbsp;by&nbsp;Ludwig&nbsp;van&nbsp;Beethoven.&quot;&nbsp;);\r\n\r\n//&nbsp;将各子元素添加到父元素内\r\n$xml_track-&gt;appendChild(&nbsp;$xml_note&nbsp;);\r\n$xml_album-&gt;appendChild(&nbsp;$xml_track&nbsp;);\r\n\r\n//&nbsp;重复..\r\n$xml_track&nbsp;=&nbsp;$xml-&gt;createElement(&nbsp;&quot;Track&quot;,&nbsp;&quot;Highway&nbsp;Blues&quot;&nbsp;);\r\n\r\n$xml_track-&gt;setAttribute(&nbsp;&quot;length&quot;,&nbsp;&quot;0:01:33&quot;&nbsp;);\r\n$xml_track-&gt;setAttribute(&nbsp;&quot;bitrate&quot;,&nbsp;&quot;64kb/s&quot;&nbsp;);\r\n$xml_track-&gt;setAttribute(&nbsp;&quot;channels&quot;,&nbsp;&quot;2&quot;&nbsp;);\r\n$xml_album-&gt;appendChild(&nbsp;$xml_track&nbsp;);\r\n\r\n$xml-&gt;appendChild(&nbsp;$xml_album&nbsp;);\r\n\r\n//&nbsp;输出XML.\r\nprint&nbsp;$xml-&gt;saveXML();//如果要保存xml文件，只需要把saveXML()方法换成save(path)方法就可以。save方法里放文件存储路径。\r\n\r\n/*输出内容:\r\n&lt;Album&gt;\r\n&nbsp;&nbsp;&lt;Track&nbsp;length=&quot;0:01:15&quot;&nbsp;bitrate=&quot;64kb/s&quot;&nbsp;channels=&quot;2&quot;&gt;\r\n&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;ninth&nbsp;symphony\r\n&nbsp;&nbsp;&nbsp;&nbsp;&lt;Note&gt;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;last&nbsp;symphony&nbsp;composed&nbsp;by&nbsp;Ludwig&nbsp;van&nbsp;Beethoven.\r\n&nbsp;&nbsp;&nbsp;&nbsp;&lt;/Note&gt;\r\n&nbsp;&nbsp;&lt;/Track&gt;\r\n&nbsp;&nbsp;&lt;Track&nbsp;length=&quot;0:01:33&quot;&nbsp;bitrate=&quot;64kb/s&quot;&nbsp;channels=&quot;2&quot;&gt;Highway&nbsp;Blues&lt;/Track&gt;\r\n&lt;/Album&gt;*/</pre><p>官方对DOMDocument的解释是：Represents an entire HTML or XML document; serves as the root of the document tree.意思就是说它代表整个HTML或者XML文件，作为文档数的根来使用。简而言之，就是操作整个文档的用它就对了。比如文档的输出，保存，添加节点等都可以用到这个实例。</p><p>上面这个例子的解释：新建一个XML文档，根元素是&lt;Album&gt;，根里面放了两首“单曲”，每首单曲有各自的属性。</p><p>这样看来用DOMDocument来创建一个xml文件还是比较方便的。</p><h3>获取DOM元素常用的方法：</h3><p>public&nbsp;<a href=\"http://php.net/manual/en/class.domnodelist.php\">DOMNodeList</a>&nbsp;DOMElement::getElementsByTagName&nbsp;(&nbsp;string&nbsp;$name&nbsp;)</p><p>This function returns a new instance of the class&nbsp;<a href=\"http://php.net/manual/en/class.domnodelist.php\">DOMNodeList</a>&nbsp;of all descendant elements with a given tag&nbsp;name, in the order in which they are encountered in a preorder traversal of this element tree.</p><p>可以观察到，返回值是一个DOMNodeList的实例。方法所属的实例是DOMElement。这个方法传入一个元素标签名，返回DOMNodeList集合。</p><p>以我们在题记中生成这个xml文件为例（啰嗦一句：保存xml文件使用的是save()方法。我在题记中的代码注释里标注出来了。我用这个方法将文件保存为album.xml了，方便在下面演示）：</p><p><img src=\"/ueditor/php/upload/image/20161227/1482810167344877.png\" title=\"1482810167344877.png\" alt=\"blob.png\"/></p><p>现在我们获取Track元素：</p><pre>&lt;?php\r\n$xml&nbsp;=&nbsp;new&nbsp;DOMDocument();\r\n$xml-&gt;load(&quot;album.xml&quot;);\r\n$tracks&nbsp;=&nbsp;$xml-&gt;getElementsByTagName(&quot;Track&quot;);\r\nforeach($tracks&nbsp;as&nbsp;$track){\r\n	echo&nbsp;$track-&gt;nodeValue.&#39;&lt;br/&gt;&#39;;\r\n}</pre><p>输出结果：<br/></p><p><img src=\"/ueditor/php/upload/image/20161227/1482810596115910.png\" title=\"1482810596115910.png\" alt=\"blob.png\"/></p><p>结果说明，我们成功获取到了这两个Track标签。在上面的代码中，我们还使用了一个load方法。load方法的作用就是从文件中读取xml数据。</p><p><br/></p><p>public&nbsp;<a href=\"http://php.net/manual/en/class.domelement.php\">DOMElement</a>&nbsp;DOMDocument::getElementById&nbsp;(&nbsp;string&nbsp;$elementId&nbsp;)</p><p>这个方法通过元素的id去获取元素，但是有一点要注意：需要有xml前缀才能获取到。</p><pre>&lt;child&nbsp;xml:id=&quot;id_xxxxxx&quot;&nbsp;status=&quot;partial&quot;&gt;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;sub_child&gt;Some&nbsp;Data&lt;/sub_child&gt;\r\n&lt;/child&gt;</pre><h3>其他：</h3><p>还有很多的类和方法，具体用到再去看吧。</p><p>http://php.net/manual/en/domdocument.getelementbyid.php</p><p><br/></p><p>							</p>','DOMDocument','使用dom的方式处理xml文件','使用DOM的方式处理xml的优势是：灵活，高效。在需要对xml文件进行修改（新增或者修改）时，用起来特别方便。','php',0,82),(57,1482818817,1482818817,1482818817,'<p>原理：</p><p>在分页类中生成url时携带onclick事件触发js函数，js函数中传递当前请求页码。在js函数中ajax请求数据，php接口中返回对应的数据<span style=\"color: rgb(255, 0, 0);\">连同分页信息。<span style=\"color: rgb(0, 0, 0);\">这样就实现了ajax分页。</span></span></p>','分页','ajax分页的简单实现','有很多关于ajax分页的开源项目。这项项目大多是“大而全”的东西，自定义起来也不方便。这篇文章介绍一种简单的方式来实现ajax分页。','php',0,59),(58,1482822028,1482822101,1482822028,'<p>								</p><p>题记：</p><p>一起来走一遍OOP吧。</p><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>什么是面向对象编程。</p><p>使用类和对象编程；每个对象负责一件事；对象之间能互相通信，传输数据，并构成系统；符合人们对客观世界的普遍认识；oop编程的三大特性：重用性，灵活性，可扩展性。</p></li></ol><p>							</p>','oop','面向对象基础梳理','只有以面向对象的思想编程，才能写出高质量的应用。','php',0,138),(59,1485152715,1485152715,1485152715,'','','相信是一些美好的事情正在发生','','',0,226),(60,1486435526,1486435526,1486435526,'<pre class=\"brush:html;toolbar:false\">&lt;?php\r\n$excel&nbsp;=&nbsp;&quot;&lt;html&gt;\r\n			&lt;head&gt;\r\n				&lt;meta&nbsp;charset=&#39;utf-8&#39;&nbsp;/&gt;\r\n				&lt;style&gt;\r\n					table{font-size:12px;font-weight:normal;}\r\n				&lt;/style&gt;\r\n			&lt;/head&gt;\r\n			&lt;body&gt;\r\n				&lt;table&gt;\r\n					&lt;thead&gt;\r\n						&lt;tr&gt;\r\n							&lt;th&gt;职业&lt;/th&gt;\r\n							&lt;th&gt;年龄&lt;/th&gt;\r\n							&lt;th&gt;性别&lt;/th&gt;\r\n						&lt;/tr&gt;\r\n					&lt;/thead&gt;\r\n					&lt;tbody&gt;\r\n						&lt;tr&gt;\r\n							&lt;td&gt;php工程师&lt;/td&gt;\r\n							&lt;td&gt;20&lt;/td&gt;\r\n							&lt;td&gt;男&lt;/td&gt;\r\n						&lt;/tr&gt;\r\n						&lt;tr&gt;\r\n							&lt;td&gt;php工程师&lt;/td&gt;\r\n							&lt;td&gt;20&lt;/td&gt;\r\n							&lt;td&gt;男&lt;/td&gt;\r\n						&lt;/tr&gt;\r\n						&lt;tr&gt;\r\n							&lt;td&gt;php工程师&lt;/td&gt;\r\n							&lt;td&gt;20&lt;/td&gt;\r\n							&lt;td&gt;男&lt;/td&gt;\r\n						&lt;/tr&gt;\r\n						&lt;tr&gt;\r\n							&lt;td&gt;php工程师&lt;/td&gt;\r\n							&lt;td&gt;20&lt;/td&gt;\r\n							&lt;td&gt;男&lt;/td&gt;\r\n						&lt;/tr&gt;\r\n					&lt;/tbody&gt;\r\n				&lt;/table&gt;&quot;;\r\nheader(&#39;Cache-Control:&nbsp;no-cache,&nbsp;must-revalidate&#39;);\r\nheader(&#39;Content-type:&nbsp;application/vnd.ms-excel;&#39;);\r\nheader(&#39;Content-Disposition:&nbsp;filename=&#39;.&nbsp;date(&quot;Y年m月d日&quot;)&nbsp;.&nbsp;&#39;.xls&#39;);\r\ndie($excel);</pre><p>很简单吧。可以用style便签来设置样式。Content-Disposition可以用来命名。</p>','','一种简单的生成excel的方式','一种简单生成excel的方式。','php',1,230),(61,1486517925,1486517966,1486517925,'<p>								</p><h3>权限管理要实现的目标</h3><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>添加管理员</p></li><li><p>分配角色</p></li><li><p>为角色分配权限（控制页面的可见性与可访问性）</p></li></ol><h3>具体实现</h3><h4>设计5个表。</h4><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>admin表，用来添加管理员。</p></li><li><p>role表用管理角色种类，比如管理员，开发者，编辑，seo等等。管理员</p></li><li><p>管理员和角色关系表，用来记录每个管理员有什么角色。</p></li><li><p>角色权限表，用来记录每个角色有哪些权限（也就是那些页面能访问）。</p></li><li><p>最后是权限表，也可叫节点表，一般按照程序总的控制器和方法来分成主节点和分节点，便于在前台操作时的批量勾选。</p></li></ol><h4>菜单显示</h4><p>根据用户角色找对应的节点进行显示即可。</p><h4>可访问性</h4><p>判断用户角色是否具有该节点权限。</p><h4>代码</h4><p>不做赘述。</p><p>							</p>','权限管理','一种写后台权限管理的方式','后台权限管理是大部分应用管理后台都需要的一个功能。本文提供一个简单好用的方式。','php',0,64),(62,1486519388,1486565254,1486519388,'<p>								</p><p>1.7:30-8:00 复习了60个单词。读了两节英文版的哈利波特。<br/></p><p>2.8:00-8:30 了解了一下《权利的游戏》的历史背景——中世纪的封建制度，骑士，领主，农民，自由城市，教会，城堡，婚姻。</p><p>3.8:30-9:00 复习了设计模式中的单例模式，广场模式和注册树模式。</p><p>4.9:30-9:40 整理了php后台项目中权限管理的方法。&nbsp;</p><p>5.10:00-10:55 修复项目中两个bug。</p><p>6.11:00-12:00,13:30-18:30 新项目后台。</p><p>7.18:30-19:30 锻炼身体</p><p>8.19:50-21:00 聚餐</p><p>9. 21-22:30 下班坐地铁</p><p>							</p>','工作','2017年2月8日工作日志','并非要记录今天做了哪些工作，只是想看看这一天到底是不是虚度光阴了。','工作',0,718),(63,1487226745,1487226745,1487226745,'<p>&lt;?php</p><p>class Algos</p><p>{</p><p>&nbsp; &nbsp; &nbsp;/**</p><p>&nbsp; &nbsp; &nbsp;* 获得用户唯一码 (用户信息+进程信息+时间戳+随机数)</p><p>&nbsp; &nbsp; &nbsp;*/</p><p>&nbsp; &nbsp; public static function getUniqueCode(){</p><p>&nbsp; &nbsp; &nbsp; &nbsp; #获得唯一的用户信息</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $cookieArr = &nbsp;$_COOKIE;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $userId &nbsp; &nbsp;= isset($cookieArr[&quot;zol_userid&quot;]) ? $cookieArr[&quot;zol_userid&quot;]</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: isset($cookieArr[&quot;ip_ck&quot;]) ? $cookieArr[&quot;ip_ck&quot;] : $_SERVER[&#39;REMOTE_ADDR&#39;];</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $userIp &nbsp; &nbsp;= $_SERVER[&#39;REMOTE_ADDR&#39;];</p><p>&nbsp; &nbsp; &nbsp; &nbsp; #时间信息</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $time &nbsp; &nbsp; &nbsp;= microtime(true);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; #服务器信息</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $server = $_SERVER[&#39;SERVER_ADDR&#39;];</p><p>&nbsp; &nbsp; &nbsp; &nbsp; #进程信息</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $pid = &#39;&#39;;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (function_exists(&#39;getmypid&#39;)) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;$pid = getmypid();</p><p>&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $rand = rand(0, 1000);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return md5($userId . $userIp .$time. $pid . $server .$rand );</p><p><br/></p><p>&nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp;/**</p><p>&nbsp; &nbsp; &nbsp;* URL的签名算法，返回一个token字符串</p><p>&nbsp; &nbsp; &nbsp;*/</p><p>&nbsp; &nbsp; public static function urlSign($paramArr){</p><p>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $options = array(</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;queryParam&#39; &nbsp;=&gt; &#39;&#39;, &nbsp;#请求参数，可以传入参数数组（一维） 也可以传入name=a&amp;age=12的参数</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;cryptkey&#39; &nbsp; &nbsp;=&gt; &#39;&#39;, &nbsp;#签名的密钥</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;timeInfo&#39; &nbsp; &nbsp;=&gt; 0, &nbsp; #添加时间信息</p><p>&nbsp; &nbsp; &nbsp; &nbsp; );</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (is_array($paramArr))$options = array_merge($options, $paramArr);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; extract($options);</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; if(!$queryParam)return &#39;&#39;;</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; if(is_string($queryParam)) parse_str($queryParam,$queryParam);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; #对参数数组进行排序，保证参数传入的顺序不同，同样能得到结果</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ksort($queryParam);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $queryString = array();</p><p>&nbsp; &nbsp; &nbsp; &nbsp; foreach ($queryParam as $key =&gt; $val){</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array_push($queryString, $key . &#39;=&#39; . $val);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $queryString = join(&#39;&amp;&#39;, $queryString);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if($timeInfo){</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $queryString .= &quot;#&quot; .time(); #将时间戳并入</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $sign = &nbsp;self::fastEncode(array(&#39;value&#39;=&gt;$queryString,&#39;cryptkey&#39;=&gt;$cryptkey));</p><p>&nbsp; &nbsp; &nbsp; &nbsp; }else{</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $sign = hash_hmac(&quot;sha1&quot;,$queryString,$cryptkey);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; } &nbsp; &nbsp; &nbsp; &nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return $sign;</p><p>&nbsp; &nbsp; }</p><p>&nbsp; &nbsp;&nbsp;</p><p>&nbsp; &nbsp; &nbsp;/**</p><p>&nbsp; &nbsp; &nbsp;* 获得URL的签名的时间戳</p><p>&nbsp; &nbsp; &nbsp;*/</p><p>&nbsp; &nbsp; public static function getUrlSignTm($paramArr){</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $options = array(</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;signStr&#39; &nbsp; &nbsp; =&gt; &#39;&#39;, &nbsp;#请求参数，可以传入参数数组（一维） 也可以传入name=a&amp;age=12的参数</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;cryptkey&#39; &nbsp; &nbsp;=&gt; &#39;&#39;, &nbsp;#签名的密钥</p><p>&nbsp; &nbsp; &nbsp; &nbsp; );</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (is_array($paramArr))$options = array_merge($options, $paramArr);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; extract($options);</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; $sign = &nbsp;self::fastDecode(array(&#39;value&#39;=&gt;$signStr,&#39;cryptkey&#39;=&gt;$cryptkey));</p><p>&nbsp; &nbsp; &nbsp; &nbsp; #时间戳部分</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $tm &nbsp; = (int)substr($sign, strpos($sign, &quot;#&quot;)+1);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; #签名部分</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $data = substr($sign, 0,strpos($sign, &quot;#&quot;));</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if($data)parse_str($data,$data);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return array(</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;data&#39; =&gt; $data,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;tm&#39; &nbsp; =&gt; $tm,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; );</p><p>&nbsp; &nbsp; }</p><p><br/></p><p>&nbsp; &nbsp; /**</p><p>&nbsp; &nbsp; &nbsp;* 3DES 加密算法</p><p>&nbsp; &nbsp; &nbsp;*/</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">	</span>public static function des3Encrypt($paramArr) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $options = array(</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;value&#39; &nbsp; &nbsp; &nbsp; =&gt; 0, #加密的字符</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;cryptkey&#39; &nbsp; &nbsp;=&gt; 0, #加密用的key</p><p>&nbsp; &nbsp; &nbsp; &nbsp; );</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (is_array($paramArr))$options = array_merge($options, $paramArr);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; extract($options);</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>$td = mcrypt_module_open(MCRYPT_3DES, &#39;&#39;, MCRYPT_MODE_ECB, &#39;&#39;);</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>$iv = mcrypt_create_iv(mcrypt_enc_get_iv_size($td), MCRYPT_DEV_URANDOM);</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>$key = substr($cryptkey, 0, mcrypt_enc_get_key_size($td));</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>mcrypt_generic_init($td, $key, $iv);</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>$ret = self::base64UrlEncode(mcrypt_generic($td, $value));</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>mcrypt_generic_deinit($td);</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>mcrypt_module_close($td);</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>return $ret;</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">	</span>}</p><p><br/></p><p>&nbsp; &nbsp; /**</p><p>&nbsp; &nbsp; &nbsp;* 3DES 解密算法</p><p>&nbsp; &nbsp; &nbsp;*/</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">	</span>public static function des3Dencrypt($paramArr) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $options = array(</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;value&#39; &nbsp; &nbsp; &nbsp; =&gt; 0, #加密的字符</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;cryptkey&#39; &nbsp; &nbsp;=&gt; 0, #加密用的key</p><p>&nbsp; &nbsp; &nbsp; &nbsp; );</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (is_array($paramArr))$options = array_merge($options, $paramArr);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; extract($options);</p><p>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>$td = mcrypt_module_open(MCRYPT_3DES, &#39;&#39;, MCRYPT_MODE_ECB, &#39;&#39;);</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>$iv = mcrypt_create_iv(mcrypt_enc_get_iv_size($td), MCRYPT_DEV_URANDOM);</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>$key = substr($cryptkey, 0, mcrypt_enc_get_key_size($td));</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>mcrypt_generic_init($td, $key, $iv);</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>$ret = trim(mdecrypt_generic($td, self::base64UrlDecode($value))) ;</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>mcrypt_generic_deinit($td);</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>mcrypt_module_close($td);</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>return $ret;</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">	</span>}</p><p>&nbsp; &nbsp;&nbsp;</p><p><br/></p><p>&nbsp; &nbsp; /**</p><p>&nbsp; &nbsp; &nbsp;* 快速的加密算法</p><p>&nbsp; &nbsp; &nbsp;*/</p><p>&nbsp; &nbsp; public static function fastEncode($paramArr) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $options = array(</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;value&#39; &nbsp; &nbsp; &nbsp; =&gt; 0, #加密的字符</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;cryptkey&#39; &nbsp; &nbsp;=&gt; 0, #加密用的key</p><p>&nbsp; &nbsp; &nbsp; &nbsp; );</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (is_array($paramArr))$options = array_merge($options, $paramArr);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; extract($options);</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; return self::_fastCode($value,&#39;ENCODE&#39;,$cryptkey);</p><p><br/></p><p>&nbsp; &nbsp; }</p><p>&nbsp; &nbsp; /**</p><p>&nbsp; &nbsp; &nbsp;* 快速的解密算法</p><p>&nbsp; &nbsp; &nbsp;*/</p><p>&nbsp; &nbsp; public static function fastDecode($paramArr) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $options = array(</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;value&#39; &nbsp; &nbsp; &nbsp; =&gt; 0, #加密的字符</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;cryptkey&#39; &nbsp; &nbsp;=&gt; 0, #加密用的key</p><p>&nbsp; &nbsp; &nbsp; &nbsp; );</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (is_array($paramArr))$options = array_merge($options, $paramArr);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; extract($options);</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; return self::_fastCode($value,&#39;DECODE&#39;,$cryptkey);</p><p><br/></p><p>&nbsp; &nbsp; }</p><p>&nbsp; &nbsp; private static function _fastCode($string, $operation = &#39;DECODE&#39;, $key = &#39;&#39;, $expiry = 0) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $auth_key = &#39;%&amp;zol_zwt!Q@W#$6y8i&#39;;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $ckey_length = 4;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $key &nbsp;= md5($key ? $key : $auth_key);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $keya = md5(substr($key, 0, 16));</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $keyb = md5(substr($key, 16, 16));</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $keyc = $ckey_length ? ($operation == &#39;DECODE&#39; ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : &#39;&#39;;</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; $cryptkey = $keya.md5($keya.$keyc);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $key_length = strlen($cryptkey);</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; $string = $operation == &#39;DECODE&#39; ? self::base64UrlDecode(substr($string, $ckey_length)) : sprintf(&#39;%010d&#39;, $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $string_length = strlen($string);</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; $result = &#39;&#39;;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $box = range(0, 255);</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; $rndkey = array();</p><p>&nbsp; &nbsp; &nbsp; &nbsp; for($i = 0; $i &lt;= 255; $i++) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $rndkey[$i] = ord($cryptkey[$i % $key_length]);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; }</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; for($j = $i = 0; $i &lt; 256; $i++) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $j = ($j + $box[$i] + $rndkey[$i]) % 256;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $tmp = $box[$i];</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $box[$i] = $box[$j];</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $box[$j] = $tmp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; }</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; for($a = $j = $i = 0; $i &lt; $string_length; $i++) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $a = ($a + 1) % 256;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $j = ($j + $box[$a]) % 256;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $tmp = $box[$a];</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $box[$a] = $box[$j];</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $box[$j] = $tmp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));</p><p>&nbsp; &nbsp; &nbsp; &nbsp; }</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; if($operation == &#39;DECODE&#39;) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() &gt; 0) &amp;&amp; substr($result, 10, 16) == substr(md5(substr($result, 26).$keyb), 0, 16)) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return substr($result, 26);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;&#39;;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; } else {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return $keyc.str_replace(&#39;=&#39;, &#39;&#39;, self::base64UrlEncode($result));</p><p>&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; }</p><p>&nbsp; &nbsp; /**</p><p>&nbsp; &nbsp; &nbsp;* 简单的加密形式</p><p>&nbsp; &nbsp; &nbsp;*/</p><p>&nbsp; &nbsp; public static function simpleEncrypt($paramArr) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $options = array(</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;value&#39; &nbsp; &nbsp; &nbsp; =&gt; 0, #加密的字符</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;cryptkey&#39; &nbsp; &nbsp;=&gt; 0, #加密用的key</p><p>&nbsp; &nbsp; &nbsp; &nbsp; );</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (is_array($paramArr))$options = array_merge($options, $paramArr);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; extract($options);</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; $mcrypt_cipher_alg &nbsp;= MCRYPT_RIJNDAEL_128;</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>$iv = mcrypt_create_iv(mcrypt_get_iv_size($mcrypt_cipher_alg,MCRYPT_MODE_ECB));</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; $newString = mcrypt_encrypt($mcrypt_cipher_alg, $cryptkey, $value, MCRYPT_MODE_ECB, $iv);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return bin2hex($newString);</p><p><br/></p><p>&nbsp; &nbsp; }</p><p>&nbsp; &nbsp; /**</p><p>&nbsp; &nbsp; &nbsp;* 简单的解密形式</p><p>&nbsp; &nbsp; &nbsp;*/</p><p>&nbsp; &nbsp; public static function simpleDecrypt($paramArr) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; $options = array(</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;value&#39; &nbsp; &nbsp; &nbsp; =&gt; 0, #加密的字符</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;cryptkey&#39; &nbsp; &nbsp;=&gt; 0, #加密用的key</p><p>&nbsp; &nbsp; &nbsp; &nbsp; );</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (is_array($paramArr))$options = array_merge($options, $paramArr);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; extract($options);</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; $mcrypt_cipher_alg &nbsp;= MCRYPT_RIJNDAEL_128;</p><p><span class=\"Apple-tab-span\" style=\"white-space:pre\">		</span>$iv = mcrypt_create_iv(mcrypt_get_iv_size($mcrypt_cipher_alg,MCRYPT_MODE_ECB));</p><p><br/></p><p>&nbsp; &nbsp; &nbsp; &nbsp; $string &nbsp; &nbsp;= pack(&quot;H*&quot;,$value);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return trim(mcrypt_decrypt($mcrypt_cipher_alg, $cryptkey, $string, MCRYPT_MODE_ECB, $iv));</p><p><br/></p><p>&nbsp; &nbsp; }</p><p><br/></p><p>&nbsp; &nbsp; /**</p><p>&nbsp; &nbsp; &nbsp;* 适合url传输的base64编码</p><p>&nbsp; &nbsp; &nbsp;*/</p><p>&nbsp; &nbsp; private static function base64UrlEncode($value){</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return rtrim(strtr(base64_encode($value), &#39;+/&#39;, &#39;-_&#39;), &#39;=&#39;);</p><p>&nbsp; &nbsp; }</p><p>&nbsp; &nbsp;&nbsp;</p><p>&nbsp; &nbsp; /**</p><p>&nbsp; &nbsp; &nbsp;* 适合url传输的base64解码</p><p>&nbsp; &nbsp; &nbsp;*/</p><p>&nbsp; &nbsp; private static function base64UrlDecode($value){</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return base64_decode(strtr($value, &#39;-_&#39;, &#39;+/&#39;));</p><p>&nbsp; &nbsp; }</p><p><br/></p><p>}</p><p><br/></p>','加密','数据加密和解密','几种常用的，好用的加解密的方法','php',0,566),(64,1487396405,1487396405,1487396405,'<p>孝敬长辈，爱护弱小，珍惜爱人，团结同事，做好工作，坚持学习，不放弃理想~</p>','做人','坚持做对的事','孝敬长辈，爱护弱小，珍惜爱人，团结同事，做好工作，坚持学习，不放弃理想','说说',0,70),(65,1487417044,1487417044,1487417044,'<pre class=\"brush:java;toolbar:false\">&lt;?php\r\n$a&nbsp;=&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;8,1,3,2,6,7,9,5,21,12,30,10\r\n);\r\n$length&nbsp;=&nbsp;count($a);\r\nfor&nbsp;($i&nbsp;=&nbsp;1;&nbsp;$i&nbsp;&lt;&nbsp;$length;&nbsp;$i++)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;($j&nbsp;=&nbsp;$i;&nbsp;$j&nbsp;&gt;&nbsp;0;&nbsp;$j--)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($a[$j]&nbsp;&lt;&nbsp;$a[$j-1])&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$temp&nbsp;=&nbsp;$a[$j];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$a[$j]&nbsp;=&nbsp;$a[$j-1];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$a[$j-1]&nbsp;=&nbsp;$temp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n}\r\nvar_dump($a);</pre><p>原理：以8为基准，其后的每一个数都要跟前面的数进行一一比对。所以外层循环从1开始，到$elngth - 1减一结束。这样保证每一个数都会进行比较，当然，除了第一个数之外。然后是内层循环。定然是从$i开始，一直比较到第一个数，所以一直到1就结束了。最后进行比较，如果当前这个数比前一个数小，那么就交换他们的位置就好了。</p>','算法','插入排序法','从最简单的这个排序算法开始，体验算法的乐趣。','算法',0,270),(66,1487661321,1487661321,1487661321,'<p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">今天搭建了oauth2.0服务端与客户端。把搭建的过程记录一下。具体实现的功能是：client.ruanwenwu.cn的用户能够通过 server.ruanwenwu.cn的用户名和密码登陆client.ruanwenwu.cn。并且登陆 后，client.ruanwenwu.cn的用户能获取server.ruanwenwu.cn哪里的一些资源。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">我的个人博客原文地址：</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">一、oauth2.0的作用</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;1、搭建第三方登录平台（就像你用很多网站支持qq登录。其实是qq提供的oauth2.0服务端支持。网站作为第三方，只要用oauth2.0标准请求服务端，求能得到用户信息，并实现登录）。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;2、公共资源管理。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;就 像你（Y）想通过一个打印照片的网站（A)来打印你存放在google(B)的照片。你就要通过这个A来获取B的照片。B肯定要验证是否是他的用户Y的请 求，验证通过才把照片传递给A实现打印。问题是Y不想把账号密码直接给A。用oauth2.0就是来解决这个问题的：</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A先 把Y导向B的站点进行授权。授权通过，B向A发送oauth_code。A拿到这个oauth_code，连同A的client_id和 oauth_secrete发送给B，如果数据正确，B就会给A发送oauth_token。有了这个token,A就可以获取B的相关资源的。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;基本的流程是这样。下面是具体的实现过程。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">二、oauth2.0服务端的搭建。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oauth2.0的服务端分为验证服务器和资源服务器。这两个服务器也可以是同一个服务器（只不过把这两个功能用一个 服务器来完成罢了）。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;说明：我的实现都在Thinkphp3.2.3框架下实现。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1、下载thinkphp3.2.3。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2、配置虚拟机server.ruanwenwu.cn</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3、在Thinkphp的Home应用下修改配置文件（server.ruanwenwu.cn/Application/Home/Conf/config.php）如下所示：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;?phpreturn&nbsp;array(&nbsp;&nbsp;&nbsp;&nbsp;//&#39;配置项&#39;=&gt;&#39;配置值&#39;&nbsp;&nbsp;&nbsp;&nbsp;//数据库设置&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DB_TYPE&#39;&nbsp;=&gt;&nbsp;&#39;mysql&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DB_HOST&#39;&nbsp;=&gt;&nbsp;&#39;127.0.0.1&#39;,//localhost&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DB_NAME&#39;&nbsp;=&gt;&nbsp;&#39;oauth&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DB_USER&#39;&nbsp;=&gt;&nbsp;&#39;root&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DB_PWD&#39;&nbsp;&nbsp;=&gt;&nbsp;&#39;root&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DB_PORT&#39;&nbsp;=&gt;&nbsp;&#39;3306&#39;,&nbsp;&nbsp;&nbsp;&nbsp;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&#39;SCOPE_INFO&#39;&nbsp;&nbsp;=&gt;&nbsp;array(&nbsp;&nbsp;&nbsp;&nbsp;//这是授权选项。根据你自己的项目来&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;name&#39;&nbsp;=&gt;&nbsp;&#39;个人信息&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;value&#39;&nbsp;=&gt;&nbsp;&#39;basicinfo&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;name&#39;&nbsp;=&gt;&nbsp;&#39;论坛发帖回帖&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;value&#39;&nbsp;=&gt;&nbsp;&#39;bbsinfo&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),&nbsp;&nbsp;&nbsp;&nbsp;),&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&#39;OAUTH2_CODES_TABLE&#39;&nbsp;&nbsp;&nbsp;=&gt;&#39;oauth_code&#39;,&nbsp;&nbsp;&nbsp;&nbsp;//这里是oauth项目需要用的三个基础表&nbsp;&nbsp;&nbsp;&nbsp;&#39;OAUTH2_CLIENTS_TABLE&#39;&nbsp;=&gt;&#39;oauth_client&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&#39;OAUTH2_TOKEN_TABLE&#39;&nbsp;&nbsp;&nbsp;=&gt;&#39;oauth_token&#39;,&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&#39;SECRETKYE&#39;&nbsp;=&gt;&nbsp;&#39;Mumayi!@#&#39;,&nbsp;&nbsp;&nbsp;&nbsp;//下面是一些网站自定义的项目。可以根据自己的情况来写或者不写&nbsp;&nbsp;&nbsp;&nbsp;//session&nbsp;有效期&nbsp;&nbsp;&nbsp;&nbsp;&#39;SESSION_EXPIRES&#39;&nbsp;=&gt;&nbsp;1200,&nbsp;&nbsp;&nbsp;&nbsp;//key&nbsp;有效期&nbsp;&nbsp;&nbsp;&nbsp;&#39;PASS_KEY_EXPIRES&#39;&nbsp;=&gt;&nbsp;86400,&nbsp;&nbsp;&nbsp;&nbsp;//key&nbsp;有效期&nbsp;&nbsp;&nbsp;&nbsp;&#39;PHONE_KEY_EXPIRES&#39;&nbsp;=&gt;&nbsp;300,&nbsp;&nbsp;&nbsp;&nbsp;//key&nbsp;加密&nbsp;整型&nbsp;数字&nbsp;必须为&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;&#39;PASS_KEY_CALC&#39;&nbsp;=&gt;&nbsp;1314,);</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4、建oauth表。</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">SET&nbsp;FOREIGN_KEY_CHECKS=0;--&nbsp;------------------------------&nbsp;Table&nbsp;structure&nbsp;for&nbsp;oauth_client--&nbsp;----------------------------DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;`oauth_client`;CREATE&nbsp;TABLE&nbsp;`oauth_client`&nbsp;(\r\n&nbsp;&nbsp;`id`&nbsp;bigint(20)&nbsp;NOT&nbsp;NULL&nbsp;AUTO_INCREMENT,\r\n&nbsp;&nbsp;`client_id`&nbsp;varchar(32)&nbsp;NOT&nbsp;NULL,\r\n&nbsp;&nbsp;`client_secret`&nbsp;varchar(32)&nbsp;NOT&nbsp;NULL,\r\n&nbsp;&nbsp;`redirect_uri`&nbsp;varchar(200)&nbsp;NOT&nbsp;NULL,\r\n&nbsp;&nbsp;`create_time`&nbsp;int(11)&nbsp;NOT&nbsp;NULL,&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(`id`))&nbsp;ENGINE=MyISAM&nbsp;AUTO_INCREMENT=3&nbsp;DEFAULT&nbsp;CHARSET=utf8;--&nbsp;------------------------------&nbsp;Table&nbsp;structure&nbsp;for&nbsp;oauth_code--&nbsp;----------------------------DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;`oauth_code`;CREATE&nbsp;TABLE&nbsp;`oauth_code`&nbsp;(\r\n&nbsp;&nbsp;`id`&nbsp;bigint(20)&nbsp;NOT&nbsp;NULL&nbsp;AUTO_INCREMENT,\r\n&nbsp;&nbsp;`client_id`&nbsp;varchar(32)&nbsp;NOT&nbsp;NULL,\r\n&nbsp;&nbsp;`user_id`&nbsp;int(11)&nbsp;NOT&nbsp;NULL&nbsp;DEFAULT&nbsp;&#39;1&#39;,\r\n&nbsp;&nbsp;`code`&nbsp;varchar(40)&nbsp;NOT&nbsp;NULL,\r\n&nbsp;&nbsp;`redirect_uri`&nbsp;varchar(200)&nbsp;NOT&nbsp;NULL,\r\n&nbsp;&nbsp;`expires`&nbsp;int(11)&nbsp;NOT&nbsp;NULL,\r\n&nbsp;&nbsp;`scope`&nbsp;varchar(250)&nbsp;DEFAULT&nbsp;NULL,&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(`id`))&nbsp;ENGINE=MyISAM&nbsp;AUTO_INCREMENT=57&nbsp;DEFAULT&nbsp;CHARSET=utf8;\r\n\r\n--&nbsp;----------------------------\r\n--&nbsp;Table&nbsp;structure&nbsp;for&nbsp;oauth_token\r\n--&nbsp;----------------------------\r\nDROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;`oauth_token`;\r\nCREATE&nbsp;TABLE&nbsp;`oauth_token`&nbsp;(\r\n&nbsp;&nbsp;`id`&nbsp;bigint(20)&nbsp;NOT&nbsp;NULL&nbsp;AUTO_INCREMENT,\r\n&nbsp;&nbsp;`client_id`&nbsp;varchar(32)&nbsp;NOT&nbsp;NULL,\r\n&nbsp;&nbsp;`user_id`&nbsp;int(11)&nbsp;NOT&nbsp;NULL,\r\n&nbsp;&nbsp;`access_token`&nbsp;varchar(40)&nbsp;NOT&nbsp;NULL,\r\n&nbsp;&nbsp;`refresh_token`&nbsp;varchar(40)&nbsp;NOT&nbsp;NULL,\r\n&nbsp;&nbsp;`expires_in`&nbsp;int(11)&nbsp;NOT&nbsp;NULL,\r\n&nbsp;&nbsp;`scope`&nbsp;varchar(200)&nbsp;DEFAULT&nbsp;NULL,\r\n&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(`id`)\r\n)&nbsp;ENGINE=MyISAM&nbsp;AUTO_INCREMENT=26&nbsp;DEFAULT&nbsp;CHARSET=utf8;</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5、引入oauth2.0服务端类文件。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-1、在\\server.ruanwenwu.cn\\ThinkPHP\\Library\\Vendor\\目录下建立oauth目录。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-2、引入oauth2.0服务端PHP脚本。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在刚建立的oauth目录下引入OAuth2.class.php这个文件基本不用做修改。我们的操作都在继承这个类的子类上完成。类的代码如下：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;?php/**&nbsp;*&nbsp;@mainpage&nbsp;*&nbsp;OAuth&nbsp;2.0&nbsp;server&nbsp;in&nbsp;PHP,&nbsp;originally&nbsp;written&nbsp;for&nbsp;*&nbsp;&lt;a&nbsp;href=&quot;http://www.opendining.net/&quot;&gt;&nbsp;Open&nbsp;Dining&lt;/a&gt;.&nbsp;Supports&nbsp;*&nbsp;&lt;a&nbsp;href=&quot;http://tools.ietf.org/html/draft-ietf-oauth-v2-10&quot;&gt;IETF&nbsp;draft&nbsp;v10&lt;/a&gt;.&nbsp;*&nbsp;*&nbsp;Source&nbsp;repo&nbsp;has&nbsp;sample&nbsp;servers&nbsp;implementations&nbsp;for&nbsp;*&nbsp;&lt;a&nbsp;href=&quot;http://php.net/manual/en/book.pdo.php&quot;&gt;&nbsp;PHP&nbsp;Data&nbsp;Objects&lt;/a&gt;&nbsp;and&nbsp;*&nbsp;&lt;a&nbsp;href=&quot;http://www.mongodb.org/&quot;&gt;MongoDB&lt;/a&gt;.&nbsp;Easily&nbsp;adaptable&nbsp;to&nbsp;other&nbsp;*&nbsp;storage&nbsp;engines.&nbsp;*&nbsp;*&nbsp;PHP&nbsp;Data&nbsp;Objects&nbsp;supports&nbsp;a&nbsp;variety&nbsp;of&nbsp;databases,&nbsp;including&nbsp;MySQL,&nbsp;*&nbsp;Microsoft&nbsp;SQL&nbsp;Server,&nbsp;SQLite,&nbsp;and&nbsp;Oracle,&nbsp;so&nbsp;you&nbsp;can&nbsp;try&nbsp;out&nbsp;the&nbsp;sample&nbsp;*&nbsp;to&nbsp;see&nbsp;how&nbsp;it&nbsp;all&nbsp;works.&nbsp;*&nbsp;*&nbsp;We&#39;re&nbsp;expanding&nbsp;the&nbsp;wiki&nbsp;to&nbsp;include&nbsp;more&nbsp;helpful&nbsp;documentation,&nbsp;but&nbsp;for&nbsp;*&nbsp;now,&nbsp;your&nbsp;best&nbsp;bet&nbsp;is&nbsp;to&nbsp;view&nbsp;the&nbsp;oauth.php&nbsp;source&nbsp;-&nbsp;it&nbsp;has&nbsp;lots&nbsp;of&nbsp;*&nbsp;comments.&nbsp;*&nbsp;*&nbsp;@author&nbsp;Tim&nbsp;Ridgely&nbsp;&lt;tim.ridgely@gmail.com&gt;&nbsp;*&nbsp;@author&nbsp;Aaron&nbsp;Parecki&nbsp;&lt;aaron@parecki.com&gt;&nbsp;*&nbsp;@author&nbsp;Edison&nbsp;Wong&nbsp;&lt;hswong3i@pantarei-design.com&gt;&nbsp;*&nbsp;*&nbsp;@see&nbsp;http://code.google.com/p/oauth2-php/&nbsp;*//**\r\n&nbsp;*&nbsp;The&nbsp;default&nbsp;duration&nbsp;in&nbsp;seconds&nbsp;of&nbsp;the&nbsp;access&nbsp;token&nbsp;lifetime.\r\n&nbsp;*/define(&quot;OAUTH2_DEFAULT_ACCESS_TOKEN_LIFETIME&quot;,&nbsp;3600);/**\r\n&nbsp;*&nbsp;The&nbsp;default&nbsp;duration&nbsp;in&nbsp;seconds&nbsp;of&nbsp;the&nbsp;authorization&nbsp;code&nbsp;lifetime.\r\n&nbsp;*/define(&quot;OAUTH2_DEFAULT_AUTH_CODE_LIFETIME&quot;,&nbsp;30);/**\r\n&nbsp;*&nbsp;The&nbsp;default&nbsp;duration&nbsp;in&nbsp;seconds&nbsp;of&nbsp;the&nbsp;refresh&nbsp;token&nbsp;lifetime.\r\n&nbsp;*/define(&quot;OAUTH2_DEFAULT_REFRESH_TOKEN_LIFETIME&quot;,&nbsp;1209600);/**\r\n&nbsp;*&nbsp;@defgroup&nbsp;oauth2_section_2&nbsp;Client&nbsp;Credentials\r\n&nbsp;*&nbsp;@{\r\n&nbsp;*\r\n&nbsp;*&nbsp;When&nbsp;interacting&nbsp;with&nbsp;the&nbsp;authorization&nbsp;server,&nbsp;the&nbsp;client&nbsp;identifies\r\n&nbsp;*&nbsp;itself&nbsp;using&nbsp;a&nbsp;client&nbsp;identifier&nbsp;and&nbsp;authenticates&nbsp;using&nbsp;a&nbsp;set&nbsp;of\r\n&nbsp;*&nbsp;client&nbsp;credentials.&nbsp;This&nbsp;specification&nbsp;provides&nbsp;one&nbsp;mechanism&nbsp;for\r\n&nbsp;*&nbsp;authenticating&nbsp;the&nbsp;client&nbsp;using&nbsp;password&nbsp;credentials.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-2\r\n&nbsp;*//**\r\n&nbsp;*&nbsp;Regex&nbsp;to&nbsp;filter&nbsp;out&nbsp;the&nbsp;client&nbsp;identifier&nbsp;(described&nbsp;in&nbsp;Section&nbsp;2&nbsp;of&nbsp;IETF&nbsp;draft).\r\n&nbsp;*\r\n&nbsp;*&nbsp;IETF&nbsp;draft&nbsp;does&nbsp;not&nbsp;prescribe&nbsp;a&nbsp;format&nbsp;for&nbsp;these,&nbsp;however&nbsp;I&#39;ve&nbsp;arbitrarily\r\n&nbsp;*&nbsp;chosen&nbsp;alphanumeric&nbsp;strings&nbsp;with&nbsp;hyphens&nbsp;and&nbsp;underscores,&nbsp;3-32&nbsp;characters\r\n&nbsp;*&nbsp;long.\r\n&nbsp;*\r\n&nbsp;*&nbsp;Feel&nbsp;free&nbsp;to&nbsp;change.\r\n&nbsp;*/define(&quot;OAUTH2_CLIENT_ID_REGEXP&quot;,&nbsp;&quot;/^[a-z0-9-_]{3,32}$/i&quot;);/**\r\n&nbsp;*&nbsp;@}\r\n&nbsp;*//**\r\n&nbsp;*&nbsp;@defgroup&nbsp;oauth2_section_3&nbsp;Obtaining&nbsp;End-User&nbsp;Authorization\r\n&nbsp;*&nbsp;@{\r\n&nbsp;*\r\n&nbsp;*&nbsp;When&nbsp;the&nbsp;client&nbsp;interacts&nbsp;with&nbsp;an&nbsp;end-user,&nbsp;the&nbsp;end-user&nbsp;MUST&nbsp;first\r\n&nbsp;*&nbsp;grant&nbsp;the&nbsp;client&nbsp;authorization&nbsp;to&nbsp;access&nbsp;its&nbsp;protected&nbsp;resources.\r\n&nbsp;*&nbsp;Once&nbsp;obtained,&nbsp;the&nbsp;end-user&nbsp;access&nbsp;grant&nbsp;is&nbsp;expressed&nbsp;as&nbsp;an\r\n&nbsp;*&nbsp;authorization&nbsp;code&nbsp;which&nbsp;the&nbsp;client&nbsp;uses&nbsp;to&nbsp;obtain&nbsp;an&nbsp;access&nbsp;token.\r\n&nbsp;*&nbsp;To&nbsp;obtain&nbsp;an&nbsp;end-user&nbsp;authorization,&nbsp;the&nbsp;client&nbsp;sends&nbsp;the&nbsp;end-user&nbsp;to\r\n&nbsp;*&nbsp;the&nbsp;end-user&nbsp;authorization&nbsp;endpoint.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3\r\n&nbsp;*//**\r\n&nbsp;*&nbsp;Denotes&nbsp;&quot;token&quot;&nbsp;authorization&nbsp;response&nbsp;type.\r\n&nbsp;*/define(&quot;OAUTH2_AUTH_RESPONSE_TYPE_ACCESS_TOKEN&quot;,&nbsp;&quot;token&quot;);/**\r\n&nbsp;*&nbsp;Denotes&nbsp;&quot;code&quot;&nbsp;authorization&nbsp;response&nbsp;type.\r\n&nbsp;*/define(&quot;OAUTH2_AUTH_RESPONSE_TYPE_AUTH_CODE&quot;,&nbsp;&quot;code&quot;);/**\r\n&nbsp;*&nbsp;Denotes&nbsp;&quot;code-and-token&quot;&nbsp;authorization&nbsp;response&nbsp;type.\r\n&nbsp;*/define(&quot;OAUTH2_AUTH_RESPONSE_TYPE_CODE_AND_TOKEN&quot;,&nbsp;&quot;code-and-token&quot;);/**\r\n&nbsp;*&nbsp;Regex&nbsp;to&nbsp;filter&nbsp;out&nbsp;the&nbsp;authorization&nbsp;response&nbsp;type.\r\n&nbsp;*/define(&quot;OAUTH2_AUTH_RESPONSE_TYPE_REGEXP&quot;,&nbsp;&quot;/^(token|code|code-and-token)$/&quot;);/**\r\n&nbsp;*&nbsp;@}\r\n&nbsp;*//**\r\n&nbsp;*&nbsp;@defgroup&nbsp;oauth2_section_4&nbsp;Obtaining&nbsp;an&nbsp;Access&nbsp;Token\r\n&nbsp;*&nbsp;@{\r\n&nbsp;*\r\n&nbsp;*&nbsp;The&nbsp;client&nbsp;obtains&nbsp;an&nbsp;access&nbsp;token&nbsp;by&nbsp;authenticating&nbsp;with&nbsp;the\r\n&nbsp;*&nbsp;authorization&nbsp;server&nbsp;and&nbsp;presenting&nbsp;its&nbsp;access&nbsp;grant&nbsp;(in&nbsp;the&nbsp;form&nbsp;of\r\n&nbsp;*&nbsp;an&nbsp;authorization&nbsp;code,&nbsp;resource&nbsp;owner&nbsp;credentials,&nbsp;an&nbsp;assertion,&nbsp;or&nbsp;a\r\n&nbsp;*&nbsp;refresh&nbsp;token).\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4\r\n&nbsp;*//**\r\n&nbsp;*&nbsp;Denotes&nbsp;&quot;authorization_code&quot;&nbsp;grant&nbsp;types&nbsp;(for&nbsp;token&nbsp;obtaining).\r\n&nbsp;*/define(&quot;OAUTH2_GRANT_TYPE_AUTH_CODE&quot;,&nbsp;&quot;authorization_code&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;Denotes&nbsp;&quot;password&quot;&nbsp;grant&nbsp;types&nbsp;(for&nbsp;token&nbsp;obtaining).\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_GRANT_TYPE_USER_CREDENTIALS&quot;,&nbsp;&quot;password&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;Denotes&nbsp;&quot;assertion&quot;&nbsp;grant&nbsp;types&nbsp;(for&nbsp;token&nbsp;obtaining).\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_GRANT_TYPE_ASSERTION&quot;,&nbsp;&quot;assertion&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;Denotes&nbsp;&quot;refresh_token&quot;&nbsp;grant&nbsp;types&nbsp;(for&nbsp;token&nbsp;obtaining).\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_GRANT_TYPE_REFRESH_TOKEN&quot;,&nbsp;&quot;refresh_token&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;Denotes&nbsp;&quot;none&quot;&nbsp;grant&nbsp;types&nbsp;(for&nbsp;token&nbsp;obtaining).\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_GRANT_TYPE_NONE&quot;,&nbsp;&quot;none&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;Regex&nbsp;to&nbsp;filter&nbsp;out&nbsp;the&nbsp;grant&nbsp;type.\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_GRANT_TYPE_REGEXP&quot;,&nbsp;&quot;/^(authorization_code|password|assertion|refresh_token|none)$/&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;@}\r\n&nbsp;*/\r\n\r\n\r\n/**\r\n&nbsp;*&nbsp;@defgroup&nbsp;oauth2_section_5&nbsp;Accessing&nbsp;a&nbsp;Protected&nbsp;Resource\r\n&nbsp;*&nbsp;@{\r\n&nbsp;*\r\n&nbsp;*&nbsp;Clients&nbsp;access&nbsp;protected&nbsp;resources&nbsp;by&nbsp;presenting&nbsp;an&nbsp;access&nbsp;token&nbsp;to\r\n&nbsp;*&nbsp;the&nbsp;resource&nbsp;server.&nbsp;Access&nbsp;tokens&nbsp;act&nbsp;as&nbsp;bearer&nbsp;tokens,&nbsp;where&nbsp;the\r\n&nbsp;*&nbsp;token&nbsp;string&nbsp;acts&nbsp;as&nbsp;a&nbsp;shared&nbsp;symmetric&nbsp;secret.&nbsp;This&nbsp;requires\r\n&nbsp;*&nbsp;treating&nbsp;the&nbsp;access&nbsp;token&nbsp;with&nbsp;the&nbsp;same&nbsp;care&nbsp;as&nbsp;other&nbsp;secrets&nbsp;(e.g.\r\n&nbsp;*&nbsp;end-user&nbsp;passwords).&nbsp;Access&nbsp;tokens&nbsp;SHOULD&nbsp;NOT&nbsp;be&nbsp;sent&nbsp;in&nbsp;the&nbsp;clear\r\n&nbsp;*&nbsp;over&nbsp;an&nbsp;insecure&nbsp;channel.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5\r\n&nbsp;*/\r\n\r\n/**\r\n&nbsp;*&nbsp;Used&nbsp;to&nbsp;define&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;OAuth&nbsp;access&nbsp;token&nbsp;parameter&nbsp;(POST/GET/etc.).\r\n&nbsp;*\r\n&nbsp;*&nbsp;IETF&nbsp;Draft&nbsp;sections&nbsp;5.1.2&nbsp;and&nbsp;5.1.3&nbsp;specify&nbsp;that&nbsp;it&nbsp;should&nbsp;be&nbsp;called\r\n&nbsp;*&nbsp;&quot;oauth_token&quot;&nbsp;but&nbsp;other&nbsp;implementations&nbsp;use&nbsp;things&nbsp;like&nbsp;&quot;access_token&quot;.\r\n&nbsp;*\r\n&nbsp;*&nbsp;I&nbsp;won&#39;t&nbsp;be&nbsp;heartbroken&nbsp;if&nbsp;you&nbsp;change&nbsp;it,&nbsp;but&nbsp;it&nbsp;might&nbsp;be&nbsp;better&nbsp;to&nbsp;adhere\r\n&nbsp;*&nbsp;to&nbsp;the&nbsp;spec.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.1.2\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.1.3\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_TOKEN_PARAM_NAME&quot;,&nbsp;&quot;oauth_token&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;@}\r\n&nbsp;*/\r\n\r\n\r\n/**\r\n&nbsp;*&nbsp;@defgroup&nbsp;oauth2_http_status&nbsp;HTTP&nbsp;status&nbsp;code\r\n&nbsp;*&nbsp;@{\r\n&nbsp;*/\r\n\r\n/**\r\n&nbsp;*&nbsp;&quot;Found&quot;&nbsp;HTTP&nbsp;status&nbsp;code.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_HTTP_FOUND&quot;,&nbsp;&quot;302&nbsp;Found&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;&quot;Bad&nbsp;Request&quot;&nbsp;HTTP&nbsp;status&nbsp;code.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_HTTP_BAD_REQUEST&quot;,&nbsp;&quot;400&nbsp;Bad&nbsp;Request&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;&quot;Unauthorized&quot;&nbsp;HTTP&nbsp;status&nbsp;code.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_HTTP_UNAUTHORIZED&quot;,&nbsp;&quot;401&nbsp;Unauthorized&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;&quot;Forbidden&quot;&nbsp;HTTP&nbsp;status&nbsp;code.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_HTTP_FORBIDDEN&quot;,&nbsp;&quot;403&nbsp;Forbidden&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;@}\r\n&nbsp;*/\r\n\r\n\r\n/**\r\n&nbsp;*&nbsp;@defgroup&nbsp;oauth2_error&nbsp;Error&nbsp;handling\r\n&nbsp;*&nbsp;@{\r\n&nbsp;*\r\n&nbsp;*&nbsp;@todo&nbsp;Extend&nbsp;for&nbsp;i18n.\r\n&nbsp;*/\r\n\r\n/**\r\n&nbsp;*&nbsp;The&nbsp;request&nbsp;is&nbsp;missing&nbsp;a&nbsp;required&nbsp;parameter,&nbsp;includes&nbsp;an&nbsp;unsupported\r\n&nbsp;*&nbsp;parameter&nbsp;or&nbsp;parameter&nbsp;value,&nbsp;or&nbsp;is&nbsp;otherwise&nbsp;malformed.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2.1\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3.1\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_ERROR_INVALID_REQUEST&quot;,&nbsp;&quot;invalid_request&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;The&nbsp;client&nbsp;identifier&nbsp;provided&nbsp;is&nbsp;invalid.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2.1\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_ERROR_INVALID_CLIENT&quot;,&nbsp;&quot;invalid_client&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;The&nbsp;client&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;use&nbsp;the&nbsp;requested&nbsp;response&nbsp;type.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2.1\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_ERROR_UNAUTHORIZED_CLIENT&quot;,&nbsp;&quot;unauthorized_client&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;The&nbsp;redirection&nbsp;URI&nbsp;provided&nbsp;does&nbsp;not&nbsp;match&nbsp;a&nbsp;pre-registered&nbsp;value.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_ERROR_REDIRECT_URI_MISMATCH&quot;,&nbsp;&quot;redirect_uri_mismatch&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;The&nbsp;end-user&nbsp;or&nbsp;authorization&nbsp;server&nbsp;denied&nbsp;the&nbsp;request.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_ERROR_USER_DENIED&quot;,&nbsp;&quot;access_denied&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;The&nbsp;requested&nbsp;response&nbsp;type&nbsp;is&nbsp;not&nbsp;supported&nbsp;by&nbsp;the&nbsp;authorization&nbsp;server.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_ERROR_UNSUPPORTED_RESPONSE_TYPE&quot;,&nbsp;&quot;unsupported_response_type&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;The&nbsp;requested&nbsp;scope&nbsp;is&nbsp;invalid,&nbsp;unknown,&nbsp;or&nbsp;malformed.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2.1\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_ERROR_INVALID_SCOPE&quot;,&nbsp;&quot;invalid_scope&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;The&nbsp;provided&nbsp;access&nbsp;grant&nbsp;is&nbsp;invalid,&nbsp;expired,&nbsp;or&nbsp;revoked&nbsp;(e.g.&nbsp;invalid\r\n&nbsp;*&nbsp;assertion,&nbsp;expired&nbsp;authorization&nbsp;token,&nbsp;bad&nbsp;end-user&nbsp;password&nbsp;credentials,\r\n&nbsp;*&nbsp;or&nbsp;mismatching&nbsp;authorization&nbsp;code&nbsp;and&nbsp;redirection&nbsp;URI).\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_ERROR_INVALID_GRANT&quot;,&nbsp;&quot;invalid_grant&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;The&nbsp;access&nbsp;grant&nbsp;included&nbsp;-&nbsp;its&nbsp;type&nbsp;or&nbsp;another&nbsp;attribute&nbsp;-&nbsp;is&nbsp;not\r\n&nbsp;*&nbsp;supported&nbsp;by&nbsp;the&nbsp;authorization&nbsp;server.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_ERROR_UNSUPPORTED_GRANT_TYPE&quot;,&nbsp;&quot;unsupported_grant_type&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;The&nbsp;access&nbsp;token&nbsp;provided&nbsp;is&nbsp;invalid.&nbsp;Resource&nbsp;servers&nbsp;SHOULD&nbsp;use&nbsp;this\r\n&nbsp;*&nbsp;error&nbsp;code&nbsp;when&nbsp;receiving&nbsp;an&nbsp;expired&nbsp;token&nbsp;which&nbsp;cannot&nbsp;be&nbsp;refreshed&nbsp;to\r\n&nbsp;*&nbsp;indicate&nbsp;to&nbsp;the&nbsp;client&nbsp;that&nbsp;a&nbsp;new&nbsp;authorization&nbsp;is&nbsp;necessary.&nbsp;The&nbsp;resource\r\n&nbsp;*&nbsp;server&nbsp;MUST&nbsp;respond&nbsp;with&nbsp;the&nbsp;HTTP&nbsp;401&nbsp;(Unauthorized)&nbsp;status&nbsp;code.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_ERROR_INVALID_TOKEN&quot;,&nbsp;&quot;invalid_token&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;The&nbsp;access&nbsp;token&nbsp;provided&nbsp;has&nbsp;expired.&nbsp;Resource&nbsp;servers&nbsp;SHOULD&nbsp;only&nbsp;use\r\n&nbsp;*&nbsp;this&nbsp;error&nbsp;code&nbsp;when&nbsp;the&nbsp;client&nbsp;is&nbsp;expected&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;handle&nbsp;the\r\n&nbsp;*&nbsp;response&nbsp;and&nbsp;request&nbsp;a&nbsp;new&nbsp;access&nbsp;token&nbsp;using&nbsp;the&nbsp;refresh&nbsp;token&nbsp;issued\r\n&nbsp;*&nbsp;with&nbsp;the&nbsp;expired&nbsp;access&nbsp;token.&nbsp;The&nbsp;resource&nbsp;server&nbsp;MUST&nbsp;respond&nbsp;with&nbsp;the\r\n&nbsp;*&nbsp;HTTP&nbsp;401&nbsp;(Unauthorized)&nbsp;status&nbsp;code.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_ERROR_EXPIRED_TOKEN&quot;,&nbsp;&quot;expired_token&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;The&nbsp;request&nbsp;requires&nbsp;higher&nbsp;privileges&nbsp;than&nbsp;provided&nbsp;by&nbsp;the&nbsp;access&nbsp;token.\r\n&nbsp;*&nbsp;The&nbsp;resource&nbsp;server&nbsp;SHOULD&nbsp;respond&nbsp;with&nbsp;the&nbsp;HTTP&nbsp;403&nbsp;(Forbidden)&nbsp;status\r\n&nbsp;*&nbsp;code&nbsp;and&nbsp;MAY&nbsp;include&nbsp;the&nbsp;&quot;scope&quot;&nbsp;attribute&nbsp;with&nbsp;the&nbsp;scope&nbsp;necessary&nbsp;to\r\n&nbsp;*&nbsp;access&nbsp;the&nbsp;protected&nbsp;resource.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2.1\r\n&nbsp;*/\r\ndefine(&quot;OAUTH2_ERROR_INSUFFICIENT_SCOPE&quot;,&nbsp;&quot;insufficient_scope&quot;);\r\n\r\n/**\r\n&nbsp;*&nbsp;@}\r\n&nbsp;*/\r\n\r\n/**\r\n&nbsp;*&nbsp;OAuth2.0&nbsp;draft&nbsp;v10&nbsp;server-side&nbsp;implementation.\r\n&nbsp;*\r\n&nbsp;*&nbsp;@author&nbsp;Originally&nbsp;written&nbsp;by&nbsp;Tim&nbsp;Ridgely&nbsp;&lt;tim.ridgely@gmail.com&gt;.\r\n&nbsp;*&nbsp;@author&nbsp;Updated&nbsp;to&nbsp;draft&nbsp;v10&nbsp;by&nbsp;Aaron&nbsp;Parecki&nbsp;&lt;aaron@parecki.com&gt;.\r\n&nbsp;*&nbsp;@author&nbsp;Debug,&nbsp;coding&nbsp;style&nbsp;clean&nbsp;up&nbsp;and&nbsp;documented&nbsp;by&nbsp;Edison&nbsp;Wong&nbsp;&lt;hswong3i@pantarei-design.com&gt;.\r\n&nbsp;*/\r\nabstract&nbsp;class&nbsp;OAuth2&nbsp;{\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Array&nbsp;of&nbsp;persistent&nbsp;variables&nbsp;stored.\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;$conf&nbsp;=&nbsp;array();\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;a&nbsp;persistent&nbsp;variable.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;To&nbsp;avoid&nbsp;problems,&nbsp;always&nbsp;use&nbsp;lower&nbsp;case&nbsp;for&nbsp;persistent&nbsp;variable&nbsp;names.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$name\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;variable&nbsp;to&nbsp;return.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$default\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;default&nbsp;value&nbsp;to&nbsp;use&nbsp;if&nbsp;this&nbsp;variable&nbsp;has&nbsp;never&nbsp;been&nbsp;set.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;value&nbsp;of&nbsp;the&nbsp;variable.\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;public&nbsp;function&nbsp;getVariable($name,&nbsp;$default&nbsp;=&nbsp;NULL)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;isset($this-&gt;conf[$name])&nbsp;?&nbsp;$this-&gt;conf[$name]&nbsp;:&nbsp;$default;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;a&nbsp;persistent&nbsp;variable.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;To&nbsp;avoid&nbsp;problems,&nbsp;always&nbsp;use&nbsp;lower&nbsp;case&nbsp;for&nbsp;persistent&nbsp;variable&nbsp;names.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$name\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;variable&nbsp;to&nbsp;set.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$value\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;value&nbsp;to&nbsp;set.\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;public&nbsp;function&nbsp;setVariable($name,&nbsp;$value)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;conf[$name]&nbsp;=&nbsp;$value;\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;//&nbsp;Subclasses&nbsp;must&nbsp;implement&nbsp;the&nbsp;following&nbsp;functions.\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Make&nbsp;sure&nbsp;that&nbsp;the&nbsp;client&nbsp;credentials&nbsp;is&nbsp;valid.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;check&nbsp;with.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_secret\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;If&nbsp;a&nbsp;secret&nbsp;is&nbsp;required,&nbsp;check&nbsp;that&nbsp;they&#39;ve&nbsp;given&nbsp;the&nbsp;right&nbsp;one.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;TRUE&nbsp;if&nbsp;client&nbsp;credentials&nbsp;are&nbsp;valid,&nbsp;and&nbsp;MUST&nbsp;return&nbsp;FALSE&nbsp;if&nbsp;invalid.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-2.1\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_2\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;abstract&nbsp;protected&nbsp;function&nbsp;checkClientCredentials($client_id,&nbsp;$client_secret&nbsp;=&nbsp;NULL);\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;the&nbsp;registered&nbsp;redirect&nbsp;URI&nbsp;of&nbsp;corresponding&nbsp;client_id.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;OAuth&nbsp;says&nbsp;we&nbsp;should&nbsp;store&nbsp;request&nbsp;URIs&nbsp;for&nbsp;each&nbsp;registered&nbsp;client.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Implement&nbsp;this&nbsp;function&nbsp;to&nbsp;grab&nbsp;the&nbsp;stored&nbsp;URI&nbsp;for&nbsp;a&nbsp;given&nbsp;client&nbsp;id.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;check&nbsp;with.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Registered&nbsp;redirect&nbsp;URI&nbsp;of&nbsp;corresponding&nbsp;client&nbsp;identifier,&nbsp;and&nbsp;MUST\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;return&nbsp;FALSE&nbsp;if&nbsp;the&nbsp;given&nbsp;client&nbsp;does&nbsp;not&nbsp;exist&nbsp;or&nbsp;is&nbsp;invalid.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;abstract&nbsp;protected&nbsp;function&nbsp;getRedirectUri($client_id);\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Look&nbsp;up&nbsp;the&nbsp;supplied&nbsp;oauth_token&nbsp;from&nbsp;storage.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;We&nbsp;need&nbsp;to&nbsp;retrieve&nbsp;access&nbsp;token&nbsp;data&nbsp;as&nbsp;we&nbsp;create&nbsp;and&nbsp;verify&nbsp;tokens.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$oauth_token\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;oauth_token&nbsp;to&nbsp;be&nbsp;check&nbsp;with.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;associative&nbsp;array&nbsp;as&nbsp;below,&nbsp;and&nbsp;return&nbsp;NULL&nbsp;if&nbsp;the&nbsp;supplied&nbsp;oauth_token\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;is&nbsp;invalid:\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;client_id:&nbsp;Stored&nbsp;client&nbsp;identifier.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;expires:&nbsp;Stored&nbsp;expiration&nbsp;in&nbsp;unix&nbsp;timestamp.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;scope:&nbsp;(optional)&nbsp;Stored&nbsp;scope&nbsp;values&nbsp;in&nbsp;space-separated&nbsp;string.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_5\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;abstract&nbsp;protected&nbsp;function&nbsp;getAccessToken($oauth_token);\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Store&nbsp;the&nbsp;supplied&nbsp;access&nbsp;token&nbsp;values&nbsp;to&nbsp;storage.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;We&nbsp;need&nbsp;to&nbsp;store&nbsp;access&nbsp;token&nbsp;data&nbsp;as&nbsp;we&nbsp;create&nbsp;and&nbsp;verify&nbsp;tokens.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$oauth_token\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;oauth_token&nbsp;to&nbsp;be&nbsp;stored.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;stored.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$expires\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Expiration&nbsp;to&nbsp;be&nbsp;stored.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$user_id\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;User&nbsp;ID\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$scope\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;Scopes&nbsp;to&nbsp;be&nbsp;stored&nbsp;in&nbsp;space-separated&nbsp;string.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;abstract&nbsp;protected&nbsp;function&nbsp;setAccessToken($oauth_token,&nbsp;$client_id,&nbsp;$expires,&nbsp;$user_id,&nbsp;$scope=NULL,&nbsp;$refresh_token=&#39;&#39;);\r\n\r\n&nbsp;&nbsp;//&nbsp;Stuff&nbsp;that&nbsp;should&nbsp;get&nbsp;overridden&nbsp;by&nbsp;subclasses.\r\n&nbsp;&nbsp;//\r\n&nbsp;&nbsp;//&nbsp;I&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;make&nbsp;these&nbsp;abstract,&nbsp;because&nbsp;then&nbsp;subclasses&nbsp;would&nbsp;have\r\n&nbsp;&nbsp;//&nbsp;to&nbsp;implement&nbsp;all&nbsp;of&nbsp;them,&nbsp;which&nbsp;is&nbsp;too&nbsp;much&nbsp;work.\r\n&nbsp;&nbsp;//\r\n&nbsp;&nbsp;//&nbsp;So&nbsp;they&#39;re&nbsp;just&nbsp;stubs.&nbsp;Override&nbsp;the&nbsp;ones&nbsp;you&nbsp;need.\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Return&nbsp;supported&nbsp;grant&nbsp;types.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;You&nbsp;should&nbsp;override&nbsp;this&nbsp;function&nbsp;with&nbsp;something,&nbsp;or&nbsp;else&nbsp;your&nbsp;OAuth\r\n&nbsp;&nbsp;&nbsp;*&nbsp;provider&nbsp;won&#39;t&nbsp;support&nbsp;any&nbsp;grant&nbsp;types!\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;list&nbsp;as&nbsp;below.&nbsp;If&nbsp;you&nbsp;support&nbsp;all&nbsp;grant&nbsp;types,&nbsp;then&nbsp;you&#39;d&nbsp;do:\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@code\r\n&nbsp;&nbsp;&nbsp;*&nbsp;return&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_GRANT_TYPE_AUTH_CODE,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_GRANT_TYPE_USER_CREDENTIALS,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_GRANT_TYPE_ASSERTION,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_GRANT_TYPE_REFRESH_TOKEN,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_GRANT_TYPE_NONE,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;);\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@endcode\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;getSupportedGrantTypes()&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array();\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Return&nbsp;supported&nbsp;authorization&nbsp;response&nbsp;types.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;You&nbsp;should&nbsp;override&nbsp;this&nbsp;function&nbsp;with&nbsp;your&nbsp;supported&nbsp;response&nbsp;types.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;list&nbsp;as&nbsp;below.&nbsp;If&nbsp;you&nbsp;support&nbsp;all&nbsp;authorization&nbsp;response&nbsp;types,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;then&nbsp;you&#39;d&nbsp;do:\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@code\r\n&nbsp;&nbsp;&nbsp;*&nbsp;return&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_AUTH_CODE,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_ACCESS_TOKEN,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_CODE_AND_TOKEN,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;);\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@endcode\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;getSupportedAuthResponseTypes()&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_AUTH_CODE,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_ACCESS_TOKEN,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_CODE_AND_TOKEN\r\n&nbsp;&nbsp;&nbsp;&nbsp;);\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Return&nbsp;supported&nbsp;scopes.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;you&nbsp;want&nbsp;to&nbsp;support&nbsp;scope&nbsp;use,&nbsp;then&nbsp;have&nbsp;this&nbsp;function&nbsp;return&nbsp;a&nbsp;list\r\n&nbsp;&nbsp;&nbsp;*&nbsp;of&nbsp;all&nbsp;acceptable&nbsp;scopes&nbsp;(used&nbsp;to&nbsp;throw&nbsp;the&nbsp;invalid-scope&nbsp;error).\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;list&nbsp;as&nbsp;below,&nbsp;for&nbsp;example:\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@code\r\n&nbsp;&nbsp;&nbsp;*&nbsp;return&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&#39;my-friends&#39;,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&#39;photos&#39;,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&#39;whatever-else&#39;,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;);\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@endcode\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;getSupportedScopes()&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array();\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Check&nbsp;restricted&nbsp;authorization&nbsp;response&nbsp;types&nbsp;of&nbsp;corresponding&nbsp;Client\r\n&nbsp;&nbsp;&nbsp;*&nbsp;identifier.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;you&nbsp;want&nbsp;to&nbsp;restrict&nbsp;clients&nbsp;to&nbsp;certain&nbsp;authorization&nbsp;response&nbsp;types,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;override&nbsp;this&nbsp;function.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;check&nbsp;with.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$response_type\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Authorization&nbsp;response&nbsp;type&nbsp;to&nbsp;be&nbsp;check&nbsp;with,&nbsp;would&nbsp;be&nbsp;one&nbsp;of&nbsp;the\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;values&nbsp;contained&nbsp;in&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_REGEXP.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;TRUE&nbsp;if&nbsp;the&nbsp;authorization&nbsp;response&nbsp;type&nbsp;is&nbsp;supported&nbsp;by&nbsp;this\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;client&nbsp;identifier,&nbsp;and&nbsp;FALSE&nbsp;if&nbsp;it&nbsp;isn&#39;t.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;checkRestrictedAuthResponseType($client_id,&nbsp;$response_type)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Check&nbsp;restricted&nbsp;grant&nbsp;types&nbsp;of&nbsp;corresponding&nbsp;client&nbsp;identifier.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;you&nbsp;want&nbsp;to&nbsp;restrict&nbsp;clients&nbsp;to&nbsp;certain&nbsp;grant&nbsp;types,&nbsp;override&nbsp;this\r\n&nbsp;&nbsp;&nbsp;*&nbsp;function.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;check&nbsp;with.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$grant_type\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Grant&nbsp;type&nbsp;to&nbsp;be&nbsp;check&nbsp;with,&nbsp;would&nbsp;be&nbsp;one&nbsp;of&nbsp;the&nbsp;values&nbsp;contained&nbsp;in\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;OAUTH2_GRANT_TYPE_REGEXP.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;TRUE&nbsp;if&nbsp;the&nbsp;grant&nbsp;type&nbsp;is&nbsp;supported&nbsp;by&nbsp;this&nbsp;client&nbsp;identifier,&nbsp;and\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;FALSE&nbsp;if&nbsp;it&nbsp;isn&#39;t.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;checkRestrictedGrantType($client_id,&nbsp;$grant_type)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;//&nbsp;Functions&nbsp;that&nbsp;help&nbsp;grant&nbsp;access&nbsp;tokens&nbsp;for&nbsp;various&nbsp;grant&nbsp;types.\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Fetch&nbsp;authorization&nbsp;code&nbsp;data&nbsp;(probably&nbsp;the&nbsp;most&nbsp;common&nbsp;grant&nbsp;type).\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Retrieve&nbsp;the&nbsp;stored&nbsp;data&nbsp;for&nbsp;the&nbsp;given&nbsp;authorization&nbsp;code.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Required&nbsp;for&nbsp;OAUTH2_GRANT_TYPE_AUTH_CODE.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$code\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Authorization&nbsp;code&nbsp;to&nbsp;be&nbsp;check&nbsp;with.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;associative&nbsp;array&nbsp;as&nbsp;below,&nbsp;and&nbsp;NULL&nbsp;if&nbsp;the&nbsp;code&nbsp;is&nbsp;invalid:\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;client_id:&nbsp;Stored&nbsp;client&nbsp;identifier.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;redirect_uri:&nbsp;Stored&nbsp;redirect&nbsp;URI.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;expires:&nbsp;Stored&nbsp;expiration&nbsp;in&nbsp;unix&nbsp;timestamp.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;scope:&nbsp;(optional)&nbsp;Stored&nbsp;scope&nbsp;values&nbsp;in&nbsp;space-separated&nbsp;string.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.1.1\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;getAuthCode($code)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Take&nbsp;the&nbsp;provided&nbsp;authorization&nbsp;code&nbsp;values&nbsp;and&nbsp;store&nbsp;them&nbsp;somewhere.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;function&nbsp;should&nbsp;be&nbsp;the&nbsp;storage&nbsp;counterpart&nbsp;to&nbsp;getAuthCode().\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;storage&nbsp;fails&nbsp;for&nbsp;some&nbsp;reason,&nbsp;we&#39;re&nbsp;not&nbsp;currently&nbsp;checking&nbsp;for\r\n&nbsp;&nbsp;&nbsp;*&nbsp;any&nbsp;sort&nbsp;of&nbsp;success/failure,&nbsp;so&nbsp;you&nbsp;should&nbsp;bail&nbsp;out&nbsp;of&nbsp;the&nbsp;script\r\n&nbsp;&nbsp;&nbsp;*&nbsp;and&nbsp;provide&nbsp;a&nbsp;descriptive&nbsp;fail&nbsp;message.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Required&nbsp;for&nbsp;OAUTH2_GRANT_TYPE_AUTH_CODE.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$code\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Authorization&nbsp;code&nbsp;to&nbsp;be&nbsp;stored.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;stored.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$redirect_uri\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Redirect&nbsp;URI&nbsp;to&nbsp;be&nbsp;stored.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$expires\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Expiration&nbsp;to&nbsp;be&nbsp;stored.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$scope\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;Scopes&nbsp;to&nbsp;be&nbsp;stored&nbsp;in&nbsp;space-separated&nbsp;string.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;setAuthCode($code,&nbsp;$client_id,&nbsp;$redirect_uri,&nbsp;$expires,&nbsp;$userId,&nbsp;$scope&nbsp;=&nbsp;NULL)&nbsp;{\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Grant&nbsp;access&nbsp;tokens&nbsp;for&nbsp;basic&nbsp;user&nbsp;credentials.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Check&nbsp;the&nbsp;supplied&nbsp;username&nbsp;and&nbsp;password&nbsp;for&nbsp;validity.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;You&nbsp;can&nbsp;also&nbsp;use&nbsp;the&nbsp;$client_id&nbsp;param&nbsp;to&nbsp;do&nbsp;any&nbsp;checks&nbsp;required&nbsp;based\r\n&nbsp;&nbsp;&nbsp;*&nbsp;on&nbsp;a&nbsp;client,&nbsp;if&nbsp;you&nbsp;need&nbsp;that.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Required&nbsp;for&nbsp;OAUTH2_GRANT_TYPE_USER_CREDENTIALS.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;check&nbsp;with.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$username\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Username&nbsp;to&nbsp;be&nbsp;check&nbsp;with.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$password\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Password&nbsp;to&nbsp;be&nbsp;check&nbsp;with.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;TRUE&nbsp;if&nbsp;the&nbsp;username&nbsp;and&nbsp;password&nbsp;are&nbsp;valid,&nbsp;and&nbsp;FALSE&nbsp;if&nbsp;it&nbsp;isn&#39;t.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Moreover,&nbsp;if&nbsp;the&nbsp;username&nbsp;and&nbsp;password&nbsp;are&nbsp;valid,&nbsp;and&nbsp;you&nbsp;want&nbsp;to\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;verify&nbsp;the&nbsp;scope&nbsp;of&nbsp;a&nbsp;user&#39;s&nbsp;access,&nbsp;return&nbsp;an&nbsp;associative&nbsp;array\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;with&nbsp;the&nbsp;scope&nbsp;values&nbsp;as&nbsp;below.&nbsp;We&#39;ll&nbsp;check&nbsp;the&nbsp;scope&nbsp;you&nbsp;provide\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;against&nbsp;the&nbsp;requested&nbsp;scope&nbsp;before&nbsp;providing&nbsp;an&nbsp;access&nbsp;token:\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@code\r\n&nbsp;&nbsp;&nbsp;*&nbsp;return&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&#39;scope&#39;&nbsp;=&gt;&nbsp;&lt;stored&nbsp;scope&nbsp;values&nbsp;(space-separated&nbsp;string)&gt;,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;);\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@endcode\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.1.2\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;checkUserCredentials($client_id,&nbsp;$username,&nbsp;$password)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Grant&nbsp;access&nbsp;tokens&nbsp;for&nbsp;assertions.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Check&nbsp;the&nbsp;supplied&nbsp;assertion&nbsp;for&nbsp;validity.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;You&nbsp;can&nbsp;also&nbsp;use&nbsp;the&nbsp;$client_id&nbsp;param&nbsp;to&nbsp;do&nbsp;any&nbsp;checks&nbsp;required&nbsp;based\r\n&nbsp;&nbsp;&nbsp;*&nbsp;on&nbsp;a&nbsp;client,&nbsp;if&nbsp;you&nbsp;need&nbsp;that.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Required&nbsp;for&nbsp;OAUTH2_GRANT_TYPE_ASSERTION.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;check&nbsp;with.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$assertion_type\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;format&nbsp;of&nbsp;the&nbsp;assertion&nbsp;as&nbsp;defined&nbsp;by&nbsp;the&nbsp;authorization&nbsp;server.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$assertion\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;assertion.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;TRUE&nbsp;if&nbsp;the&nbsp;assertion&nbsp;is&nbsp;valid,&nbsp;and&nbsp;FALSE&nbsp;if&nbsp;it&nbsp;isn&#39;t.&nbsp;Moreover,&nbsp;if\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;the&nbsp;assertion&nbsp;is&nbsp;valid,&nbsp;and&nbsp;you&nbsp;want&nbsp;to&nbsp;verify&nbsp;the&nbsp;scope&nbsp;of&nbsp;an&nbsp;access\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;request,&nbsp;return&nbsp;an&nbsp;associative&nbsp;array&nbsp;with&nbsp;the&nbsp;scope&nbsp;values&nbsp;as&nbsp;below.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;We&#39;ll&nbsp;check&nbsp;the&nbsp;scope&nbsp;you&nbsp;provide&nbsp;against&nbsp;the&nbsp;requested&nbsp;scope&nbsp;before\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;providing&nbsp;an&nbsp;access&nbsp;token:\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@code\r\n&nbsp;&nbsp;&nbsp;*&nbsp;return&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&#39;scope&#39;&nbsp;=&gt;&nbsp;&lt;stored&nbsp;scope&nbsp;values&nbsp;(space-separated&nbsp;string)&gt;,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;);\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@endcode\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.1.3\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;checkAssertion($client_id,&nbsp;$assertion_type,&nbsp;$assertion)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Grant&nbsp;refresh&nbsp;access&nbsp;tokens.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Retrieve&nbsp;the&nbsp;stored&nbsp;data&nbsp;for&nbsp;the&nbsp;given&nbsp;refresh&nbsp;token.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Required&nbsp;for&nbsp;OAUTH2_GRANT_TYPE_REFRESH_TOKEN.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$refresh_token\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Refresh&nbsp;token&nbsp;to&nbsp;be&nbsp;check&nbsp;with.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;associative&nbsp;array&nbsp;as&nbsp;below,&nbsp;and&nbsp;NULL&nbsp;if&nbsp;the&nbsp;refresh_token&nbsp;is\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;invalid:\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;client_id:&nbsp;Stored&nbsp;client&nbsp;identifier.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;expires:&nbsp;Stored&nbsp;expiration&nbsp;unix&nbsp;timestamp.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;scope:&nbsp;(optional)&nbsp;Stored&nbsp;scope&nbsp;values&nbsp;in&nbsp;space-separated&nbsp;string.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.1.4\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;getRefreshToken($refresh_token)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Take&nbsp;the&nbsp;provided&nbsp;refresh&nbsp;token&nbsp;values&nbsp;and&nbsp;store&nbsp;them&nbsp;somewhere.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;function&nbsp;should&nbsp;be&nbsp;the&nbsp;storage&nbsp;counterpart&nbsp;to&nbsp;getRefreshToken().\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;storage&nbsp;fails&nbsp;for&nbsp;some&nbsp;reason,&nbsp;we&#39;re&nbsp;not&nbsp;currently&nbsp;checking&nbsp;for\r\n&nbsp;&nbsp;&nbsp;*&nbsp;any&nbsp;sort&nbsp;of&nbsp;success/failure,&nbsp;so&nbsp;you&nbsp;should&nbsp;bail&nbsp;out&nbsp;of&nbsp;the&nbsp;script\r\n&nbsp;&nbsp;&nbsp;*&nbsp;and&nbsp;provide&nbsp;a&nbsp;descriptive&nbsp;fail&nbsp;message.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Required&nbsp;for&nbsp;OAUTH2_GRANT_TYPE_REFRESH_TOKEN.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$refresh_token\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Refresh&nbsp;token&nbsp;to&nbsp;be&nbsp;stored.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;to&nbsp;be&nbsp;stored.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$expires\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;expires&nbsp;to&nbsp;be&nbsp;stored.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$scope\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;Scopes&nbsp;to&nbsp;be&nbsp;stored&nbsp;in&nbsp;space-separated&nbsp;string.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;setRefreshToken($refresh_token,&nbsp;$client_id,&nbsp;$expires,&nbsp;$scope&nbsp;=&nbsp;NULL)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Expire&nbsp;a&nbsp;used&nbsp;refresh&nbsp;token.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;is&nbsp;not&nbsp;explicitly&nbsp;required&nbsp;in&nbsp;the&nbsp;spec,&nbsp;but&nbsp;is&nbsp;almost&nbsp;implied.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;After&nbsp;granting&nbsp;a&nbsp;new&nbsp;refresh&nbsp;token,&nbsp;the&nbsp;old&nbsp;one&nbsp;is&nbsp;no&nbsp;longer&nbsp;useful&nbsp;and\r\n&nbsp;&nbsp;&nbsp;*&nbsp;so&nbsp;should&nbsp;be&nbsp;forcibly&nbsp;expired&nbsp;in&nbsp;the&nbsp;data&nbsp;store&nbsp;so&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;used&nbsp;again.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;storage&nbsp;fails&nbsp;for&nbsp;some&nbsp;reason,&nbsp;we&#39;re&nbsp;not&nbsp;currently&nbsp;checking&nbsp;for\r\n&nbsp;&nbsp;&nbsp;*&nbsp;any&nbsp;sort&nbsp;of&nbsp;success/failure,&nbsp;so&nbsp;you&nbsp;should&nbsp;bail&nbsp;out&nbsp;of&nbsp;the&nbsp;script\r\n&nbsp;&nbsp;&nbsp;*&nbsp;and&nbsp;provide&nbsp;a&nbsp;descriptive&nbsp;fail&nbsp;message.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$refresh_token\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Refresh&nbsp;token&nbsp;to&nbsp;be&nbsp;expirse.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;unsetRefreshToken($refresh_token)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Grant&nbsp;access&nbsp;tokens&nbsp;for&nbsp;the&nbsp;&quot;none&quot;&nbsp;grant&nbsp;type.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Not&nbsp;really&nbsp;described&nbsp;in&nbsp;the&nbsp;IETF&nbsp;Draft,&nbsp;so&nbsp;I&nbsp;just&nbsp;left&nbsp;a&nbsp;method\r\n&nbsp;&nbsp;&nbsp;*&nbsp;stub...&nbsp;Do&nbsp;whatever&nbsp;you&nbsp;want!\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Required&nbsp;for&nbsp;OAUTH2_GRANT_TYPE_NONE.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;checkNoneAccess($client_id)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;default&nbsp;authentication&nbsp;realm&nbsp;for&nbsp;WWW-Authenticate&nbsp;header.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Change&nbsp;this&nbsp;to&nbsp;whatever&nbsp;authentication&nbsp;realm&nbsp;you&nbsp;want&nbsp;to&nbsp;send&nbsp;in&nbsp;a\r\n&nbsp;&nbsp;&nbsp;*&nbsp;WWW-Authenticate&nbsp;header.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;string&nbsp;that&nbsp;you&nbsp;want&nbsp;to&nbsp;send&nbsp;in&nbsp;a&nbsp;WWW-Authenticate&nbsp;header.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_error\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;getDefaultAuthenticationRealm()&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&quot;Service&quot;;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;//&nbsp;End&nbsp;stuff&nbsp;that&nbsp;should&nbsp;get&nbsp;overridden.\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Creates&nbsp;an&nbsp;OAuth2.0&nbsp;server-side&nbsp;instance.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$config\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;associative&nbsp;array&nbsp;as&nbsp;below:\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;access_token_lifetime:&nbsp;(optional)&nbsp;The&nbsp;lifetime&nbsp;of&nbsp;access&nbsp;token&nbsp;in\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seconds.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;auth_code_lifetime:&nbsp;(optional)&nbsp;The&nbsp;lifetime&nbsp;of&nbsp;authorization&nbsp;code&nbsp;in\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seconds.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;refresh_token_lifetime:&nbsp;(optional)&nbsp;The&nbsp;lifetime&nbsp;of&nbsp;refresh&nbsp;token&nbsp;in\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seconds.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;display_error:&nbsp;(optional)&nbsp;Whether&nbsp;to&nbsp;show&nbsp;verbose&nbsp;error&nbsp;messages&nbsp;in\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;response.\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;public&nbsp;function&nbsp;__construct($config&nbsp;=&nbsp;array())&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($config&nbsp;as&nbsp;$name&nbsp;=&gt;&nbsp;$value)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;setVariable($name,&nbsp;$value);\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;//&nbsp;Resource&nbsp;protecting&nbsp;(Section&nbsp;5).\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Check&nbsp;that&nbsp;a&nbsp;valid&nbsp;access&nbsp;token&nbsp;has&nbsp;been&nbsp;provided.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;scope&nbsp;parameter&nbsp;defines&nbsp;any&nbsp;required&nbsp;scope&nbsp;that&nbsp;the&nbsp;token&nbsp;must&nbsp;have.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;a&nbsp;scope&nbsp;param&nbsp;is&nbsp;provided&nbsp;and&nbsp;the&nbsp;token&nbsp;does&nbsp;not&nbsp;have&nbsp;the&nbsp;required\r\n&nbsp;&nbsp;&nbsp;*&nbsp;scope,&nbsp;we&nbsp;bounce&nbsp;the&nbsp;request.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Some&nbsp;implementations&nbsp;may&nbsp;choose&nbsp;to&nbsp;return&nbsp;a&nbsp;subset&nbsp;of&nbsp;the&nbsp;protected\r\n&nbsp;&nbsp;&nbsp;*&nbsp;resource&nbsp;(i.e.&nbsp;&quot;public&quot;&nbsp;data)&nbsp;if&nbsp;the&nbsp;user&nbsp;has&nbsp;not&nbsp;provided&nbsp;an&nbsp;access\r\n&nbsp;&nbsp;&nbsp;*&nbsp;token&nbsp;or&nbsp;if&nbsp;the&nbsp;access&nbsp;token&nbsp;is&nbsp;invalid&nbsp;or&nbsp;expired.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;IETF&nbsp;spec&nbsp;says&nbsp;that&nbsp;we&nbsp;should&nbsp;send&nbsp;a&nbsp;401&nbsp;Unauthorized&nbsp;header&nbsp;and\r\n&nbsp;&nbsp;&nbsp;*&nbsp;bail&nbsp;immediately&nbsp;so&nbsp;that&#39;s&nbsp;what&nbsp;the&nbsp;defaults&nbsp;are&nbsp;set&nbsp;to.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$scope\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;space-separated&nbsp;string&nbsp;of&nbsp;required&nbsp;scope(s),&nbsp;if&nbsp;you&nbsp;want&nbsp;to&nbsp;check\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;for&nbsp;scope.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$exit_not_present\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;If&nbsp;TRUE&nbsp;and&nbsp;no&nbsp;access&nbsp;token&nbsp;is&nbsp;provided,&nbsp;send&nbsp;a&nbsp;401&nbsp;header&nbsp;and&nbsp;exit,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;otherwise&nbsp;return&nbsp;FALSE.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$exit_invalid\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;If&nbsp;TRUE&nbsp;and&nbsp;the&nbsp;implementation&nbsp;of&nbsp;getAccessToken()&nbsp;returns&nbsp;NULL,&nbsp;exit,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;otherwise&nbsp;return&nbsp;FALSE.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$exit_expired\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;If&nbsp;TRUE&nbsp;and&nbsp;the&nbsp;access&nbsp;token&nbsp;has&nbsp;expired,&nbsp;exit,&nbsp;otherwise&nbsp;return&nbsp;FALSE.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$exit_scope\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;If&nbsp;TRUE&nbsp;the&nbsp;access&nbsp;token&nbsp;does&nbsp;not&nbsp;have&nbsp;the&nbsp;required&nbsp;scope(s),&nbsp;exit,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;otherwise&nbsp;return&nbsp;FALSE.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$realm\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;If&nbsp;you&nbsp;want&nbsp;to&nbsp;specify&nbsp;a&nbsp;particular&nbsp;realm&nbsp;for&nbsp;the&nbsp;WWW-Authenticate\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;header,&nbsp;supply&nbsp;it&nbsp;here.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_5\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;public&nbsp;function&nbsp;verifyAccessToken($scope&nbsp;=&nbsp;NULL,&nbsp;$exit_not_present&nbsp;=&nbsp;TRUE,&nbsp;$exit_invalid&nbsp;=&nbsp;TRUE,&nbsp;$exit_expired&nbsp;=&nbsp;TRUE,&nbsp;$exit_scope&nbsp;=&nbsp;TRUE,&nbsp;$realm&nbsp;=&nbsp;NULL)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;$token_param&nbsp;=&nbsp;$this-&gt;getAccessTokenParams();\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($token_param&nbsp;===&nbsp;FALSE)&nbsp;//&nbsp;Access&nbsp;token&nbsp;was&nbsp;not&nbsp;provided\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$exit_not_present&nbsp;?&nbsp;$this-&gt;errorWWWAuthenticateResponseHeader(OAUTH2_HTTP_BAD_REQUEST,&nbsp;$realm,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;The&nbsp;request&nbsp;is&nbsp;missing&nbsp;a&nbsp;required&nbsp;parameter,&nbsp;includes&nbsp;an&nbsp;unsupported&nbsp;parameter&nbsp;or&nbsp;parameter&nbsp;value,&nbsp;repeats&nbsp;the&nbsp;same&nbsp;parameter,&nbsp;uses&nbsp;more&nbsp;than&nbsp;one&nbsp;method&nbsp;for&nbsp;including&nbsp;an&nbsp;access&nbsp;token,&nbsp;or&nbsp;is&nbsp;otherwise&nbsp;malformed.&#39;,&nbsp;NULL,&nbsp;$scope)&nbsp;:&nbsp;FALSE;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Get&nbsp;the&nbsp;stored&nbsp;token&nbsp;data&nbsp;(from&nbsp;the&nbsp;implementing&nbsp;subclass)\r\n&nbsp;&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;$this-&gt;getAccessToken($token_param);\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($token&nbsp;===&nbsp;NULL)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$exit_invalid&nbsp;?&nbsp;$this-&gt;errorWWWAuthenticateResponseHeader(OAUTH2_HTTP_UNAUTHORIZED,&nbsp;$realm,&nbsp;OAUTH2_ERROR_INVALID_TOKEN,&nbsp;&#39;The&nbsp;access&nbsp;token&nbsp;provided&nbsp;is&nbsp;invalid.&#39;,&nbsp;NULL,&nbsp;$scope)&nbsp;:&nbsp;FALSE;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;token&nbsp;expiration&nbsp;(I&#39;m&nbsp;leaving&nbsp;this&nbsp;check&nbsp;separated,&nbsp;later&nbsp;we&#39;ll&nbsp;fill&nbsp;in&nbsp;better&nbsp;error&nbsp;messages)\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($token[&quot;expires&quot;])&nbsp;&amp;&amp;&nbsp;time()&nbsp;&gt;&nbsp;$token[&quot;expires&quot;])\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$exit_expired&nbsp;?&nbsp;$this-&gt;errorWWWAuthenticateResponseHeader(OAUTH2_HTTP_UNAUTHORIZED,&nbsp;$realm,&nbsp;OAUTH2_ERROR_EXPIRED_TOKEN,&nbsp;&#39;The&nbsp;access&nbsp;token&nbsp;provided&nbsp;has&nbsp;expired.&#39;,&nbsp;NULL,&nbsp;$scope)&nbsp;:&nbsp;FALSE;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;scope,&nbsp;if&nbsp;provided\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;If&nbsp;token&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;scope,&nbsp;it&#39;s&nbsp;NULL/empty,&nbsp;or&nbsp;it&#39;s&nbsp;insufficient,&nbsp;then&nbsp;throw&nbsp;an&nbsp;error\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($scope&nbsp;&amp;&amp;&nbsp;(!isset($token[&quot;scope&quot;])&nbsp;||&nbsp;!$token[&quot;scope&quot;]&nbsp;||&nbsp;!$this-&gt;checkScope($scope,&nbsp;$token[&quot;scope&quot;])))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$exit_scope&nbsp;?&nbsp;$this-&gt;errorWWWAuthenticateResponseHeader(OAUTH2_HTTP_FORBIDDEN,&nbsp;$realm,&nbsp;OAUTH2_ERROR_INSUFFICIENT_SCOPE,&nbsp;&#39;The&nbsp;request&nbsp;requires&nbsp;higher&nbsp;privileges&nbsp;than&nbsp;provided&nbsp;by&nbsp;the&nbsp;access&nbsp;token.&#39;,&nbsp;NULL,&nbsp;$scope)&nbsp;:&nbsp;FALSE;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Check&nbsp;if&nbsp;everything&nbsp;in&nbsp;required&nbsp;scope&nbsp;is&nbsp;contained&nbsp;in&nbsp;available&nbsp;scope.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$required_scope\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Required&nbsp;scope&nbsp;to&nbsp;be&nbsp;check&nbsp;with.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$available_scope\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Available&nbsp;scope&nbsp;to&nbsp;be&nbsp;compare&nbsp;with.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;TRUE&nbsp;if&nbsp;everything&nbsp;in&nbsp;required&nbsp;scope&nbsp;is&nbsp;contained&nbsp;in&nbsp;available&nbsp;scope,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;and&nbsp;False&nbsp;if&nbsp;it&nbsp;isn&#39;t.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_5\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;private&nbsp;function&nbsp;checkScope($required_scope,&nbsp;$available_scope)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;required&nbsp;scope&nbsp;should&nbsp;match&nbsp;or&nbsp;be&nbsp;a&nbsp;subset&nbsp;of&nbsp;the&nbsp;available&nbsp;scope\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!is_array($required_scope))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$required_scope&nbsp;=&nbsp;explode(&quot;&nbsp;&quot;,&nbsp;$required_scope);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!is_array($available_scope))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$available_scope&nbsp;=&nbsp;explode(&quot;&nbsp;&quot;,&nbsp;$available_scope);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(count(array_diff($required_scope,&nbsp;$available_scope))&nbsp;==&nbsp;0);\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Pulls&nbsp;the&nbsp;access&nbsp;token&nbsp;out&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;request.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Either&nbsp;from&nbsp;the&nbsp;Authorization&nbsp;header&nbsp;or&nbsp;GET/POST/etc.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Access&nbsp;token&nbsp;value&nbsp;if&nbsp;present,&nbsp;and&nbsp;FALSE&nbsp;if&nbsp;it&nbsp;isn&#39;t.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@todo&nbsp;Support&nbsp;PUT&nbsp;or&nbsp;DELETE.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.1\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_5\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;private&nbsp;function&nbsp;getAccessTokenParams()&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;$auth_header&nbsp;=&nbsp;$this-&gt;getAuthorizationHeader();\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($auth_header&nbsp;!==&nbsp;FALSE)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Make&nbsp;sure&nbsp;only&nbsp;the&nbsp;auth&nbsp;header&nbsp;is&nbsp;set\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_GET[OAUTH2_TOKEN_PARAM_NAME])&nbsp;||&nbsp;isset($_POST[OAUTH2_TOKEN_PARAM_NAME]))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;Auth&nbsp;token&nbsp;found&nbsp;in&nbsp;GET&nbsp;or&nbsp;POST&nbsp;when&nbsp;token&nbsp;present&nbsp;in&nbsp;header&#39;);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$auth_header&nbsp;=&nbsp;trim($auth_header);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Make&nbsp;sure&nbsp;it&#39;s&nbsp;Token&nbsp;authorization\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strcmp(substr($auth_header,&nbsp;0,&nbsp;5),&nbsp;&quot;OAuth&nbsp;&quot;)&nbsp;!==&nbsp;0)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;Auth&nbsp;header&nbsp;found&nbsp;that&nbsp;doesn\\&#39;t&nbsp;start&nbsp;with&nbsp;&quot;OAuth&quot;&#39;);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Parse&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;header\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(preg_match(&#39;/\\s*OAuth\\s*=&quot;(.+)&quot;/&#39;,&nbsp;substr($auth_header,&nbsp;5),&nbsp;$matches)&nbsp;==&nbsp;0&nbsp;||&nbsp;count($matches)&nbsp;&lt;&nbsp;2)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;Malformed&nbsp;auth&nbsp;header&#39;);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$matches[1];\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_GET[OAUTH2_TOKEN_PARAM_NAME]))&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_POST[OAUTH2_TOKEN_PARAM_NAME]))&nbsp;//&nbsp;Both&nbsp;GET&nbsp;and&nbsp;POST&nbsp;are&nbsp;not&nbsp;allowed\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;Only&nbsp;send&nbsp;the&nbsp;token&nbsp;in&nbsp;GET&nbsp;or&nbsp;POST,&nbsp;not&nbsp;both&#39;);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$_GET[OAUTH2_TOKEN_PARAM_NAME];\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_POST[OAUTH2_TOKEN_PARAM_NAME]))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$_POST[OAUTH2_TOKEN_PARAM_NAME];\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;//&nbsp;Access&nbsp;token&nbsp;granting&nbsp;(Section&nbsp;4).\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Grant&nbsp;or&nbsp;deny&nbsp;a&nbsp;requested&nbsp;access&nbsp;token.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;would&nbsp;be&nbsp;called&nbsp;from&nbsp;the&nbsp;&quot;/token&quot;&nbsp;endpoint&nbsp;as&nbsp;defined&nbsp;in&nbsp;the&nbsp;spec.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Obviously,&nbsp;you&nbsp;can&nbsp;call&nbsp;your&nbsp;endpoint&nbsp;whatever&nbsp;you&nbsp;want.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;public&nbsp;function&nbsp;grantAccessToken()&nbsp;{\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;$filters&nbsp;=&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;grant_type&quot;&nbsp;=&gt;&nbsp;array(&quot;filter&quot;&nbsp;=&gt;&nbsp;FILTER_VALIDATE_REGEXP,&nbsp;&quot;options&quot;&nbsp;=&gt;&nbsp;array(&quot;regexp&quot;&nbsp;=&gt;&nbsp;OAUTH2_GRANT_TYPE_REGEXP),&nbsp;&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;scope&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;code&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;redirect_uri&quot;&nbsp;=&gt;&nbsp;array(&quot;filter&quot;&nbsp;=&gt;&nbsp;FILTER_SANITIZE_URL),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;username&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;password&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;assertion_type&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;assertion&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;refresh_token&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),\r\n&nbsp;&nbsp;&nbsp;&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;filter_input_array(INPUT_POST,&nbsp;$filters);\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Grant&nbsp;Type&nbsp;must&nbsp;be&nbsp;specified.\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;grant_type&quot;])\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;Invalid&nbsp;grant_type&nbsp;parameter&nbsp;or&nbsp;parameter&nbsp;missing&#39;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Make&nbsp;sure&nbsp;we&#39;ve&nbsp;implemented&nbsp;the&nbsp;requested&nbsp;grant&nbsp;type\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!in_array($input[&quot;grant_type&quot;],&nbsp;$this-&gt;getSupportedGrantTypes()))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_UNSUPPORTED_GRANT_TYPE);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Authorize&nbsp;the&nbsp;client\r\n&nbsp;&nbsp;&nbsp;&nbsp;$client&nbsp;=&nbsp;$this-&gt;getClientCredentials();\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;checkClientCredentials($client[0],&nbsp;$client[1])&nbsp;===&nbsp;FALSE)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_CLIENT);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$this-&gt;checkRestrictedGrantType($client[0],&nbsp;$input[&quot;grant_type&quot;]))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_UNAUTHORIZED_CLIENT);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Do&nbsp;the&nbsp;granting\r\n&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;($input[&quot;grant_type&quot;])&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;OAUTH2_GRANT_TYPE_AUTH_CODE:\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;code&quot;]&nbsp;||&nbsp;!$input[&quot;redirect_uri&quot;])\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stored&nbsp;=&nbsp;$this-&gt;getAuthCode($input[&quot;code&quot;]);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Ensure&nbsp;that&nbsp;the&nbsp;input&nbsp;uri&nbsp;starts&nbsp;with&nbsp;the&nbsp;stored&nbsp;uri\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($stored&nbsp;===&nbsp;NULL&nbsp;||&nbsp;(strcasecmp(substr($input[&quot;redirect_uri&quot;],&nbsp;0,&nbsp;strlen($stored[&quot;redirect_uri&quot;])),&nbsp;$stored[&quot;redirect_uri&quot;])&nbsp;!==&nbsp;0)&nbsp;||&nbsp;$client[0]&nbsp;!=&nbsp;$stored[&quot;client_id&quot;])\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_GRANT);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($stored[&quot;expires&quot;]&nbsp;&lt;&nbsp;time())\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_EXPIRED_TOKEN);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;OAUTH2_GRANT_TYPE_USER_CREDENTIALS:\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;username&quot;]&nbsp;||&nbsp;!$input[&quot;password&quot;])\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;Missing&nbsp;parameters.&nbsp;&quot;username&quot;&nbsp;and&nbsp;&quot;password&quot;&nbsp;required&#39;);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stored&nbsp;=&nbsp;$this-&gt;checkUserCredentials($client[0],&nbsp;$input[&quot;username&quot;],&nbsp;$input[&quot;password&quot;]);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($stored&nbsp;===&nbsp;FALSE)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_GRANT);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;OAUTH2_GRANT_TYPE_ASSERTION:\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;assertion_type&quot;]&nbsp;||&nbsp;!$input[&quot;assertion&quot;])\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stored&nbsp;=&nbsp;$this-&gt;checkAssertion($client[0],&nbsp;$input[&quot;assertion_type&quot;],&nbsp;$input[&quot;assertion&quot;]);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($stored&nbsp;===&nbsp;FALSE)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_GRANT);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;OAUTH2_GRANT_TYPE_REFRESH_TOKEN:\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;refresh_token&quot;])\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;No&nbsp;&quot;refresh_token&quot;&nbsp;parameter&nbsp;found&#39;);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stored&nbsp;=&nbsp;$this-&gt;getRefreshToken($input[&quot;refresh_token&quot;]);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($stored&nbsp;===&nbsp;NULL&nbsp;||&nbsp;$client[0]&nbsp;!=&nbsp;$stored[&quot;client_id&quot;])\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_GRANT);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($stored[&quot;expires&quot;]&nbsp;&lt;&nbsp;time())\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_EXPIRED_TOKEN);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;store&nbsp;the&nbsp;refresh&nbsp;token&nbsp;locally&nbsp;so&nbsp;we&nbsp;can&nbsp;delete&nbsp;it&nbsp;when&nbsp;a&nbsp;new&nbsp;refresh&nbsp;token&nbsp;is&nbsp;generated\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;setVariable(&#39;_old_refresh_token&#39;,&nbsp;$stored[&quot;token&quot;]);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;OAUTH2_GRANT_TYPE_NONE:\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stored&nbsp;=&nbsp;$this-&gt;checkNoneAccess($client[0]);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($stored&nbsp;===&nbsp;FALSE)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_REQUEST);\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;scope,&nbsp;if&nbsp;provided\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($input[&quot;scope&quot;]&nbsp;&amp;&amp;&nbsp;(!is_array($stored)&nbsp;||&nbsp;!isset($stored[&quot;scope&quot;])&nbsp;||&nbsp;!$this-&gt;checkScope($input[&quot;scope&quot;],&nbsp;$stored[&quot;scope&quot;])))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_SCOPE);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;scope&quot;])\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$input[&quot;scope&quot;]&nbsp;=&nbsp;NULL;\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;$this-&gt;createAccessToken($client[0],&nbsp;$input[&quot;scope&quot;],&nbsp;$stored[&quot;user_id&quot;]);\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//TOKEN&nbsp;为&nbsp;数组&nbsp;(包括&nbsp;TOKEN&nbsp;值，&nbsp;有效时间，&nbsp;权限)\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;$this-&gt;sendJsonHeaders();\r\n&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;json_encode($token);\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Internal&nbsp;function&nbsp;used&nbsp;to&nbsp;get&nbsp;the&nbsp;client&nbsp;credentials&nbsp;from&nbsp;HTTP&nbsp;basic\r\n&nbsp;&nbsp;&nbsp;*&nbsp;auth&nbsp;or&nbsp;POST&nbsp;data.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;list&nbsp;containing&nbsp;the&nbsp;client&nbsp;identifier&nbsp;and&nbsp;password,&nbsp;for&nbsp;example\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@code\r\n&nbsp;&nbsp;&nbsp;*&nbsp;return&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;$_POST[&quot;client_id&quot;],\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;$_POST[&quot;client_secret&quot;],\r\n&nbsp;&nbsp;&nbsp;*&nbsp;);\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@endcode\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-2\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_2\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;getClientCredentials()&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_SERVER[&quot;PHP_AUTH_USER&quot;])&nbsp;&amp;&amp;&nbsp;$_POST&nbsp;&amp;&amp;&nbsp;isset($_POST[&quot;client_id&quot;]))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_CLIENT);\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Try&nbsp;basic&nbsp;auth\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_SERVER[&quot;PHP_AUTH_USER&quot;]))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array($_SERVER[&quot;PHP_AUTH_USER&quot;],&nbsp;$_SERVER[&quot;PHP_AUTH_PW&quot;]);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Try&nbsp;POST\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($_POST&nbsp;&amp;&amp;&nbsp;isset($_POST[&quot;client_id&quot;]))&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_POST[&quot;client_secret&quot;]))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array($_POST[&quot;client_id&quot;],&nbsp;$_POST[&quot;client_secret&quot;]);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array($_POST[&quot;client_id&quot;],&nbsp;NULL);\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;No&nbsp;credentials&nbsp;were&nbsp;specified\r\n&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_BAD_REQUEST,&nbsp;OAUTH2_ERROR_INVALID_CLIENT);\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;//&nbsp;End-user/client&nbsp;Authorization&nbsp;(Section&nbsp;3&nbsp;of&nbsp;IETF&nbsp;Draft).\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Pull&nbsp;the&nbsp;authorization&nbsp;request&nbsp;data&nbsp;out&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;request.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;authorization&nbsp;parameters&nbsp;so&nbsp;the&nbsp;authorization&nbsp;server&nbsp;can&nbsp;prompt\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;the&nbsp;user&nbsp;for&nbsp;approval&nbsp;if&nbsp;valid.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;public&nbsp;function&nbsp;getAuthorizeParams()&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;$filters&nbsp;=&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;client_id&quot;&nbsp;=&gt;&nbsp;array(&quot;filter&quot;&nbsp;=&gt;&nbsp;FILTER_VALIDATE_REGEXP,&nbsp;&quot;options&quot;&nbsp;=&gt;&nbsp;array(&quot;regexp&quot;&nbsp;=&gt;&nbsp;OAUTH2_CLIENT_ID_REGEXP),&nbsp;&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;response_type&quot;&nbsp;=&gt;&nbsp;array(&quot;filter&quot;&nbsp;=&gt;&nbsp;FILTER_VALIDATE_REGEXP,&nbsp;&quot;options&quot;&nbsp;=&gt;&nbsp;array(&quot;regexp&quot;&nbsp;=&gt;&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_REGEXP),&nbsp;&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;redirect_uri&quot;&nbsp;=&gt;&nbsp;array(&quot;filter&quot;&nbsp;=&gt;&nbsp;FILTER_SANITIZE_URL),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;state&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;scope&quot;&nbsp;=&gt;&nbsp;array(&quot;flags&quot;&nbsp;=&gt;&nbsp;FILTER_REQUIRE_SCALAR),\r\n&nbsp;&nbsp;&nbsp;&nbsp;);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;filter_input_array(INPUT_GET,&nbsp;$filters);\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Make&nbsp;sure&nbsp;a&nbsp;valid&nbsp;client&nbsp;id&nbsp;was&nbsp;supplied\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;client_id&quot;])&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($input[&quot;redirect_uri&quot;])\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorDoRedirectUriCallback($input[&quot;redirect_uri&quot;],&nbsp;OAUTH2_ERROR_INVALID_CLIENT,&nbsp;NULL,&nbsp;NULL,&nbsp;$input[&quot;state&quot;]);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_FOUND,&nbsp;OAUTH2_ERROR_INVALID_CLIENT);&nbsp;//&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;good&nbsp;URI&nbsp;to&nbsp;use\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;redirect_uri&nbsp;is&nbsp;not&nbsp;required&nbsp;if&nbsp;already&nbsp;established&nbsp;via&nbsp;other&nbsp;channels\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;check&nbsp;an&nbsp;existing&nbsp;redirect&nbsp;URI&nbsp;against&nbsp;the&nbsp;one&nbsp;supplied\r\n&nbsp;&nbsp;&nbsp;&nbsp;$redirect_uri&nbsp;=&nbsp;$this-&gt;getRedirectUri($input[&quot;client_id&quot;]);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;At&nbsp;least&nbsp;one&nbsp;of:&nbsp;existing&nbsp;redirect&nbsp;URI&nbsp;or&nbsp;input&nbsp;redirect&nbsp;URI&nbsp;must&nbsp;be&nbsp;specified\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$redirect_uri&nbsp;&amp;&amp;&nbsp;!$input[&quot;redirect_uri&quot;])\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorJsonResponse(OAUTH2_HTTP_FOUND,&nbsp;OAUTH2_ERROR_INVALID_REQUEST);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;getRedirectUri()&nbsp;should&nbsp;return&nbsp;FALSE&nbsp;if&nbsp;the&nbsp;given&nbsp;client&nbsp;ID&nbsp;is&nbsp;invalid\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;this&nbsp;probably&nbsp;saves&nbsp;us&nbsp;from&nbsp;making&nbsp;a&nbsp;separate&nbsp;db&nbsp;call,&nbsp;and&nbsp;simplifies&nbsp;the&nbsp;method&nbsp;set\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($redirect_uri&nbsp;===&nbsp;FALSE)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorDoRedirectUriCallback($input[&quot;redirect_uri&quot;],&nbsp;OAUTH2_ERROR_INVALID_CLIENT,&nbsp;NULL,&nbsp;NULL,&nbsp;$input[&quot;state&quot;]);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;existing&nbsp;uri&nbsp;and&nbsp;one&nbsp;from&nbsp;input,&nbsp;verify&nbsp;that&nbsp;they&nbsp;match\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($redirect_uri&nbsp;&amp;&amp;&nbsp;$input[&quot;redirect_uri&quot;])&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Ensure&nbsp;that&nbsp;the&nbsp;input&nbsp;uri&nbsp;starts&nbsp;with&nbsp;the&nbsp;stored&nbsp;uri\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strcasecmp(substr($input[&quot;redirect_uri&quot;],&nbsp;0,&nbsp;strlen($redirect_uri)),&nbsp;$redirect_uri)&nbsp;!==&nbsp;0)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorDoRedirectUriCallback($input[&quot;redirect_uri&quot;],&nbsp;OAUTH2_ERROR_REDIRECT_URI_MISMATCH,&nbsp;NULL,&nbsp;NULL,&nbsp;$input[&quot;state&quot;]);\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;elseif&nbsp;($redirect_uri)&nbsp;{&nbsp;//&nbsp;They&nbsp;did&nbsp;not&nbsp;provide&nbsp;a&nbsp;uri&nbsp;from&nbsp;input,&nbsp;so&nbsp;use&nbsp;the&nbsp;stored&nbsp;one\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$input[&quot;redirect_uri&quot;]&nbsp;=&nbsp;$redirect_uri;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;type&nbsp;and&nbsp;client_id&nbsp;are&nbsp;required\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$input[&quot;response_type&quot;])\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorDoRedirectUriCallback($input[&quot;redirect_uri&quot;],&nbsp;OAUTH2_ERROR_INVALID_REQUEST,&nbsp;&#39;Invalid&nbsp;response&nbsp;type.&#39;,&nbsp;NULL,&nbsp;$input[&quot;state&quot;]);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;requested&nbsp;auth&nbsp;response&nbsp;type&nbsp;against&nbsp;the&nbsp;list&nbsp;of&nbsp;supported&nbsp;types\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(array_search($input[&quot;response_type&quot;],&nbsp;$this-&gt;getSupportedAuthResponseTypes())&nbsp;===&nbsp;FALSE)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorDoRedirectUriCallback($input[&quot;redirect_uri&quot;],&nbsp;OAUTH2_ERROR_UNSUPPORTED_RESPONSE_TYPE,&nbsp;NULL,&nbsp;NULL,&nbsp;$input[&quot;state&quot;]);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Restrict&nbsp;clients&nbsp;to&nbsp;certain&nbsp;authorization&nbsp;response&nbsp;types\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;checkRestrictedAuthResponseType($input[&quot;client_id&quot;],&nbsp;$input[&quot;response_type&quot;])&nbsp;===&nbsp;FALSE)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorDoRedirectUriCallback($input[&quot;redirect_uri&quot;],&nbsp;OAUTH2_ERROR_UNAUTHORIZED_CLIENT,&nbsp;NULL,&nbsp;NULL,&nbsp;$input[&quot;state&quot;]);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Validate&nbsp;that&nbsp;the&nbsp;requested&nbsp;scope&nbsp;is&nbsp;supported\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($input[&quot;scope&quot;]&nbsp;&amp;&amp;&nbsp;!$this-&gt;checkScope($input[&quot;scope&quot;],&nbsp;$this-&gt;getSupportedScopes()))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorDoRedirectUriCallback($input[&quot;redirect_uri&quot;],&nbsp;OAUTH2_ERROR_INVALID_SCOPE,&nbsp;NULL,&nbsp;NULL,&nbsp;$input[&quot;state&quot;]);\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$input;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Redirect&nbsp;the&nbsp;user&nbsp;appropriately&nbsp;after&nbsp;approval.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;After&nbsp;the&nbsp;user&nbsp;has&nbsp;approved&nbsp;or&nbsp;denied&nbsp;the&nbsp;access&nbsp;request&nbsp;the\r\n&nbsp;&nbsp;&nbsp;*&nbsp;authorization&nbsp;server&nbsp;should&nbsp;call&nbsp;this&nbsp;function&nbsp;to&nbsp;redirect&nbsp;the&nbsp;user\r\n&nbsp;&nbsp;&nbsp;*&nbsp;appropriately.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$is_authorized\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;TRUE&nbsp;or&nbsp;FALSE&nbsp;depending&nbsp;on&nbsp;whether&nbsp;the&nbsp;user&nbsp;authorized&nbsp;the&nbsp;access.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$params\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;associative&nbsp;array&nbsp;as&nbsp;below:\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;response_type:&nbsp;The&nbsp;requested&nbsp;response:&nbsp;an&nbsp;access&nbsp;token,&nbsp;an\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authorization&nbsp;code,&nbsp;or&nbsp;both.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;client_id:&nbsp;The&nbsp;client&nbsp;identifier&nbsp;as&nbsp;described&nbsp;in&nbsp;Section&nbsp;2.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;redirect_uri:&nbsp;An&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;which&nbsp;the&nbsp;authorization&nbsp;server\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will&nbsp;redirect&nbsp;the&nbsp;user-agent&nbsp;to&nbsp;when&nbsp;the&nbsp;end-user&nbsp;authorization\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;step&nbsp;is&nbsp;completed.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;scope:&nbsp;(optional)&nbsp;The&nbsp;scope&nbsp;of&nbsp;the&nbsp;access&nbsp;request&nbsp;expressed&nbsp;as&nbsp;a\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list&nbsp;of&nbsp;space-delimited&nbsp;strings.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;state:&nbsp;(optional)&nbsp;An&nbsp;opaque&nbsp;value&nbsp;used&nbsp;by&nbsp;the&nbsp;client&nbsp;to&nbsp;maintain\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;between&nbsp;the&nbsp;request&nbsp;and&nbsp;callback.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;public&nbsp;function&nbsp;finishClientAuthorization($is_authorized,&nbsp;$params&nbsp;=&nbsp;array())&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;$params&nbsp;+=&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&#39;scope&#39;&nbsp;=&gt;&nbsp;NULL,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;state&#39;&nbsp;=&gt;&nbsp;NULL,\r\n&nbsp;&nbsp;&nbsp;&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;extract($params);\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($state&nbsp;!==&nbsp;NULL)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;query&quot;][&quot;state&quot;]&nbsp;=&nbsp;$state;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($is_authorized&nbsp;===&nbsp;FALSE)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;query&quot;][&quot;error&quot;]&nbsp;=&nbsp;OAUTH2_ERROR_USER_DENIED;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($response_type&nbsp;==&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_AUTH_CODE&nbsp;||&nbsp;$response_type&nbsp;==&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_CODE_AND_TOKEN)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;query&quot;][&quot;code&quot;]&nbsp;=&nbsp;$this-&gt;createAuthCode($client_id,&nbsp;$redirect_uri,&nbsp;$user_id,&nbsp;$scope);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($response_type&nbsp;==&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_ACCESS_TOKEN&nbsp;||&nbsp;$response_type&nbsp;==&nbsp;OAUTH2_AUTH_RESPONSE_TYPE_CODE_AND_TOKEN)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;fragment&quot;]&nbsp;=&nbsp;$this-&gt;createAccessToken($client_id,&nbsp;$scope,&nbsp;$user_id);\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;$result[&#39;display&#39;]&nbsp;=&nbsp;!empty($display)&nbsp;?&nbsp;$display&nbsp;:&nbsp;&#39;&#39;;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;doRedirectUriCallback($redirect_uri,&nbsp;$result);\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;//&nbsp;Other/utility&nbsp;functions.\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Redirect&nbsp;the&nbsp;user&nbsp;agent.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Handle&nbsp;both&nbsp;redirect&nbsp;for&nbsp;success&nbsp;or&nbsp;error&nbsp;response.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$redirect_uri\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;which&nbsp;the&nbsp;authorization&nbsp;server&nbsp;will&nbsp;redirect\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;the&nbsp;user-agent&nbsp;to&nbsp;when&nbsp;the&nbsp;end-user&nbsp;authorization&nbsp;step&nbsp;is&nbsp;completed.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$params\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Parameters&nbsp;to&nbsp;be&nbsp;pass&nbsp;though&nbsp;buildUri().\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;private&nbsp;function&nbsp;doRedirectUriCallback($redirect_uri,&nbsp;$params)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;HTTP/1.1&nbsp;&quot;.&nbsp;OAUTH2_HTTP_FOUND);\r\n&nbsp;&nbsp;&nbsp;&nbsp;if($params[&#39;display&#39;]&nbsp;==&nbsp;&#39;frame&#39;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&#39;&lt;script&gt;window.top.location.href=&quot;&#39;.$this-&gt;buildUri($redirect_uri,&nbsp;$params).&#39;&quot;;&lt;/script&gt;&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;Location:&nbsp;&quot;&nbsp;.&nbsp;$this-&gt;buildUri($redirect_uri,&nbsp;$params));\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;exit;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Build&nbsp;the&nbsp;absolute&nbsp;URI&nbsp;based&nbsp;on&nbsp;supplied&nbsp;URI&nbsp;and&nbsp;parameters.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$uri\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;absolute&nbsp;URI.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$params\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Parameters&nbsp;to&nbsp;be&nbsp;append&nbsp;as&nbsp;GET.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;absolute&nbsp;URI&nbsp;with&nbsp;supplied&nbsp;parameters.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;private&nbsp;function&nbsp;buildUri($uri,&nbsp;$params)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;session_start();\r\n&nbsp;&nbsp;&nbsp;&nbsp;$parse_url&nbsp;=&nbsp;parse_url($uri);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Add&nbsp;our&nbsp;params&nbsp;to&nbsp;the&nbsp;parsed&nbsp;uri\r\n&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($params&nbsp;as&nbsp;$k&nbsp;=&gt;&nbsp;$v)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($parse_url[$k]))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parse_url[$k]&nbsp;.=&nbsp;&quot;&amp;&quot;&nbsp;.&nbsp;http_build_query($v);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parse_url[$k]&nbsp;=&nbsp;http_build_query($v);\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Put&nbsp;humpty&nbsp;dumpty&nbsp;back&nbsp;together\r\n&nbsp;&nbsp;&nbsp;&nbsp;$return&nbsp;=\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((isset($parse_url[&quot;scheme&quot;]))&nbsp;?&nbsp;$parse_url[&quot;scheme&quot;]&nbsp;.&nbsp;&quot;://&quot;&nbsp;:&nbsp;&quot;&quot;)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.&nbsp;((isset($parse_url[&quot;user&quot;]))&nbsp;?&nbsp;$parse_url[&quot;user&quot;]&nbsp;.&nbsp;((isset($parse_url[&quot;pass&quot;]))&nbsp;?&nbsp;&quot;:&quot;&nbsp;.&nbsp;$parse_url[&quot;pass&quot;]&nbsp;:&nbsp;&quot;&quot;)&nbsp;.&nbsp;&quot;@&quot;&nbsp;:&nbsp;&quot;&quot;)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.&nbsp;((isset($parse_url[&quot;host&quot;]))&nbsp;?&nbsp;$parse_url[&quot;host&quot;]&nbsp;:&nbsp;&quot;&quot;)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.&nbsp;((isset($parse_url[&quot;port&quot;]))&nbsp;?&nbsp;&quot;:&quot;&nbsp;.&nbsp;$parse_url[&quot;port&quot;]&nbsp;:&nbsp;&quot;&quot;)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.&nbsp;((isset($parse_url[&quot;path&quot;]))&nbsp;?&nbsp;$parse_url[&quot;path&quot;]&nbsp;:&nbsp;&quot;&quot;)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.&nbsp;((isset($parse_url[&quot;query&quot;]))&nbsp;?&nbsp;&quot;?&quot;&nbsp;.&nbsp;$parse_url[&quot;query&quot;]&nbsp;:&nbsp;&quot;&quot;)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.&nbsp;((isset($parse_url[&quot;fragment&quot;]))&nbsp;?&nbsp;&quot;#&quot;&nbsp;.&nbsp;$parse_url[&quot;fragment&quot;]&nbsp;:&nbsp;&quot;&quot;)&nbsp;.&nbsp;&quot;&amp;ssid=&quot;.base64_encode(&#39;2egc83&#39;.session_id());\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$return;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Handle&nbsp;the&nbsp;creation&nbsp;of&nbsp;access&nbsp;token,&nbsp;also&nbsp;issue&nbsp;refresh&nbsp;token&nbsp;if&nbsp;support.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;belongs&nbsp;in&nbsp;a&nbsp;separate&nbsp;factory,&nbsp;but&nbsp;to&nbsp;keep&nbsp;it&nbsp;simple,&nbsp;I&#39;m&nbsp;just\r\n&nbsp;&nbsp;&nbsp;*&nbsp;keeping&nbsp;it&nbsp;here.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;related&nbsp;to&nbsp;the&nbsp;access&nbsp;token.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$scope\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;Scopes&nbsp;to&nbsp;be&nbsp;stored&nbsp;in&nbsp;space-separated&nbsp;string.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;createAccessToken($client_id,&nbsp;$scope&nbsp;=&nbsp;NULL,&nbsp;$user_id&nbsp;=&nbsp;10)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;access_token&quot;&nbsp;=&gt;&nbsp;$this-&gt;genAccessToken(),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;expires_in&quot;&nbsp;=&gt;&nbsp;$this-&gt;getVariable(&#39;access_token_lifetime&#39;,&nbsp;OAUTH2_DEFAULT_ACCESS_TOKEN_LIFETIME),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;user_id&quot;&nbsp;=&gt;&nbsp;$user_id,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;scope&quot;&nbsp;=&gt;&nbsp;$scope\r\n&nbsp;&nbsp;&nbsp;&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;$refresh_token&nbsp;=&nbsp;&#39;&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Issue&nbsp;a&nbsp;refresh&nbsp;token&nbsp;also,&nbsp;if&nbsp;we&nbsp;support&nbsp;them\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(in_array(OAUTH2_GRANT_TYPE_REFRESH_TOKEN,&nbsp;$this-&gt;getSupportedGrantTypes()))&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$refresh_token&nbsp;=&nbsp;$this-&gt;genAccessToken();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;$this-&gt;setRefreshToken($token[&quot;refresh_token&quot;],&nbsp;$client_id,&nbsp;time()&nbsp;+&nbsp;$this-&gt;getVariable(&#39;refresh_token_lifetime&#39;,&nbsp;OAUTH2_DEFAULT_REFRESH_TOKEN_LIFETIME),&nbsp;$user_id,&nbsp;$scope);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$token[&quot;refresh_token&quot;]&nbsp;=&nbsp;$refresh_token;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;If&nbsp;we&#39;ve&nbsp;granted&nbsp;a&nbsp;new&nbsp;refresh&nbsp;token,&nbsp;expire&nbsp;the&nbsp;old&nbsp;one\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;getVariable(&#39;_old_refresh_token&#39;))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;unsetRefreshToken($this-&gt;getVariable(&#39;_old_refresh_token&#39;));\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;$access_token&nbsp;=&nbsp;$token[&#39;access_token&#39;];\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;setAccessToken($access_token,&nbsp;$client_id,&nbsp;time()&nbsp;+&nbsp;$this-&gt;getVariable(&#39;access_token_lifetime&#39;,&nbsp;OAUTH2_DEFAULT_ACCESS_TOKEN_LIFETIME),&nbsp;$token[&#39;user_id&#39;],&nbsp;$scope,&nbsp;$refresh_token);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$token;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Handle&nbsp;the&nbsp;creation&nbsp;of&nbsp;auth&nbsp;code.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;belongs&nbsp;in&nbsp;a&nbsp;separate&nbsp;factory,&nbsp;but&nbsp;to&nbsp;keep&nbsp;it&nbsp;simple,&nbsp;I&#39;m&nbsp;just\r\n&nbsp;&nbsp;&nbsp;*&nbsp;keeping&nbsp;it&nbsp;here.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$client_id\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;Client&nbsp;identifier&nbsp;related&nbsp;to&nbsp;the&nbsp;access&nbsp;token.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$redirect_uri\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;which&nbsp;the&nbsp;authorization&nbsp;server&nbsp;will&nbsp;redirect&nbsp;the\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;user-agent&nbsp;to&nbsp;when&nbsp;the&nbsp;end-user&nbsp;authorization&nbsp;step&nbsp;is&nbsp;completed.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$scope\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;Scopes&nbsp;to&nbsp;be&nbsp;stored&nbsp;in&nbsp;space-separated&nbsp;string.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;private&nbsp;function&nbsp;createAuthCode($client_id,&nbsp;$redirect_uri,&nbsp;$userId,&nbsp;$scope&nbsp;=&nbsp;NULL)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;$code&nbsp;=&nbsp;$this-&gt;genAuthCode();\r\n&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;setAuthCode($code,&nbsp;$client_id,&nbsp;$redirect_uri,&nbsp;time()&nbsp;+&nbsp;$this-&gt;getVariable(&#39;auth_code_lifetime&#39;,&nbsp;OAUTH2_DEFAULT_AUTH_CODE_LIFETIME),&nbsp;$userId,&nbsp;$scope);\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$code;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Generate&nbsp;unique&nbsp;access&nbsp;token.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Implementing&nbsp;classes&nbsp;may&nbsp;want&nbsp;to&nbsp;override&nbsp;these&nbsp;function&nbsp;to&nbsp;implement\r\n&nbsp;&nbsp;&nbsp;*&nbsp;other&nbsp;access&nbsp;token&nbsp;or&nbsp;auth&nbsp;code&nbsp;generation&nbsp;schemes.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;unique&nbsp;access&nbsp;token.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;genAccessToken()&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;md5(base64_encode(pack(&#39;N6&#39;,&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;uniqid())));\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Generate&nbsp;unique&nbsp;auth&nbsp;code.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Implementing&nbsp;classes&nbsp;may&nbsp;want&nbsp;to&nbsp;override&nbsp;these&nbsp;function&nbsp;to&nbsp;implement\r\n&nbsp;&nbsp;&nbsp;*&nbsp;other&nbsp;access&nbsp;token&nbsp;or&nbsp;auth&nbsp;code&nbsp;generation&nbsp;schemes.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;unique&nbsp;auth&nbsp;code.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_3\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;genAuthCode()&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;md5(base64_encode(pack(&#39;N6&#39;,&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;mt_rand(),&nbsp;uniqid())));\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Pull&nbsp;out&nbsp;the&nbsp;Authorization&nbsp;HTTP&nbsp;header&nbsp;and&nbsp;return&nbsp;it.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Implementing&nbsp;classes&nbsp;may&nbsp;need&nbsp;to&nbsp;override&nbsp;this&nbsp;function&nbsp;for&nbsp;use&nbsp;on\r\n&nbsp;&nbsp;&nbsp;*&nbsp;non-Apache&nbsp;web&nbsp;servers.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@return\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;Authorization&nbsp;HTTP&nbsp;header,&nbsp;and&nbsp;FALSE&nbsp;if&nbsp;does&nbsp;not&nbsp;exist.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@todo&nbsp;Handle&nbsp;Authorization&nbsp;HTTP&nbsp;header&nbsp;for&nbsp;non-Apache&nbsp;web&nbsp;servers.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_5\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;private&nbsp;function&nbsp;getAuthorizationHeader()&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(array_key_exists(&quot;HTTP_AUTHORIZATION&quot;,&nbsp;$_SERVER))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$_SERVER[&quot;HTTP_AUTHORIZATION&quot;];\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(function_exists(&quot;apache_request_headers&quot;))&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers&nbsp;=&nbsp;apache_request_headers();\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(array_key_exists(&quot;Authorization&quot;,&nbsp;$headers))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$headers[&quot;Authorization&quot;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Send&nbsp;out&nbsp;HTTP&nbsp;headers&nbsp;for&nbsp;JSON.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.2\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_section_4\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;private&nbsp;function&nbsp;sendJsonHeaders()&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;Content-Type:&nbsp;application/json&quot;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;Cache-Control:&nbsp;no-store&quot;);\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Redirect&nbsp;the&nbsp;end-user&#39;s&nbsp;user&nbsp;agent&nbsp;with&nbsp;error&nbsp;message.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$redirect_uri\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;An&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;which&nbsp;the&nbsp;authorization&nbsp;server&nbsp;will&nbsp;redirect&nbsp;the\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;user-agent&nbsp;to&nbsp;when&nbsp;the&nbsp;end-user&nbsp;authorization&nbsp;step&nbsp;is&nbsp;completed.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;single&nbsp;error&nbsp;code&nbsp;as&nbsp;described&nbsp;in&nbsp;Section&nbsp;3.2.1.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error_description\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;A&nbsp;human-readable&nbsp;text&nbsp;providing&nbsp;additional&nbsp;information,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;used&nbsp;to&nbsp;assist&nbsp;in&nbsp;the&nbsp;understanding&nbsp;and&nbsp;resolution&nbsp;of&nbsp;the&nbsp;error\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;occurred.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error_uri\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;A&nbsp;URI&nbsp;identifying&nbsp;a&nbsp;human-readable&nbsp;web&nbsp;page&nbsp;with\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;information&nbsp;about&nbsp;the&nbsp;error,&nbsp;used&nbsp;to&nbsp;provide&nbsp;the&nbsp;end-user&nbsp;with\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;additional&nbsp;information&nbsp;about&nbsp;the&nbsp;error.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$state\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;REQUIRED&nbsp;if&nbsp;the&nbsp;&quot;state&quot;&nbsp;parameter&nbsp;was&nbsp;present&nbsp;in&nbsp;the&nbsp;client\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;authorization&nbsp;request.&nbsp;Set&nbsp;to&nbsp;the&nbsp;exact&nbsp;value&nbsp;received&nbsp;from&nbsp;the&nbsp;client.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-3.2\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_error\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;private&nbsp;function&nbsp;errorDoRedirectUriCallback($redirect_uri,&nbsp;$error,&nbsp;$error_description&nbsp;=&nbsp;NULL,&nbsp;$error_uri&nbsp;=&nbsp;NULL,&nbsp;$state&nbsp;=&nbsp;NULL)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;query&quot;][&quot;error&quot;]&nbsp;=&nbsp;$error;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($state)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;query&quot;][&quot;state&quot;]&nbsp;=&nbsp;$state;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;getVariable(&#39;display_error&#39;)&nbsp;&amp;&amp;&nbsp;$error_description)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;query&quot;][&quot;error_description&quot;]&nbsp;=&nbsp;$error_description;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;getVariable(&#39;display_error&#39;)&nbsp;&amp;&amp;&nbsp;$error_uri)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;query&quot;][&quot;error_uri&quot;]&nbsp;=&nbsp;$error_uri;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;doRedirectUriCallback($redirect_uri,&nbsp;$result);\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Send&nbsp;out&nbsp;error&nbsp;message&nbsp;in&nbsp;JSON.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$http_status_code\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;HTTP&nbsp;status&nbsp;code&nbsp;message&nbsp;as&nbsp;predefined.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;single&nbsp;error&nbsp;code.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error_description\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;A&nbsp;human-readable&nbsp;text&nbsp;providing&nbsp;additional&nbsp;information,\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;used&nbsp;to&nbsp;assist&nbsp;in&nbsp;the&nbsp;understanding&nbsp;and&nbsp;resolution&nbsp;of&nbsp;the&nbsp;error\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;occurred.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error_uri\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;A&nbsp;URI&nbsp;identifying&nbsp;a&nbsp;human-readable&nbsp;web&nbsp;page&nbsp;with\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;information&nbsp;about&nbsp;the&nbsp;error,&nbsp;used&nbsp;to&nbsp;provide&nbsp;the&nbsp;end-user&nbsp;with\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;additional&nbsp;information&nbsp;about&nbsp;the&nbsp;error.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-4.3\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_error\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;private&nbsp;function&nbsp;errorJsonResponse($http_status_code,&nbsp;$error,&nbsp;$error_description&nbsp;=&nbsp;NULL,&nbsp;$error_uri&nbsp;=&nbsp;NULL)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;$result[&#39;error&#39;]&nbsp;=&nbsp;$error;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;getVariable(&#39;display_error&#39;)&nbsp;&amp;&amp;&nbsp;$error_description)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;error_description&quot;]&nbsp;=&nbsp;$error_description;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;getVariable(&#39;display_error&#39;)&nbsp;&amp;&amp;&nbsp;$error_uri)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[&quot;error_uri&quot;]&nbsp;=&nbsp;$error_uri;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;HTTP/1.1&nbsp;&quot;&nbsp;.&nbsp;$http_status_code);\r\n&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;sendJsonHeaders();\r\n&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;json_encode($result);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;exit;\r\n&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Send&nbsp;a&nbsp;401&nbsp;unauthorized&nbsp;header&nbsp;with&nbsp;the&nbsp;given&nbsp;realm&nbsp;and&nbsp;an&nbsp;error,&nbsp;if\r\n&nbsp;&nbsp;&nbsp;*&nbsp;provided.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$http_status_code\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;HTTP&nbsp;status&nbsp;code&nbsp;message&nbsp;as&nbsp;predefined.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$realm\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;&quot;realm&quot;&nbsp;attribute&nbsp;is&nbsp;used&nbsp;to&nbsp;provide&nbsp;the&nbsp;protected&nbsp;resources\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;partition&nbsp;as&nbsp;defined&nbsp;by&nbsp;[RFC2617].\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$scope\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;A&nbsp;space-delimited&nbsp;list&nbsp;of&nbsp;scope&nbsp;values&nbsp;indicating&nbsp;the&nbsp;required&nbsp;scope\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;of&nbsp;the&nbsp;access&nbsp;token&nbsp;for&nbsp;accessing&nbsp;the&nbsp;requested&nbsp;resource.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;The&nbsp;&quot;error&quot;&nbsp;attribute&nbsp;is&nbsp;used&nbsp;to&nbsp;provide&nbsp;the&nbsp;client&nbsp;with&nbsp;the&nbsp;reason\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;why&nbsp;the&nbsp;access&nbsp;request&nbsp;was&nbsp;declined.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error_description\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;The&nbsp;&quot;error_description&quot;&nbsp;attribute&nbsp;provides&nbsp;a&nbsp;human-readable&nbsp;text\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;containing&nbsp;additional&nbsp;information,&nbsp;used&nbsp;to&nbsp;assist&nbsp;in&nbsp;the&nbsp;understanding\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;and&nbsp;resolution&nbsp;of&nbsp;the&nbsp;error&nbsp;occurred.\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$error_uri\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;(optional)&nbsp;The&nbsp;&quot;error_uri&quot;&nbsp;attribute&nbsp;provides&nbsp;a&nbsp;URI&nbsp;identifying&nbsp;a&nbsp;human-readable\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;web&nbsp;page&nbsp;with&nbsp;information&nbsp;about&nbsp;the&nbsp;error,&nbsp;used&nbsp;to&nbsp;offer&nbsp;the&nbsp;end-user\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;with&nbsp;additional&nbsp;information&nbsp;about&nbsp;the&nbsp;error.&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;not&nbsp;an\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;absolute&nbsp;URI,&nbsp;it&nbsp;is&nbsp;relative&nbsp;to&nbsp;the&nbsp;URI&nbsp;of&nbsp;the&nbsp;requested&nbsp;protected\r\n&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;resource.\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;http://tools.ietf.org/html/draft-ietf-oauth-v2-10#section-5.2\r\n&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@ingroup&nbsp;oauth2_error\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;private&nbsp;function&nbsp;errorWWWAuthenticateResponseHeader($http_status_code,&nbsp;$realm,&nbsp;$error,&nbsp;$error_description&nbsp;=&nbsp;NULL,&nbsp;$error_uri&nbsp;=&nbsp;NULL,&nbsp;$scope&nbsp;=&nbsp;NULL)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;$realm&nbsp;=&nbsp;$realm&nbsp;===&nbsp;NULL&nbsp;?&nbsp;$this-&gt;getDefaultAuthenticationRealm()&nbsp;:&nbsp;$realm;\r\n&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;&quot;WWW-Authenticate:&nbsp;OAuth&nbsp;realm=&#39;&quot;&nbsp;.&nbsp;$realm&nbsp;.&nbsp;&quot;&#39;&quot;;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($error)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;,&nbsp;error=&#39;&quot;&nbsp;.&nbsp;$error&nbsp;.&nbsp;&quot;&#39;&quot;;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;getVariable(&#39;display_error&#39;)&nbsp;&amp;&amp;&nbsp;$error_description)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;,&nbsp;error_description=&#39;&quot;&nbsp;.&nbsp;$error_description&nbsp;.&nbsp;&quot;&#39;&quot;;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;getVariable(&#39;display_error&#39;)&nbsp;&amp;&amp;&nbsp;$error_uri)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;,&nbsp;error_uri=&#39;&quot;&nbsp;.&nbsp;$error_uri&nbsp;.&nbsp;&quot;&#39;&quot;;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($scope)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;,&nbsp;scope=&#39;&quot;&nbsp;.&nbsp;$scope&nbsp;.&nbsp;&quot;&#39;&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;HTTP/1.1&nbsp;&quot;.&nbsp;$http_status_code);\r\n&nbsp;&nbsp;&nbsp;&nbsp;header($result);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;exit;\r\n&nbsp;&nbsp;}\r\n}</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;代码比较多。有兴趣的可以细看。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于采用Vendor方法引入，所以这里的文件都没有采用命名空间。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-3、在同目录下，建ThinkOAuth2.php文件，这个文件里的类继承上面那个基类：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;?phprequire&nbsp;&quot;oauth2.class.php&quot;;class&nbsp;ThinkOAuth2&nbsp;extends&nbsp;OAuth2{&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;$db;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;$table;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;构造\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;__construct()&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent::__construct();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;=&nbsp;M();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;table&nbsp;=&nbsp;array(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;auth_codes&#39;=&gt;C(&#39;OAUTH2_CODES_TABLE&#39;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;clients&#39;=&gt;C(&#39;OAUTH2_CLIENTS_TABLE&#39;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;tokens&#39;=&gt;C(&#39;OAUTH2_TOKEN_TABLE&#39;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;析构\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;__destruct()&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;db&nbsp;=&nbsp;NULL;&nbsp;//&nbsp;Release&nbsp;db&nbsp;connection&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;function&nbsp;handleException($e)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&quot;Database&nbsp;error:&nbsp;&quot;&nbsp;.&nbsp;$e-&gt;getMessage();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;增加client\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$client_id\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$client_secret\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$redirect_uri\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;addClient($client_id,&nbsp;$client_secret,&nbsp;$redirect_uri)&nbsp;{&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$time&nbsp;=&nbsp;time();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;{$this&nbsp;-&gt;&nbsp;table[&#39;clients&#39;]}&nbsp;(client_id,&nbsp;client_secret,&nbsp;redirect_uri,create_time)&nbsp;VALUES&nbsp;(&#39;{$client_id}&#39;,&nbsp;&#39;{$client_secret}&#39;,&nbsp;&#39;{$redirect_uri}&#39;,&#39;{$time}&#39;)&quot;;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;-&gt;&nbsp;execute($sql);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;res;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Implements&nbsp;OAuth2::checkClientCredentials()\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::checkClientCredentials()\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;function&nbsp;checkClientCredentials($client_id,&nbsp;$client_secret&nbsp;=&nbsp;NULL)&nbsp;{&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;&quot;SELECT&nbsp;client_secret&nbsp;FROM&nbsp;{$this&nbsp;-&gt;&nbsp;table[&#39;clients&#39;]}&nbsp;WHERE&nbsp;client_id&nbsp;=&nbsp;{$client_id}&quot;;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;-&gt;&nbsp;query($sql);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($client_secret&nbsp;===&nbsp;NULL)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$result&nbsp;!==&nbsp;FALSE;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;checkClientCredentials&nbsp;:&nbsp;&quot;.$result);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;checkClientCredentials&nbsp;:&nbsp;&quot;.$result[0]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;checkClientCredentials&nbsp;:&nbsp;&quot;.$result[0][&quot;client_secret&quot;]);&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$result[0][&quot;client_secret&quot;]&nbsp;==&nbsp;$client_secret;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Implements&nbsp;OAuth2::getRedirectUri().\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::getRedirectUri()\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;function&nbsp;getRedirectUri($client_id)&nbsp;{\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;&quot;SELECT&nbsp;redirect_uri&nbsp;FROM&nbsp;{$this&nbsp;-&gt;&nbsp;table[&#39;clients&#39;]}&nbsp;WHERE&nbsp;client_id&nbsp;=&nbsp;{$client_id}&quot;;\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;-&gt;&nbsp;query($sql);\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($result&nbsp;===&nbsp;FALSE)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getRedirectUri&nbsp;:&nbsp;&quot;.$result);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getRedirectUri&nbsp;:&nbsp;&quot;.$result[0]);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getRedirectUri&nbsp;:&nbsp;&quot;.$result[0][&quot;redirect_uri&quot;]);\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;isset($result[0][&quot;redirect_uri&quot;])&nbsp;&amp;&amp;&nbsp;$result[0][&quot;redirect_uri&quot;]&nbsp;?&nbsp;$result[0][&quot;redirect_uri&quot;]&nbsp;:&nbsp;NULL;\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Implements&nbsp;OAuth2::getAccessToken().\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::getAccessToken()\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;function&nbsp;getAccessToken($access_token)&nbsp;{\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;&quot;SELECT&nbsp;client_id,&nbsp;expires_in,&nbsp;scope&nbsp;FROM&nbsp;{$this&nbsp;-&gt;&nbsp;table[&#39;tokens&#39;]}&nbsp;WHERE&nbsp;access_token&nbsp;=&nbsp;&#39;{$access_token}&#39;&quot;;\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;-&gt;&nbsp;query($sql);\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getAccessToken&nbsp;:&nbsp;&quot;.$result);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getAccessToken&nbsp;:&nbsp;&quot;.$result[0]);\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$result&nbsp;!==&nbsp;FALSE&nbsp;?&nbsp;$result&nbsp;:&nbsp;NULL;\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Implements&nbsp;OAuth2::setAccessToken().\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::setAccessToken()\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;function&nbsp;setAccessToken($access_token,&nbsp;$client_id,&nbsp;$expires,&nbsp;$user_id,&nbsp;$scope=NULL,&nbsp;$refresh_token=&#39;&#39;)&nbsp;{\r\n&nbsp;\r\n$sql&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;{$this&nbsp;-&gt;&nbsp;table[&#39;tokens&#39;]}&nbsp;(access_token,&nbsp;client_id,&nbsp;expires_in,&nbsp;scope,user_id,refresh_token)&nbsp;VALUES&nbsp;(&#39;{$access_token}&#39;,&nbsp;&#39;{$client_id}&#39;,&nbsp;&#39;{$expires}&#39;,&nbsp;&#39;{$scope}&#39;,{$user_id},&#39;{$refresh_token}&#39;)&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;-&gt;&nbsp;execute($sql);\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Overrides&nbsp;OAuth2::getSupportedGrantTypes().\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::getSupportedGrantTypes()\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;function&nbsp;getSupportedGrantTypes()&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OAUTH2_GRANT_TYPE_AUTH_CODE\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Overrides&nbsp;OAuth2::getAuthCode().\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::getAuthCode()\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;function&nbsp;getAuthCode($code)&nbsp;{\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;&quot;SELECT&nbsp;user_id,&nbsp;code,&nbsp;client_id,&nbsp;redirect_uri,&nbsp;expires,&nbsp;scope&nbsp;FROM&nbsp;{$this&nbsp;-&gt;&nbsp;table[&#39;auth_codes&#39;]}&nbsp;WHERE&nbsp;code&nbsp;=&nbsp;&#39;{$code}&#39;&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;-&gt;&nbsp;query($sql);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getAuthcode&nbsp;:&nbsp;&quot;.$result);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getAuthcode&nbsp;:&nbsp;&quot;.$result[0]);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Log::write(&quot;getAuthcode&nbsp;:&nbsp;&quot;.$result[0][&quot;code&quot;]);\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$result&nbsp;!==&nbsp;FALSE&nbsp;?&nbsp;$result[0]&nbsp;:&nbsp;NULL;\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Overrides&nbsp;OAuth2::setAuthCode().\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::setAuthCode()\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;function&nbsp;setAuthCode($code,&nbsp;$client_id,&nbsp;$redirect_uri,&nbsp;$expires,&nbsp;$scope&nbsp;=&nbsp;NULL)&nbsp;{\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$time&nbsp;=&nbsp;time();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;{$this&nbsp;-&gt;&nbsp;table[&#39;auth_codes&#39;]}&nbsp;(code,&nbsp;client_id,&nbsp;redirect_uri,&nbsp;expires,&nbsp;scope)&nbsp;VALUES&nbsp;(&#39;{$code}&#39;,&nbsp;&#39;{$client_id}&#39;,&nbsp;&#39;{$redirect_uri}&#39;,&nbsp;&#39;{$expires}&#39;,&nbsp;&#39;{$scope}&#39;)&quot;;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;db&nbsp;-&gt;&nbsp;execute($sql);\r\n&nbsp;&nbsp;}\r\n&nbsp;\r\n&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;*&nbsp;Overrides&nbsp;OAuth2::checkUserCredentials().\r\n&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;OAuth2::checkUserCredentials()\r\n&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;protected&nbsp;function&nbsp;checkUserCredentials($client_id,&nbsp;$username,&nbsp;$password){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;\r\n&nbsp;&nbsp;}\r\n&nbsp;&nbsp;\r\n\r\n}</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">这里涉及到一些数据库的操作。继承出来操作，还是比较一目了然的。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-4、准备好类了。我们就可以实现控制器里的功能代码。动手之前先搞清楚我们的意图。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;首先，我们需要分配一个oauth_client和一个oauth_secrete给第三方网站（也就是client.ruanwenwu.cn)来获取oauth服务。 &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其次，client.ruanwenwu.cn会把用户导入到server.ruanwenwu.cn来进行授权。所以我们我们还需要准备授权页面。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;因为涉及到服务端和客户端的数据交互，所以可能服务端和客户端的相关介绍我会交叉进行。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-4-1、创建oauth_client。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-4-2、获取oauth_cliest列表。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-4-3、准备获取用户授权的页面和逻辑。（授权服务器）</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-4-4、准备提供用户数据的逻辑。（资源服务器）</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这些逻辑我都写在一个控制器OauthController.class.php里。代码如下：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;?phpnamespace&nbsp;Home\\Controller;use&nbsp;Think\\Controller;class&nbsp;OauthController&nbsp;extends&nbsp;Controller{&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;$oauth&nbsp;=&nbsp;NULL;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;_initialize(){&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;Content-Type:&nbsp;application/json&quot;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Vendor(&quot;oauth.ThinkOAuth2&quot;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;=&nbsp;new&nbsp;\\ThinkOAuth2();&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;index(){&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;Content-Type:application/json;&nbsp;charset=utf-8&quot;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;ajaxReturn(null,&nbsp;&#39;oauth-server-start&#39;,&nbsp;1,&nbsp;&#39;json&#39;);&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;access_token()&nbsp;{&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;-&gt;&nbsp;grantAccessToken();&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//权限验证&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;authorize()&nbsp;{&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(IS_POST)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(true){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//这个地方验证成功后要把用户的uid加进来&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_POST[&#39;user_id&#39;]&nbsp;=&nbsp;1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;-&gt;&nbsp;finishClientAuthorization(true,&nbsp;$_POST);&nbsp;&nbsp;&nbsp;&nbsp;//第一个参数很重要，是用户是否授权&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;///表单准备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$auth_params&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;-&gt;&nbsp;getAuthorizeParams();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;assign(&quot;auth_params&quot;,$auth_params);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;display();&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;addclient()&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&#39;jack&#39;;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(IS_POST)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&#39;pd&#39;;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;-&gt;&nbsp;addClient($_POST[&quot;client_id&quot;],&nbsp;$_POST[&quot;client_secret&quot;],&nbsp;$_POST[&quot;redirect_uri&quot;]);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($res){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;redirect(&quot;/home/Oauth/clientlist&quot;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;display();\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;clientlist(){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res&nbsp;=&nbsp;M()-&gt;table(&quot;oauth_client&quot;)-&gt;select();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;assign(&quot;clients&quot;,$res);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var_dump($res);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;display();\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n}</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">顺便我将用到的模板文件（server.ruanwenwu.cn\\Application\\Home\\View\\oauth目录下）也贴出来给大家参考一下：</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">addclient.html</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;!doctype&nbsp;html&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;head&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;charset=&quot;utf-8&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;title&gt;这里是添加客户端界面&lt;/title&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/head&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;body&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;h1&gt;添加客户端&lt;/h1&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;form&nbsp;action=&quot;&quot;&nbsp;method=&quot;post&quot;&nbsp;&gt;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientId:&lt;input&nbsp;type=&quot;text&quot;&nbsp;name=&quot;client_id&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;/&gt;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client_secrete:&lt;input&nbsp;type=&quot;text&quot;&nbsp;name=&quot;client_secret&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;/&gt;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackUrl:&lt;input&nbsp;type=&quot;text&quot;&nbsp;name=&quot;redirect_uri&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input&nbsp;type=&quot;submit&quot;&nbsp;value=&quot;submit&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/form&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/body&gt;&lt;/html&gt;</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">authorize.html</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;!doctype&nbsp;html&gt;&lt;html&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;form&nbsp;action=&quot;&quot;&nbsp;method=&quot;post&quot;&gt;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;用户名：&lt;input&nbsp;type=&quot;text&quot;&nbsp;name=&quot;username&quot;&nbsp;/&gt;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;/&gt;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;密码：&lt;input&nbsp;type=&quot;text&quot;&nbsp;name=&quot;pwd&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input&nbsp;type=&quot;hidden&quot;&nbsp;name=&quot;response_type&quot;&nbsp;value=&quot;code&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input&nbsp;type=&quot;hidden&quot;&nbsp;name=&quot;client_id&quot;&nbsp;value=&quot;{$auth_params[&#39;client_id&#39;]}&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input&nbsp;type=&quot;hidden&quot;&nbsp;name=&quot;redirect_uri&quot;&nbsp;value=&quot;{$auth_params[&#39;redirect_uri&#39;]}&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input&nbsp;type=&quot;submit&quot;&nbsp;value=&quot;submit&quot;&nbsp;/&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/form&gt;&lt;/html&gt;</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">注意：我这里用到了几个隐藏域。这个是必须的，在post提交验证时会用到。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5-4-5、创建oauth2.0用户。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;打 开server.ruanwenwu.cn/index.php/home/oauth/addcient,输入client_id和 client_secrete还有redirect_uri创建一个oauth2.0用户。其中redirect_uri是用户授权后需要跳转的地方。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">到这里服务端的部署就差不多结束了。现在开始部署客户端。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\"><strong>三、oauth2.0客户端搭建。</strong></p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;1、同服务端一样搭建client.ruanwenwu.cn。（也是用thinkphp)。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;2、能正常访问后。在类库中加入oauth2.0客户端类。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在\\client.ruanwenwu.cn\\ThinkPHP\\Library\\Org\\Util目录下建立Oauth2.class.php，代码如下：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;?phpnamespace&nbsp;Org\\Util;/**\r\n&nbsp;*&nbsp;与&nbsp;OAuth2&nbsp;服务器&nbsp;通讯验证&nbsp;核心类&nbsp;(PHP版)\r\n&nbsp;*&nbsp;\r\n&nbsp;*&nbsp;@description&nbsp;OAuth2&nbsp;说明请大家参考&nbsp;木蚂蚁接口文档\r\n&nbsp;*\r\n&nbsp;*\r\n&nbsp;*&nbsp;@author&nbsp;&nbsp;&nbsp;Mumayi-Team&nbsp;(zhaopan赵攀)\r\n&nbsp;*&nbsp;@version&nbsp;&nbsp;1.0\r\n&nbsp;*&nbsp;@datetime&nbsp;2013-12-31\r\n&nbsp;*/class&nbsp;Oauth2{&nbsp;&nbsp;&nbsp;&nbsp;/*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;以下几个参数&nbsp;具体作用和用法&nbsp;详见&nbsp;木蚂蚁接口文档\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//分配的客户端&nbsp;ID&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$client_id;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//分配的客户端&nbsp;密匙&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$client_secret;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//获得的&nbsp;用户授权&nbsp;访问令牌&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$access_token;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//刷新&nbsp;访问令牌&nbsp;(过期时使用)&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$refresh_token;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;最后一个收到的HTTP代码&nbsp;(用于调试，忽略)&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$http_code;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//预留字段&nbsp;(忽略)&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$url;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//设置&nbsp;基础链接&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$host&nbsp;=&nbsp;&quot;http://server.ruanwenwu.cn/index.php/home/oauth/&quot;;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//请求超时时间&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$timeout&nbsp;=&nbsp;30;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//链接超时时间&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$connecttimeout&nbsp;=&nbsp;30;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//是否验证&nbsp;SSL&nbsp;证书&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$ssl_verifypeer&nbsp;=&nbsp;FALSE;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//请求结果处理格式&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$format&nbsp;=&nbsp;&#39;json&#39;;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//以&nbsp;JSON_DECODE&nbsp;方式解析&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$decode_json&nbsp;=&nbsp;TRUE;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//预留字段&nbsp;(忽略)&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$http_info;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//CURL&nbsp;函数使用&nbsp;(验证使用，&nbsp;忽略)&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$useragent&nbsp;=&nbsp;&#39;Mumayi&nbsp;Team&nbsp;OAuth2&nbsp;v1.0&#39;;&nbsp;&nbsp;&nbsp;&nbsp;//是否&nbsp;开启&nbsp;请求调试&nbsp;(开启时&nbsp;将输出&nbsp;详细的请求结果)&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$debug&nbsp;=&nbsp;FALSE;&nbsp;&nbsp;&nbsp;&nbsp;//边界&nbsp;(CURL使用&nbsp;写入在Header的分界线,&nbsp;忽略)&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;$boundary&nbsp;=&nbsp;&#39;&#39;;&nbsp;&nbsp;&nbsp;&nbsp;//返回&nbsp;OAuth&nbsp;令牌&nbsp;请求地址&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;accessTokenURL()&nbsp;&nbsp;{&nbsp;return&nbsp;$this-&gt;host.&#39;access_token&#39;;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;//返回&nbsp;OAuth&nbsp;自动授权&nbsp;请求地址&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;authorizeURL()&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;return&nbsp;$this-&gt;host.&#39;authorize&#39;;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;//构造函数&nbsp;赋值&nbsp;一些必要参数&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;__construct($client_id,&nbsp;$client_secret,&nbsp;$access_token&nbsp;=&nbsp;NULL,&nbsp;$refresh_token&nbsp;=&nbsp;NULL)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;client_id&nbsp;=&nbsp;$client_id;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;client_secret&nbsp;=&nbsp;$client_secret;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;access_token&nbsp;=&nbsp;$access_token;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;refresh_token&nbsp;=&nbsp;$refresh_token;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;$this-&gt;debug&nbsp;=&nbsp;true;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;authorize接口\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;对应API：{@link&nbsp;http://u.mumayi.com/oauth/authorize&nbsp;Oauth2/authorize}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$url&nbsp;授权后的回调地址,站外应用需与回调地址一致,站内应用需要填写canvas&nbsp;page的地址\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$response_type&nbsp;支持的值包括&nbsp;code&nbsp;和token&nbsp;默认值为code\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$state&nbsp;用于保持请求和回调的状态。在回调时,会在Query&nbsp;Parameter中回传该参数\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$display&nbsp;授权页面类型&nbsp;可选范围:&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;default&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;默认授权页面\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;mobile&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;支持html5的手机\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;popup&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;弹窗授权页\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;wap1.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wap1.2页面\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;wap2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wap2.0页面\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;js&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;js-sdk&nbsp;专用&nbsp;授权页面是弹窗，返回结果为js-sdk回掉函数\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;apponweibo&nbsp;&nbsp;&nbsp;&nbsp;站内应用专用,站内应用不传display参数,并且response_type为token时,默认使用改display.授权后不会返回access_token，只是输出js刷新站内应用父框架\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;getAuthorizeURL(&nbsp;$url,&nbsp;$response_type&nbsp;=&nbsp;&#39;code&#39;,&nbsp;$state&nbsp;=&nbsp;NULL,&nbsp;$display&nbsp;=&nbsp;NULL&nbsp;)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params&nbsp;=&nbsp;array();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;client_id&#39;]&nbsp;=&nbsp;$this-&gt;client_id;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;redirect_uri&#39;]&nbsp;=&nbsp;$url;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;response_type&#39;]&nbsp;=&nbsp;$response_type;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;state&#39;]&nbsp;=&nbsp;$state;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;display&#39;]&nbsp;=&nbsp;$display;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;authorizeURL()&nbsp;.&nbsp;&quot;&amp;&quot;&nbsp;.&nbsp;http_build_query($params);\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;access_token接口\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;对应API：{@link&nbsp;http://open.weibo.com/wiki/OAuth2/access_token&nbsp;OAuth2/access_token}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$type&nbsp;请求的类型,可以为:code,&nbsp;password,&nbsp;token\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;array&nbsp;$keys&nbsp;其他参数：\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;当$type为code时：&nbsp;array(&#39;code&#39;=&gt;...,&nbsp;&#39;redirect_uri&#39;=&gt;...)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;当$type为password时：&nbsp;array(&#39;username&#39;=&gt;...,&nbsp;&#39;password&#39;=&gt;...)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;-&nbsp;当$type为token时：&nbsp;array(&#39;refresh_token&#39;=&gt;...)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;getAccessToken(&nbsp;$type&nbsp;=&nbsp;&#39;code&#39;,&nbsp;$keys&nbsp;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params&nbsp;=&nbsp;array();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;client_id&#39;]&nbsp;=&nbsp;$this-&gt;client_id;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;client_secret&#39;]&nbsp;=&nbsp;$this-&gt;client_secret;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;$type&nbsp;===&nbsp;&#39;token&#39;&nbsp;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;grant_type&#39;]&nbsp;=&nbsp;&#39;refresh_token&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;refresh_token&#39;]&nbsp;=&nbsp;$keys[&#39;refresh_token&#39;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(&nbsp;$type&nbsp;===&nbsp;&#39;code&#39;&nbsp;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;grant_type&#39;]&nbsp;=&nbsp;&#39;authorization_code&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;code&#39;]&nbsp;=&nbsp;$keys[&#39;code&#39;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;redirect_uri&#39;]&nbsp;=&nbsp;$keys[&#39;redirect_uri&#39;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(&nbsp;$type&nbsp;===&nbsp;&#39;password&#39;&nbsp;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;grant_type&#39;]&nbsp;=&nbsp;&#39;password&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;username&#39;]&nbsp;=&nbsp;$keys[&#39;username&#39;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[&#39;password&#39;]&nbsp;=&nbsp;$keys[&#39;password&#39;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;json_encode(array(&#39;error&#39;&nbsp;=&gt;&nbsp;&#39;错误的授权类型[&#39;.$type.&#39;(token,&nbsp;code)]&#39;));\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$this-&gt;oAuthRequest($this-&gt;accessTokenURL(),&nbsp;&#39;POST&#39;,&nbsp;$params);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//var_dump($response);die;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;json_decode($response,&nbsp;true);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;is_array($token)&nbsp;&amp;&amp;&nbsp;!isset($token[&#39;error&#39;])&nbsp;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;access_token&nbsp;=&nbsp;$token[&#39;access_token&#39;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$this-&gt;refresh_token&nbsp;=&nbsp;$token[&#39;refresh_token&#39;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;json_encode(array(&#39;error&#39;&nbsp;=&gt;&nbsp;&#39;获取访问令牌失败。[&#39;.$token[&#39;error&#39;].&#39;]&#39;));\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$token;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;解析&nbsp;signed_request\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$signed_request&nbsp;应用框架在加载iframe时会通过向Canvas&nbsp;URL&nbsp;post的参数signed_request\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;parseSignedRequest($signed_request)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list($encoded_sig,&nbsp;$payload)&nbsp;=&nbsp;explode(&#39;.&#39;,&nbsp;$signed_request,&nbsp;2);&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sig&nbsp;=&nbsp;self::base64decode($encoded_sig)&nbsp;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data&nbsp;=&nbsp;json_decode(self::base64decode($payload),&nbsp;true);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strtoupper($data[&#39;algorithm&#39;])&nbsp;!==&nbsp;&#39;HMAC-SHA256&#39;)&nbsp;return&nbsp;&#39;-1&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$expected_sig&nbsp;=&nbsp;hash_hmac(&#39;sha256&#39;,&nbsp;$payload,&nbsp;$this-&gt;client_secret,&nbsp;true);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;($sig&nbsp;!==&nbsp;$expected_sig)?&nbsp;&#39;-2&#39;:$data;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@ignore\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;base64decode($str)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;base64_decode(strtr($str.str_repeat(&#39;=&#39;,&nbsp;(4&nbsp;-&nbsp;strlen($str)&nbsp;%&nbsp;4)),&nbsp;&#39;-_&#39;,&nbsp;&#39;+/&#39;));\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;读取jssdk授权信息，用于和jssdk的同步登录\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array&nbsp;成功返回array(&#39;access_token&#39;=&gt;&#39;value&#39;,&nbsp;&#39;refresh_token&#39;=&gt;&#39;value&#39;);&nbsp;失败返回false\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;getTokenFromJSSDK()&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key&nbsp;=&nbsp;&quot;mumayijs_&quot;&nbsp;.&nbsp;$this-&gt;client_id;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;isset($_COOKIE[$key])&nbsp;&amp;&amp;&nbsp;$cookie&nbsp;=&nbsp;$_COOKIE[$key]&nbsp;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parse_str($cookie,&nbsp;$token);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;isset($token[&#39;access_token&#39;])&nbsp;&amp;&amp;&nbsp;isset($token[&#39;refresh_token&#39;])&nbsp;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;access_token&nbsp;=&nbsp;$token[&#39;access_token&#39;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;refresh_token&nbsp;=&nbsp;$token[&#39;refresh_token&#39;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$token;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;从数组中读取access_token和refresh_token\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;常用于从Session或Cookie中读取token，或通过Session/Cookie中是否存有token判断登录状态。\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;array&nbsp;$arr&nbsp;存有access_token和secret_token的数组\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array&nbsp;成功返回array(&#39;access_token&#39;=&gt;&#39;value&#39;,&nbsp;&#39;refresh_token&#39;=&gt;&#39;value&#39;);&nbsp;失败返回false\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;getTokenFromArray(&nbsp;$arr&nbsp;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($arr[&#39;access_token&#39;])&nbsp;&amp;&amp;&nbsp;$arr[&#39;access_token&#39;])&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;array();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;access_token&nbsp;=&nbsp;$token[&#39;access_token&#39;]&nbsp;=&nbsp;$arr[&#39;access_token&#39;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($arr[&#39;refresh_token&#39;])&nbsp;&amp;&amp;&nbsp;$arr[&#39;refresh_token&#39;])&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;refresh_token&nbsp;=&nbsp;$token[&#39;refresh_token&#39;]&nbsp;=&nbsp;$arr[&#39;refresh_token&#39;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$token;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;以&nbsp;GET&nbsp;请求方式&nbsp;请求&nbsp;OAuth&nbsp;验证服务器\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;mixed\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;get($url,&nbsp;$parameters&nbsp;=&nbsp;array())&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$this-&gt;oAuthRequest($url,&nbsp;&#39;GET&#39;,&nbsp;$parameters);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;format&nbsp;===&nbsp;&#39;json&#39;&nbsp;&amp;&amp;&nbsp;$this-&gt;decode_json)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;json_decode($response,&nbsp;true);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;以&nbsp;POST&nbsp;请求方式&nbsp;请求&nbsp;OAuth&nbsp;验证服务器\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;mixed\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;post($url,&nbsp;$parameters&nbsp;=&nbsp;array(),&nbsp;$multi&nbsp;=&nbsp;false)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$this-&gt;oAuthRequest($url,&nbsp;&#39;POST&#39;,&nbsp;$parameters,&nbsp;$multi&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;format&nbsp;===&nbsp;&#39;json&#39;&nbsp;&amp;&amp;&nbsp;$this-&gt;decode_json)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;json_decode($response,&nbsp;true);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;请求&nbsp;OAuth&nbsp;验证服务器&nbsp;进行验证\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;string\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;oAuthRequest($url,&nbsp;$method,&nbsp;$parameters,&nbsp;$multi&nbsp;=&nbsp;false)&nbsp;{\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strrpos($url,&nbsp;&#39;http://&#39;)&nbsp;!==&nbsp;0&nbsp;&amp;&amp;&nbsp;strrpos($url,&nbsp;&#39;https://&#39;)&nbsp;!==&nbsp;0)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url&nbsp;=&nbsp;&quot;{$this-&gt;host}{$url}.{$this-&gt;format}&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;($method)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;&#39;GET&#39;:\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!empty($parameters))\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url&nbsp;=&nbsp;$url&nbsp;.&nbsp;&#39;&amp;&#39;&nbsp;.&nbsp;http_build_query($parameters);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;http($url,&nbsp;&#39;GET&#39;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers&nbsp;=&nbsp;array();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$multi&nbsp;&amp;&amp;&nbsp;(is_array($parameters)&nbsp;||&nbsp;is_object($parameters))&nbsp;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body&nbsp;=&nbsp;http_build_query($parameters);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body&nbsp;=&nbsp;self::build_http_query_multi($parameters);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers[]&nbsp;=&nbsp;&quot;Content-Type:&nbsp;multipart/form-data;&nbsp;boundary=&quot;&nbsp;.&nbsp;self::$boundary;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//return&nbsp;$this-&gt;http($url,&nbsp;$method,&nbsp;$body,&nbsp;$headers);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;http($url,&nbsp;$method,&nbsp;$body,&nbsp;$headers);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;使用&nbsp;CURL&nbsp;模拟一个&nbsp;HTTP&nbsp;请求&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@description&nbsp;(需要开启&nbsp;CURL&nbsp;扩展)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;string&nbsp;API&nbsp;results\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;http($url,&nbsp;$method,&nbsp;$postfields&nbsp;=&nbsp;NULL,&nbsp;$headers&nbsp;=&nbsp;array())&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;http_info&nbsp;=&nbsp;array();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ci&nbsp;=&nbsp;curl_init();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;Curl&nbsp;settings&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_HTTP_VERSION,&nbsp;CURL_HTTP_VERSION_1_0);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_USERAGENT,&nbsp;$this-&gt;useragent);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_CONNECTTIMEOUT,&nbsp;$this-&gt;connecttimeout);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_TIMEOUT,&nbsp;$this-&gt;timeout);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_RETURNTRANSFER,&nbsp;TRUE);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_ENCODING,&nbsp;&quot;&quot;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_SSL_VERIFYPEER,&nbsp;$this-&gt;ssl_verifypeer);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_SSL_VERIFYHOST,&nbsp;1);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_HEADERFUNCTION,&nbsp;array($this,&nbsp;&#39;getHeader&#39;));\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_HEADER,&nbsp;FALSE);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;($method)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;&#39;POST&#39;:\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_POST,&nbsp;TRUE);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!empty($postfields))&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_POSTFIELDS,&nbsp;$postfields);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;postdata&nbsp;=&nbsp;$postfields;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;&#39;DELETE&#39;:\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_CUSTOMREQUEST,&nbsp;&#39;DELETE&#39;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!empty($postfields))&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url&nbsp;=&nbsp;&quot;{$url}?{$postfields}&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;isset($this-&gt;access_token)&nbsp;&amp;&amp;&nbsp;$this-&gt;access_token&nbsp;)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers[]&nbsp;=&nbsp;&quot;Authorization:&nbsp;OAuth2&nbsp;&quot;.$this-&gt;access_token;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!empty($this-&gt;remote_ip)&nbsp;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;defined(&#39;SAE_ACCESSKEY&#39;)&nbsp;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers[]&nbsp;=&nbsp;&quot;SaeRemoteIP:&nbsp;&quot;&nbsp;.&nbsp;$this-&gt;remote_ip;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers[]&nbsp;=&nbsp;&quot;API-RemoteIP:&nbsp;&quot;&nbsp;.&nbsp;$this-&gt;remote_ip;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!defined(&#39;SAE_ACCESSKEY&#39;)&nbsp;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers[]&nbsp;=&nbsp;&quot;API-RemoteIP:&nbsp;&quot;&nbsp;.&nbsp;$_SERVER[&#39;REMOTE_ADDR&#39;];\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_URL,&nbsp;$url&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLOPT_HTTPHEADER,&nbsp;$headers&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ci,&nbsp;CURLINFO_HEADER_OUT,&nbsp;TRUE&nbsp;);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;curl_exec($ci);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;http_code&nbsp;=&nbsp;curl_getinfo($ci,&nbsp;CURLINFO_HTTP_CODE);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;http_info&nbsp;=&nbsp;array_merge($this-&gt;http_info,&nbsp;curl_getinfo($ci));\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;url&nbsp;=&nbsp;$url;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;debug)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&quot;=====post&nbsp;data======\\r\\n&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var_dump($postfields);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&quot;=====headers======\\r\\n&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_r($headers);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&#39;=====request&nbsp;info=====&#39;.&quot;\\r\\n&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_r(&nbsp;curl_getinfo($ci)&nbsp;);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&#39;=====response=====&#39;.&quot;\\r\\n&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_r(&nbsp;$response&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_close&nbsp;($ci);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;从结果中&nbsp;获取&nbsp;header&nbsp;参数&nbsp;(CURL&nbsp;使用)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;int\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@ignore&nbsp;(忽略)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;getHeader($ch,&nbsp;$header)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i&nbsp;=&nbsp;strpos($header,&nbsp;&#39;:&#39;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!empty($i))&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key&nbsp;=&nbsp;str_replace(&#39;-&#39;,&nbsp;&#39;_&#39;,&nbsp;strtolower(substr($header,&nbsp;0,&nbsp;$i)));\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value&nbsp;=&nbsp;trim(substr($header,&nbsp;$i&nbsp;+&nbsp;2));\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;http_header[$key]&nbsp;=&nbsp;$value;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;strlen($header);\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;/**\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;把要传递的参数&nbsp;重新构造一下&nbsp;(多维数组)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@ignore&nbsp;(忽略)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;function&nbsp;build_http_query_multi($params)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$params)&nbsp;return&nbsp;&#39;&#39;;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uksort($params,&nbsp;&#39;strcmp&#39;);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pairs&nbsp;=&nbsp;array();\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$boundary&nbsp;=&nbsp;$boundary&nbsp;=&nbsp;uniqid(&#39;------------------&#39;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$MPboundary&nbsp;=&nbsp;&#39;--&#39;.$boundary;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$endMPboundary&nbsp;=&nbsp;$MPboundary.&nbsp;&#39;--&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;=&nbsp;&#39;&#39;;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($params&nbsp;as&nbsp;$parameter&nbsp;=&gt;&nbsp;$value)&nbsp;{\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;in_array($parameter,&nbsp;array(&#39;pic&#39;,&nbsp;&#39;image&#39;))&nbsp;&amp;&amp;&nbsp;$value{0}&nbsp;==&nbsp;&#39;@&#39;&nbsp;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url&nbsp;=&nbsp;ltrim(&nbsp;$value,&nbsp;&#39;@&#39;&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content&nbsp;=&nbsp;file_get_contents(&nbsp;$url&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$array&nbsp;=&nbsp;explode(&nbsp;&#39;?&#39;,&nbsp;basename(&nbsp;$url&nbsp;)&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$filename&nbsp;=&nbsp;$array[0];\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;$MPboundary&nbsp;.&nbsp;&quot;\\r\\n&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;&#39;Content-Disposition:&nbsp;form-data;&nbsp;name=&quot;&#39;&nbsp;.&nbsp;$parameter&nbsp;.&nbsp;&#39;&quot;;&nbsp;filename=&quot;&#39;&nbsp;.&nbsp;$filename&nbsp;.&nbsp;&#39;&quot;&#39;.&nbsp;&quot;\\r\\n&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;&quot;Content-Type:&nbsp;image/unknown\\r\\n\\r\\n&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;$content.&nbsp;&quot;\\r\\n&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;$MPboundary&nbsp;.&nbsp;&quot;\\r\\n&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;&#39;content-disposition:&nbsp;form-data;&nbsp;name=&quot;&#39;&nbsp;.&nbsp;$parameter&nbsp;.&nbsp;&quot;\\&quot;\\r\\n\\r\\n&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;$value.&quot;\\r\\n&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multipartbody&nbsp;.=&nbsp;$endMPboundary;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$multipartbody;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;get_uid()&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hostUrl&nbsp;=&nbsp;&#39;http://server.ruanwenwu.cn/index.php/home/resource/userinfo?type=mumayi&#39;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params&nbsp;=&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;access_token&#39;&nbsp;=&gt;&nbsp;$this-&gt;access_token,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;get(&nbsp;$hostUrl,&nbsp;$params&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n}</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">注意：这个类的加载跟服务端采用的不同的方式。这里用了命名空间。服务端用的vendor。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3、准备访问链接。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们通过这个url将用户导向server.ruanwenwu.cn进行授权，发送accesss_code操作。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我在client.ruanwenwu.cn的index控制器中实现的这个url。控制器里没有逻辑，我只贴index.html了：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;!doctype&nbsp;html&gt;&lt;html&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;head&gt;&lt;/head&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;body&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://server.ruanwenwu.cn/index.php/home/oauth/authorize?redirect_uri=http://client.ruanwenwu.cn/index.php/home/login&amp;response_type=code&amp;client_id=10009174&amp;type=123456&quot;&gt;登陆&lt;/a&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/body&gt;&lt;/html&gt;</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注 意：这个url中redirect_uri,response_type为必选参数。而且这个redirect_uri必须包含我们在服务端添加 oauth服务时写的那个redirect_uri。否则不能通过验证。（也就是说：在我们这个例子里，这个redirect_uri必须包含：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">http://client.ruanwenwu.cn/index.php/home/login</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4、点击链接，跳转到服务端对应的url。实际上就是server.ruanwenwu.cn的authorize操作。在这里会对用户进行验证，并判断是否授权。</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&nbsp;&nbsp;&nbsp;&nbsp;//权限验证&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;authorize()&nbsp;{&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(IS_POST)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(true){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//这个地方验证成功后要把用户的uid加进来&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_POST[&#39;user_id&#39;]&nbsp;=&nbsp;1;&nbsp;&nbsp;&nbsp;&nbsp;//这里是写死的，实际上是从数据库读出来&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;-&gt;&nbsp;finishClientAuthorization(true,&nbsp;$_POST);&nbsp;&nbsp;&nbsp;&nbsp;//第一个参数很重要，是用户是否授权&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;///表单准备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$auth_params&nbsp;=&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;-&gt;&nbsp;getAuthorizeParams();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;assign(&quot;auth_params&quot;,$auth_params);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;display();&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注意看我在这个操作里写的注释。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;验证成功后，页面又跳回到我们之前写的redirect_uri，并带上了code参数，这就是验证服务器向客户端发送的access_code。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5、客户端拿到access_code，向验证服务器请求access_token。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在我的client.ruanwenwu.cn的loginController.class.php中进行：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;?phpnamespace&nbsp;Home\\Controller;use&nbsp;Think\\Controller;use&nbsp;Org\\Util\\Oauth2;class&nbsp;LoginController&nbsp;extends&nbsp;Controller{&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;_initialize(){&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;index(){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;oauth&nbsp;=&nbsp;new&nbsp;Oauth2(&#39;10009174&#39;,&#39;123456&#39;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$keys&nbsp;=&nbsp;array();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//keys&nbsp;数组&nbsp;赋值&nbsp;code&nbsp;值&nbsp;(换取token,&nbsp;必须参数)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$keys[&#39;code&#39;]&nbsp;=&nbsp;$_GET[&#39;code&#39;];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//keys&nbsp;数组&nbsp;赋值&nbsp;回调地址信息&nbsp;(换取token,&nbsp;必须参数)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$keys[&#39;redirect_uri&#39;]&nbsp;=&nbsp;&#39;http://client.ruanwenwu.cn/index.php/home/login?type=mumayidev&#39;;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//根据&nbsp;code&nbsp;获取&nbsp;token&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//var_dump(&nbsp;$token&nbsp;=&nbsp;$this-&gt;oauth-&gt;getAccessToken(&nbsp;&#39;code&#39;,&nbsp;$keys&nbsp;))&nbsp;;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;$this-&gt;oauth-&gt;getAccessToken(&nbsp;&#39;code&#39;,&nbsp;$keys&nbsp;)&nbsp;;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//现在已经得到token，并且将access_token写到对象里了。就可以请求资源了&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var_dump(&nbsp;$this-&gt;oauth-&gt;get_uid());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die;&nbsp;&nbsp;&nbsp;&nbsp;}}</pre><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;$this-&gt;oauth-&gt;getAccessToken(&nbsp;&#39;code&#39;,&nbsp;$keys&nbsp;)&nbsp;;&nbsp;&nbsp;&nbsp;&nbsp;//这就是请求代码。code是验证方式。$keys数组里要code和redirect_uri。在服务器端需要验证</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">服务端的响应是这样的：</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">验证client.ruanwenwu.cn的client_id和secrete是否合法，还要判读access_code是否过期</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;access_token()&nbsp;{&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&nbsp;-&gt;&nbsp;oauth&nbsp;-&gt;&nbsp;grantAccessToken();&nbsp;&nbsp;&nbsp;&nbsp;//这个方法里有所有的验证及生成access_token的操作。（会有数据库的写入）&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">服务端生成access_token之后，会返回给客户端。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">客户端拿到access_token之后，向资源服务器请求用户资源：</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">在这里我的验证服务器和资源服务器都是server.ruanwenwu.cn。我用resourceController.class.php来做资源控制：</p><pre class=\"brush:php;toolbar:false language-php\" style=\"font-family: &quot;Courier New&quot;; font-size: 12px; margin: 5px 8px; padding: 5px;\">&lt;?phpnamespace&nbsp;Home\\Controller;use&nbsp;Think\\Controller;class&nbsp;ResourceController&nbsp;extends&nbsp;Controller{&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;$db;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;_initialize(){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;db&nbsp;=&nbsp;M();&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;userinfo(){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;$arr&nbsp;=&nbsp;array(&quot;username&quot;=&gt;&quot;阮文武&quot;,&quot;sex&quot;=&gt;1,&quot;img&quot;=&gt;&quot;http://weewrerfdf&quot;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;echo&nbsp;json_encode($arr);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;die;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($_GET[&#39;access_token&#39;])&nbsp;&amp;&amp;&nbsp;$_GET[&#39;access_token&#39;]){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res&nbsp;=&nbsp;$this-&gt;db-&gt;table(&quot;oauth_token&quot;)-&gt;where(&quot;access_token&nbsp;=&nbsp;&#39;&quot;.$_GET[&#39;access_token&#39;].&quot;&#39;&quot;)-&gt;find();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($res&nbsp;&amp;&amp;&nbsp;count($res)&nbsp;&gt;&nbsp;0){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($res[&#39;expires_in&#39;]&nbsp;&gt;&nbsp;time()){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$arr&nbsp;=&nbsp;array(&quot;username&quot;=&gt;&quot;阮文武d&quot;,&quot;sex&quot;=&gt;1,&quot;img&quot;=&gt;&quot;http://weewrerfdf&quot;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;json_encode($arr);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};&nbsp;&nbsp;&nbsp;&nbsp;}}</pre><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">如果access_token有效，就查到用户id，取出用户的信息。我这里只是做测试，所以就直接自己返回了数据。<br/>原本写的很详细，后来因为内容字段是text，没保存完整，这会时间比较赶，就写的简单一点。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">再抽时间补充吧。</p><p style=\"margin: 10px auto; font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; white-space: normal;\">欢迎大家与我讨论哦。</p><p><br/></p>','框架','php搭建oatuth2.0服务端和客户端','oauth2.0搭建服务端和客户端的一个记录','php',0,68),(67,1487671848,1487671848,1487671848,'<p style=\"margin-top: 0px; margin-bottom: 1.5rem; color: rgb(51, 51, 51); font-family: &quot;Fira Sans&quot;, &quot;Source Sans Pro&quot;, Helvetica, Arial, sans-serif; white-space: normal; background-color: rgb(242, 242, 242);\"><span style=\"text-rendering: optimizeLegibility;\">对数据库结果（当然可以对自定义结果集）进行排序，其实usort也可以实现。除此之外usort还可以对对象进行排序。</span></p><p style=\"margin-top: 0px; margin-bottom: 1.5rem;\">本例中&nbsp;data&nbsp;数组中的每个单元表示一个表中的一行。这是典型的数据库记录的数据集合。</p><p style=\"margin-top: 0px; margin-bottom: 1.5rem;\">例子中的数据如下：</p><pre style=\"white-space: pre-wrap; margin-top: 0px; margin-bottom: 0px;\">volume&nbsp;|&nbsp;edition\r\n-------+--------\r\n&nbsp;&nbsp;&nbsp;&nbsp;67&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2\r\n&nbsp;&nbsp;&nbsp;&nbsp;86&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\r\n&nbsp;&nbsp;&nbsp;&nbsp;85&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6\r\n&nbsp;&nbsp;&nbsp;&nbsp;98&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2\r\n&nbsp;&nbsp;&nbsp;&nbsp;86&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6\r\n&nbsp;&nbsp;&nbsp;&nbsp;67&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7</pre><p style=\"margin-top: 0px; margin-bottom: 1.5rem;\">数据全都存放在名为&nbsp;data&nbsp;的数组中。这通常是通过循环从数据库取得的结果，例如&nbsp;<span class=\"function\"><a href=\"http://php.net/manual/zh/function.mysql-fetch-assoc.php\" class=\"function\" style=\"border-bottom: 1px solid; text-decoration: none; color: rgb(51, 102, 153);\">mysql_fetch_assoc()</a></span>。</p><p><code style=\"font-stretch: normal; font-size: 0.875rem; line-height: 1.5rem; font-family: &quot;Fira Mono&quot;, &quot;Source Code Pro&quot;, monospace; word-wrap: break-word; display: block;\"><span style=\"color: rgb(0, 0, 0);\"><span style=\"color: rgb(0, 0, 187);\">&lt;?php<br/>$data</span><span style=\"color: rgb(0, 119, 0);\">[]&nbsp;=&nbsp;array(</span><span style=\"color: rgb(221, 0, 0);\">&#39;volume&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">67</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(221, 0, 0);\">&#39;edition&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">2</span><span style=\"color: rgb(0, 119, 0);\">);<br/></span><span style=\"color: rgb(0, 0, 187);\">$data</span><span style=\"color: rgb(0, 119, 0);\">[]&nbsp;=&nbsp;array(</span><span style=\"color: rgb(221, 0, 0);\">&#39;volume&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">86</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(221, 0, 0);\">&#39;edition&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">1</span><span style=\"color: rgb(0, 119, 0);\">);<br/></span><span style=\"color: rgb(0, 0, 187);\">$data</span><span style=\"color: rgb(0, 119, 0);\">[]&nbsp;=&nbsp;array(</span><span style=\"color: rgb(221, 0, 0);\">&#39;volume&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">85</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(221, 0, 0);\">&#39;edition&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">6</span><span style=\"color: rgb(0, 119, 0);\">);<br/></span><span style=\"color: rgb(0, 0, 187);\">$data</span><span style=\"color: rgb(0, 119, 0);\">[]&nbsp;=&nbsp;array(</span><span style=\"color: rgb(221, 0, 0);\">&#39;volume&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">98</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(221, 0, 0);\">&#39;edition&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">2</span><span style=\"color: rgb(0, 119, 0);\">);<br/></span><span style=\"color: rgb(0, 0, 187);\">$data</span><span style=\"color: rgb(0, 119, 0);\">[]&nbsp;=&nbsp;array(</span><span style=\"color: rgb(221, 0, 0);\">&#39;volume&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">86</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(221, 0, 0);\">&#39;edition&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">6</span><span style=\"color: rgb(0, 119, 0);\">);<br/></span><span style=\"color: rgb(0, 0, 187);\">$data</span><span style=\"color: rgb(0, 119, 0);\">[]&nbsp;=&nbsp;array(</span><span style=\"color: rgb(221, 0, 0);\">&#39;volume&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">67</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(221, 0, 0);\">&#39;edition&#39;&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">7</span><span style=\"color: rgb(0, 119, 0);\">);<br/></span><span style=\"color: rgb(0, 0, 187);\">?&gt;</span></span></code></p><p style=\"margin-top: 0px; margin-bottom: 1.5rem;\">本例中将把&nbsp;volume&nbsp;降序排列，把&nbsp;edition&nbsp;升序排列。</p><p style=\"margin-top: 0px; margin-bottom: 1.5rem;\">现在有了包含有行的数组，但是&nbsp;<span class=\"function\"><span style=\"text-rendering: optimizeLegibility;\">array_multisort()</span></span>&nbsp;需要一个包含列的数组，因此用以下代码来取得列，然后排序。</p><p><code style=\"font-stretch: normal; font-size: 0.875rem; line-height: 1.5rem; font-family: &quot;Fira Mono&quot;, &quot;Source Code Pro&quot;, monospace; word-wrap: break-word; display: block;\"><span style=\"color: rgb(0, 0, 0);\"><span style=\"color: rgb(0, 0, 187);\">&lt;?php<br/></span><span style=\"color: rgb(255, 128, 0);\">//&nbsp;取得列的列表<br/></span><span style=\"color: rgb(0, 119, 0);\">foreach&nbsp;(</span><span style=\"color: rgb(0, 0, 187);\">$data&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">as&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$key&nbsp;</span><span style=\"color: rgb(0, 119, 0);\">=&gt;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$row</span><span style=\"color: rgb(0, 119, 0);\">)&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$volume</span><span style=\"color: rgb(0, 119, 0);\">[</span><span style=\"color: rgb(0, 0, 187);\">$key</span><span style=\"color: rgb(0, 119, 0);\">]&nbsp;&nbsp;=&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$row</span><span style=\"color: rgb(0, 119, 0);\">[</span><span style=\"color: rgb(221, 0, 0);\">&#39;volume&#39;</span><span style=\"color: rgb(0, 119, 0);\">];<br/>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$edition</span><span style=\"color: rgb(0, 119, 0);\">[</span><span style=\"color: rgb(0, 0, 187);\">$key</span><span style=\"color: rgb(0, 119, 0);\">]&nbsp;=&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$row</span><span style=\"color: rgb(0, 119, 0);\">[</span><span style=\"color: rgb(221, 0, 0);\">&#39;edition&#39;</span><span style=\"color: rgb(0, 119, 0);\">];<br/>}<br/><br/></span><span style=\"color: rgb(255, 128, 0);\">//&nbsp;将数据根据&nbsp;volume&nbsp;降序排列，根据&nbsp;edition&nbsp;升序排列<br/>//&nbsp;把&nbsp;$data&nbsp;作为最后一个参数，以通用键排序<br/></span><span style=\"color: rgb(0, 0, 187);\">array_multisort</span><span style=\"color: rgb(0, 119, 0);\">(</span><span style=\"color: rgb(0, 0, 187);\">$volume</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">SORT_DESC</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$edition</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">SORT_ASC</span><span style=\"color: rgb(0, 119, 0);\">,&nbsp;</span><span style=\"color: rgb(0, 0, 187);\">$data</span><span style=\"color: rgb(0, 119, 0);\">);<br/></span><span style=\"color: rgb(0, 0, 187);\">?&gt;</span></span></code></p><p style=\"margin-top: 0px; margin-bottom: 1.5rem;\">数据集合现在排好序了，结果如下：</p><pre style=\"white-space: pre-wrap; margin-top: 0px; margin-bottom: 0px;\">volume&nbsp;|&nbsp;edition\r\n-------+--------\r\n&nbsp;&nbsp;&nbsp;&nbsp;98&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2\r\n&nbsp;&nbsp;&nbsp;&nbsp;86&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\r\n&nbsp;&nbsp;&nbsp;&nbsp;86&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6\r\n&nbsp;&nbsp;&nbsp;&nbsp;85&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6\r\n&nbsp;&nbsp;&nbsp;&nbsp;67&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2\r\n&nbsp;&nbsp;&nbsp;&nbsp;67&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7</pre><p><br/></p>','','array_multisort','本文摘自php手册，仅作为日常工作参考','php',0,355),(68,1487983604,1487983604,1487983604,'<pre class=\"brush:js;toolbar:false\">/**\r\n&nbsp;*&nbsp;该脚本用于加载更多数据\r\n&nbsp;*&nbsp;@author&nbsp;rww\r\n&nbsp;*&nbsp;@date&nbsp;2017/02/24\r\n&nbsp;*/\r\nwindow.onload&nbsp;=&nbsp;function(){\r\n	/*\r\n	&nbsp;{\r\n		page&nbsp;:&nbsp;1,	//&nbsp;请求页\r\n	&nbsp;	functionSwitch&nbsp;:&nbsp;1,	//整体功能开关\r\n	&nbsp;	ajaxUrl&nbsp;:&nbsp;&quot;&quot;,	//请求数据地址\r\n	&nbsp;	loadStatusEleId&nbsp;:&nbsp;&quot;loadPrompt&quot;&nbsp;//加载状态显示元素类名\r\n	&nbsp;	targetElementId&nbsp;:&nbsp;&quot;targetUl&quot;,&nbsp;//返回数据填充元素id\r\n	&nbsp;	loadSwitch&nbsp;:&nbsp;1,	//是否允许加载数据\r\n	&nbsp;}\r\n	&nbsp;*/\r\n	function&nbsp;loadMore(param){\r\n		for&nbsp;(var&nbsp;i&nbsp;in&nbsp;param)&nbsp;{\r\n			this[i]&nbsp;=&nbsp;param[i];\r\n			if&nbsp;(i&nbsp;!=&nbsp;&quot;functionSwitch&quot;&nbsp;&amp;&amp;&nbsp;!param[i])&nbsp;{\r\n				console.log(&quot;参数配置：&quot;+i+&quot;不能为空&quot;);\r\n			}\r\n		}\r\n\r\n		this.statusDiv&nbsp;=&nbsp;document.querySelector(&quot;#&quot;+this.loadStatusEleId);	//供全部方法使用\r\n	}\r\n	\r\n	//通过原型增加方法\r\n	loadMore.prototype&nbsp;=&nbsp;{\r\n			constructor&nbsp;:&nbsp;loadMore,\r\n\r\n			//初始化\r\n			init&nbsp;:&nbsp;function(){	//初始化插件\r\n				if&nbsp;(!this.functionSwitch)&nbsp;{	//如果整体功能关闭，不在继续执行\r\n					return&nbsp;false;\r\n				}\r\n				\r\n				this.listenScroll();\r\n				\r\n			},\r\n\r\n			//监听滚动\r\n			listenScroll&nbsp;:&nbsp;function(){\r\n				var&nbsp;self&nbsp;=&nbsp;this;\r\n				window.addEventListener(&quot;scroll&quot;,function(){\r\n					if&nbsp;(self.functionSwitch&nbsp;&amp;&amp;&nbsp;self.loadSwitch&nbsp;&amp;&amp;&nbsp;self.checkIfToLoad())&nbsp;{	//如果已经滚动到位\r\n							self.loadData();\r\n					}&nbsp;\r\n				});\r\n			},\r\n			\r\n			//检查是否能够加载\r\n			checkIfToLoad&nbsp;:&nbsp;function()&nbsp;{\r\n				&nbsp;var&nbsp;scrollTop&nbsp;=&nbsp;document.documentElement.scrollTop&nbsp;||&nbsp;document.body.scrollTop;\r\n				&nbsp;var&nbsp;windowHeight&nbsp;=&nbsp;document.documentElement.clientHeight;\r\n				&nbsp;var&nbsp;scrollHeight&nbsp;=&nbsp;document.documentElement.scrollHeight;\r\n				&nbsp;if&nbsp;(scrollTop&nbsp;+&nbsp;windowHeight&nbsp;&gt;&nbsp;scrollHeight&nbsp;-&nbsp;300)&nbsp;{\r\n					&nbsp;return&nbsp;true;\r\n				&nbsp;}&nbsp;else&nbsp;{\r\n					&nbsp;return&nbsp;false;\r\n				&nbsp;}\r\n			},\r\n			\r\n			//加载数据\r\n			loadData&nbsp;:&nbsp;function(){\r\n				var&nbsp;self&nbsp;=&nbsp;this;\r\n				self.loadSwitch&nbsp;=&nbsp;false;	//加载数据时将该参数关闭\r\n				var&nbsp;xmlhttp=null;\r\n				\r\n				if&nbsp;(window.XMLHttpRequest)&nbsp;{\r\n					xmlhttp=new&nbsp;XMLHttpRequest();\r\n				}&nbsp;\r\n				\r\n				if&nbsp;(xmlhttp&nbsp;!=&nbsp;null)&nbsp;{\r\n					xmlhttp.onreadystatechange&nbsp;=&nbsp;function(e){\r\n						self.statusDiv.classList.add(&quot;loading&quot;);\r\n						if&nbsp;(this.readyState==4)&nbsp;{//&nbsp;4&nbsp;=&nbsp;&quot;loaded&quot;\r\n							if&nbsp;(this.status==200)&nbsp;{\r\n								for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;3000;&nbsp;i++){\r\n									console.log(1);\r\n								}\r\n								self.loadSwitch&nbsp;=&nbsp;true;&nbsp;//请求成功将开关再次开启\r\n								self.statusDiv.classList.remove(&quot;loading&quot;);\r\n								if&nbsp;(this.response&nbsp;!=&nbsp;&quot;false&quot;)&nbsp;{\r\n									self.appendHtml(this.response);\r\n								}&nbsp;else&nbsp;{\r\n									self.functionSwitch&nbsp;=&nbsp;false;\r\n									self.statusDiv.classList.add(&quot;loaded&quot;);\r\n								}\r\n								self.page++;\r\n							}else&nbsp;{\r\n								alert(&quot;Problem&nbsp;retrieving&nbsp;XML&nbsp;data&quot;);\r\n							}\r\n						}\r\n				&nbsp;&nbsp;&nbsp;&nbsp;}\r\n					//POST方式发送数据\r\n				&nbsp;&nbsp;&nbsp;&nbsp;xmlhttp.open(&quot;POST&quot;,self.ajaxUrl,true);\r\n				&nbsp;&nbsp;&nbsp;&nbsp;xmlhttp.responseType&nbsp;=&nbsp;&quot;text&quot;;\r\n					xmlhttp.setRequestHeader(&quot;Content-Type&quot;,&quot;application/x-www-form-urlencoded&quot;);\r\n				&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;formData&nbsp;=&nbsp;&#39;page=&#39;+self.page;\r\n				&nbsp;&nbsp;&nbsp;&nbsp;xmlhttp.send(formData);\r\n				}&nbsp;else&nbsp;{\r\n					alert(&quot;Your&nbsp;browser&nbsp;does&nbsp;not&nbsp;support&nbsp;XMLHTTP.&quot;);\r\n				}\r\n				\r\n			},\r\n\r\n			//追加html到页面中。文档片段，一次性append，提高性能\r\n			appendHtml&nbsp;:&nbsp;function(html){\r\n				var&nbsp;divTemp&nbsp;=&nbsp;document.createElement(&quot;div&quot;),&nbsp;\r\n					nodes&nbsp;=&nbsp;null,\r\n					fragment&nbsp;=&nbsp;document.createDocumentFragment();\r\n				divTemp.innerHTML&nbsp;=&nbsp;html;\r\n				nodes&nbsp;=&nbsp;divTemp.childNodes;\r\n				var&nbsp;nlength&nbsp;=&nbsp;nodes.length;\r\n\r\n				for&nbsp;(var&nbsp;i=0,&nbsp;i&lt;nlength;&nbsp;i+=1)&nbsp;{\r\n				&nbsp;&nbsp;&nbsp;fragment.appendChild(nodes[i].cloneNode(true));\r\n				}\r\n\r\n				document.getElementById(this.targetElementId).appendChild(fragment);\r\n				nodes&nbsp;=&nbsp;null;\r\n				fragment&nbsp;=&nbsp;null;&nbsp;\r\n			}\r\n			\r\n	}\r\n	\r\n	//实例化对象\r\n	var&nbsp;loadInstance&nbsp;=&nbsp;new&nbsp;loadMore(\r\n			{\r\n				page&nbsp;:&nbsp;2,	//&nbsp;请求页\r\n			&nbsp;	functionSwitch&nbsp;:&nbsp;1,	//整体功能开关\r\n			&nbsp;	ajaxUrl&nbsp;:&nbsp;&quot;/index.php?c=Ajax_My_Main&amp;a=MyQuestion&quot;,	//请求数据地址\r\n			&nbsp;	loadStatusEleId&nbsp;:&nbsp;&quot;loadPrompt&quot;,&nbsp;//加载状态显示元素类名\r\n			&nbsp;	targetElementId&nbsp;:&nbsp;&quot;targetUl&quot;,&nbsp;//返回数据填充元素id\r\n			&nbsp;	loadSwitch&nbsp;:&nbsp;1,\r\n			}\r\n	);\r\n	loadInstance.init();\r\n}</pre><p>先把代码放在这里，有兴趣的可以读一下。具体说明我以上再详细。<br/></p>','上拉加载','移动端上拉加载','适用于移动端上拉加载的插件','',0,221),(69,1488267424,1488267464,1488267424,'','亲情','在地铁上看到一个小伙子在发一个66.66元微信红包，随红包的祝福语是：妈妈生日快乐！','你有没有被这个举动触动呢？','生活',1,143),(70,1488422208,1488422208,1488422208,'<p>出现这个问题之后，我“一鼓作气”把好几个虚拟机全部删了！打算重装。可是杯具的是：重装也不行。百度一下找到答案：把这些服务都开启来就好了。</p><p><img src=\"/ueditor/php/upload/image/20170302/1488422155491250.png\" title=\"1488422155491250.png\" alt=\"blob.png\"/></p><p>就是这几个鬼，都开启来就好了。大家千万不要冲动，像我一样删掉了，重装，浪费不少时间。</p>','linux','vmware出现“内部错误”的解决办法','原来是window的vmware相关服务没有开启，开启之后就正常了。','linux',0,54),(71,1488460457,1488460457,1488460457,'<p>rsync 报错 Failed to exec ssh: No such file or directory (2)</p><p>安装openssh-clients就可以了：yum -y install openssh-clients。</p><p><img src=\"/ueditor/php/upload/image/20170302/1488460444393360.png\" title=\"1488460444393360.png\" alt=\"blob.png\"/></p><p>安装完，再运行就好了。</p><p><br/></p>','openssh-clients','rsync 报错 Failed to exec ssh: No such file or directory (2)','实验rsync的ssh通道传输时执行命令遇到这个错误，记录一下解决办法。','linux',0,525),(72,1489247933,1490273933,1489247933,'<p>								</p><p>原本是想改/etc/hosts文件的内容，可是所有者是root，登录用户名是ruanwenwu,改不了。所以想切换到root用户：su root,可是忘了密码。</p><p><br/></p><p>网上的解决办法试了不少，最终这个最好用：</p><p>sudo bash</p><p>输入自己当前用户的密码</p><p>passwd root</p><p>重新输入新的面就好了。</p><p><img src=\"/ueditor/php/upload/image/20170323/1490273929139647.png\" title=\"1490273929139647.png\" alt=\"blob.png\"/></p><p>							</p>','mac','mac下重置root管理员密码','记录一下过程','mac',0,32),(73,1489249192,1489249192,1489249192,'<p>在apache的默认配置中，有这么一段：</p><p><img src=\"webkit-fake-url://b9b96e53-9c00-437a-ad18-0457309b390d/image.tiff\"/></p><p>它的意思是，根目录不允许任何人访问。所以如果你在创建虚拟主机的时候，项目目录一定要指定一下权限，否则就一直会是403了。</p><p>下面是一个可行的配置：</p><p><img src=\"webkit-fake-url://59e6939d-040c-4efe-b90c-e700a03a90b7/image.tiff\"/></p>','跨过的坑','apache的目录权限管理的坑一个','跨过的linux的坑一个','linux',0,358),(74,1489741758,1489745193,1489741758,'<p>								</p><p>我要从下面这段html中匹配出图片的src地址：</p><p><img src=\"/ueditor/php/upload/image/20170317/1489741196734911.png\" title=\"1489741196734911.png\" alt=\"blob.png\"/></p><p>用的正则是：</p><pre class=\"brush:cpp;toolbar:false\">$pattern&nbsp;=&nbsp;&quot;/\\&lt;img.*src=(\\&#39;|\\&quot;)(.*)\\\\1.*&gt;/U&quot;;;</pre><p>这个的优点是不管src在img标签的什么地方都能匹配到。这个正则中的\\\\1，表示反向选择前面的第一个括号里的内容（也叫子模式）。</p><p>最后的效果：</p><p><img src=\"/ueditor/php/upload/image/20170317/1489741646623339.png\" title=\"1489741646623339.png\" alt=\"blob.png\"/></p><p>注意，$pattern如果用单引号的话，\\\\1这个地方就必须要改成\\1，双引号必须是\\\\1,因为\\\\转义后就是\\的意思。</p><p>注意：/U方法和.*?不能同时用，否则会出问题。上面的正则如果不用/U模式修正符，用.*?的话是这样：</p><p>/\\&lt;img.*?src=(\\&#39;|\\&quot;).*?\\\\1.*?&gt;/&quot;</p><p>补充：.*?的意思取消贪婪。.代表任意字符（除了换行），*代表任意数量如果.*src代表一致匹配到src为止。</p><p>比如字符串：sfdsfsrcdfsdfsrc,用/.*src/就一直会匹配到最后的src，也就是匹配全部内容了。</p><p><img src=\"/ueditor/php/upload/image/20170317/1489745022795551.png\" title=\"1489745022795551.png\" alt=\"blob.png\"/></p><p>如果用.*?src的话，则匹配的是</p><table><tbody><tr class=\"firstRow\"><td class=\"line-number\"><br/></td><td class=\"line-content\">array(1) {</td></tr><tr><td class=\"line-number\"><br/></td><td class=\"line-content\">[0]=&gt;</td></tr><tr><td class=\"line-number\"><br/></td><td class=\"line-content\">array(2) {</td></tr><tr><td class=\"line-number\"><br/></td><td class=\"line-content\">[0]=&gt;</td></tr><tr><td class=\"line-number\"><br/></td><td class=\"line-content\">string(8) &quot;sfdsfsrc&quot;</td></tr><tr><td class=\"line-number\"><br/></td><td class=\"line-content\">[1]=&gt;</td></tr><tr><td class=\"line-number\"><br/></td><td class=\"line-content\">string(8) &quot;dfsdfsrc&quot;</td></tr><tr><td class=\"line-number\"><br/></td><td class=\"line-content\">}</td></tr><tr><td class=\"line-number\"><br/></td><td class=\"line-content\">}</td></tr><tr><td class=\"line-number\"><br/></td><td class=\"line-number\"><br/></td></tr></tbody></table><p>发现匹配到了两次。而且都是到第一个src结尾。</p><p>如果.*?和/U连用：$pattern = &quot;/.*?src/U&quot;，结果如下：</p><p><img src=\"/ueditor/php/upload/image/20170317/1489745167213540.png\" title=\"1489745167213540.png\" alt=\"blob.png\"/></p><p>							</p>','','php正则匹配图片地址','一个常碰到的正则匹配图片或者链接地址的经验','php',0,129),(75,1489844693,1489844693,1489844693,'','搜索','网站添加了搜索功能，赶紧试试吧','网站添加了搜索，立马高大上了，哈哈。','说说',0,126),(76,1489859006,1489859006,1489859006,'<p>难度不大，主要用到了我自己封装的这个函数：<br/></p><pre class=\"brush:css;toolbar:false\">&nbsp;private&nbsp;function&nbsp;curlrequest($param){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$option&nbsp;=&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;request_type&quot;&nbsp;&nbsp;=&gt;&nbsp;&nbsp;&quot;post&quot;,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;data&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;&nbsp;array(),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;header&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;&nbsp;array(),\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;show_header_info&quot;&nbsp;&nbsp;=&gt;&nbsp;&nbsp;0,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;url&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;&nbsp;&quot;&quot;,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($param&nbsp;&amp;&amp;&nbsp;is_array($param))&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$option&nbsp;=&nbsp;array_merge($option,&nbsp;$param);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;extract($option);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$url)&nbsp;return&nbsp;false;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ch&nbsp;=&nbsp;curl_init();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ch,&nbsp;CURLOPT_URL,&nbsp;$url);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ch,&nbsp;CURLOPT_RETURNTRANSFER,&nbsp;1);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ch,&nbsp;CURLOPT_HEADER,&nbsp;$show_header_info);&nbsp;&nbsp;&nbsp;&nbsp;//是否显示头信息\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ch,&nbsp;CURLOPT_HTTPHEADER,&nbsp;$header);\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($request_type&nbsp;==&nbsp;&quot;post&quot;)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ch,&nbsp;CURLOPT_POST,&nbsp;1);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($ch,&nbsp;CURLOPT_POSTFIELDS,&nbsp;$data);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res&nbsp;=&nbsp;curl_exec($ch);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_close($ch);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$res;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p>curl在发送请求时还是比较强大的。各种头信息。<br/></p><p>注意，最后一步，通过accesstoken获得用户信息的接口最好这样来写，即是在后信息里进行验证：</p><p><img src=\"/ueditor/php/upload/image/20170319/1489858977441576.png\" title=\"1489858977441576.png\" alt=\"blob.png\"/></p>','oauth登陆','使用github登陆上线了，不得了','现在我的博客必须使用github登陆才能发表评论，朋友们，快来试试吧','php',4,81),(77,1489977538,1489977694,1489977538,'<p>								</p><pre class=\"brush:bash;toolbar:false\">function&nbsp;writeCookie($userid){\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$expire&nbsp;=&nbsp;time()+86400;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$check&nbsp;=&nbsp;rand();\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setcookie(&quot;userid&quot;,&nbsp;$userid,&nbsp;$expire,&nbsp;&quot;/&quot;,&nbsp;&quot;.ruanwenwu.cn&quot;,false,true);&nbsp;&nbsp;&nbsp;&nbsp;//最后一个参数设置成true,意思是指允许http传输，禁止js获取cookie，这样更安全\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setcookie(&quot;check&quot;,&nbsp;$check,&nbsp;$expire,&nbsp;&quot;/&quot;,&nbsp;&quot;.ruanwenwu.cn&quot;,&nbsp;false,&nbsp;true);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key&nbsp;=&nbsp;&quot;sa^2fa*%mdpyw$@4&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cipher=&nbsp;md5(md5($key&nbsp;.&nbsp;$check)&nbsp;.&nbsp;$userid&nbsp;.&nbsp;$key);\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setcookie(&quot;cipher&quot;,&nbsp;$cipher,&nbsp;$expire,&nbsp;&quot;/&quot;,&nbsp;&quot;.ruanwenwu.cn&quot;,&nbsp;false,&nbsp;true);\r\n}</pre><p>这样基本上就能够防止被伪造了。</p><p>							</p>','安全','设置更安全的cookie','登录后都需要设置cookie,怎样的cookie设置比较安全呢，能防止被伪造呢？','php',2,82),(78,1490025005,1490025005,1490025005,'<h3>题记</h3><p>参考文档：<a href=\"http://blog.csdn.net/lanwu628/article/details/17714885\">http://blog.csdn.net/lanwu628/article/details/17714885</a></p><p>以下文档基于Centos 6.5，本人亲测ok，如有问题可以评论，我看到了会回复哦。</p><p>什么是RPMForge</p><p>RPMForge是CentOS系统下的软件仓库，拥有10000多种的软件包，被CentOS社区认为是最安全也是最稳定的一个软件仓库。默认的CentOS源，软件太少了，可以添加额外的RpmForge。这里系统为CentOS5.7。</p><h3>步骤</h3><p>1、安装yum-priorities插件<br/>因为要添加第三方源，先确认系统是否安装了yum-priorities这个插件，这个插件用来保证安装软件时候软件仓库先后次序（priority优先权），一般是默认先从官方base或者镜像安装，然后从社区用户contribute的软件中安装，再从第三方软件仓库中安装。当然这个次序可以自己更改，为了安全和稳定还是依照这个次序吧。<br/></p><pre class=\"brush:html;toolbar:false\">yum&nbsp;install&nbsp;yum-priorities</pre><p>2、查看/etc/yum/pluginconf.d/priorities.conf文件<br/></p><pre class=\"brush:groovy;toolbar:false\">vim&nbsp;/etc/yum/pluginconf.d/priorities.conf</pre><p>确认文件中有以下内容：<br/></p><pre class=\"brush:diff;toolbar:false\">[main]\r\nenabled=1</pre><p>3、设置/etc/yum.repos.d/CentOS-Base.repo文件<br/>添加顺序指令priority=N（N 从 1 至 99，1 优先级最高）。<br/></p><pre class=\"brush:html;toolbar:false\">vim&nbsp;/etc/yum.repos.d/CentOS-Base.repo</pre><p>[base]、[updates]、[addons]、[extras]最后分别设置priority=1，[centosplus]、[contrib]最后分别设置priority=2，其他第三的软件源设置priority=N（推荐N&gt;10）。<br/></p><p><img src=\"/ueditor/php/upload/image/20170320/1490024718253754.png\" title=\"1490024718253754.png\" alt=\"blob.png\"/></p><p>（像上图这样加就行了）</p><p>4、安装rpmforge的软件仓库<br/>查看系统<a title=\"大型网站架构知识库\" href=\"http://lib.csdn.net/base/architecture\" target=\"_blank\">架构</a>：<br/></p><pre class=\"brush:css;toolbar:false\">uname&nbsp;-i</pre><p>i386系统执行：<br/><a href=\"http://repository.it4i.cz/mirrors/repoforge/redhat/el5/en/i386/rpmforge/RPMS/rpmforge-release-0.5.3-1.el5.rf.i386.rpm\"></a><br/></p><pre class=\"brush:java;toolbar:false\">rpm&nbsp;-ivh&nbsp;\r\nhttp://repository.it4i.cz/mirrors/repoforge/redhat/el5/en/i386/rpmforge/RPMS/rpmforge-release-0.5.3-1.el5.rf.i386.rpm</pre><p>x86_64系统执行：<br/><a href=\"http://repository.it4i.cz/mirrors/repoforge/redhat/el6/en/x86_64/rpmforge/RPMS/rpmforge-release-0.5.3-1.el6.rf.x86_64.rpm\"></a></p><pre class=\"brush:html;toolbar:false\">rpm&nbsp;-ivh&nbsp;\r\nhttp://repository.it4i.cz/mirrors/repoforge/redhat/el6/en/x86_64/rpmforge/RPMS/rpmforge-release-0.5.3-1.el6.rf.x86_64.rpm</pre><p>5、设置/etc/yum.repos.d/rpmforge.repo文件<br/></p><pre class=\"brush:html;toolbar:false\">vim&nbsp;/etc/yum.repos.d/rpmforge.repo</pre><p>[rpmforge]、[rpmforge-extras]、[rpmforge-testing]最后分别设置priority=11。<br/></p><p>9、验证是否设置成功<br/>执行：</p><pre class=\"brush:html;toolbar:false\">yum&nbsp;check-update</pre><p>查看是否有：Loaded plugins: fastestmirror, priorities<br/>如果看到上述信息，表明RPMforge安装源和优先级配置已经起作用了。<br/></p><p><br/></p>','RPMForge','RPMForge安装详细记录-亲测可用','第一遍安装真是蛋疼，第二遍有文档麻溜的不要不要的。把文档奉献出来，希望可以帮到有需要的朋友哦~','linux',0,23),(79,1490027733,1490027733,1490027733,'<h3>下载地址</h3><p><a href=\"http://php.net/get/php-5.5.38.tar.gz/from/a/mirror\">http://php.net/get/php-5.5.38.tar.gz/from/a/mirror</a></p><h3>解压，移动到/usr/local/src目录下</h3><pre class=\"brush:as3;toolbar:false\">tar&nbsp;zxvf&nbsp;php-5.5.38.tar.gz\r\nmv&nbsp;php-5.5.38&nbsp;/usr/local/src</pre><h3>加上编译参数</h3><pre class=\"brush:as3;toolbar:false\">./configure&nbsp;--prefix=/usr/local/php&nbsp;--with-config-file-path=/usr/local/php/etc&nbsp;--enable-fpm&nbsp;--with-fpm-user=php-fpm&nbsp;--with-fpm-group=php-fpm&nbsp;--with-mysql=/usr/local/mysql&nbsp;--with-mysql-sock=/tmp/mysql.sock&nbsp;--with-libxml-dir&nbsp;--with-gd&nbsp;--with-jpeg-dir&nbsp;--with-png-dir&nbsp;--with-freetype-dir&nbsp;--with-iconv-dir&nbsp;--with-zlib-dir&nbsp;--with-mcrypt&nbsp;--enable-soap&nbsp;--enable-gd-native-ttf&nbsp;--enable-ftp&nbsp;--enable-mbstring&nbsp;--enable-exif&nbsp;--disable-ipv6&nbsp;--with-pear&nbsp;--with-curl&nbsp;--with-openssl</pre><p>注释：</p><p>--enable-fpm 是包含php-fpm模块</p><p>--with-mysql 前提是要已经安装了mysql了</p><h3>错误解决</h3><p>第一次configure出现这样的错误：</p><p><img src=\"/ueditor/php/upload/image/20170320/1490022611192688.png\" title=\"1490022611192688.png\" alt=\"blob.png\"/></p><p>安装gcc解决问题：<br/></p><pre class=\"brush:as3;toolbar:false\">yum&nbsp;install&nbsp;-y&nbsp;gcc*</pre><p>安装完gcc重新编译，报这样的错误：</p><p><span style=\"color: rgb(255, 0, 0);\">configure error xml2-config not found. please check your libxml2 installation 错误</span></p><p>安装libxml2和libxml2-devel解决问题：<br/></p><pre class=\"brush:as3;toolbar:false\">yum&nbsp;install&nbsp;-y&nbsp;libxml2\r\nyum&nbsp;install&nbsp;-y&nbsp;libxml2-devel</pre><p>安装libxml2和libxml2-devel完再次重新编译，报这样的错误：</p><p><span style=\"color: rgb(69, 69, 69); font-family: Tahoma, Helvetica, Arial, STHeiti; font-size: 14px; background-color: rgb(253, 253, 253);\"></span></p><p><span style=\"color: rgb(255, 0, 0);\">configure: error: Cannot find OpenSSL&#39;s &lt;evp.h&gt;</span></p><p><span style=\"color: rgb(69, 69, 69); font-family: Tahoma, Helvetica, Arial, STHeiti; font-size: 14px; background-color: rgb(253, 253, 253);\"></span><img src=\"/ueditor/php/upload/image/20170320/1490023145310471.png\" title=\"1490023145310471.png\" alt=\"blob.png\"/></p><p>安装openssl和openssl-devel后，这一步算是过去了。</p><p><br/></p><p>再次重新编译，又出现新的错误，太蛋疼了^_^</p><p><span style=\"color: rgb(255, 0, 0);\">configure: error: Please reinstall the libcurl distribution -</span></p><p><span style=\"color: rgb(255, 0, 0);\">&nbsp; &nbsp; easy.h should be in &lt;curl-dir&gt;/include/curl/</span></p><p>安装curl-devel:</p><pre class=\"brush:as3;toolbar:false\">yum&nbsp;-y&nbsp;install&nbsp;curl-devel</pre><p>过了curl,再来编译，又报错了，是不是快崩溃了，哈哈</p><p><span style=\"color: rgb(255, 0, 0);\">configure: error: jpeglib.h not found.</span></p><p>安装libjpeg-devl</p><pre class=\"brush:as3;toolbar:false\">yum&nbsp;-y&nbsp;install&nbsp;libjpeg-devel</pre><p>最好接着安装,要不然马上要报libpng的错误<br/></p><pre class=\"brush:as3;toolbar:false\">yum&nbsp;-y&nbsp;install&nbsp;libpng-devel</pre><p>过了libjpeg和libpng，重新编译，又报错：</p><p><span style=\"color: rgb(255, 0, 0);\">configure: error: freetype-config not found.</span></p><p>安装freetype和freetype-devel<br/></p><pre class=\"brush:as3;toolbar:false\">yum&nbsp;install&nbsp;-y&nbsp;freetype&nbsp;freetype-devel</pre><p><span style=\"color: rgb(255, 0, 0);\">过了freetype又来：</span></p><p><span style=\"color: rgb(255, 0, 0);\">configure: error: mcrypt.h not found. Please reinstall libmcrypt.</span></p><p>yum搜索这两个包，没有，尴尬了吧。</p><p><img src=\"/ueditor/php/upload/image/20170320/1490023923922856.png\" title=\"1490023923922856.png\" alt=\"blob.png\"/></p><p>这个时候，就要配另外一个yum源<span style=\"color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; line-height: 21px; widows: 1; background-color: rgb(255, 255, 255);\">rpmforge</span>，两个yum源一起搞看有没有。</p><p>配置rmpforge的步骤：</p><p><a href=\"http://ruanwenwu.cn/blog/78.html(亲测可用哦）\">http://ruanwenwu.cn/blog/78.html(亲测可用哦）</a> </p><p>配置完再来搞：妥妥的行了。</p><p><img src=\"/ueditor/php/upload/image/20170320/1490025277324497.png\" title=\"1490025277324497.png\" alt=\"blob.png\"/></p><p>别忘了：<br/></p><pre class=\"brush:as3;toolbar:false\">make&nbsp;&amp;&amp;&nbsp;make&nbsp;install</pre><p>经过几个世纪的等待，终于安装完——这一步^_^</p><p><img src=\"/ueditor/php/upload/image/20170321/1490026235488440.png\" title=\"1490026235488440.png\" alt=\"blob.png\"/></p><h3>配置</h3><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p><strong>将php.ini挪到安装目录</strong><br/></p></li></ol><pre class=\"brush:as3;toolbar:false\">cp&nbsp;php.ini-production&nbsp;/usr/local/php/etc/php.in</pre><p><strong>&nbsp; &nbsp;2.将启动程序挪到/etc/init.d下</strong></p><p><img src=\"/ueditor/php/upload/image/20170321/1490026605183581.png\" title=\"1490026605183581.png\" alt=\"blob.png\"/></p><p>上面这些命令的意思分别是：将启动文件挪到/etc/init.d,给php-fpm可执行权限，将php-fpm加入自启动，并且加入开机启动。</p><p><strong>&nbsp; 3.建立php-fpm用户和用户组，因为我们在编译的时候就是指定的这个用户：</strong></p><pre class=\"brush:as3;toolbar:false\">useradd&nbsp;-s&nbsp;/sbin/nologin&nbsp;php-fpm&nbsp;-M</pre><p>&nbsp; 4<strong>.准备配置文件：</strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;在/usr/local/php/etc/下面有一个php-fpm.conf.default</p><p><img src=\"/ueditor/php/upload/image/20170321/1490026913590273.png\" title=\"1490026913590273.png\" alt=\"blob.png\"/></p><p>&nbsp; &nbsp; 我们直接改成php-fpm.conf就好了。<br/></p><p><strong>&nbsp; &nbsp;5.启动</strong><br/></p><p>&nbsp;<img src=\"/ueditor/php/upload/image/20170321/1490026984144100.png\" title=\"1490026984144100.png\" alt=\"blob.png\"/></p><p>&nbsp;<strong>&nbsp;&nbsp;&nbsp;6.查看启动情况（一个主进程，两个子进程）</strong><img src=\"/ueditor/php/upload/image/20170321/1490027034113284.png\" title=\"1490027034113284.png\" alt=\"blob.png\"/></p><p>&nbsp;<strong>&nbsp;&nbsp;&nbsp;7.查看监听端口(9000端口起来了）</strong><br/></p><p><img src=\"/ueditor/php/upload/image/20170321/1490027131753690.png\" title=\"1490027131753690.png\" alt=\"blob.png\"/></p><p>到这里就算完了。终于^_^</p><h3>总结</h3><p>搞了这么久，要是提前把这些依赖全部安装好再来搞就快多了。</p>','php编译安装','编译安装php5.5.38','谁装谁知道……','',0,10),(80,1490029157,1490029477,1490029157,'<p>								</p><h3>下载</h3><pre class=\"brush:as3;toolbar:false\">wget&nbsp;http://nginx.org/download/nginx-1.10.3.tar.gz</pre><p>nginx的官网是：www.nginx.org</p><h3>解压，移动到/usr/local/src目录</h3><pre class=\"brush:as3;toolbar:false\">tar&nbsp;zxvf&nbsp;nginx-1.10.3.tar.gz\r\ncp&nbsp;nginx-1.10.3&nbsp;/usr/local/src</pre><h3>编译安装</h3><pre class=\"brush:as3;toolbar:false\">cd&nbsp;nginx-1.10.3\r\n./configure&nbsp;--prefix=/usr/local/nginx&nbsp;--with-pcre</pre><p>安装完报错：</p><p><span style=\"color: rgb(255, 0, 0);\">./configure: error: the HTTP rewrite module requires the PCRE library.</span></p><p><span style=\"color: rgb(255, 0, 0);\">You can either disable the module by using --without-http_rewrite_module</span></p><p><span style=\"color: rgb(255, 0, 0);\">option, or install the PCRE library into the system, or build the PCRE library</span></p><p><span style=\"color: rgb(255, 0, 0);\">statically from the source with nginx by using --with-pcre=&lt;path&gt; option.</span></p><p>安装pcre-devel解决问题：</p><pre class=\"brush:as3;toolbar:false\">yum&nbsp;install&nbsp;-y&nbsp;pcre-devel</pre><h3>完成安装</h3><pre class=\"brush:css;toolbar:false\">make&nbsp;&amp;&amp;&nbsp;make&nbsp;install</pre><p><img src=\"/ueditor/php/upload/image/20170321/1490029130858130.png\" title=\"1490029130858130.png\" alt=\"blob.png\"/></p><p><br/></p><p>启动与查看</p><p>nginx的启动命令就是/usr/local/nginx/sbin/nginx,比较奇葩啊，哈哈</p><p><img src=\"/ueditor/php/upload/image/20170321/1490029436893731.png\" title=\"1490029436893731.png\" alt=\"blob.png\"/></p><p>成功了，监听到80端口了。</p><p>nginx的安装的包比较小，安装起来还是很快滴~</p><p>							</p>','nginx','nginx1.10.3编译安装','编译nginx的一个过程，记录一下。','linux',0,15),(81,1490029271,1490029271,1490029271,'','听音乐','Bose入手，安静我有，哈哈哈~','掐死你的温柔。。。','说说',0,12),(82,1490030583,1490030583,1490030583,'<h3>先上一张配好的图片</h3><p><img src=\"/ueditor/php/upload/image/20170321/1490030267575216.png\" title=\"1490030267575216.png\" alt=\"blob.png\"/></p><h3><strong>步骤</strong></h3><p><strong>修改nginx.conf配置文件</strong></p><pre class=\"brush:as3;toolbar:false\">location&nbsp;~&nbsp;\\.php$&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;html;&nbsp;&nbsp;&nbsp;#这个就是网站的根目录\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_pass&nbsp;&nbsp;&nbsp;127.0.0.1:9000;&nbsp;&nbsp;#这个是你的php-fpm监听的端口\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_index&nbsp;&nbsp;index.php;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_param&nbsp;&nbsp;SCRIPT_FILENAME&nbsp;&nbsp;/usr/local/nginx/html$fastcgi_script_name;&nbsp;&nbsp;&nbsp;#注意/usr/local/nginx/html是你的网站的根目录\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_params;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p><strong>修改配置文件后需要重新加载配置文件</strong></p><pre class=\"brush:as3;toolbar:false\">/usr/local/nginx/sbin/nginx&nbsp;-s&nbsp;reload</pre><p><strong>在html目录下建一个php文件</strong></p><pre class=\"brush:as3;toolbar:false\">&lt;?php\r\nphpinfo();</pre><p>通过浏览器访问以下吧，看到上面的图片里的内容，你就成功了。</p>','nginx','nginx支持php的配置','nginx支持php的最简配置','linux',0,19),(83,1490057149,1490057449,1490057149,'<p>								</p><h3>题记</h3><p>这一块的配置，就是虚拟机的配置。一个是默认虚拟主机，一个是我们正常需要提供服务的。</p><p>环境:</p><p>linux:CentOS release 6.5 (Final) (more /etc/issue查看）</p><p>nginx:nginx/1.10.3 &nbsp; (nginx -v查看,需要加环境变量)</p><p>php:PHP 5.5.38 (php -v查看，需要加环境变量</p><h3>步骤</h3><p><strong>在vhosts目录下（这个目录开始是需要自己创建的），创建default.conf。</strong></p><p>vim default.conf:</p><pre class=\"brush:as3;toolbar:false\">server\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;80&nbsp;default_server;&nbsp;#default_server，这样这个虚拟主机就是默认虚拟主机\r\n&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;localhost;\r\n&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;index.html&nbsp;index.htm&nbsp;index.php;\r\n&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;/tmp/1233;\r\n&nbsp;&nbsp;&nbsp;&nbsp;deny&nbsp;all;&nbsp;#拒绝所有访问\r\n}</pre><p><strong>配置完重新载入nginx配置文件：（最好先-t测试一下有没有语法错误）</strong></p><pre class=\"brush:as3;toolbar:false\">/etc/init.d/nginx&nbsp;reload</pre><p><strong>检测是否成功：</strong></p><pre class=\"brush:as3;toolbar:false\">curl&nbsp;-x127.0.0.1:80&nbsp;localhost&nbsp;&nbsp;#别忘了加端口号，否则不会成功</pre><p>如果发现403就对了：</p><p><img src=\"/ueditor/php/upload/image/20170321/1490056996290812.png\" title=\"1490056996290812.png\" alt=\"blob.png\"/></p><p><strong>然后再建立一个我们真实项目需要的配置文件，比如ruanwenwu.conf</strong></p><p>vim ruanwenwu.conf</p><pre class=\"brush:as3;toolbar:false\">server\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;80;\r\n&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;ruanwenwu.com;\r\n&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;index.html&nbsp;index.htm&nbsp;index.php;\r\n&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;/data/www;&nbsp;&nbsp;&nbsp;&nbsp;#这是你的项目根目录,如果没有需要创建，我创建了这个目录，还在里面写了个index.php\r\n&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;~&nbsp;\\.php$&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;fastcgi_params;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_pass&nbsp;127.0.0.1:9000;&nbsp;&nbsp;&nbsp;&nbsp;#注意这里fastcgi_pass，看你启动的fpm是端口+ip模式还是socket模式,如果是端口+ip,选这种，如果是sock模式选下面。\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#fastcgi_pass&nbsp;unix:/tmp/php-fcgi.sock;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_index&nbsp;index.php;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_param&nbsp;SCRIPT_FILENAME&nbsp;/data/www$fastcgi_script_name;&nbsp;#前面的部分改成你的项目根目录\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n}</pre><p><strong>检查配置文件</strong></p><pre class=\"brush:as3;toolbar:false\">/etc/init.d/nginx&nbsp;-t</pre><p><strong>如果没有语法错误，重新载入</strong></p><pre class=\"brush:as3;toolbar:false\">/etc/inti.d/nginx&nbsp;reload</pre><p><strong>看成功没有</strong></p><pre class=\"brush:as3;toolbar:false\">curl&nbsp;-x127.0.0.1&nbsp;ruanwenwu.com</pre><p><img src=\"http://ruanwenwu.cn/Public/plugin/ueditor/themes/default/images/spacer.gif\"/><img src=\"/ueditor/php/upload/image/20170321/1490057118783258.png\" title=\"1490057118783258.png\" alt=\"blob.png\"/></p><p><br/></p><p>							</p>','nginx','简单的nginx虚拟主机配置','常用的nginx的虚拟主机配置，最基本的哦','linux',0,24),(84,1490065620,1490065620,1490065620,'','心情','三毛说，偶尔有那么一丝小喜悦就是极好的了','人生不如意的事太多，偶尔有这样的体验就知足吧~','说说',0,25),(85,1490099956,1490186986,1490099956,'<p>								</p><h3>将原先的配置文件清空，用以下的替换：<br/></h3><p>vim /usr/local/php/etc/php-fpm.conf</p><pre class=\"brush:as3;toolbar:false\">[global]&nbsp;&nbsp;#全局配置&nbsp;\r\npid&nbsp;=&nbsp;/usr/local/php/var/run/php-fpm.pid&nbsp;\r\nerror_log&nbsp;=&nbsp;/usr/local/php/var/log/php-fpm.log\r\n[www]&nbsp;&nbsp;&nbsp;#池子名称，一个网站可用一个自己的池子名称，池子可以指定自己的用户和用户组，这样更加安全，能够避免一个网站的用户被窃取了，连带的别的网站也受影响。再就是如果一个池子挂了，不至于影响别的池子。&nbsp;\r\nlisten&nbsp;=&nbsp;/tmp/php-fcgi.sock#监听的socket，可以自定义比如：/tmp/www.sock&nbsp;\r\nuser&nbsp;=&nbsp;php-fpm&nbsp;#池子的用户&nbsp;\r\ngroup&nbsp;=&nbsp;php-fpm&nbsp;#池子的用户组&nbsp;\r\npm&nbsp;=&nbsp;dynamic&nbsp;#进程是动态还是静态。如果是static,那么pm.start_servers，pm.min_spare_servers,pm.max_spare_servers都将失效。只有pm.max_children生效。而且数量不会变。&nbsp;\r\npm.max_children&nbsp;=&nbsp;50&nbsp;\r\npm.start_servers&nbsp;=&nbsp;20&nbsp;\r\npm.min_spare_servers&nbsp;=&nbsp;5&nbsp;\r\npm.max_spare_servers&nbsp;=&nbsp;35&nbsp;\r\npm.max_requests&nbsp;=&nbsp;500&nbsp;\r\nrlimit_files&nbsp;=&nbsp;1024#这个可以适当提高\r\nslowlog&nbsp;=&nbsp;/tmp/www-slow.log#慢日志\r\nrequest_slowlog_timeout&nbsp;=&nbsp;1\r\nphp-admin-value[open_basedir]&nbsp;=&nbsp;/data/www/&nbsp;#注意，这个要以/结尾，如果值为/data/www，那么实际上限定的是data目录，用户仍然可以在data目录活动。</pre><p>这个slowlog很好用，配置了该项后，执行时间超过1秒的都会被记录到/tmp/www-slow.log中。这对排查问题特别好用。</p><p>b.php</p><h3><img src=\"/ueditor/php/upload/image/20170322/1490186893122948.png\" title=\"1490186893122948.png\" alt=\"blob.png\"/></h3><p>执行后，/tmp/www-slow.log就记录下来了（确实很强大啊）：<br/></p><p><img src=\"/ueditor/php/upload/image/20170322/1490186935131706.png\" title=\"1490186935131706.png\" alt=\"blob.png\"/></p><h3>下面附一个多个进程池子的配置的例子：<br/></h3><pre class=\"brush:as3;toolbar:false\">[global]\r\npid&nbsp;=&nbsp;/usr/local/php/var/run/php-fpm.pid\r\nerror_log&nbsp;=&nbsp;/usr/local/php/var/log/php-fpm.log\r\n[www]\r\nlisten&nbsp;=&nbsp;/tmp/www.sock\r\nuser&nbsp;=&nbsp;php-fpm\r\ngroup&nbsp;=&nbsp;php-fpm\r\npm&nbsp;=&nbsp;dynamic\r\npm.max_children&nbsp;=&nbsp;50\r\npm.start_servers&nbsp;=&nbsp;20\r\npm.min_spare_servers&nbsp;=&nbsp;5\r\npm.max_spare_servers&nbsp;=&nbsp;35\r\npm.max_requests&nbsp;=&nbsp;500\r\nrlimit_files&nbsp;=&nbsp;1024\r\n[www1]\r\nlisten&nbsp;=&nbsp;/tmp/www1.sock\r\nuser&nbsp;=&nbsp;php-fpm\r\ngroup&nbsp;=&nbsp;php-fpm\r\npm&nbsp;=&nbsp;dynamic\r\npm.max_children&nbsp;=&nbsp;50\r\npm.start_servers&nbsp;=&nbsp;20\r\npm.min_spare_servers&nbsp;=&nbsp;5\r\npm.max_spare_servers&nbsp;=&nbsp;35\r\npm.max_requests&nbsp;=&nbsp;500\r\nrlimit_files&nbsp;=&nbsp;1024</pre><p><img src=\"/ueditor/php/upload/image/20170321/1490099261493853.png\" title=\"1490099261493853.png\" alt=\"blob.png\"/></p><p>（www1的池子起来了）<br/></p><p><img src=\"/ueditor/php/upload/image/20170321/1490099286925169.png\" title=\"1490099286925169.png\" alt=\"blob.png\"/></p><p>(www的池子起来了）</p><h3>php-fpm的池子怎么跟nginx联合起来呢？</h3><p>只需要修改虚拟机的配置如下：</p><pre class=\"brush:as3;toolbar:false\">server\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;80;\r\n&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;111.com;\r\n&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;index.html&nbsp;index.htm&nbsp;index.php;\r\n&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;/data/www;\r\n&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;~&nbsp;\\.php$&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;fastcgi_params;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#fastcgi_pass&nbsp;127.0.0.1:9000;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_pass&nbsp;unix:/tmp/www.sock;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_index&nbsp;index.php;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_param&nbsp;SCRIPT_FILENAME&nbsp;/data/www$fastcgi_script_name;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n}</pre><p>重启nginx服务，访问网站，发现502了。为什么呢？</p><p>是因为nginx进程的执行用户是nobody，所以必须配置php-fpm配置文件，让php-fpm进程能够允许nobody用户。</p><p>修改php-fpm.conf文件：</p><p><img src=\"/ueditor/php/upload/image/20170321/1490103999566195.png\" title=\"1490103999566195.png\" alt=\"blob.png\"/></p><p>加上这两行，再访问就好了。</p><p>另外，项目的权限要给pool里的用户和用户组权限，在www这个池子里，就是php-fpm。</p><p><img src=\"/ueditor/php/upload/image/20170321/1490104456471097.png\" title=\"1490104456471097.png\" alt=\"blob.png\"/></p><p>有些项目把nginx的执行用户和组配成www,把所有的池子都配成www。</p><p>							</p>','php-fpm','php-fpm配置详解','简单又详细的php-fpm配置，一目了然','linux',0,23),(86,1490161849,1490165684,1490161849,'<p>								</p><h3>$_POST<br/></h3><p>只有Coentent-Type的值为application/x-<a href=\"http://www.form-urlencoded和multipart/form-data两种类型时，$_POST才能获取到数据。\">www.form-urlencoded和multipart/form-data两种类型时，$_POST才能获取到数据。</a></p><h3>$GLOBALS[&#39;HTTP_RAW_POST_DATA&#39;] 或者$HTTP_RAW_POST_DATA</h3><p>如果<a href=\"http://lib.csdn.net/base/php\" title=\"PHP知识库\" target=\"_blank\">PHP</a>无法识别Coentent-Type类型，也就无法获取请求数据，这个时候，可以用$GLOBALS[&#39;HTTP_RAW_POST_DATA&#39;]来获取。</p><h3>php://input</h3><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>&nbsp;从使用结果看，php://input与$GLOBALS[&#39;HTTP_RAW_POST_DATA&#39;]的功能是一样的，但是，php://input需要的内存比较小，并且它不受 php.ini 配置文件的限制。</p></li><li><p>如果Coentent-Type的类型为multipart/form-data，使用php://input和$GLOBALS[&#39;HTTP_RAW_POST_DATA&#39;]是获取不到数据的，除此之外，php://input都能获取到数据。</p></li><li><p>&nbsp;仅当Coentent-Type的类型为application/x-www.form-urlencoded时，使用php://input和$_POST获取到的数据才是一致的。</p></li><li><p>&nbsp;使用方式：使用file_get_contents(&#39;php://input&#39;)获取请求数据。</p></li></ol><p>一段通过curl发送json数据的代码</p><p>请求页面：<br/></p><pre class=\"brush:as3;toolbar:false\">&lt;?php\r\nurl&nbsp;=&nbsp;&quot;http://test.ruanwenwu.cn/test2.php&quot;;\r\n$data&nbsp;=&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&quot;id&quot;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;&nbsp;3,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&quot;photo&quot;&nbsp;=&gt;&nbsp;&nbsp;array(&quot;pic1&quot;,&quot;pic2&quot;,&quot;pic3&quot;),\r\n);\r\n$data&nbsp;=&nbsp;json_encode($data);\r\n$ch&nbsp;=&nbsp;curl_init();\r\ncurl_setopt($ch,&nbsp;CURLOPT_POST,&nbsp;1);\r\ncurl_setopt($ch,&nbsp;CURLOPT_URL,&nbsp;$url);\r\ncurl_setopt($ch,&nbsp;CURLOPT_POSTFIELDS,&nbsp;$data);\r\ncurl_setopt(&nbsp;$ch,&nbsp;CURLOPT_SSL_VERIFYPEER,&nbsp;false&nbsp;);\r\ncurl_setopt(&nbsp;$ch,&nbsp;CURLOPT_SSL_VERIFYHOST,&nbsp;false&nbsp;);\r\ncurl_setopt($ch,&nbsp;CURLOPT_HTTPHEADER,&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&#39;Content-Type:&nbsp;application/json;&nbsp;charset=gbk&#39;,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&#39;Content-Length:&nbsp;&#39;.strlen($data))\r\n);\r\n$result&nbsp;=&nbsp;curl_exec($ch);\r\n?&gt;</pre><p>接收页面：</p><pre class=\"brush:as3;toolbar:false\">&lt;?php\r\n$data&nbsp;=&nbsp;file_get_contents(&#39;php://input&#39;);\r\nfile_put_contents(&quot;ruanwenwue.txt&quot;,&nbsp;$data);die;\r\n$data&nbsp;=&nbsp;json_decode($HTTP_RAW_POST_DATA);\r\n//file_put_contents(&quot;ruanwenwu.txt&quot;,&nbsp;$data-&gt;id);\r\nfile_put_contents(&quot;ruanwenwud.txt&quot;,$HTTP_RAW_POST_DATA);</pre><p>因为请求的无法打印，我就直接写入文件了。接收到的json数据需要json_decode之后使用。</p><h3 style=\"white-space: normal;\">补充：什么是x-<a href=\"http://www.form-urlencode/?\">www.form-urlencode?</a></h3><p style=\"white-space: normal;\">看这个表单：</p><pre class=\"brush:as3;toolbar:false\">&lt;?php\r\n&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;Content-type:text/html;charset=gbk&quot;);&nbsp;\r\n?&gt;\r\n&lt;form&nbsp;action&nbsp;=&quot;/test.php&quot;&nbsp;method=&quot;post&quot;&gt;\r\n用户名：&lt;input&nbsp;type=&quot;text&quot;&nbsp;name=&quot;username&quot;&nbsp;/&gt;&lt;br/&gt;\r\n密码：&lt;input&nbsp;type=&quot;password&quot;&nbsp;name=&quot;password&quot;&nbsp;/&gt;&lt;br/&gt;\r\n&lt;input&nbsp;type=&quot;submit&quot;&nbsp;value=&quot;提交&quot;&nbsp;/&gt;\r\n&lt;/form&gt;</pre><p style=\"white-space: normal;\"><img src=\"http://ruanwenwu.cn/ueditor/php/upload/image/20170322/1490165477395726.png\" title=\"1490165477395726.png\" alt=\"blob.png\"/></p><p style=\"white-space: normal;\">通过post请求过去，没有发送图片的情况下，就是application/x-www-form-urlencoded</p><p><br/></p><p>							</p>','php://input','$_POST,$GLOBALS[\'HTTP_RAW_POST_DATA\']和php://input的区别','接受数据时常会用到的几个东西，做了几个小实验，记录一下。','php',0,23),(87,1490188020,1490310638,1490188020,'<p>								</p><h3>客户端设计图</h3><p><img src=\"/ueditor/php/upload/image/20170322/1490187120560655.png\" title=\"1490187120560655.png\" alt=\"blob.png\"/></p><h3>php需要捕获这些数据，包括图片，入库。</h3><p>客户端最终传输的数据格式：</p><p><img src=\"/ueditor/php/upload/image/20170322/1490187208572030.png\" title=\"1490187208572030.png\" alt=\"blob.png\"/></p><p>注意：photo是去掉了图片类型和base64标志的base64数据格式：</p><p><img src=\"/ueditor/php/upload/image/20170322/1490187266302922.png\" title=\"1490187266302922.png\" alt=\"blob.png\"/>（完整格式）</p><p>客户端怎么传的我不懂，如果用Php模拟提交这部分数据的话是这样：</p><pre class=\"brush:as3;toolbar:false\">$url&nbsp;=&nbsp;&quot;http://ask.rww.com.cn/test2.php&quot;;\r\n$data&nbsp;=&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&quot;id&quot;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;&nbsp;3,\r\n&nbsp;&nbsp;&nbsp;&nbsp;&quot;photo&quot;&nbsp;=&gt;&nbsp;&nbsp;array(&quot;pic1&quot;,&quot;pic2&quot;,&quot;pic3&quot;),\r\n);\r\n$data&nbsp;=&nbsp;json_encode($data);#注意，这里转换成json格式了。\r\n$ch&nbsp;=&nbsp;curl_init();\r\ncurl_setopt($ch,&nbsp;CURLOPT_POST,&nbsp;1);\r\ncurl_setopt($ch,&nbsp;CURLOPT_URL,&nbsp;$url);\r\ncurl_setopt($ch,&nbsp;CURLOPT_POSTFIELDS,&nbsp;$data);\r\ncurl_setopt(&nbsp;$ch,&nbsp;CURLOPT_SSL_VERIFYPEER,&nbsp;false&nbsp;);\r\ncurl_setopt(&nbsp;$ch,&nbsp;CURLOPT_SSL_VERIFYHOST,&nbsp;false&nbsp;);\r\ncurl_setopt($ch,&nbsp;CURLOPT_HTTPHEADER,&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&#39;Content-Type:&nbsp;application/json;&nbsp;charset=gbk&#39;,#头上指定了格式\r\n&nbsp;&nbsp;&nbsp;&nbsp;&#39;Content-Length:&nbsp;&#39;.strlen($data))\r\n);\r\n$result&nbsp;=&nbsp;curl_exec($ch);</pre><h3>php收到数据后的处理：</h3><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p>通过php://input或者$HTTP_RAW_POST_DATA接收原始数据。json_decode成对象以供使用。伪代码：</p><p>$data = json_decode($HTTP_RAW_POST_DATA)；</p></li><li><p>下载图片。</p></li></ol><pre class=\"brush:as3;toolbar:false\">$img&nbsp;=&nbsp;array();\r\nforeach&nbsp;($data-&gt;photo&nbsp;as&nbsp;$key=&gt;$val){\r\n	$str&nbsp;&nbsp;&nbsp;=&nbsp;&quot;data:image/png;base64,&quot;;&nbsp;&nbsp;&nbsp;&nbsp;//加上头信息，如果有就不需要了\r\n	$str&nbsp;&nbsp;.=&nbsp;$val;\r\n	$img1&nbsp;=&nbsp;down(array(\r\n		&#39;base64Str&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;$str,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#base64的字符串\r\n	));\r\n	$img[]&nbsp;=&nbsp;$img1;\r\n}\r\n\r\nfunction&nbsp;down($paramArr){\r\n&nbsp;&nbsp;&nbsp;&nbsp;$options&nbsp;=&nbsp;array(\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;base64Str&#39;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;&nbsp;false,&nbsp;#base64的字符串&nbsp;格式为data:image/png;base64,\r\n&nbsp;&nbsp;&nbsp;&nbsp;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(is_array($paramArr))$options&nbsp;=&nbsp;array_merge($options,&nbsp;$paramArr);\r\n&nbsp;&nbsp;&nbsp;&nbsp;extract($options);\r\n&nbsp;&nbsp;&nbsp;&nbsp;if(!$base64Str)return&nbsp;false;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;$pos&nbsp;=&nbsp;strpos($base64Str,&nbsp;&#39;;base64,&#39;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;if(!$pos)return&nbsp;false;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;$data&nbsp;=&nbsp;base64_decode(substr($base64Str,&nbsp;$pos+8));\r\n&nbsp;&nbsp;&nbsp;&nbsp;$ext&nbsp;&nbsp;=&nbsp;trim(str_replace(&quot;data:image/&quot;,&nbsp;&quot;&quot;,substr($base64Str,&nbsp;0,$pos)));\r\n&nbsp;&nbsp;&nbsp;&nbsp;$tmpFile&nbsp;=&nbsp;&quot;/tmp/&quot;.SYSTEM_TIME&nbsp;.&nbsp;rand(0,&nbsp;1000)&nbsp;.&nbsp;&quot;.&quot;.$ext;\r\n&nbsp;&nbsp;&nbsp;&nbsp;file_put_contents($tmpFile,&nbsp;$data);\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$tmpFile;&nbsp;\r\n}</pre><p><br/></p><p>							</p>','base64','与客户端配合做数据写入（包括图片处理）','客户端传输json数据到php，php入库操作。','php',0,18),(88,1490192202,1490273082,1490192202,'<p>								</p><h3>最后的效果：</h3><p><img src=\"/ueditor/php/upload/image/20170322/1490191768608433.png\" title=\"1490191768608433.png\" alt=\"blob.png\"/></p><h3>配置：</h3><p>cat /usr/local/nginx/conf/vhosts/111.conf</p><p>server</p><p>{</p><p>&nbsp; &nbsp; listen 80;</p><p>&nbsp; &nbsp; server_name www.111.com;</p><p>&nbsp; &nbsp; index index.html index.htm index.php;</p><p>&nbsp; &nbsp; root /data/www/upload;</p><p><br/></p><p><span style=\"color: rgb(255, 0, 0);\">&nbsp; &nbsp; location ~ .*admin\\.php$ {</span></p><p><span style=\"color: rgb(255, 0, 0);\"><span class=\"Apple-tab-span\" style=\"color: rgb(255, 0, 0); white-space: pre;\"></span>auth_basic &quot;ruanwenwu auth&quot;;</span></p><p><span style=\"color: rgb(255, 0, 0);\"><span class=\"Apple-tab-span\" style=\"color: rgb(255, 0, 0); white-space: pre;\"></span>auth_basic_user_file /usr/local/nginx/conf/.htpasswd;</span></p><p><span style=\"color: rgb(255, 0, 0);\">&nbsp; &nbsp; }</span></p><p><span style=\"white-space: pre; color: rgb(255, 0, 0);\"></span></p><p><br/></p><p>&nbsp; &nbsp; location ~ \\.php$ {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; include fastcgi_params;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; #fastcgi_pass 127.0.0.1:9000; &nbsp; &nbsp; &nbsp; &nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; fastcgi_pass unix:/tmp/www.sock;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; fastcgi_index index.php;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; fastcgi_param SCRIPT_FILENAME /data/www/upload$fastcgi_script_name;</p><p>&nbsp; &nbsp; }</p><p><br/></p><p>}</p><h3>就是红色的部分起的作用。其中/usr/local/ngin/conf/.htpasswd是这样生成的：</h3><p><img src=\"/ueditor/php/upload/image/20170323/1490272994744213.png\" title=\"1490272994744213.png\" alt=\"blob.png\"/></p><p>简单说明：先找到htpasswd文件。如果没有的话，有两种方式生成，一种是编译安装apache,一种是yum install -y httpd。找到htpasswd后，运行生成密码文件的命令。这个过程需要重复输入密码。最后cat查看的结果是最后一行。</p><h3>但是这样有个问题，就是授权后（登陆），admin.php会被下载，这简直太可怕了。这是因为这个规则不能解析php.</h3><p><img src=\"/ueditor/php/upload/image/20170322/1490191958876201.png\" title=\"1490191958876201.png\" alt=\"blob.png\"/>(下载了）</p><p>怎么办?答案是让这部分配置支持php解析就好了，将配置文件修改如下：</p><p>server</p><p>{</p><p>&nbsp; &nbsp; listen 80;</p><p>&nbsp; &nbsp; server_name www.111.com;</p><p>&nbsp; &nbsp; index index.html index.htm index.php;</p><p>&nbsp; &nbsp; root /data/www/upload;</p><p><br/></p><p><span style=\"color: rgb(255, 0, 0);\">&nbsp; &nbsp; location ~ .*admin\\.php$ {</span></p><p><span style=\"color: rgb(255, 0, 0);\"><span class=\"Apple-tab-span\" style=\"color: rgb(255, 0, 0); white-space: pre;\"></span>auth_basic &quot;ruanwenwu auth&quot;;</span></p><p><span style=\"color: rgb(255, 0, 0);\"><span class=\"Apple-tab-span\" style=\"color: rgb(255, 0, 0); white-space: pre;\"></span>auth_basic_user_file /usr/local/nginx/conf/.htpasswd;</span></p><p><span style=\"color: rgb(255, 0, 0);\">&nbsp; &nbsp; &nbsp; &nbsp; include fastcgi_params;</span></p><p><span style=\"color: rgb(255, 0, 0);\">&nbsp; &nbsp; &nbsp; &nbsp; fastcgi_pass unix:/tmp/www.sock;</span></p><p><span style=\"color: rgb(255, 0, 0);\">&nbsp; &nbsp; &nbsp; &nbsp; fastcgi_index index.php;</span></p><p><span style=\"color: rgb(255, 0, 0);\">&nbsp; &nbsp; &nbsp; &nbsp; fastcgi_param SCRIPT_FILENAME /data/www/upload$fastcgi_script_name;</span></p><p><span style=\"color: rgb(255, 0, 0);\">&nbsp; &nbsp; }</span></p><p><span style=\"white-space: pre; color: rgb(255, 0, 0);\"></span></p><p><br/></p><p>&nbsp; &nbsp; location ~ \\.php$ {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; include fastcgi_params;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; #fastcgi_pass 127.0.0.1:9000; &nbsp; &nbsp; &nbsp; &nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; fastcgi_pass unix:/tmp/www.sock;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; fastcgi_index index.php;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; fastcgi_param SCRIPT_FILENAME /data/www/upload$fastcgi_script_name;</p><p>&nbsp; &nbsp; }</p><p><br/></p><p>}</p><p>这样就正常了，不会再下载了。</p><p>							</p>','安全','nginx用户认证','反正就是更安全了，看看就知道。','linux',0,31),(89,1490238898,1490238898,1490238898,'<h3>一、问题：</h3><p>安装wordpress时，跟着安装操作指引，到数据库配置时，一直出错。</p><h3>二、解决办法</h3><p>在数据库里创建名为wordpress的数据库，然后再继续安装，果断成功了。</p><h3>三、评论</h3><p>这个安装程序不太智能，数据库不能自动创建啊。</p><h3>四、上线地址</h3><p><a href=\"http://wss.ruanwenwu.cn\" target=\"_blank\" title=\"王珊珊的网络日志\">王珊珊的网络日志</a></p>','wordpress','安装wordpress时遇到的一个坑','安装wordpress时，跟着安装操作指引，到数据库配置时，一直出错。','php',0,22),(90,1490247582,1490318917,1490247582,'<p>								</p><h3>一、问题<br/></h3><p>这两天写的文章有点多。搜索服务没有做增量索引，也没有做每天的计划任务跑全部索引，新写的文章搜不到，所以中午抽一点时间把搜索功能完善一下。</p><h3>二、几个概念</h3><p>索引（一般是所有数据的索引）：就是你的数据源的所有的数据源（source）的集合。</p><p>增量索引：索引生成后，文章还在继续增加中。这时候就用到增量索引了。php查询的时候，可以用到这一部分，这就保证新加入的数据能够被搜索到。</p><p>主索引：就是数据量多的那个。</p><h3>三、解决步骤</h3><ol class=\" list-paddingleft-2\" style=\"list-style-type: decimal;\"><li><p><strong>原来的索引记录到id为76的文章了。原本可以重新索引一下，但是这样每次重新索引的话，1来数据量大的话是很慢的，2来不及时。</strong></p><p>原来的main source的索引sql为：</p><p>SELECT id,title,summary,content,ctime,mtime,category from z_post</p><p>上面这个sql是生成全部数据的索引，如果考虑到增量索引就需要修改成这样：</p><p>SELECT id,title,summary,content,ctime,mtime,category from z_post WHERE id&lt;=( SELECT max_doc_id FROM sph_counter WHERE counter_id=1 )</p><p>对应的delta source（增量索引源）的sql需要进行配置（这是在没有增量索引的基础上增加的部分）：</p></li></ol><pre class=\"brush:as3;toolbar:false\">source&nbsp;delta&nbsp;:&nbsp;main\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_query_pre&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;SET&nbsp;NAMES&nbsp;utf8\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_query&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;z_post&nbsp;WHERE&nbsp;id&gt;(&nbsp;SELECT&nbsp;max_doc_id&nbsp;FROM&nbsp;sph_counter&nbsp;WHERE&nbsp;counter_id=1&nbsp;)\r\n&nbsp;&nbsp;&nbsp;&nbsp;#sql_query_post_index&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;REPLACE&nbsp;INTO&nbsp;sph_counter&nbsp;SELECT&nbsp;1,MAX(id)&nbsp;FROM&nbsp;z_post&nbsp;&nbsp;#这个貌似注释才行\r\n}</pre><p>&nbsp;&nbsp;&nbsp;&nbsp;除了配置数据源之外，delta源的index配置也需要增加：<br/></p><pre class=\"brush:as3;toolbar:false\">index&nbsp;delta&nbsp;:&nbsp;main\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;delta\r\n&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;/usr/local/coreseek/var/data/delta/delta\r\n}</pre><p>最终的配置文件：<br/></p><pre class=\"brush:as3;toolbar:false\">#MySQL数据源配置，详情请查看：http://www.coreseek.cn/products-install/mysql/\r\n#请先将var/test/documents.sql导入数据库，并配置好以下的MySQL用户密码数据库\r\n#源定义\r\nsource&nbsp;main\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;mysql\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_host&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;localhost\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_user&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;root\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_pass&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;7DMKne22\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_db&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;blog\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3306\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_query_pre&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;SET&nbsp;NAMES&nbsp;utf8\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_query_pre&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;REPLACE&nbsp;INTO&nbsp;sph_counter&nbsp;SELECT&nbsp;1,MAX(id)&nbsp;FROM&nbsp;z_post&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_query&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;SELECT&nbsp;id,title,summary,content,ctime,mtime,category&nbsp;from&nbsp;z_post&nbsp;WHERE&nbsp;id&lt;=(&nbsp;SELECT&nbsp;max_doc_id&nbsp;FROM&nbsp;sph_counter&nbsp;WHERE&nbsp;counter_id=1&nbsp;)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#sql_query第一列id需为整数\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#title、content作为字符串/文本字段，被全文索引\r\n&nbsp;&nbsp;&nbsp;&nbsp;#sql_attr_uint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;group_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#从SQL读取到的值必须为整数\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_attr_timestamp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ctime&nbsp;#从SQL读取到的值必须为整数，作为时间属性\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_attr_timestamp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;mtime&nbsp;#从SQL读取到的值必须为整数，作为时间属性\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_query_info_pre&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;SET&nbsp;NAMES&nbsp;utf8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#命令行查询时，设置正确的字符集\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_query_info&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;SELECT&nbsp;*&nbsp;from&nbsp;z_post&nbsp;WHERE&nbsp;id=$id&nbsp;#命令行查询时，从数据库读取原始数据信息\r\n}\r\nsource&nbsp;delta&nbsp;:&nbsp;main&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_query_pre&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;SET&nbsp;NAMES&nbsp;utf8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_query&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;SELECT&nbsp;id,title,summary,content,ctime,mtime,category&nbsp;FROM&nbsp;z_post&nbsp;WHERE&nbsp;id&gt;(&nbsp;SELECT&nbsp;max_doc_id&nbsp;FROM&nbsp;sph_counter&nbsp;WHERE&nbsp;counter_id=1&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;sql_query_post_index&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;REPLACE&nbsp;INTO&nbsp;sph_counter&nbsp;SELECT&nbsp;1,MAX(id)&nbsp;FROM&nbsp;z_post&nbsp;\r\n}&nbsp;\r\n#index定义\r\nindex&nbsp;main\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;main&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#对应的source名称\r\n&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;/usr/local/coreseek/var/data/mysql/mysql&nbsp;#请修改为实际使用的绝对路径，例如：/usr/local/coreseek/var/...\r\n&nbsp;&nbsp;&nbsp;&nbsp;docinfo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;extern\r\n&nbsp;&nbsp;&nbsp;&nbsp;mlock&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;0\r\n&nbsp;&nbsp;&nbsp;&nbsp;morphology&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;none\r\n&nbsp;&nbsp;&nbsp;&nbsp;min_word_len&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1\r\n&nbsp;&nbsp;&nbsp;&nbsp;html_strip&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;0\r\n&nbsp;&nbsp;&nbsp;&nbsp;#中文分词配置，详情请查看：http://www.coreseek.cn/products-install/coreseek_mmseg/\r\n&nbsp;&nbsp;&nbsp;&nbsp;charset_dictpath&nbsp;=&nbsp;/usr/local/mmseg/etc/&nbsp;#BSD、Linux环境下设置，/符号结尾\r\n&nbsp;&nbsp;&nbsp;&nbsp;#charset_dictpath&nbsp;=&nbsp;etc/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Windows环境下设置，/符号结尾，最好给出绝对路径，例如：C:/usr/local/coreseek/etc/...\r\n&nbsp;&nbsp;&nbsp;&nbsp;charset_type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;zh_cn.utf-8\r\n}\r\nindex&nbsp;delta&nbsp;:&nbsp;main&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;delta&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;/usr/local/coreseek/var/data/delta/delta&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n}&nbsp;&nbsp;&nbsp;&nbsp;\r\n#全局index定义\r\nindexer\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;mem_limit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;128M\r\n}\r\n#searchd服务定义\r\nsearchd\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;&nbsp;9312\r\n&nbsp;&nbsp;&nbsp;&nbsp;read_timeout&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;5\r\n&nbsp;&nbsp;&nbsp;&nbsp;max_children&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;30\r\n&nbsp;&nbsp;&nbsp;&nbsp;max_matches&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1000\r\n&nbsp;&nbsp;&nbsp;&nbsp;seamless_rotate&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;0\r\n&nbsp;&nbsp;&nbsp;&nbsp;preopen_indexes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;0\r\n&nbsp;&nbsp;&nbsp;&nbsp;unlink_old&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1\r\n&nbsp;&nbsp;&nbsp;&nbsp;pid_file&nbsp;=&nbsp;/usr/local/coreseek/var/log/searchd_mysql.pid&nbsp;&nbsp;#请修改为实际使用的绝对路径，例如：/usr/local/coreseek/var/...\r\n&nbsp;&nbsp;&nbsp;&nbsp;log&nbsp;=&nbsp;/usr/local/coreseek/var/log/searchd_mysql.log&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#请修改为实际使用的绝对路径，例如：/usr/local/coreseek/var/...\r\n&nbsp;&nbsp;&nbsp;&nbsp;query_log&nbsp;=&nbsp;/usr/local/coreseek/var/log/query_mysql.log&nbsp;#请修改为实际使用的绝对路径，例如：/usr/local/coreseek/var/...\r\n}</pre><p><strong>2.建计数表：sph_counter,就两个字段，值分别为1和当前索引到的位置</strong><br/></p><p>&nbsp; &nbsp;&nbsp;<img src=\"/ueditor/php/upload/image/20170323/1490247115156226.png\" title=\"1490247115156226.png\" alt=\"blob.png\"/></p><p><strong>3.生成delta索引：</strong></p><p><span style=\"margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;\"><span style=\"margin: 0px; padding: 0px; border: none; background-color: inherit;\">/usr/local/coreseek/bin/indexer&nbsp;-c&nbsp;/usr/local/coreseek/etc/csft_mysql.conf&nbsp;delta&nbsp;--rotate &nbsp;</span></span></p><p><strong><span style=\"margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;\"><span style=\"margin: 0px; padding: 0px; border: none; background-color: inherit;\">4.关掉当前正在运行的搜索服务</span></span></strong></p><p><span style=\"color: black; margin: 0px; padding: 0px; border: none; background-color: inherit;\">/usr/local/coreseek/bin/searchd&nbsp;-c&nbsp;/usr/local/coreseek/etc/csft_mysql.conf&nbsp;--stop</span></p><p><strong><span style=\"color: black; margin: 0px; padding: 0px; border: none; background-color: inherit;\">5.重新开启（开启前我新建了delta数据源的目录/usr/local/coreseek/var/data/delta/）</span></strong></p><p><span style=\"color: black; margin: 0px; padding: 0px; border: none; background-color: inherit;\">&nbsp;/usr/local/coreseek/bin/searchd&nbsp;-c&nbsp;/usr/local/coreseek/etc/csft_mysql.conf</span></p><p><span style=\"color: black; margin: 0px; padding: 0px; border: none; background-color: inherit;\">开启后，php部分在查询的时候，带上delta源发现已经有数据了，而且max_doc_id从75变成了89,这说明增量索引生成成功，并且服务正常。</span></p><p><strong><span style=\"color: black; margin: 0px; padding: 0px; border: none; background-color: inherit;\">6.将下面这些加入到计划任务</span></strong></p><p><br/></p><ol style=\"padding: 0px; border: none; list-style-position: initial; list-style-image: initial; background-color: rgb(255, 255, 255); color: rgb(92, 92, 92); font-family: Consolas, &quot;Courier New&quot;, Courier, mono, serif; font-size: 12px; white-space: normal; margin-bottom: 1px !important; margin-left: 45px !important;\" class=\" list-paddingleft-2\"><li><p><span style=\"color: black; margin: 0px; padding: 0px; border: none; background-color: inherit;\">*/1&nbsp;*&nbsp;*&nbsp;*&nbsp;* &nbsp;/usr/local/coreseek/bin/indexer&nbsp;-c&nbsp;/usr/local/coreseek/etc/csft_mysql.conf&nbsp;delta&nbsp;--rotate&nbsp;&nbsp;&nbsp;&nbsp;</span></p></li><li><p><span style=\"color: black; margin: 0px; padding: 0px; border: none; background-color: inherit;\">*/5&nbsp;*&nbsp;*&nbsp;*&nbsp;* &nbsp;/usr/local/coreseek/bin/indexer&nbsp;-c&nbsp;/usr/local/coreseek/etc/csft_mysql.conf&nbsp;--merge&nbsp;main&nbsp;delta&nbsp;--rotate&nbsp;--merge-dst-range&nbsp;deleted&nbsp;0&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp; #这个开启了有问题，后台注释掉了<br/></span></p></li><li><p><span style=\"color: black; margin: 0px; padding: 0px; border: none; background-color: inherit;\">30&nbsp;1&nbsp;*&nbsp;*&nbsp;* &nbsp; /usr/local/coreseek/bin/indexer&nbsp;-c&nbsp;/usr/local/coreseek/etc/csft_mysql.conf&nbsp;--all&nbsp;--rotate &nbsp;</span></p></li></ol><p>它们代表，每分钟执行一次增量索引，每五分钟合并一次索引，每天1点30分执行一次全部索引。</p><p><br/></p><p><br/></p><p>							</p>','coreseek','搜索服务安装了增量索引，索引合并，和重新索引','这两天写的文章有点多。搜索服务没有做增量索引，也没有做每天的计划任务跑全部索引，新写的文章搜不到，所以中午抽一点时间把搜索功能完善一下。','php',0,23),(94,1490277857,1490277857,1490277857,'<h3>先看一张配置成功的图片：</h3><p><img src=\"/ueditor/php/upload/image/20170323/1490276314949841.png\" title=\"1490276314949841.png\" alt=\"blob.png\"/></p><p>（浏览器中输入<a href=\"http://www.test.com,发现马上跳到www.111.com了。而跳到www.111.com/forum.php是程序在index.php里做了跳转）。\">www.test.com,发现马上跳到www.111.com了。而跳到www.111.com/forum.php是程序在index.php里做了跳转）。</a> </p><h3>配置（写在server里）</h3><pre class=\"brush:as3;toolbar:false\">if&nbsp;($host&nbsp;!=&nbsp;&#39;www.111.com&#39;)\r\n{\r\n&nbsp;&nbsp;&nbsp;rewrite&nbsp;^/(.*)$&nbsp;http://www.111.com/$1&nbsp;permanent;\r\n}</pre><p>实际上用的是nginx的rewrite模块。<span style=\"color: rgb(255, 0, 0);\">rewrite可以用在if里，server里，location里。</span>nginx的rewrite模块分成四个部分：</p><p>最左侧：rewrite关键词。</p><p>其次：匹配的规则如：^/(.*)$。</p><p>接着是：匹配的url要跳转的地方，$1代表上一部分的匹配规则中的第一个括号的内容。</p><p>第四部分：flag。常用的flag有：</p><p>&nbsp;&nbsp;&nbsp;&nbsp;permanent 永久重定向301 &nbsp;<span style=\"color: rgb(255, 0, 0);\">浏览器地址跳转</span><br/></p><p>&nbsp;&nbsp;&nbsp;&nbsp;redirect 临时重定向302 &nbsp;<span style=\"color: rgb(255, 0, 0);\">浏览器地址跳转</span><br/></p><p>&nbsp;&nbsp;&nbsp;&nbsp;last/break 都表示结束匹配 &nbsp;<span style=\"color: rgb(255, 0, 0);\">浏览器地址不跳转</span><br/></p><h3>几个rewrite的实例</h3><pre class=\"brush:as3;toolbar:false\">if&nbsp;($http_user_agent&nbsp;~&nbsp;MSIE)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;rewrite&nbsp;^(.*)$&nbsp;/nginx-ie/$1&nbsp;break;\r\n}</pre><p>这个rewrite的意思是，如果user_agent里包含MSIE就跳到nginx-ie这个目录下。</p><h3>补充知识点：</h3><pre class=\"brush:as3;toolbar:false\">~&nbsp;为区分大小写匹配\r\n~*&nbsp;为不区分大小写匹配\r\n!~和!~*分别为区分大小写不匹配及不区分大小写不匹\r\n-f和!-f用来判断是否存在文件\r\n-d和!-d用来判断是否存在目录\r\n-e和!-e用来判断是否存在文件或目录\r\n-x和!-x用来判断文件是否可执行</pre><p>上面这几条知识点好像挺难记，但是还是有规律的。~表示匹配 ！~表示不匹配，*表示不区分大小写。这样前面3条就都记住了。f表示文件，d表示目录，e代表exist，x表示chmod里的x，！表示否，这样后面的也就都记住 了。现在回头来看$http_user_agent ~MSIE,意思就是如果user_agent区分大小写匹配MSIE成立的话。</p><p><br/></p>','重定向','nginx实现重定向','使用nginx实现301,302重定向的方法','linux',0,26),(95,1490311246,1490311246,1490311246,'<h3>一、在nginx全局配置的http部分增加如下配置：</h3><p>vim /usr/local/nginx/conf/nginx.conf<br/></p><pre class=\"brush:as3;toolbar:false\">&nbsp;log_format&nbsp;ruanwenwu&nbsp;&#39;$remote_addr&nbsp;$http_x_forwarded_for&nbsp;[$time_local]&#39;\r\n&nbsp;&#39;&nbsp;$host&nbsp;&quot;$request_uri&quot;&nbsp;$status&nbsp;&#39;\r\n&nbsp;&#39;&quot;$http_referer&quot;&nbsp;&quot;$http_user_agent&quot;&#39;;</pre><p>注意，上面这三行连起来是一句，结尾用分号别忘了。简单解释：log_format是定义日志格式，ruanwenwu相当于是日志格式的变量名，后面的一长串代表记录的日志的内容。</p><p>$remote_addr 真实ip</p><p>$http_x_forwarded_for 代理ip</p><p>$time_local 时间 ,注意这两个[]只是格式化显示的作用，没有语法意义。这中间的双引号也是，只是为了显示的时候带上，下面是这条规则捉到的日志。没有代理ip好像用-（横杠）来代替了。</p><pre class=\"brush:as3;toolbar:false\">45.117.156.124&nbsp;-&nbsp;[23/Mar/2017:23:26:18&nbsp;+0800]www.ruanwenwu.cn&nbsp;&quot;/&quot;&nbsp;200&quot;http://www.ruanwenwu.cn&quot;&nbsp;&quot;Mozilla/5.0&nbsp;(Windows&nbsp;NT&nbsp;6.1;&nbsp;WOW64)&nbsp;AppleWebKit/537.36&nbsp;(KHTML,&nbsp;like&nbsp;Gecko)&nbsp;Chrome/39.0.2171.95&nbsp;Safari/537.36&quot;</pre><h3>二、然后在虚拟主机的server上增加配置</h3><p>vim /usr/local/nginx/conv/vhosts/111.conf</p><pre class=\"brush:as3;toolbar:false\">access_log&nbsp;/data/wwwlogs/access_log.ruanwenwu.cn.log&nbsp;ruanwenwu;#结尾的这个ruanwenwu就是我们在全局http配置中设置的日志变量。</pre><p>其实加上这一行，再重新加载我们的配置文件就好了。但是这样有一个问题，css和js或者图片的访问日志都会记录下来，这不是我们想要的。所以需要配置，让这些文件不作记录。配置部分如下：</p><pre class=\"brush:as3;toolbar:false\">&nbsp;location&nbsp;~&nbsp;.*\\.(gif|jpg|jpeg|png|bmp|swf|flv|ico)$&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expires&nbsp;30d;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;off;\r\n&nbsp;}\r\n&nbsp;location&nbsp;~&nbsp;.*\\.(js|css)$&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expires&nbsp;7d;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;off;\r\n&nbsp;}</pre><p>注：~表示区分大小写匹配，这个我在上一篇文章<a href=\"/blog/94.html\" target=\"_self\">nginx实现重定向</a>里总结过了。</p><p>上面这两句的意思是，如果访问地址匹配到图片（任意格式）或者css或者js,一律不记录日志。一句access_log off;就搞定了。expires 30d;代表30天过期的缓存。</p><p>最后附上相关配置：</p><p>虚拟主机（不包含php解析部分）：</p><pre class=\"brush:as3;toolbar:false\">server&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;80;\r\n&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;ruanwenwu.cn&nbsp;www.ruanwenwu.cn;\r\n&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;/xxx/xxx/access_log.ruanwenwu.cn.log&nbsp;ruanwenwu;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;/data/xxx/blog;\r\n&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;index.html&nbsp;index.htm&nbsp;index.php;\r\n&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;~&nbsp;.*\\.(gif|jpg|jpeg|png|bmp|swf|flv|ico)$&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expires&nbsp;30d;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;off;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;~&nbsp;.*\\.(js|css)?$&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expires&nbsp;7d;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;off;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n}</pre><p><br/></p>','日志','nginx访问日志（与不记录指定类型日志）','访问日志对于我们监听网站流量来自什么地方特别有用。','linux',0,15),(96,1490314449,1490318321,1490314449,'<p>								</p><h3>一、不是废话的废话</h3><p>nginx不像apache一样自带切割日志的方法——此刻有没有觉得apache高大上？^_^——。说到apache，顺便贴一下apache切割日志的方法：</p><pre class=\"brush:as3;toolbar:false\">&lt;VirtualHost&nbsp;*:80&gt;\r\n&nbsp;&nbsp;&nbsp;&nbsp;CustomLog&nbsp;&quot;|/usr/local/apache2/bin/rotatelogs&nbsp;-l&nbsp;/usr/local/apache2/logs/mydiscuz.com-access.com-access_%Y%m%d_log&nbsp;86400&quot;&nbsp;combined\r\n&lt;/VirtualHost&gt;</pre><p>意思是86400(每天）生成一份。/bin/rotatelogs -l 是命令，/usr/local/apache2/logs/mydiscuz.com-access_%Y%m%d_log是文件路径。combined跟nginx里的log_format规定的变量名称是一个意思。</p><p>言归正传。nginx的日志切割，必须要自己写个脚本来完成。思路是：每天0点跑个计划任务，把前一天的日志移到指定的目录，然后重新载入配置文件，最好是压缩一下就完美了。</p><h3>二、shell代码实现</h3><pre class=\"brush:as3;toolbar:false\">#!/bin/bash\r\nd=`date&nbsp;-d&nbsp;&quot;-1&nbsp;day&quot;&nbsp;+%F`\r\n[&nbsp;-d&nbsp;/data/wwwlogs/cutedlogs&nbsp;]&nbsp;||&nbsp;mkdir&nbsp;/data/wwwlogs/cutedlogs\r\nmv&nbsp;/data/wwwlogs/access_log.ruanwenwu.cn.log&nbsp;/data/wwwlogs/cutedlogs/$d.log\r\n/etc/init.d/nginx&nbsp;reload&nbsp;&gt;&nbsp;/dev/null\r\ncd&nbsp;/data/wwwlogs/cutedlogs\r\ngzip&nbsp;-f&nbsp;$d.log</pre><p>第一行建立d这个变量。第二行判断如果cutedlogs不存在就创建。第三行将现在的日志移到cutedlogs。第四行重载配置文件。第五行进入cuted目录。第六行进行压缩。</p><p>小知识：shell -x xx.sh是让直行过程可见。</p><p>实现截图：</p><p><img src=\"/ueditor/php/upload/image/20170324/1490314072745981.png\" title=\"1490314072745981.png\" alt=\"图片.png\"/></p><h3>三、添加计划任务，让每天0点执行</h3><p>crontab -e,添加：</p><p>#每天切割日志<br/></p><pre class=\"brush:as3;toolbar:false\">0&nbsp;0&nbsp;*&nbsp;*&nbsp;*&nbsp;/bin/sh&nbsp;/root/shellscripts/cutaccesslog.sh</pre><p>							</p>','日志','nginx日志切割','但凡是有点流量的网站访问日志都会比较大。不做切割的话，时间久了就没法看了。跟我一起来看看nginx切割日志的方法吧。','linux',0,17),(97,1490316920,1490318289,1490316920,'<p>								</p><p>一、配置</p><pre class=\"brush:as3;toolbar:false\">&nbsp;location&nbsp;~&nbsp;.*\\.(gif|jpg|jpeg|png|bmp|swf|flv|ico)$&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expires&nbsp;30d;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;off;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;valid_referers&nbsp;none&nbsp;blocked&nbsp;*.ruanwenwu.cn;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($invalid_referer)\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;403;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p>二、测试</p><ol style=\"list-style-type: decimal;\" class=\" list-paddingleft-2\"><li><p>用curl测试，发现当指定referer为百度时，返回403<br/></p><p><img src=\"/ueditor/php/upload/image/20170324/1490316692959324.png\" title=\"1490316692959324.png\" alt=\"图片.png\"/></p></li><li><p>用网站测试，将该图片发到网站www.111.com上：</p><p><img src=\"/ueditor/php/upload/image/20170324/1490316766254919.png\" title=\"1490316766254919.png\" alt=\"图片.png\"/>（不显示）。</p></li><li><p>将防盗链代码去掉再看：</p><p><img src=\"/ueditor/php/upload/image/20170324/1490316829284345.png\" title=\"1490316829284345.png\" alt=\"图片.png\"/></p></li></ol><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 111.com能看ruanwenwu.cn的图片了。说明防盗链失效了。<br/></p><p>							</p>','安全','简单实用的Nginx防盗链配置','nginx防盗链配置,简单粗暴，有图有真相。','linux',0,32),(99,1490373681,1490373681,1490373681,'<p>I will not quit,never.</p>','干劲','Let\'s go on and on...','I will not quit,never.','说说',0,23),(100,1490424686,1490424686,1490424686,'<p>这是我父亲日记里的文字~这是我父亲日记里的文字~这是我父亲日记里的文字~这是他的青春，他的青春留下来的散文诗~</p>','心情','父亲写的散文诗','这是我父亲日记里的文字~','说说',0,13),(101,1490427857,1490428740,1490427857,'<p>								</p><h3>题记：<br/></h3><p>之前我们已经讲过用户访问控制的实现。这是我的博客上实现的“<a href=\"/admin.php\" target=\"_blank\">用户访问控制</a>”,忘了的话，方法参考这里：<a href=\"/blog/88.html\" target=\"_blank\">戳这里</a>。</p><p>这一节我们讲几种别的访问控制。比如我们的后台admin.php只允许某个ip或者某些ip。又比如我们查看网站的访问日志，发现某些Ip存在恶意攻击的行为，我们需要将这些ip禁用掉。</p><p>只允许某些ip访问某个文件，配置如下：</p><pre class=\"brush:as3;toolbar:false\">&nbsp;location&nbsp;~&nbsp;.*admin\\.php$&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#auth_basic&nbsp;&quot;ruanwenwu&nbsp;auth&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#auth_basic_user_file&nbsp;/usr/local/nginx/conf/.htpasswd;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow&nbsp;127.0.0.1;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow&nbsp;10.21.95.251;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deny&nbsp;all;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;fastcgi_params;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_pass&nbsp;unix:/tmp/www.sock;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_index&nbsp;index.php;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_param&nbsp;SCRIPT_FILENAME&nbsp;/data/www/upload$fastcgi_script_name;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p><img src=\"/ueditor/php/upload/image/20170325/1490427454305818.png\" title=\"1490427454305818.png\" alt=\"blob.png\"/>（被允许的ip可以访问）</p><p><br/></p><p><img src=\"http://ruanwenwu.cn/ueditor/php/upload/image/20170325/1490427751548703.png\" title=\"1490427751548703.png\" alt=\"blob.png\"/>（没被允许的访问403了）</p><h3>上面这个例子只是限制admin.php，因为限制规则都写在location里面。如果写在server下就是全局限制，就像这样：</h3><pre class=\"brush:as3;toolbar:false\">server\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;80;\r\n&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;www.111.com&nbsp;www.test.com;\r\n&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;index.html&nbsp;index.htm&nbsp;index.php;\r\n&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;/data/www/upload;\r\n&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;/usr/local/nginx/logs/111.com.access.log;\r\n&nbsp;&nbsp;&nbsp;&nbsp;deny&nbsp;127.0.0.1;\r\n}</pre><p><img src=\"/ueditor/php/upload/image/20170325/1490428471308849.png\" title=\"1490428471308849.png\" alt=\"blob.png\"/>（非127.0.0.1的ip访问正常）</p><p><img src=\"/ueditor/php/upload/image/20170325/1490428553990828.png\" title=\"1490428553990828.png\" alt=\"blob.png\"/></p><p>（127.0.0.1访问被禁止）</p><p>备注：deny就是黑名单，allow就是白名单。</p><p><br/></p><p>							</p>','安全','nginx访问控制','之前我们已经讲过nginx的用户认证，这种方式可以增加某些页面一定的安全性。这一节我们讲几种别的控制访问的方式。','linux',0,24),(102,1490435701,1490435701,1490435701,'<h3>题记</h3><p>最常用的应该就是限制一般的curl抓取，蜘蛛的爬取。</p><p>配置很简单，可以加在location里，也可以加在server里，看具体情况而定</p><pre class=\"brush:as3;toolbar:false\">&nbsp;if&nbsp;($http_user_agent&nbsp;~&nbsp;baidu|sougou|360|curl)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;403;\r\n&nbsp;}</pre><p>发现curl访问被禁掉了。</p><p><img src=\"/ueditor/php/upload/image/20170325/1490429999648551.png\" title=\"1490429999648551.png\" alt=\"blob.png\"/></p><h3>干掉curl，看看百度有没有被禁掉，修改配置文件如下：</h3><pre class=\"brush:as3;toolbar:false\">&nbsp;if&nbsp;($http_user_agent&nbsp;~&nbsp;baidu|sougou|360)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;403;\r\n&nbsp;}</pre><p>可以发现：</p><p><img src=\"/ueditor/php/upload/image/20170325/1490430191239638.png\" title=\"1490430191239638.png\" alt=\"blob.png\"/></p><p>curl已经能够正常访问，而含有百度的user_agent已经被限制了。</p><h3>补充：</h3><p>我自己是做php的，有时候业务需要爬取一些网站。我有时候用file_get_contents，有时候也用curl。刚才做了测试，发现这两个函数直接用（不做复杂的参数配置），nginx捕获的日志显示的useragent是空，referer也是空。</p><p>所以我在vhost里加了一条规则来过滤这些请求：</p><pre class=\"brush:as3;toolbar:false\">&nbsp;if&nbsp;($http_user_agent&nbsp;~&nbsp;^$)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;403;\r\n&nbsp;&nbsp;}</pre><p>处理过后，再看日志：</p><p><img src=\"http://ruanwenwu.cn/ueditor/php/upload/image/20170325/1490435581709370.png\" title=\"1490435581709370.png\" alt=\"blob.png\"/></p><p>对于比较老练的“爬手”这样根本是防不住的，最好的还是通过程序判断ip访问频次，比如每份钟100次的，丢到黑名单里。</p>','nginx','nginx禁止指定user_agent','对于搞开发的，特别是前端开发的，useragent这个东西非常常见，因为他们的代码要调浏览器兼容性，而每一个浏览器都对应一个useragent。事实上，每一个http请求里都含有useragent这个东西，当然也有不含有的，那是通过程序发出的请求。nginx作为网站的第一道防线，肯定不能没有对useragent的限制啦。','linux',0,36),(104,1490459833,1490459833,1490459833,'<h3>一、模块化开发的意义</h3><p><strong>1.解决命名冲突。</strong></p><p>从一个故事说起。</p><p>有一天开发人员小王发现自己负责的业务突然出故障了。经过好一番排查发现是他们项目中公用的utile.js里（这是个超大的utile，简直就像百宝箱一样，这样的工具箱太可怕了），不知道被哪个&quot;坑货&quot;加了一个函数，把他之前用的那个函数覆盖了。</p><p>为了避免像这样的命名冲突的问题再发生，小组决定使用命名空间，于是函数名称变成了这样：orl.utile.changeStatus。</p><p>这样，虽然解决了冲突的问题，但是仍然存在很明显的弊端。一是文件名太长（还有比上面更长的），加重了开发人员的记忆负担；二是这样的用json格式的封装，里面的变量是可被操作的，这不符合封装的要求，容易被污染；三是这样一坨的东西放在一起，根本是不好用，也是不合理的。为什么工具需要分类呢？是为了更好的使用。而模块化正是实现了工具分类。</p><p><strong>2.解决依赖。</strong></p><p>我们在用jquery的插件的时候都知道要先引入jquery文件然后再引入jquery插件，是因为我们知道有这样的依赖关系，这没有问题。但是如果某个功能是项目中的一个成员A开发的，而这个功能又依赖那个功能，这下就有问题了。不论A告知大家这样的依赖关系，但总有人会忘记或者有新人来根部不知道，这样的问题会一直纠缠着A，永远永远，最后A疯了，放弃了程序员这个伟大的职业，转行卖煎饼去了。</p><p><br/></p><p>为了解决依赖的问题，雅虎就采用配置的方法，将这些依赖做声明，结果代码编程这样：</p><pre class=\"brush:as3;toolbar:false\">YUI.add(&#39;my-module&#39;,&nbsp;function&nbsp;(Y)&nbsp;{&nbsp;&nbsp;//&nbsp;...},&nbsp;&#39;0.0.1&#39;,&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;requires:&nbsp;[&#39;node&#39;,&nbsp;&#39;event&#39;]\r\n});</pre><p>这都是些什么鬼，可读性差，配置太复杂了，要疯掉的啦~~</p><p>终于，后来有个叫玉伯的男人开发了一款叫sea.js的工具，完美了解决了上面两个问题，将无数的程序员从痛苦与绝望中拯救了出来。</p><h3>二、模块化的超简单步骤（先看看情况，再了解细节啊）</h3><p><strong>废话说在前面</strong></p><p>让所谓的AMD和CMD见鬼去吧，这些伤脑筋的玩意。不管你用require.js还是sea.js，明白模块的结构，会用模块化的方法去解决项目中的问题才是关键。这里我们只介绍sea.js的使用方法。</p><p>暂且不看单个模块怎么写，我们先看看模块是怎么关联部署的。</p><p>官方的例子已经比较简单了，但是刚开起来还是费劲。我总结了一下，也写了两个例子，其中一个超级简单的我删掉了，留了一个稍微有点意义的例子。总结起来就是3步走到位。</p><pre class=\"brush:as3;toolbar:false\">1.引入sea.js\r\n2.给你的模块找个窝，然后把你写好的模块放到窝里。（就是放模块的目录^_^）\r\n2.配置sea.js</pre><p>就是这么简单。</p><p>木有图，木有代码，木有链接，就木有真相，贴贴贴，都贴上：</p><p><strong>链接：</strong><a href=\"http://ruanwenwu.cn/index.php/Demo/Index/seajs\" target=\"_self\">http://ruanwenwu.cn/index.php/Demo/Index/seajs</a></p><p><strong>代码：</strong></p><pre class=\"brush:as3;toolbar:false\">&lt;extend&nbsp;name=&quot;Public:base&quot;&nbsp;/&gt;\r\n&lt;block&nbsp;name=&quot;css&quot;&gt;\r\n	&lt;style&gt;\r\n		#div1{width:200px;height:200px;background:red;position:absolute;top:30;left:0;}\r\n	&lt;/style&gt;\r\n&lt;/block&gt;\r\n\r\n&lt;block&nbsp;name=&quot;content&quot;&gt;\r\n&lt;h1&gt;sea.js的实例&lt;/h1&gt;\r\n&lt;div&nbsp;id=&quot;div1&quot;&gt;\r\n&lt;/div&gt;\r\n&lt;/block&gt;\r\n\r\n&lt;block&nbsp;name=&quot;script&quot;&gt;\r\n	&lt;script&nbsp;src=&quot;/Public/sea/sea.js&quot;&gt;&lt;/script&gt;\r\n	&lt;script&gt;\r\n	&nbsp;//&nbsp;Set&nbsp;configuration\r\n		&nbsp;&nbsp;seajs.config({\r\n			base:&nbsp;&quot;/Public/sea/modules/&quot;,\r\n			alias:&nbsp;{\r\n			&nbsp;&nbsp;&quot;jquery&quot;:&nbsp;&quot;jquery/jquery/1.10.1/jquery.js&quot;\r\n			}\r\n		&nbsp;&nbsp;});\r\n\r\n		&nbsp;&nbsp;seajs.use(&quot;/Public/sea/app/demo_index_sea_main&quot;);\r\n	&nbsp;&lt;/script&gt;\r\n&lt;/block&gt;</pre><p>太xx的简洁了，(请自动忽略模板语言里的这些block,和extend)，简直符合洁癖强迫症患者的口味？有没有？</p><p><strong>我给大家看看我的模块的窝放的地方：/Public/sea/modules/</strong></p><p><img src=\"http://ruanwenwu.cn/Public/plugin/ueditor/themes/default/images/spacer.gif\"/><img src=\"/ueditor/php/upload/image/20170326/1490459239948024.png\" title=\"1490459239948024.png\" alt=\"blob.png\"/></p><p>这个窝放哪里都行，服务器能找到就可以。这里为什么会有一个app目录呢？这个app也是用来放模块的，只不是它只放业务模块，没有特定的功能，一般一个页面有一个。这个app目录是我自己设计的，不用它也是可以的。</p><p><strong>说明：</strong>流程就是sea.js调demo_index_sea_main.js这个模块，然后就没有然后了。后面的事就交给demo_index_sea_main.js这个模块去处理了，它可能找别的模块帮忙，那就是它的事了。</p><h3>三、现在知道Sea.js(CMD)模块部署的流程了，我们再回头来看一下单个模块是如何写的。</h3><p>简单粗暴就是贴代码。我将这个例子的两个模块贴一下：</p><p>demo_index_sea_main:</p><pre class=\"brush:as3;toolbar:false\">define(function(require){\r\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;alertModule&nbsp;=&nbsp;require(&quot;../modules/alertmodule&quot;);//引入alert模块\r\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;drag&nbsp;=&nbsp;require(&quot;../modules/perfectdrag&quot;);\r\n&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;drag(&quot;div1&quot;);\r\n});\r\nperfectdrag.js</pre><p>perfectdrag.js:</p><pre class=\"brush:as3;toolbar:false\">define(function(require,exports,module){	\r\n	function&nbsp;perfectDrag(ele){	\r\n		var&nbsp;oDiv&nbsp;=&nbsp;document.getElementById(ele);			\r\n		oDiv.onmousedown&nbsp;=&nbsp;function(){\r\n			var&nbsp;pos&nbsp;=&nbsp;getPos();\r\n			var&nbsp;diffX&nbsp;=&nbsp;pos.x&nbsp;-&nbsp;this.offsetLeft;\r\n			var&nbsp;diffY&nbsp;=&nbsp;pos.y&nbsp;-&nbsp;this.offsetTop;\r\n			var&nbsp;moveObj;\r\n			\r\n			if(oDiv.setCapture){\r\n				moveObj&nbsp;=&nbsp;oDiv;\r\n			}else{\r\n				moveObj&nbsp;=&nbsp;document;\r\n			}\r\n			\r\n			moveObj.onmousemove&nbsp;=&nbsp;mousemove;\r\n			\r\n			moveObj.onmouseup&nbsp;=&nbsp;function(){\r\n				this.onmousemove&nbsp;=&nbsp;null;\r\n				this.onmouseup&nbsp;&nbsp;&nbsp;=&nbsp;null;\r\n				if(this.releaseCapture){\r\n					this.releaseCapture();\r\n				}\r\n			}\r\n			\r\n			if(this.setCapture){\r\n				this.setCapture();\r\n			}\r\n			\r\n			return&nbsp;false;\r\n			\r\n			function&nbsp;mousemove(){\r\n				var&nbsp;pos&nbsp;=&nbsp;getPos();\r\n				oDiv.style.left&nbsp;=&nbsp;pos.x&nbsp;-&nbsp;diffX&nbsp;+&nbsp;&#39;px&#39;;\r\n				oDiv.style.top&nbsp;&nbsp;=&nbsp;pos.y&nbsp;-&nbsp;diffY&nbsp;+&nbsp;&#39;px&#39;;\r\n			}\r\n		}\r\n	\r\n	}\r\n	\r\n	module.exports&nbsp;=&nbsp;perfectDrag;	#输出模块的功能。这就是那些所谓的API,整这些术语真是让人费解~~\r\n\r\n	function&nbsp;getPos(){\r\n		var&nbsp;sTop&nbsp;&nbsp;=&nbsp;document.documentElement.scrollTop&nbsp;||&nbsp;document.body.scrollTop;\r\n		var&nbsp;sLeft&nbsp;=&nbsp;document.documentElement.scrollLeft&nbsp;||&nbsp;document.body.scrollLeft;\r\n		var&nbsp;e=arguments.callee.caller.arguments[0]&nbsp;||&nbsp;window.event;&nbsp;\r\n		return&nbsp;{x&nbsp;:&nbsp;sLeft&nbsp;+&nbsp;e.clientX,&nbsp;y&nbsp;:&nbsp;sTop&nbsp;+&nbsp;e.clientY};\r\n	}\r\n});</pre><p>解释一下上面的模块：</p><pre class=\"brush:as3;toolbar:false\">1.一般一个模块放一个文件，不用担心文件太多，影响加载速度，这个我们最后会有压缩工具&nbsp;来压缩和合并。\r\n2.模块书写固定格式：\r\ndefine(function(require,exports,module){\r\n//code&nbsp;&nbsp;这里原来怎么写现在还怎么写\r\n});\r\n接受一个工厂方法，方法里的这三个变量分别是：加载模块的方法的引用，模块的exports变量（APID输出）的引用，模块信息的对象。这三个名称建议不要更改。不要问我为什么，感兴趣可以读一下源码。\r\n3.引入模块的方法：\r\nvar&nbsp;a&nbsp;=&nbsp;require(&quot;b&quot;);//引入b模块，将模块的输出返回给变量a。说到模块的输出，那么什么是模块的输出呢？像这样：\r\ndefine(function(require,exports,module){\r\nfunction&nbsp;person(name){\r\nthis.name&nbsp;=&nbsp;name;\r\n}\r\nmodule.exports&nbsp;=&nbsp;person;\r\n});\r\n或者这样:\r\ndefine(function(require,exports,module){\r\nfunction&nbsp;add(a,b){\r\nreturn&nbsp;a+b;\r\n}\r\nexports.add&nbsp;=&nbsp;add;\r\n});</pre><p>最常用的就是这两种的，记太多也没意义了。exports是module.exports的引用，不能直接给exports赋值，这是错误的：exports = add;</p><h3>模块标志：（啥模块标志，就是怎么引模块）</h3><p>好啦，模块化的东西基本上就完了。如果有人还有疑问，可能是想问模块怎么引入的？这个引入的方法特别多。我建议只记住我下面说的就好了。</p><p>相对路径：永远相对于当前跑的这个文件。</p><p>绝对路径：这个就是完整路径，没什么好说的。</p><p>默认路径：就是不是以/或者.或者..开头的目录，相对于我们配置的base目录，如果没有配就相对于sea.js的文件目录。</p><p>压缩的先不说，还没做试验。其实不做影响也不大。现在的带宽不是问题，而且浏览器本身支持多任务，多个文件一起下，说不定更快哦。</p><p><br/></p>','js模块化开发','sea.js快速入门','js模块化开发棒棒哒，解决好多问题呢','js',0,22),(105,1490507756,1490507756,1490507756,'<h3>废话说在前头</h3><p>我是源码安装的。特别坑。make了差不多半个小时。还是建议使用二进制包。解压开就能直接用了。</p><h3>node.js安装（源码包安装）</h3><p><strong>下载</strong></p><p>我是在官网下的源码包</p><p>wget&nbsp;<a href=\"https://nodejs.org/dist/v6.10.1/node-v6.10.1.tar.gz\">https://nodejs.org/dist/v6.10.1/node-v6.10.1.tar.gz</a> </p><p><strong>解压,安装（等吧，make完好像经过了几个世纪）</strong></p><pre class=\"brush:as3;toolbar:false\">tar&nbsp;zxvf&nbsp;node-v6.10.1.tar.gz\r\ncd&nbsp;node-v6.10.1\r\n./configure&nbsp;--prefix=/usr/local/node\r\nmake&nbsp;&amp;&amp;&nbsp;make&nbsp;install</pre><p><strong>安装完后</strong></p><pre class=\"brush:as3;toolbar:false\">cd&nbsp;/usr/local/node/bin\r\nnode&nbsp;-v</pre><p>看看版本号。如果正常，接着装npm。</p><p><span style=\"color: rgb(255, 0, 0);\">注意，这儿要先把node命令安装到全局$PATH变量，否则安装npm会出错。</span></p><h3><span style=\"color: rgb(0, 0, 0);\">npm安装</span></h3><p><span style=\"color: rgb(0, 0, 0);\">node安装好，npm的源码包也包括在里面了，路径是：</span></p><p><img src=\"/ueditor/php/upload/image/20170326/1490507605495465.png\" title=\"1490507605495465.png\" alt=\"blob.png\"/></p><p>看到configure文件没？</p><pre class=\"brush:as3;toolbar:false\">./configure\r\nmake&nbsp;&amp;&amp;&nbsp;make&nbsp;isntall</pre><p>完工。</p>','js模块化开发','linux环境下安装node.js和npm','没想到装个Node花了这么长时间，记录一下过程，希望能帮助到一些人。','node',0,4),(106,1490511414,1490511414,1490511414,'<h3>简单的代理</h3><p>这个代理实现通过代理服务器来访问ruanwenwu.cn的效果。</p><p><strong>首先修改代理服务器的hosts，让ruanwenwu.cn指向127.0.0.1</strong><br/></p><p>vim /etc/hosts</p><p><img src=\"/ueditor/php/upload/image/20170326/1490508279456387.png\" title=\"1490508279456387.png\" alt=\"图片.png\"/></p><p><strong>在/usr/local/nginx/conf/vhosts目录下建立proxy_test_single.conf文件：</strong></p><pre class=\"brush:as3;toolbar:false\">server{\r\n&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;80;\r\n&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;ruanwenwu.cn;\r\n&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;/&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_pass&nbsp;http://101.200.168.135/;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#proxy_set_header&nbsp;Host&nbsp;$host;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n}\r\n这个配置的意思是，通过这台代理服务器访问ruanwenwu.cn的时候，将目的指向\r\n这里有个问题，就是如果要成功的话，ruanwenwu.cn的网站的默认server是开放的才行，如果默认server是deny&nbsp;all，像下面这样，这个实验就该返回403了\r\n&nbsp;\r\nserver\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;80&nbsp;default_server;\r\n&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;localhost;\r\n&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;index.html&nbsp;index.htm&nbsp;index.php;\r\n&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;/tmp/1233;\r\n&nbsp;&nbsp;&nbsp;&nbsp;deny&nbsp;all;\r\n}</pre><p>有人也叫上面这种default_server空主机头。好处就是你的网站不能通过ip访问，其他的子域名也不会都指向别的地方。配置好，检查一下nginx配置的语法，没问题就可以重新加载配置文件了。</p><p><strong>测试</strong></p><p>curl -x127.0.0.1:80 <a href=\"http://www.ruanwenwu.cn\">www.ruanwenwu.cn</a> -I 返回200说明成功了。 <br/></p><h3>通过nginx的upstream实现负载均衡</h3><p>现在我手上有3台服务器：10.21.93.208,10.21.93.205,10.21.93.204。205和204这两台都部署了网站111.com的程序。现在我想让10.21.93.208做为负载均衡服务器，让请求能够分发到205和204上面。</p><p>首先，我配置好了204和205的网站环境，让他们能够通过10.21.93.205:80和10.21.93.204:80都能够访问到。这一步只要去掉空主机头，让接受111.com访问的虚拟主机成功默认虚拟主机。贴上204和205其中一台的虚拟机配置：</p><pre class=\"brush:as3;toolbar:false\">server\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;80&nbsp;default_server;\r\n&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;www.111.com&nbsp;www.test.com;\r\n&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;index.html&nbsp;index.htm&nbsp;index.php;\r\n&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;/data/www/upload;\r\n&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;/usr/local/nginx/logs/111.com.access.log;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($http_user_agent&nbsp;~&nbsp;baidu|sougou|360)&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;403;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($host&nbsp;!=&nbsp;&#39;www.111.com&#39;)\r\n&nbsp;&nbsp;&nbsp;&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;rewrite&nbsp;^/(.*)$&nbsp;http://www.111.com/$1&nbsp;permanent;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;~&nbsp;.*admin\\.php$&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;#auth_basic&nbsp;&quot;ruanwenwu&nbsp;auth&quot;;\r\n&nbsp;&nbsp;&nbsp;&nbsp;#auth_basic_user_file&nbsp;/usr/local/nginx/conf/.htpasswd;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#allow&nbsp;127.0.0.1;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#allow&nbsp;10.21.95.251;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#deny&nbsp;all;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;fastcgi_params;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_pass&nbsp;unix:/tmp/www.sock;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_index&nbsp;index.php;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_param&nbsp;SCRIPT_FILENAME&nbsp;/data/www/upload$fastcgi_script_name;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n&nbsp;&nbsp;&nbsp;&nbsp;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;~&nbsp;\\.php$&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;fastcgi_params;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#fastcgi_pass&nbsp;127.0.0.1:9000;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_pass&nbsp;unix:/tmp/www.sock;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_index&nbsp;index.php;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_param&nbsp;SCRIPT_FILENAME&nbsp;/data/www/upload$fastcgi_script_name;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n\r\n}</pre><p>现在，我们配置208上的负载均衡的配置：</p><p>vim 111.conf</p><pre class=\"brush:as3;toolbar:false\">upstream&nbsp;ruanwenwu&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;10.21.93.205:80;\r\n&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;10.21.93.204:80;\r\n}\r\nserver\r\n{\r\n&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;80;\r\n&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;www.111.com&nbsp;www.test.com;\r\n\r\n&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;/&nbsp;{\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_pass&nbsp;http://ruanwenwu;\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_set_header&nbsp;HOST&nbsp;$host;\r\n&nbsp;&nbsp;&nbsp;&nbsp;}\r\n}</pre><p>注意upstream后面的名称一定要拼写正确，而且upstream reuanwenwu后最好跟一个空格，就像上面代码贴的这样，否则就会一致报下面的错误：<br/></p><p>nginx: [emerg] host not found in upstream &quot;<span style=\"color: rgb(255, 0, 0);\">ruanewnwu</span>&quot; in /usr/local/nginx/conf/vhosts/111.conf:11<br/>最后的效果:</p><p><img src=\"/ueditor/php/upload/image/20170326/1490511196540142.png\" title=\"1490511196540142.png\" alt=\"图片.png\"/></p><p><img src=\"/ueditor/php/upload/image/20170326/1490511212562850.png\" title=\"1490511212562850.png\" alt=\"图片.png\"/></p><p>说明已经成功了，oh y!<br/></p>','nginx','nginx做代理和负载均衡','nginx做代理就是，举个栗子，你让张三帮你去买个水果，那么张三就是代理。那么什么是负载均衡呢？再举个栗子，负载均衡就好像银行办理业务，客户拿到流水单号后，会被随机分配到不同的柜台，这些柜台一起办理业务，加快了业务的办理速度，减少了用户的等待时间，这就是负载均衡。','linux',0,9),(107,1490525243,1490525243,1490525243,'<h3>首先在github上创建一个新的repo。</h3><p>这个入口很多，随便都能找到，就不细说了。</p><h3>配置自己的云服务器，把服务器的公私贴给git服务器。</h3><pre class=\"brush:as3;toolbar:false\">[root@iZ25lzba47vZ&nbsp;~]#&nbsp;cd&nbsp;~\r\n[root@iZ25lzba47vZ&nbsp;~]#&nbsp;ls&nbsp;-la|grep&nbsp;.ssh\r\ndrwx------&nbsp;&nbsp;&nbsp;2&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4096&nbsp;Mar&nbsp;26&nbsp;17:28&nbsp;.ssh\r\n[root@iZ25lzba47vZ&nbsp;~]#&nbsp;ls&nbsp;.ssh\r\nid_rsa&nbsp;&nbsp;id_rsa.pub&nbsp;&nbsp;known_hosts</pre><p>如果发现你连.ssh目录都没有，就需要创建了，创建方法。详细请看<a href=\"https://help.github.com/articles/generating-an-ssh-key/\" target=\"_self\">官方文档</a></p><pre class=\"command-line\">ssh-keygen&nbsp;-t&nbsp;rsa&nbsp;-b&nbsp;4096&nbsp;-C&nbsp;&quot;your_email@example.com&quot;</pre><p>创建完成后，就可以打开id_rsa.pub文件，并复制里面的内容了。复制好，贴到这里：</p><p><img src=\"/ueditor/php/upload/image/20170326/1490524838296332.png\" title=\"1490524838296332.png\" alt=\"图片.png\"/></p><h3>贴完就可以开始同步你的代码到git仓库了</h3><p>我假设你已经有自己的项目了。进入你的项目运行下面几个命令：</p><pre class=\"f5 js-zeroclipboard-target\">git&nbsp;remote&nbsp;add&nbsp;origin&nbsp;git@github.com:ruanwenwu/ruanwenwu.cn.git\r\ngit&nbsp;push&nbsp;-u&nbsp;origin&nbsp;master</pre><p>这样就把你的项目给推到git了。好了，现在可以做计划任务定时备份数据并且传到git了。</p><h3>我写了这样一个脚本：</h3><pre class=\"brush:as3;toolbar:false\">#!/bin/bash\r\n#备份配置文件\r\n\\cp&nbsp;/usr/local/nginx/conf/nginx.conf&nbsp;/data/wwwroot/blog/confbak/\r\n\\cp&nbsp;/usr/local/php/etc/php-fpm.conf&nbsp;/data/wwwroot/blog/confbak/\r\n\\cp&nbsp;/etc/my.cnf&nbsp;/data/wwwroot/blog/confbak/\r\n\\cp&nbsp;-r&nbsp;/usr/local/nginx/conf/vhost&nbsp;/data/wwwroot/blog/confbak/vhost\r\n#备份数据库\r\n/usr/local/mysql/bin/mysqldump&nbsp;-uroot&nbsp;-p7DMKne22&nbsp;blog&nbsp;&gt;&nbsp;/data/wwwroot/blog/data.sql\r\n#提交到git\r\ncd&nbsp;/data/wwwroot/blog/\r\n/usr/bin/git&nbsp;add&nbsp;-A&nbsp;.\r\n/usr/bin/git&nbsp;commit&nbsp;-m&nbsp;&#39;autoupload&#39;\r\n/usr/bin/git&nbsp;push&nbsp;-u&nbsp;origin&nbsp;master</pre><h3>计划任务每天凌晨2点跑一次就好了。</h3><pre class=\"brush:as3;toolbar:false\">#每天备份sql并同步到git\r\n*&nbsp;2&nbsp;*&nbsp;*&nbsp;*&nbsp;/usr/bin/sh&nbsp;/root/syncwithgit.sh</pre><h3>效果：</h3><p><img src=\"/ueditor/php/upload/image/20170326/1490525143506834.png\" title=\"1490525143506834.png\" alt=\"图片.png\"/></p><p>（测试的时候，计划任务做的每分钟一次，非常好用）<br/></p>','安全','使用git和linux实现自动备份功能','博客用的阿里云的服务器，要是哪天云服务一抽风或者忘缴费，辛辛苦苦弄的东西全没了，就疯掉了。所以抽了点时间将这些东西做了个自动备份。','linux',0,7);
/*!40000 ALTER TABLE `z_post` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `z_tag`
--

DROP TABLE IF EXISTS `z_tag`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `z_tag` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(25) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=54 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `z_tag`
--

LOCK TABLES `z_tag` WRITE;
/*!40000 ALTER TABLE `z_tag` DISABLE KEYS */;
INSERT INTO `z_tag` VALUES (2,'自我介绍'),(5,'框架'),(6,'zolframework'),(7,'架构'),(8,'瀑布流'),(9,'代码高亮'),(10,'移动端性能优化'),(11,'温暖'),(12,'offsetParent'),(13,'scrollTop'),(14,'js运动'),(15,'缓冲运动'),(16,'干劲'),(17,'分享'),(18,'亲情'),(19,'js事件'),(20,'css3'),(21,'php设计模式'),(22,'小技巧'),(23,'撒哈拉沙漠的故事'),(24,'DOMDocument'),(25,'分页'),(26,'oop'),(27,'权限管理'),(28,'工作'),(29,'加密'),(30,'做人'),(31,'算法'),(32,'上拉加载'),(33,'linux'),(34,'openssh-clients'),(35,'mac'),(36,'跨过的坑'),(37,'搜索'),(38,'oauth登陆'),(39,'安全'),(40,'RPMForge'),(41,'php编译安装'),(42,'nginx'),(43,'听音乐'),(44,'心情'),(45,'php-fpm'),(46,'php://input'),(47,'base64'),(48,'wordpress'),(49,'coreseek'),(50,'重定向'),(51,'日志'),(52,'女儿'),(53,'js模块化开发');
/*!40000 ALTER TABLE `z_tag` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `z_user`
--

DROP TABLE IF EXISTS `z_user`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `z_user` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `type` tinyint(3) unsigned NOT NULL DEFAULT '1' COMMENT '1.git.',
  `openid` varchar(55) NOT NULL DEFAULT '' COMMENT 'openid',
  `avatar` varchar(255) NOT NULL DEFAULT '',
  `ctime` int(11) NOT NULL DEFAULT '0',
  `lastlogin` int(11) NOT NULL DEFAULT '0' COMMENT '最后登录时间',
  `nickname` varchar(50) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`),
  KEY `openid` (`openid`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `z_user`
--

LOCK TABLES `z_user` WRITE;
/*!40000 ALTER TABLE `z_user` DISABLE KEYS */;
INSERT INTO `z_user` VALUES (1,1,'12878115','https://avatars0.githubusercontent.com/u/12878115?v=3',1490453306,1490453306,'ruanwenwu'),(2,1,'4101156','https://avatars1.githubusercontent.com/u/4101156?v=3',1490000933,1490000933,'gh72029002');
/*!40000 ALTER TABLE `z_user` ENABLE KEYS */;
UNLOCK TABLES;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

-- Dump completed on 2017-03-27  2:33:01
